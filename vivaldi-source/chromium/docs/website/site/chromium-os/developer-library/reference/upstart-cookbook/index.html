<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0064)https://itessier.users.x20web.corp.google.com/upstart/index.html -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/">
<title>Upstart Intro, Cookbook and Best Practises</title>
<style type="text/css">

/*
@import "https://wiki.ubuntu.com/htdocs/light/css/common.css";
@import "https://wiki.ubuntu.com/htdocs/light/css/screen.css";
*/

html
{
  font-family: "Ubuntu","Ubuntu Beta", UbuntuBeta, Ubuntu, "Bitstream Vera Sans", "DejaVu Sans", Tahoma,sans-serif;
}

.title
{
  border-bottom: 0.1em solid #23b500;
  display: inline-block;
}

img.upstart-logo
{
  display: inline-block;
  float: right;
  border: none;
}

img.ubuntu-logo
{
  display: inline;
  border: none;
}

img.ubuntu-transient
{
  display: inline;
  border: 0.2em solid #dc4c00;
  padding: 0.1em;
  filter: invert;
}

a
{
  text-decoration:none;
}

dt
{
    padding: 0.2em 0;
}

dd + dt
{
    margin-top: 0.5em;
}

dd
{
    margin-left: 1em;
}

div.contents
{
  font-size: smaller;
  float: right !important;
  border-left: medium solid silver;
  margin: 1.5em;
  margin-right: 0;
  padding: 0.5em 0 0.5em 1.5em;
}

div.contents ul
{
    padding-left: 0;
    list-style: none;
    margin: 0.35em 0;
}

div.contents ul ul
{
    padding-left: 1.5em;
}

div.contents p.topic-title
{
    font-weight: bold;
    font-size: 1.5em;
    margin: 0;
    margin-bottom: 0.5em;
}

div.section div.section
{
    margin-left: 0.35em;
}

pre.literal-block
{
  margin: 0 0 0 2em;
  background-color: WhiteSmoke;
  display: inline-block;

  /* indent */
  padding: 0.5em 2em 0.5em 0.5em;
}

.toc-backref,
section
{
  color: black;
}

.reference
{
  text-decoration: none;
  border-bottom: 1px dotted silver;
  color: black;
}

a:hover
{
  border-bottom: 2px solid silver !important;
}


div[id="standard-environment-variables"] table,
  a[id="standard-environment-variables"] table,
div[id="job-states"] table,
  a[id="job-states"] table,
div[id="releases"] table,
  a[id="releases"] table,
div[id="bridges"] table,
  a[id="bridges"] table,
div[id="initctl-commands-summary"] table,
  a[id="initctl-commands-summary"] table,
div[id="stanzas-by-category"] table,
  a[id="stanzas-by-category"] table,
div[id="implications-of-misspecifying-expect"] table,
  a[id="implications-of-misspecifying-expect"] table,
div[id="command-line-options"] table,
  a[id="command-line-options"] table,
div[id="statistics"] table,
  a[id="statistics"] table
{
  border: 1px solid black;

  /* indent */
  margin: 0 0 0 3em;
}

/* override hard-coded column widths rst2html generates in HTML */
col
{
  width: auto !important;
}

div[id="standard-environment-variables"] th,
  a[id="standard-environment-variables"] th,
div[id="job-states"] th,
  a[id="job-states"] th,
div[id="releases"] th,
  a[id="releases"] th,
div[id="bridges"] th,
  a[id="bridges"] th,
div[id="initctl-commands-summary"] th,
  a[id="initctl-commands-summary"] th,
div[id="stanzas-by-category"] th,
  a[id="stanzas-by-category"] th,
div[id="implications-of-misspecifying-expect"] th,
  a[id="implications-of-misspecifying-expect"] th,
div[id="command-line-options"] th,
  a[id="command-line-options"] th,
div[id="statistics"] th,
  a[id="statistics"] th
{
  text-align: center;
  background-color: lavender;
  border-top: 0;
  border-left: 1px;
  padding: 0 1em 0 1em;
  border-right: 1px dotted silver;
  border-bottom: 1px solid black;
}

/* don't underline spanned column */
div[id="standard-environment-variables"] th[colspan],
  a[id="standard-environment-variables"] th[colspan],
div[id="job-states"] th[colspan],
  a[id="job-states"] th[colspan],
div[id="releases"] th[colspan],
  a[id="releases"] th[colspan],
div[id="bridges"] th[colspan],
  a[id="bridges"] th[colspan],
div[id="initctl-commands-summary"] th[colspan],
  a[id="initctl-commands-summary"] th[colspan],
div[id="stanzas-by-category"] th[colspan],
  a[id="stanzas-by-category"] th[colspan],
div[id="implications-of-misspecifying-expect"] th[colspan],
  a[id="implications-of-misspecifying-expect"] th[colspan],
div[id="command-line-options"] th[colspan],
  a[id="command-line-options"] th[colspan],
div[id="statistics"] th[colspan],
  a[id="statistics"] th[colspan]
{
  text-align: center;
  background-color: lavender;
  border-bottom: 1px solid silver;
  padding: 0 0 0 0;
}

div[id="standard-environment-variables"] td,
  a[id="standard-environment-variables"] td,
div[id="job-states"] td,
  a[id="job-states"] td,
div[id="releases"] td,
  a[id="releases"] td,
div[id="bridges"] td,
  a[id="bridges"] td,
div[id="initctl-commands-summary"] td,
  a[id="initctl-commands-summary"] td,
div[id="stanzas-by-category"] td,
  a[id="stanzas-by-category"] td,
div[id="implications-of-misspecifying-expect"] td,
  a[id="implications-of-misspecifying-expect"] td,
div[id="command-line-options"] td,
  a[id="command-line-options"] td,
div[id="statistics"] td,
  a[id="statistics"] td
{
  border-top: 0;
  border-left: 0;
  border-right: 1px dotted silver;
  border-bottom: 1px dotted silver;
  padding: 0 1em 0 1em;
}


table.docutils.footnote
{
    margin-bottom: 0.2em;
}

div.document div.attention,
div.document div.caution,
div.document div.danger,
div.document div.error,
div.document div.hint,
div.document div.important,
div.document div.note,
div.document div.tip,
div.document div.warning,
div.document div.admonition
{
  margin: 2em;
  border: medium outset;
  padding: 1em;
}

.admonition-title
{
  color: red;
  font-weight: bold;
}

</style>
</head>
<body>
<div class="document" id="upstart-intro-cookbook-and-best-practises">
<h1 class="title">Upstart Intro, Cookbook and Best Practises</h1>

<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<!-- TODO -->
<!--  -->
<!-- - fold in all upstart.at blog entries with help from the Wayback Machine :) -->
<!-- - D-Bus API. -->
<!-- - hallyn: document 'restart job' acting differently from 'stop; start' -->
<!-- when there is a pre-stop or post-stop stanza (needs to go into man -->
<!-- pages too). -->
<!-- - limit cpu time for job using cpulimit pkg. -->
<!-- - mntctl(8) - needs man page! -->
<!-- - add chart of relative event order. -->
<!-- - Test: add question using incorrect use of respawn + expect. -->
<!-- - Respawn explanation -->
<!-- - Explain that mountall does not emit mounting/mounted for -->
<!-- *directories* such as /etc if there is only a single partition! -->
<!-- - Explanation of how upstart treats job exit codes: -->
<!-- - respawn jobs -->
<!-- - tasks -->
<!-- - normal exit -->
<!-- - as long as job "starts" successfully, it's happy. -->
<!-- - "start on stopping rsyslog" issues: -->
<!-- - lucid - killall5/pidof is limited to 4 omit pids: -->
<!-- $ pidof -o 1 -o 2 -o 3 -o 4 -o 5 foo -->
<!-- pidof: omit pid buffer size 5 exceeded! -->
<!-- - oneiric: jobs start but rsyslog has status stop/killed! -->
<!-- (is this from sendsigs??) -->
<!-- - single-user mode! -->
<!-- - start a job when an event has *not* been emitted. -->
<!-- - debian packaging and control: -->
<!-- - dh_installinit -->
<!-- - /lib/init/upstart-job. -->
<!-- - update-rc.d -->
<!-- - invoke-rc.d -->
<!-- - Reading default values -->
<!-- - /etc/default/ and sourcing advice (clint). -->
<!-- - Feature overview. -->
<!-- - Improve "Integrating your New Application with Upstart". -->
<!-- - add in summary of all major blog posts on features. -->
<!-- - add in a list of precepts. -->
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<!-- HEADER -->
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<img alt="Upstart Logo" class="upstart-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/4926319605052bdf09442836fd8d799b236e5db8">
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="index.html#meta" id="toc-entry-1">1&nbsp;&nbsp;&nbsp;Meta</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#document-version" id="toc-entry-2">1.1&nbsp;&nbsp;&nbsp;Document Version</a></li>
<li><a class="reference internal" href="index.html#authors" id="toc-entry-3">1.2&nbsp;&nbsp;&nbsp;Authors</a></li>
<li><a class="reference internal" href="index.html#acknowledgements" id="toc-entry-4">1.3&nbsp;&nbsp;&nbsp;Acknowledgements</a></li>
<li><a class="reference internal" href="index.html#purpose" id="toc-entry-5">1.4&nbsp;&nbsp;&nbsp;Purpose</a></li>
<li><a class="reference internal" href="index.html#suggestions-and-errata" id="toc-entry-6">1.5&nbsp;&nbsp;&nbsp;Suggestions and Errata</a></li>
<li><a class="reference internal" href="index.html#coverage" id="toc-entry-7">1.6&nbsp;&nbsp;&nbsp;Coverage</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#upstream-upstart" id="toc-entry-8">1.6.1&nbsp;&nbsp;&nbsp;Upstream Upstart</a></li>
<li><a class="reference internal" href="index.html#debian-and-ubuntu-version-of-upstart" id="toc-entry-9">1.6.2&nbsp;&nbsp;&nbsp;Debian and Ubuntu Version of Upstart</a></li>
<li><a class="reference internal" href="index.html#availability" id="toc-entry-10">1.6.3&nbsp;&nbsp;&nbsp;Availability</a></li>
<li><a class="reference internal" href="index.html#releases" id="toc-entry-11">1.6.4&nbsp;&nbsp;&nbsp;Releases</a></li>
<li><a class="reference internal" href="index.html#debian-specific-and-ubuntu-specific-content-debian-and-ubuntu-specific" id="toc-entry-12">1.6.5&nbsp;&nbsp;&nbsp;Debian-specific and Ubuntu-Specific Content (D , U)</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#audience" id="toc-entry-13">1.7&nbsp;&nbsp;&nbsp;Audience</a></li>
<li><a class="reference internal" href="index.html#document-preparation" id="toc-entry-14">1.8&nbsp;&nbsp;&nbsp;Document Preparation</a></li>
<li><a class="reference internal" href="index.html#document-availability" id="toc-entry-15">1.9&nbsp;&nbsp;&nbsp;Document Availability</a></li>
<li><a class="reference internal" href="index.html#warning" id="toc-entry-16">1.10&nbsp;&nbsp;&nbsp;Warning</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#typographical-conventions" id="toc-entry-17">2&nbsp;&nbsp;&nbsp;Typographical Conventions</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#commands-and-configuration-stanzas" id="toc-entry-18">2.1&nbsp;&nbsp;&nbsp;Commands and configuration stanzas</a></li>
<li><a class="reference internal" href="index.html#user-input-and-command-output" id="toc-entry-19">2.2&nbsp;&nbsp;&nbsp;User Input and Command Output</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#non-privileged-user" id="toc-entry-20">2.2.1&nbsp;&nbsp;&nbsp;Non-Privileged User</a></li>
<li><a class="reference internal" href="index.html#super-user" id="toc-entry-21">2.2.2&nbsp;&nbsp;&nbsp;Super-User</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#configuration-examples" id="toc-entry-22">2.3&nbsp;&nbsp;&nbsp;Configuration Examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#introduction" id="toc-entry-23">3&nbsp;&nbsp;&nbsp;Introduction</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#what-is-upstart" id="toc-entry-24">3.1&nbsp;&nbsp;&nbsp;What is Upstart?</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#reliability" id="toc-entry-25">3.1.1&nbsp;&nbsp;&nbsp;Reliability</a></li>
<li><a class="reference internal" href="index.html#design-history" id="toc-entry-26">3.1.2&nbsp;&nbsp;&nbsp;Design History</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#critique-of-the-system-v-init-system" id="toc-entry-27">3.1.2.1&nbsp;&nbsp;&nbsp;Critique of the System V init System</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#sysv-benefits" id="toc-entry-28">3.1.2.1.1&nbsp;&nbsp;&nbsp;SysV Benefits</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#simplicity" id="toc-entry-29">3.1.2.1.1.1&nbsp;&nbsp;&nbsp;Simplicity</a></li>
<li><a class="reference internal" href="index.html#guaranteed-ordering-of-services" id="toc-entry-30">3.1.2.1.1.2&nbsp;&nbsp;&nbsp;Guaranteed Ordering of Services</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#sysv-limitations" id="toc-entry-31">3.1.2.1.2&nbsp;&nbsp;&nbsp;SysV Limitations</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#non-optimal-performance" id="toc-entry-32">3.1.2.1.2.1&nbsp;&nbsp;&nbsp;Non-Optimal Performance</a></li>
<li><a class="reference internal" href="index.html#server-centric" id="toc-entry-33">3.1.2.1.2.2&nbsp;&nbsp;&nbsp;Server-Centric</a></li>
<li><a class="reference internal" href="index.html#assumes-static-hardware-at-all-times" id="toc-entry-34">3.1.2.1.2.3&nbsp;&nbsp;&nbsp;Assumes Static Hardware at all Times</a></li>
<li><a class="reference internal" href="index.html#every-service-does-heavy-lifting" id="toc-entry-35">3.1.2.1.2.4&nbsp;&nbsp;&nbsp;Every Service Does Heavy Lifting</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="index.html#critique-of-dependency-based-init-systems" id="toc-entry-36">3.1.2.2&nbsp;&nbsp;&nbsp;Critique of Dependency-Based init Systems</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#benefits-of-dependency-based-init" id="toc-entry-37">3.1.2.2.1&nbsp;&nbsp;&nbsp;Benefits of Dependency-based init</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#recognises-services-require-other-services" id="toc-entry-38">3.1.2.2.1.1&nbsp;&nbsp;&nbsp;Recognises Services Require Other Services</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#limitations-of-dependency-based-init" id="toc-entry-39">3.1.2.2.2&nbsp;&nbsp;&nbsp;Limitations of Dependency-based init</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#does-not-recognise-dynamic-nature-of-linux" id="toc-entry-40">3.1.2.2.2.1&nbsp;&nbsp;&nbsp;Does Not Recognise Dynamic Nature of Linux</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="index.html#upstart-s-design-why-it-is-revolutionary" id="toc-entry-41">3.1.2.3&nbsp;&nbsp;&nbsp;Upstart's Design: Why It Is Revolutionary</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#performance" id="toc-entry-42">3.1.3&nbsp;&nbsp;&nbsp;Performance</a></li>
<li><a class="reference internal" href="index.html#server" id="toc-entry-43">3.1.4&nbsp;&nbsp;&nbsp;Server</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#boot-performance" id="toc-entry-44">3.1.4.1&nbsp;&nbsp;&nbsp;Boot Performance</a></li>
<li><a class="reference internal" href="index.html#failure-modes" id="toc-entry-45">3.1.4.2&nbsp;&nbsp;&nbsp;Failure Modes</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="index.html#concepts-and-terminology" id="toc-entry-46">4&nbsp;&nbsp;&nbsp;Concepts and Terminology</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#job" id="toc-entry-47">4.1&nbsp;&nbsp;&nbsp;Job</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#job-types" id="toc-entry-48">4.1.1&nbsp;&nbsp;&nbsp;Job Types</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#task-job" id="toc-entry-49">4.1.1.1&nbsp;&nbsp;&nbsp;Task Job</a></li>
<li><a class="reference internal" href="index.html#service-job" id="toc-entry-50">4.1.1.2&nbsp;&nbsp;&nbsp;Service Job</a></li>
<li><a class="reference internal" href="index.html#abstract-job" id="toc-entry-51">4.1.1.3&nbsp;&nbsp;&nbsp;Abstract Job</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#job-states" id="toc-entry-52">4.1.2&nbsp;&nbsp;&nbsp;Job States</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#viewing-state-transitions" id="toc-entry-53">4.1.2.1&nbsp;&nbsp;&nbsp;Viewing State Transitions</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#job-environment" id="toc-entry-54">4.1.3&nbsp;&nbsp;&nbsp;Job Environment</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#job-configuration-file" id="toc-entry-55">4.2&nbsp;&nbsp;&nbsp;Job Configuration File</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#system-job" id="toc-entry-56">4.2.1&nbsp;&nbsp;&nbsp;System Job</a></li>
<li><a class="reference internal" href="index.html#user-job" id="toc-entry-57">4.2.2&nbsp;&nbsp;&nbsp;User Job</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#enabling" id="toc-entry-58">4.2.2.1&nbsp;&nbsp;&nbsp;Enabling</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#session-job" id="toc-entry-59">4.2.3&nbsp;&nbsp;&nbsp;Session Job</a></li>
<li><a class="reference internal" href="index.html#odd-jobs" id="toc-entry-60">4.2.4&nbsp;&nbsp;&nbsp;Odd Jobs</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#job-with-start-on-but-no-stop-on" id="toc-entry-61">4.2.4.1&nbsp;&nbsp;&nbsp;Job with <tt class="docutils literal">start on</tt>, but no <tt class="docutils literal">stop on</tt></a></li>
<li><a class="reference internal" href="index.html#job-with-stop-on-but-no-start-on" id="toc-entry-62">4.2.4.2&nbsp;&nbsp;&nbsp;Job with <tt class="docutils literal">stop on</tt>, but no <tt class="docutils literal">start on</tt></a></li>
<li><a class="reference internal" href="index.html#job-with-no-stop-on-or-start-on" id="toc-entry-63">4.2.4.3&nbsp;&nbsp;&nbsp;Job with no <tt class="docutils literal">stop on</tt> or <tt class="docutils literal">start on</tt></a></li>
<li><a class="reference internal" href="index.html#minimal-job-configuration" id="toc-entry-64">4.2.4.4&nbsp;&nbsp;&nbsp;Minimal Job Configuration</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="index.html#session-init" id="toc-entry-65">4.3&nbsp;&nbsp;&nbsp;Session Init</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#non-graphical-sessions-ubuntu-specific" id="toc-entry-66">4.3.1&nbsp;&nbsp;&nbsp;Non-graphical Sessions (U)</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#joining-a-session" id="toc-entry-67">4.3.1.1&nbsp;&nbsp;&nbsp;Joining a Session</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="index.html#event" id="toc-entry-68">4.4&nbsp;&nbsp;&nbsp;Event</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#event-types" id="toc-entry-69">4.4.1&nbsp;&nbsp;&nbsp;Event Types</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#signals" id="toc-entry-70">4.4.1.1&nbsp;&nbsp;&nbsp;Signals</a></li>
<li><a class="reference internal" href="index.html#methods" id="toc-entry-71">4.4.1.2&nbsp;&nbsp;&nbsp;Methods</a></li>
<li><a class="reference internal" href="index.html#hooks" id="toc-entry-72">4.4.1.3&nbsp;&nbsp;&nbsp;Hooks</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#events-not-states" id="toc-entry-73">4.4.2&nbsp;&nbsp;&nbsp;Events, not States</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#job-lifecycle" id="toc-entry-74">4.5&nbsp;&nbsp;&nbsp;Job Lifecycle</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#starting-a-job" id="toc-entry-75">4.5.1&nbsp;&nbsp;&nbsp;Starting a Job</a></li>
<li><a class="reference internal" href="index.html#stopping-a-job" id="toc-entry-76">4.5.2&nbsp;&nbsp;&nbsp;Stopping a Job</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#ordering" id="toc-entry-77">4.6&nbsp;&nbsp;&nbsp;Ordering</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#order-in-which-events-are-emitted" id="toc-entry-78">4.6.1&nbsp;&nbsp;&nbsp;Order in which Events are Emitted</a></li>
<li><a class="reference internal" href="index.html#order-in-which-jobs-which-start-on-the-same-event-are-run" id="toc-entry-79">4.6.2&nbsp;&nbsp;&nbsp;Order in Which Jobs Which <cite>start on</cite> the Same Event are Run</a></li>
<li><a class="reference internal" href="index.html#ordering-of-stop-start-operations" id="toc-entry-80">4.6.3&nbsp;&nbsp;&nbsp;Ordering of Stop/Start Operations</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#single-job" id="toc-entry-81">4.6.3.1&nbsp;&nbsp;&nbsp;Single Job</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#if-job-is-not-currently-running" id="toc-entry-82">4.6.3.1.1&nbsp;&nbsp;&nbsp;If Job is Not Currently Running</a></li>
<li><a class="reference internal" href="index.html#if-job-is-currently-running" id="toc-entry-83">4.6.3.1.2&nbsp;&nbsp;&nbsp;If Job is Currently Running</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#multiple-jobs" id="toc-entry-84">4.6.3.2&nbsp;&nbsp;&nbsp;Multiple Jobs</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="index.html#runlevels" id="toc-entry-85">4.7&nbsp;&nbsp;&nbsp;Runlevels</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#display-runlevel" id="toc-entry-86">4.7.1&nbsp;&nbsp;&nbsp;Display Runlevel</a></li>
<li><a class="reference internal" href="index.html#change-runlevel-immediately" id="toc-entry-87">4.7.2&nbsp;&nbsp;&nbsp;Change Runlevel Immediately</a></li>
<li><a class="reference internal" href="index.html#changing-the-default-runlevel" id="toc-entry-88">4.7.3&nbsp;&nbsp;&nbsp;Changing the Default Runlevel</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#permanently" id="toc-entry-89">4.7.3.1&nbsp;&nbsp;&nbsp;Permanently</a></li>
<li><a class="reference internal" href="index.html#single-boot" id="toc-entry-90">4.7.3.2&nbsp;&nbsp;&nbsp;Single Boot</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="index.html#system-phases" id="toc-entry-91">5&nbsp;&nbsp;&nbsp;System Phases</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#startup" id="toc-entry-92">5.1&nbsp;&nbsp;&nbsp;Startup</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#startup-process" id="toc-entry-93">5.1.1&nbsp;&nbsp;&nbsp;Startup Process</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#shutdown" id="toc-entry-94">5.2&nbsp;&nbsp;&nbsp;Shutdown</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#observations" id="toc-entry-95">5.2.1&nbsp;&nbsp;&nbsp;Observations</a></li>
<li><a class="reference internal" href="index.html#shutdown-process" id="toc-entry-96">5.2.2&nbsp;&nbsp;&nbsp;Shutdown Process</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#reboot" id="toc-entry-97">5.3&nbsp;&nbsp;&nbsp;Reboot</a></li>
<li><a class="reference internal" href="index.html#single-user-mode" id="toc-entry-98">5.4&nbsp;&nbsp;&nbsp;Single-User Mode</a></li>
<li><a class="reference internal" href="index.html#recovery-mode-ubuntu-specific" id="toc-entry-99">5.5&nbsp;&nbsp;&nbsp;Recovery Mode (U)</a></li>
<li><a class="reference internal" href="index.html#failsafe-mode-ubuntu-specific" id="toc-entry-100">5.6&nbsp;&nbsp;&nbsp;Failsafe Mode (U)</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#configuration" id="toc-entry-101">6&nbsp;&nbsp;&nbsp;Configuration</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#stanzas-by-category" id="toc-entry-102">6.1&nbsp;&nbsp;&nbsp;Stanzas by Category</a></li>
<li><a class="reference internal" href="index.html#apparmor" id="toc-entry-103">6.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">apparmor</tt></a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#apparmor-load" id="toc-entry-104">6.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">apparmor load</tt></a></li>
<li><a class="reference internal" href="index.html#apparmor-switch" id="toc-entry-105">6.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">apparmor switch</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#author" id="toc-entry-106">6.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">author</tt></a></li>
<li><a class="reference internal" href="index.html#cgroup" id="toc-entry-107">6.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">cgroup</tt></a></li>
<li><a class="reference internal" href="index.html#console" id="toc-entry-108">6.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">console</tt></a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#console-log" id="toc-entry-109">6.5.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">console log</tt></a></li>
<li><a class="reference internal" href="index.html#console-none" id="toc-entry-110">6.5.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">console none</tt></a></li>
<li><a class="reference internal" href="index.html#console-output" id="toc-entry-111">6.5.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">console output</tt></a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#example-of-console-output" id="toc-entry-112">6.5.3.1&nbsp;&nbsp;&nbsp;Example of <tt class="docutils literal">console output</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#console-owner" id="toc-entry-113">6.5.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">console owner</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#chdir" id="toc-entry-114">6.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">chdir</tt></a></li>
<li><a class="reference internal" href="index.html#chroot" id="toc-entry-115">6.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal">chroot</tt></a></li>
<li><a class="reference internal" href="index.html#description" id="toc-entry-116">6.8&nbsp;&nbsp;&nbsp;<tt class="docutils literal">description</tt></a></li>
<li><a class="reference internal" href="index.html#emits" id="toc-entry-117">6.9&nbsp;&nbsp;&nbsp;<tt class="docutils literal">emits</tt></a></li>
<li><a class="reference internal" href="index.html#end-script" id="toc-entry-118">6.10&nbsp;&nbsp;&nbsp;<tt class="docutils literal">end script</tt></a></li>
<li><a class="reference internal" href="index.html#env" id="toc-entry-119">6.11&nbsp;&nbsp;&nbsp;<tt class="docutils literal">env</tt></a></li>
<li><a class="reference internal" href="index.html#exec" id="toc-entry-120">6.12&nbsp;&nbsp;&nbsp;<tt class="docutils literal">exec</tt></a></li>
<li><a class="reference internal" href="index.html#expect" id="toc-entry-121">6.13&nbsp;&nbsp;&nbsp;<tt class="docutils literal">expect</tt></a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#expect-fork" id="toc-entry-122">6.13.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">expect fork</tt></a></li>
<li><a class="reference internal" href="index.html#expect-daemon" id="toc-entry-123">6.13.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">expect daemon</tt></a></li>
<li><a class="reference internal" href="index.html#expect-stop" id="toc-entry-124">6.13.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">expect stop</tt></a></li>
<li><a class="reference internal" href="index.html#how-to-establish-fork-count" id="toc-entry-125">6.13.4&nbsp;&nbsp;&nbsp;How to Establish Fork Count</a></li>
<li><a class="reference internal" href="index.html#implications-of-misspecifying-expect" id="toc-entry-126">6.13.5&nbsp;&nbsp;&nbsp;Implications of Misspecifying <tt class="docutils literal">expect</tt></a></li>
<li><a class="reference internal" href="index.html#recovery-on-misspecification-of-expect" id="toc-entry-127">6.13.6&nbsp;&nbsp;&nbsp;Recovery on Misspecification of <tt class="docutils literal">expect</tt></a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#when-start-hangs" id="toc-entry-128">6.13.6.1&nbsp;&nbsp;&nbsp;When <tt class="docutils literal">start</tt> hangs</a></li>
<li><a class="reference internal" href="index.html#when-wrong-pid-is-tracked" id="toc-entry-129">6.13.6.2&nbsp;&nbsp;&nbsp;When Wrong PID is Tracked</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="index.html#export" id="toc-entry-130">6.14&nbsp;&nbsp;&nbsp;<tt class="docutils literal">export</tt></a></li>
<li><a class="reference internal" href="index.html#instance" id="toc-entry-131">6.15&nbsp;&nbsp;&nbsp;<tt class="docutils literal">instance</tt></a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#a-simple-instance-example" id="toc-entry-132">6.15.1&nbsp;&nbsp;&nbsp;A Simple Instance Example</a></li>
<li><a class="reference internal" href="index.html#another-instance-example" id="toc-entry-133">6.15.2&nbsp;&nbsp;&nbsp;Another Instance Example</a></li>
<li><a class="reference internal" href="index.html#starting-an-instance-job-without-specifying-an-instance-value" id="toc-entry-134">6.15.3&nbsp;&nbsp;&nbsp;Starting an Instance Job Without Specifying an Instance Value</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#kill-signal" id="toc-entry-135">6.16&nbsp;&nbsp;&nbsp;<tt class="docutils literal">kill signal</tt></a></li>
<li><a class="reference internal" href="index.html#kill-timeout" id="toc-entry-136">6.17&nbsp;&nbsp;&nbsp;<tt class="docutils literal">kill timeout</tt></a></li>
<li><a class="reference internal" href="index.html#limit" id="toc-entry-137">6.18&nbsp;&nbsp;&nbsp;<tt class="docutils literal">limit</tt></a></li>
<li><a class="reference internal" href="index.html#manual" id="toc-entry-138">6.19&nbsp;&nbsp;&nbsp;<tt class="docutils literal">manual</tt></a></li>
<li><a class="reference internal" href="index.html#nice" id="toc-entry-139">6.20&nbsp;&nbsp;&nbsp;<tt class="docutils literal">nice</tt></a></li>
<li><a class="reference internal" href="index.html#normal-exit" id="toc-entry-140">6.21&nbsp;&nbsp;&nbsp;<tt class="docutils literal">normal exit</tt></a></li>
<li><a class="reference internal" href="index.html#oom-score" id="toc-entry-141">6.22&nbsp;&nbsp;&nbsp;<tt class="docutils literal">oom score</tt></a></li>
<li><a class="reference internal" href="index.html#post-start" id="toc-entry-142">6.23&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">post-start</span></tt></a></li>
<li><a class="reference internal" href="index.html#post-stop" id="toc-entry-143">6.24&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">post-stop</span></tt></a></li>
<li><a class="reference internal" href="index.html#pre-start" id="toc-entry-144">6.25&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">pre-start</span></tt></a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#pre-start-example-debian-and-ubuntu-specific" id="toc-entry-145">6.25.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">pre-start</span></tt> example (D , U)</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#pre-stop" id="toc-entry-146">6.26&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">pre-stop</span></tt></a></li>
<li><a class="reference internal" href="index.html#reload-signal" id="toc-entry-147">6.27&nbsp;&nbsp;&nbsp;<tt class="docutils literal">reload signal</tt></a></li>
<li><a class="reference internal" href="index.html#respawn" id="toc-entry-148">6.28&nbsp;&nbsp;&nbsp;<tt class="docutils literal">respawn</tt></a></li>
<li><a class="reference internal" href="index.html#respawn-limit" id="toc-entry-149">6.29&nbsp;&nbsp;&nbsp;<tt class="docutils literal">respawn limit</tt></a></li>
<li><a class="reference internal" href="index.html#script" id="toc-entry-150">6.30&nbsp;&nbsp;&nbsp;<tt class="docutils literal">script</tt></a></li>
<li><a class="reference internal" href="index.html#setgid" id="toc-entry-151">6.31&nbsp;&nbsp;&nbsp;<tt class="docutils literal">setgid</tt></a></li>
<li><a class="reference internal" href="index.html#setuid" id="toc-entry-152">6.32&nbsp;&nbsp;&nbsp;<tt class="docutils literal">setuid</tt></a></li>
<li><a class="reference internal" href="index.html#start-on" id="toc-entry-153">6.33&nbsp;&nbsp;&nbsp;<tt class="docutils literal">start on</tt></a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#normal-start" id="toc-entry-154">6.33.1&nbsp;&nbsp;&nbsp;Normal start</a></li>
<li><a class="reference internal" href="index.html#start-depends-on-another-service" id="toc-entry-155">6.33.2&nbsp;&nbsp;&nbsp;Start depends on another service</a></li>
<li><a class="reference internal" href="index.html#start-must-precede-another-service" id="toc-entry-156">6.33.3&nbsp;&nbsp;&nbsp;Start must precede another service</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#stop-on" id="toc-entry-157">6.34&nbsp;&nbsp;&nbsp;<tt class="docutils literal">stop on</tt></a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#normal-shutdown" id="toc-entry-158">6.34.1&nbsp;&nbsp;&nbsp;Normal shutdown</a></li>
<li><a class="reference internal" href="index.html#stop-before-depended-upon-service" id="toc-entry-159">6.34.2&nbsp;&nbsp;&nbsp;Stop before depended-upon service</a></li>
<li><a class="reference internal" href="index.html#stop-after-dependent-service" id="toc-entry-160">6.34.3&nbsp;&nbsp;&nbsp;Stop after dependent service</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#task" id="toc-entry-161">6.35&nbsp;&nbsp;&nbsp;<tt class="docutils literal">task</tt></a></li>
<li><a class="reference internal" href="index.html#umask" id="toc-entry-162">6.36&nbsp;&nbsp;&nbsp;<tt class="docutils literal">umask</tt></a></li>
<li><a class="reference internal" href="index.html#usage" id="toc-entry-163">6.37&nbsp;&nbsp;&nbsp;<tt class="docutils literal">usage</tt></a></li>
<li><a class="reference internal" href="index.html#version" id="toc-entry-164">6.38&nbsp;&nbsp;&nbsp;<tt class="docutils literal">version</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#command-line-options" id="toc-entry-165">7&nbsp;&nbsp;&nbsp;Command-Line Options</a></li>
<li><a class="reference internal" href="index.html#explanations" id="toc-entry-166">8&nbsp;&nbsp;&nbsp;Explanations</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#really-understanding-start-on-and-stop-on" id="toc-entry-167">8.1&nbsp;&nbsp;&nbsp;Really understanding <tt class="docutils literal">start on</tt> and <tt class="docutils literal">stop on</tt></a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#the-rc-job" id="toc-entry-168">8.1.1&nbsp;&nbsp;&nbsp;The <tt class="docutils literal">rc</tt> Job</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#environment-variables" id="toc-entry-169">8.2&nbsp;&nbsp;&nbsp;Environment Variables</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#restrictions" id="toc-entry-170">8.2.1&nbsp;&nbsp;&nbsp;Restrictions</a></li>
<li><a class="reference internal" href="index.html#standard-environment-variables" id="toc-entry-171">8.2.2&nbsp;&nbsp;&nbsp;Standard Environment Variables</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#job-with-multiple-duplicate-stanzas" id="toc-entry-172">8.3&nbsp;&nbsp;&nbsp;Job with Multiple Duplicate Stanzas</a></li>
<li><a class="reference internal" href="index.html#job-specifying-same-condition-in-start-on-on-stop-on" id="toc-entry-173">8.4&nbsp;&nbsp;&nbsp;Job Specifying Same Condition in <tt class="docutils literal">start on</tt> on <tt class="docutils literal">stop on</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#features" id="toc-entry-174">9&nbsp;&nbsp;&nbsp;Features</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#d-bus-service-activation" id="toc-entry-175">9.1&nbsp;&nbsp;&nbsp;D-Bus Service Activation</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#tools" id="toc-entry-176">10&nbsp;&nbsp;&nbsp;Tools</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#utilities" id="toc-entry-177">10.1&nbsp;&nbsp;&nbsp;Utilities</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#reload" id="toc-entry-178">10.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">reload</tt></a></li>
<li><a class="reference internal" href="index.html#restart" id="toc-entry-179">10.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">restart</tt></a></li>
<li><a class="reference internal" href="index.html#runlevel" id="toc-entry-180">10.1.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">runlevel</tt></a></li>
<li><a class="reference internal" href="index.html#start" id="toc-entry-181">10.1.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">start</tt></a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#attempting-to-start-an-already-running-job" id="toc-entry-182">10.1.4.1&nbsp;&nbsp;&nbsp;Attempting to Start an Already Running Job</a></li>
<li><a class="reference internal" href="index.html#attempting-to-start-a-job-that-requires-an-instance-variable" id="toc-entry-183">10.1.4.2&nbsp;&nbsp;&nbsp;Attempting to Start a Job that requires an Instance Variable</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#stop" id="toc-entry-184">10.1.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">stop</tt></a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#attempting-to-stop-an-already-stopped-job" id="toc-entry-185">10.1.5.1&nbsp;&nbsp;&nbsp;Attempting to Stop an Already Stopped Job</a></li>
<li><a class="reference internal" href="index.html#attempting-to-stop-a-job-that-requires-an-instance-variable" id="toc-entry-186">10.1.5.2&nbsp;&nbsp;&nbsp;Attempting to Stop a Job that requires an Instance Variable</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#initctl" id="toc-entry-187">10.1.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl</tt></a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#initctl-commands-summary" id="toc-entry-188">10.1.6.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl</tt> Commands Summary</a></li>
<li><a class="reference internal" href="index.html#initctl-check-config" id="toc-entry-189">10.1.6.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl <span class="pre">check-config</span></tt></a></li>
<li><a class="reference internal" href="index.html#initctl-emit" id="toc-entry-190">10.1.6.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl emit</tt></a></li>
<li><a class="reference internal" href="index.html#initctl-get-env" id="toc-entry-191">10.1.6.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl <span class="pre">get-env</span></tt></a></li>
<li><a class="reference internal" href="index.html#initctl-help" id="toc-entry-192">10.1.6.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl help</tt></a></li>
<li><a class="reference internal" href="index.html#initctl-list" id="toc-entry-193">10.1.6.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl list</tt></a></li>
<li><a class="reference internal" href="index.html#initctl-list-env" id="toc-entry-194">10.1.6.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl <span class="pre">list-env</span></tt></a></li>
<li><a class="reference internal" href="index.html#initctl-list-sessions" id="toc-entry-195">10.1.6.8&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl <span class="pre">list-sessions</span></tt></a></li>
<li><a class="reference internal" href="index.html#initctl-log-priority" id="toc-entry-196">10.1.6.9&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl <span class="pre">log-priority</span></tt></a></li>
<li><a class="reference internal" href="index.html#initctl-notify-cgroup-manager-address" id="toc-entry-197">10.1.6.10&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl <span class="pre">notify-cgroup-manager-address</span></tt></a></li>
<li><a class="reference internal" href="index.html#initctl-notify-disk-writeable" id="toc-entry-198">10.1.6.11&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl <span class="pre">notify-disk-writeable</span></tt></a></li>
<li><a class="reference internal" href="index.html#initctl-reload" id="toc-entry-199">10.1.6.12&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl reload</tt></a></li>
<li><a class="reference internal" href="index.html#initctl-reload-configuration" id="toc-entry-200">10.1.6.13&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl <span class="pre">reload-configuration</span></tt></a></li>
<li><a class="reference internal" href="index.html#initctl-reset-env" id="toc-entry-201">10.1.6.14&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl <span class="pre">reset-env</span></tt></a></li>
<li><a class="reference internal" href="index.html#initctl-restart" id="toc-entry-202">10.1.6.15&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl restart</tt></a></li>
<li><a class="reference internal" href="index.html#initctl-set-env" id="toc-entry-203">10.1.6.16&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl <span class="pre">set-env</span></tt></a></li>
<li><a class="reference internal" href="index.html#initctl-show-config" id="toc-entry-204">10.1.6.17&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl <span class="pre">show-config</span></tt></a></li>
<li><a class="reference internal" href="index.html#initctl-start" id="toc-entry-205">10.1.6.18&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl start</tt></a></li>
<li><a class="reference internal" href="index.html#initctl-status" id="toc-entry-206">10.1.6.19&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl status</tt></a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#single-job-instance-running-without-pid" id="toc-entry-207">10.1.6.19.1&nbsp;&nbsp;&nbsp;Single Job Instance Running without PID</a></li>
<li><a class="reference internal" href="index.html#single-job-instance-running-job-with-pid" id="toc-entry-208">10.1.6.19.2&nbsp;&nbsp;&nbsp;Single Job Instance Running Job with PID</a></li>
<li><a class="reference internal" href="index.html#single-job-instance-running-with-multiple-pids" id="toc-entry-209">10.1.6.19.3&nbsp;&nbsp;&nbsp;Single Job Instance Running with Multiple PIDs</a></li>
<li><a class="reference internal" href="index.html#multiple-running-job-instances-without-pid" id="toc-entry-210">10.1.6.19.4&nbsp;&nbsp;&nbsp;Multiple Running Job Instances Without PID</a></li>
<li><a class="reference internal" href="index.html#multiple-running-job-instances-with-pids" id="toc-entry-211">10.1.6.19.5&nbsp;&nbsp;&nbsp;Multiple Running Job Instances With PIDs</a></li>
<li><a class="reference internal" href="index.html#multiple-running-job-instances-with-multiple-pids" id="toc-entry-212">10.1.6.19.6&nbsp;&nbsp;&nbsp;Multiple Running Job Instances With Multiple PIDs</a></li>
<li><a class="reference internal" href="index.html#stopped-job" id="toc-entry-213">10.1.6.19.7&nbsp;&nbsp;&nbsp;Stopped Job</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#initctl-stop" id="toc-entry-214">10.1.6.20&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl stop</tt></a></li>
<li><a class="reference internal" href="index.html#initctl-unset-env" id="toc-entry-215">10.1.6.21&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl <span class="pre">unset-env</span></tt></a></li>
<li><a class="reference internal" href="index.html#initctl-usage" id="toc-entry-216">10.1.6.22&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl usage</tt></a></li>
<li><a class="reference internal" href="index.html#initctl-version" id="toc-entry-217">10.1.6.23&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl version</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#init-checkconf" id="toc-entry-218">10.1.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">init-checkconf</span></tt></a></li>
<li><a class="reference internal" href="index.html#upstart-monitor" id="toc-entry-219">10.1.8&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">upstart-monitor</span></tt></a></li>
<li><a class="reference internal" href="index.html#mountall-debian-and-ubuntu-specific" id="toc-entry-220">10.1.9&nbsp;&nbsp;&nbsp;<tt class="docutils literal">mountall</tt> (D , U)</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#mountall-events" id="toc-entry-221">10.1.9.1&nbsp;&nbsp;&nbsp;Mountall events</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#mounting" id="toc-entry-222">10.1.9.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">mounting</tt></a></li>
<li><a class="reference internal" href="index.html#mounted" id="toc-entry-223">10.1.9.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">mounted</tt></a></li>
<li><a class="reference internal" href="index.html#all-swaps" id="toc-entry-224">10.1.9.1.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">all-swaps</span></tt></a></li>
<li><a class="reference internal" href="index.html#filesystem" id="toc-entry-225">10.1.9.1.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">filesystem</tt></a></li>
<li><a class="reference internal" href="index.html#virtual-filesystems" id="toc-entry-226">10.1.9.1.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">virtual-filesystems</span></tt></a></li>
<li><a class="reference internal" href="index.html#local-filesystems" id="toc-entry-227">10.1.9.1.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">local-filesystems</span></tt></a></li>
<li><a class="reference internal" href="index.html#remote-filesystems" id="toc-entry-228">10.1.9.1.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">remote-filesystems</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#mountall-event-summary" id="toc-entry-229">10.1.9.2&nbsp;&nbsp;&nbsp;Mountall Event Summary</a></li>
<li><a class="reference internal" href="index.html#mountall-examples" id="toc-entry-230">10.1.9.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">mountall</tt> Examples</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="index.html#bridges" id="toc-entry-231">10.2&nbsp;&nbsp;&nbsp;Bridges</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#plymouth-upstart-bridge-ubuntu-specific" id="toc-entry-232">10.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">plymouth-upstart-bridge</span></tt> (U)</a></li>
<li><a class="reference internal" href="index.html#upstart-socket-bridge" id="toc-entry-233">10.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">upstart-socket-bridge</span></tt></a></li>
<li><a class="reference internal" href="index.html#upstart-udev-bridge" id="toc-entry-234">10.2.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">upstart-udev-bridge</span></tt></a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#careful-use-of-udev-events" id="toc-entry-235">10.2.3.1&nbsp;&nbsp;&nbsp;Careful Use of udev Events</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#upstart-event-bridge" id="toc-entry-236">10.2.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">upstart-event-bridge</span></tt></a></li>
<li><a class="reference internal" href="index.html#upstart-file-bridge" id="toc-entry-237">10.2.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">upstart-file-bridge</span></tt></a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#examples" id="toc-entry-238">10.2.5.1&nbsp;&nbsp;&nbsp;Examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#upstart-dbus-bridge" id="toc-entry-239">10.2.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">upstart-dbus-bridge</span></tt></a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#example" id="toc-entry-240">10.2.6.1&nbsp;&nbsp;&nbsp;Example</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#upstart-dconf-bridge" id="toc-entry-241">10.2.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">upstart-dconf-bridge</span></tt></a></li>
<li><a class="reference internal" href="index.html#upstart-local-bridge" id="toc-entry-242">10.2.8&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">upstart-local-bridge</span></tt></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="index.html#cookbook-and-best-practises" id="toc-entry-243">11&nbsp;&nbsp;&nbsp;Cookbook and Best Practises</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#list-all-jobs" id="toc-entry-244">11.1&nbsp;&nbsp;&nbsp;List All Jobs</a></li>
<li><a class="reference internal" href="index.html#list-all-jobs-with-no-stop-on-condition" id="toc-entry-245">11.2&nbsp;&nbsp;&nbsp;List All Jobs With No <tt class="docutils literal">stop on</tt> Condition</a></li>
<li><a class="reference internal" href="index.html#list-all-events-that-jobs-are-interested-in-on-your-system" id="toc-entry-246">11.3&nbsp;&nbsp;&nbsp;List All Events That Jobs Are Interested In On Your System</a></li>
<li><a class="reference internal" href="index.html#create-an-event" id="toc-entry-247">11.4&nbsp;&nbsp;&nbsp;Create an Event</a></li>
<li><a class="reference internal" href="index.html#create-an-event-alias" id="toc-entry-248">11.5&nbsp;&nbsp;&nbsp;Create an Event Alias</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#change-the-type-of-an-event" id="toc-entry-249">11.5.1&nbsp;&nbsp;&nbsp;Change the Type of an Event</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#synchronisation" id="toc-entry-250">11.6&nbsp;&nbsp;&nbsp;Synchronisation</a></li>
<li><a class="reference internal" href="index.html#determine-if-job-was-started-by-an-event-or-by-start" id="toc-entry-251">11.7&nbsp;&nbsp;&nbsp;Determine if Job was Started by an Event or by "<tt class="docutils literal">start</tt>"</a></li>
<li><a class="reference internal" href="index.html#stop-a-job-from-running-if-a-pre-start-condition-fails" id="toc-entry-252">11.8&nbsp;&nbsp;&nbsp;Stop a Job from Running if A <tt class="docutils literal"><span class="pre">pre-start</span></tt> Condition Fails</a></li>
<li><a class="reference internal" href="index.html#run-a-job-only-when-an-event-variable-matches-some-value" id="toc-entry-253">11.9&nbsp;&nbsp;&nbsp;Run a Job Only When an Event Variable Matches Some Value</a></li>
<li><a class="reference internal" href="index.html#run-a-job-when-an-event-variable-does-not-match-some-value" id="toc-entry-254">11.10&nbsp;&nbsp;&nbsp;Run a Job when an Event Variable Does Not Match Some Value</a></li>
<li><a class="reference internal" href="index.html#run-a-job-as-soon-as-possible-after-boot" id="toc-entry-255">11.11&nbsp;&nbsp;&nbsp;Run a Job as Soon as Possible After Boot</a></li>
<li><a class="reference internal" href="index.html#run-a-job-when-a-user-logs-in-graphically-ubuntu-specific" id="toc-entry-256">11.12&nbsp;&nbsp;&nbsp;Run a Job When a User Logs in Graphically (U)</a></li>
<li><a class="reference internal" href="index.html#run-a-job-when-a-user-logs-in" id="toc-entry-257">11.13&nbsp;&nbsp;&nbsp;Run a Job When a User Logs in</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#environment" id="toc-entry-258">11.13.1&nbsp;&nbsp;&nbsp;Environment</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#run-a-job-for-all-of-a-number-of-conditions" id="toc-entry-259">11.14&nbsp;&nbsp;&nbsp;Run a Job For All of a Number of Conditions</a></li>
<li><a class="reference internal" href="index.html#run-a-job-before-another-job" id="toc-entry-260">11.15&nbsp;&nbsp;&nbsp;Run a Job Before Another Job</a></li>
<li><a class="reference internal" href="index.html#run-a-job-after-another-job" id="toc-entry-261">11.16&nbsp;&nbsp;&nbsp;Run a Job After Another Job</a></li>
<li><a class="reference internal" href="index.html#run-a-job-once-after-some-other-job-ends" id="toc-entry-262">11.17&nbsp;&nbsp;&nbsp;Run a Job Once After Some Other Job Ends</a></li>
<li><a class="reference internal" href="index.html#run-a-job-before-another-job-and-stop-it-after-that-job-stops" id="toc-entry-263">11.18&nbsp;&nbsp;&nbsp;Run a Job Before Another Job and Stop it After that Job Stops</a></li>
<li><a class="reference internal" href="index.html#run-a-job-only-if-another-job-succeeds" id="toc-entry-264">11.19&nbsp;&nbsp;&nbsp;Run a Job Only If Another Job Succeeds</a></li>
<li><a class="reference internal" href="index.html#run-a-job-only-if-another-job-fails" id="toc-entry-265">11.20&nbsp;&nbsp;&nbsp;Run a Job Only If Another Job Fails</a></li>
<li><a class="reference internal" href="index.html#run-a-job-only-if-one-job-succeeds-and-another-fails" id="toc-entry-266">11.21&nbsp;&nbsp;&nbsp;Run a Job Only If One Job Succeeds and Another Fails</a></li>
<li><a class="reference internal" href="index.html#run-a-job-if-another-job-exits-with-a-particular-exit-code" id="toc-entry-267">11.22&nbsp;&nbsp;&nbsp;Run a Job If Another Job Exits with a particular Exit Code</a></li>
<li><a class="reference internal" href="index.html#detect-if-any-job-fails" id="toc-entry-268">11.23&nbsp;&nbsp;&nbsp;Detect if Any Job Fails</a></li>
<li><a class="reference internal" href="index.html#use-details-of-a-failed-job-from-another-job" id="toc-entry-269">11.24&nbsp;&nbsp;&nbsp;Use Details of a Failed Job from Another Job</a></li>
<li><a class="reference internal" href="index.html#stop-a-job-when-another-job-starts" id="toc-entry-270">11.25&nbsp;&nbsp;&nbsp;Stop a Job when Another Job Starts</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#simple-mutual-exclusion" id="toc-entry-271">11.25.1&nbsp;&nbsp;&nbsp;Simple Mutual Exclusion</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#run-a-job-periodically" id="toc-entry-272">11.26&nbsp;&nbsp;&nbsp;Run a Job Periodically</a></li>
<li><a class="reference internal" href="index.html#restart-a-job-on-a-particular-event" id="toc-entry-273">11.27&nbsp;&nbsp;&nbsp;Restart a job on a Particular Event</a></li>
<li><a class="reference internal" href="index.html#migration-from-system-v-initialization-scripts" id="toc-entry-274">11.28&nbsp;&nbsp;&nbsp;Migration from System V initialization scripts</a></li>
<li><a class="reference internal" href="index.html#how-to-establish-a-jobs-start-on-and-stop-on-conditions" id="toc-entry-275">11.29&nbsp;&nbsp;&nbsp;How to Establish a Jobs <tt class="docutils literal">start on</tt> and <tt class="docutils literal">stop on</tt> Conditions</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#determining-the-start-on-condition-debian-and-ubuntu-specific" id="toc-entry-276">11.29.1&nbsp;&nbsp;&nbsp;Determining the <tt class="docutils literal">start on</tt> Condition (D , U)</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#standard-idioms" id="toc-entry-277">11.29.1.1&nbsp;&nbsp;&nbsp;Standard Idioms</a></li>
<li><a class="reference internal" href="index.html#more-exotic-start-on-conditions" id="toc-entry-278">11.29.1.2&nbsp;&nbsp;&nbsp;More Exotic start on Conditions</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#udev-conditions" id="toc-entry-279">11.29.1.2.1&nbsp;&nbsp;&nbsp;udev conditions</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="index.html#determining-the-stop-on-condition-ubuntu-specific" id="toc-entry-280">11.29.2&nbsp;&nbsp;&nbsp;Determining the <tt class="docutils literal">stop on</tt> Condition (U)</a></li>
<li><a class="reference internal" href="index.html#final-words-of-advice" id="toc-entry-281">11.29.3&nbsp;&nbsp;&nbsp;Final Words of Advice</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#guarantee-that-a-job-will-only-run-once" id="toc-entry-282">11.30&nbsp;&nbsp;&nbsp;Guarantee that a job will only run once</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#method-1" id="toc-entry-283">11.30.1&nbsp;&nbsp;&nbsp;Method 1</a></li>
<li><a class="reference internal" href="index.html#method-2" id="toc-entry-284">11.30.2&nbsp;&nbsp;&nbsp;Method 2</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#stop-a-job-that-is-about-to-start" id="toc-entry-285">11.31&nbsp;&nbsp;&nbsp;Stop a Job That is About to Start</a></li>
<li><a class="reference internal" href="index.html#stop-a-job-that-is-about-to-start-from-within-that-job" id="toc-entry-286">11.32&nbsp;&nbsp;&nbsp;Stop a Job That is About to Start From Within That Job</a></li>
<li><a class="reference internal" href="index.html#stop-a-job-from-running-if-its-configuration-file-has-not-been-created-modified" id="toc-entry-287">11.33&nbsp;&nbsp;&nbsp;Stop a Job from Running if its Configuration file has not been Created/Modified</a></li>
<li><a class="reference internal" href="index.html#stop-a-job-when-some-other-job-is-about-to-start" id="toc-entry-288">11.34&nbsp;&nbsp;&nbsp;Stop a Job When Some Other Job is about to Start</a></li>
<li><a class="reference internal" href="index.html#start-a-job-when-a-particular-filesystem-is-about-to-be-mounted" id="toc-entry-289">11.35&nbsp;&nbsp;&nbsp;Start a Job when a Particular Filesystem is About to be Mounted</a></li>
<li><a class="reference internal" href="index.html#start-a-job-when-a-device-is-hot-plugged" id="toc-entry-290">11.36&nbsp;&nbsp;&nbsp;Start a Job when a Device is Hot-Plugged</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#to-start-a-job-when-eth0-is-added-to-the-system" id="toc-entry-291">11.36.1&nbsp;&nbsp;&nbsp;To start a job when eth0 is <em>added to the system</em></a></li>
<li><a class="reference internal" href="index.html#to-start-a-job-when-eth0-is-available" id="toc-entry-292">11.36.2&nbsp;&nbsp;&nbsp;To start a job when eth0 is <em>available</em></a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#stopping-a-job-if-it-runs-for-too-long" id="toc-entry-293">11.37&nbsp;&nbsp;&nbsp;Stopping a Job if it Runs for Too Long</a></li>
<li><a class="reference internal" href="index.html#run-a-job-when-a-file-or-directory-is-created-deleted" id="toc-entry-294">11.38&nbsp;&nbsp;&nbsp;Run a Job When a File or Directory is Created/Deleted</a></li>
<li><a class="reference internal" href="index.html#run-a-job-each-time-a-condition-is-true" id="toc-entry-295">11.39&nbsp;&nbsp;&nbsp;Run a Job Each Time a Condition is True</a></li>
<li><a class="reference internal" href="index.html#run-a-job-when-a-particular-runlevel-is-entered-and-left" id="toc-entry-296">11.40&nbsp;&nbsp;&nbsp;Run a Job When a Particular Runlevel is Entered and Left</a></li>
<li><a class="reference internal" href="index.html#pass-state-between-job-processes" id="toc-entry-297">11.41&nbsp;&nbsp;&nbsp;Pass State Between Job Processes</a></li>
<li><a class="reference internal" href="index.html#pass-state-from-job-configuration-file-to-a-script-section" id="toc-entry-298">11.42&nbsp;&nbsp;&nbsp;Pass State From Job Configuration File to a Script Section</a></li>
<li><a class="reference internal" href="index.html#run-a-job-as-a-different-user" id="toc-entry-299">11.43&nbsp;&nbsp;&nbsp;Run a Job as a Different User</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#running-a-user-job" id="toc-entry-300">11.43.1&nbsp;&nbsp;&nbsp;Running a User Job</a></li>
<li><a class="reference internal" href="index.html#changing-user" id="toc-entry-301">11.43.2&nbsp;&nbsp;&nbsp;Changing User</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#disabling-a-job-from-automatically-starting" id="toc-entry-302">11.44&nbsp;&nbsp;&nbsp;Disabling a Job from Automatically Starting</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#override-files" id="toc-entry-303">11.44.1&nbsp;&nbsp;&nbsp;Override Files</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#change-a-jobs-start-stop-conditions" id="toc-entry-304">11.44.1.1&nbsp;&nbsp;&nbsp;Change a Jobs Start/Stop Conditions</a></li>
<li><a class="reference internal" href="index.html#adding-stanzas-that-are-not-present-in-the-conf-file" id="toc-entry-305">11.44.1.2&nbsp;&nbsp;&nbsp;Adding Stanzas that are Not Present in the .conf File</a></li>
<li><a class="reference internal" href="index.html#separating-variables-from-the-job" id="toc-entry-306">11.44.1.3&nbsp;&nbsp;&nbsp;Separating Variables from the Job</a></li>
<li><a class="reference internal" href="index.html#ensuring-customized-packages-upgrade-smoothly" id="toc-entry-307">11.44.1.4&nbsp;&nbsp;&nbsp;Ensuring Customized Packages Upgrade Smoothly</a></li>
<li><a class="reference internal" href="index.html#caveat-emptor" id="toc-entry-308">11.44.1.5&nbsp;&nbsp;&nbsp;Caveat Emptor</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="index.html#jobs-that-run-forever" id="toc-entry-309">11.45&nbsp;&nbsp;&nbsp;Jobs that "Run Forever"</a></li>
<li><a class="reference internal" href="index.html#run-a-java-application" id="toc-entry-310">11.46&nbsp;&nbsp;&nbsp;Run a Java Application</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#alternative-method" id="toc-entry-311">11.46.1&nbsp;&nbsp;&nbsp;Alternative Method</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#ensure-a-directory-exists-before-starting-a-job" id="toc-entry-312">11.47&nbsp;&nbsp;&nbsp;Ensure a Directory Exists Before Starting a Job</a></li>
<li><a class="reference internal" href="index.html#run-a-gui-application" id="toc-entry-313">11.48&nbsp;&nbsp;&nbsp;Run a GUI Application</a></li>
<li><a class="reference internal" href="index.html#run-an-application-through-gnu-screen" id="toc-entry-314">11.49&nbsp;&nbsp;&nbsp;Run an Application through GNU Screen</a></li>
<li><a class="reference internal" href="index.html#run-upstart-in-a-chroot-environment" id="toc-entry-315">11.50&nbsp;&nbsp;&nbsp;Run Upstart in a chroot Environment</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#chroot-workaround-for-older-versions-of-upstart-debian-and-ubuntu-specific" id="toc-entry-316">11.50.1&nbsp;&nbsp;&nbsp;chroot Workaround for Older Versions of Upstart (D , U)</a></li>
<li><a class="reference internal" href="index.html#chroots-in-ubuntu-natty-ubuntu-specific" id="toc-entry-317">11.50.2&nbsp;&nbsp;&nbsp;chroots in Ubuntu Natty (U)</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#record-all-jobs-and-events-which-emit-an-event" id="toc-entry-318">11.51&nbsp;&nbsp;&nbsp;Record all Jobs and Events which Emit an Event</a></li>
<li><a class="reference internal" href="index.html#integrating-your-new-application-with-upstart" id="toc-entry-319">11.52&nbsp;&nbsp;&nbsp;Integrating your New Application with Upstart</a></li>
<li><a class="reference internal" href="index.html#block-another-job-until-yours-has-started" id="toc-entry-320">11.53&nbsp;&nbsp;&nbsp;Block Another Job Until Yours has Started</a></li>
<li><a class="reference internal" href="index.html#controlling-upstart-using-d-bus" id="toc-entry-321">11.54&nbsp;&nbsp;&nbsp;Controlling Upstart using D-Bus</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#query-version-of-upstart" id="toc-entry-322">11.54.1&nbsp;&nbsp;&nbsp;Query Version of Upstart</a></li>
<li><a class="reference internal" href="index.html#query-log-priority" id="toc-entry-323">11.54.2&nbsp;&nbsp;&nbsp;Query Log Priority</a></li>
<li><a class="reference internal" href="index.html#set-log-priority" id="toc-entry-324">11.54.3&nbsp;&nbsp;&nbsp;Set Log Priority</a></li>
<li><a class="reference internal" href="index.html#list-all-jobs-via-d-bus" id="toc-entry-325">11.54.4&nbsp;&nbsp;&nbsp;List all Jobs via D-Bus</a></li>
<li><a class="reference internal" href="index.html#get-status-of-job-via-d-bus" id="toc-entry-326">11.54.5&nbsp;&nbsp;&nbsp;Get Status of Job via D-Bus</a></li>
<li><a class="reference internal" href="index.html#emit-an-event" id="toc-entry-327">11.54.6&nbsp;&nbsp;&nbsp;Emit an Event</a></li>
<li><a class="reference internal" href="index.html#get-jobs-start-on-and-stop-on-conditions-via-d-bus" id="toc-entry-328">11.54.7&nbsp;&nbsp;&nbsp;Get Jobs start on and stop on Conditions via D-Bus</a></li>
<li><a class="reference internal" href="index.html#to-start-a-job-via-d-bus" id="toc-entry-329">11.54.8&nbsp;&nbsp;&nbsp;To Start a Job via D-Bus</a></li>
<li><a class="reference internal" href="index.html#to-stop-a-job-via-d-bus" id="toc-entry-330">11.54.9&nbsp;&nbsp;&nbsp;To Stop a Job via D-Bus</a></li>
<li><a class="reference internal" href="index.html#to-restart-a-job-via-d-bus" id="toc-entry-331">11.54.10&nbsp;&nbsp;&nbsp;To Restart a Job via D-Bus</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#establish-blocking-job" id="toc-entry-332">11.55&nbsp;&nbsp;&nbsp;Establish Blocking Job</a></li>
<li><a class="reference internal" href="index.html#determine-if-a-job-is-disabled" id="toc-entry-333">11.56&nbsp;&nbsp;&nbsp;Determine if a Job is Disabled</a></li>
<li><a class="reference internal" href="index.html#visualising-jobs-and-events" id="toc-entry-334">11.57&nbsp;&nbsp;&nbsp;Visualising Jobs and Events</a></li>
<li><a class="reference internal" href="index.html#sourcing-files" id="toc-entry-335">11.58&nbsp;&nbsp;&nbsp;Sourcing Files</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#develop-scripts-using-bin-sh" id="toc-entry-336">11.58.1&nbsp;&nbsp;&nbsp;Develop Scripts Using <tt class="docutils literal">/bin/sh</tt></a></li>
<li><a class="reference internal" href="index.html#ureadahead" id="toc-entry-337">11.58.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">ureadahead</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#determining-how-to-stop-a-job-with-multiple-running-instances" id="toc-entry-338">11.59&nbsp;&nbsp;&nbsp;Determining How to Stop a Job with Multiple Running Instances</a></li>
<li><a class="reference internal" href="index.html#logging-boot-and-shutdown-times" id="toc-entry-339">11.60&nbsp;&nbsp;&nbsp;Logging Boot and Shutdown Times</a></li>
<li><a class="reference internal" href="index.html#running-an-alternative-job-on-a-tty" id="toc-entry-340">11.61&nbsp;&nbsp;&nbsp;Running an Alternative Job on a tty</a></li>
<li><a class="reference internal" href="index.html#delay-respawn-of-a-job" id="toc-entry-341">11.62&nbsp;&nbsp;&nbsp;Delay Respawn of a Job</a></li>
<li><a class="reference internal" href="index.html#allow-a-job-to-detect-if-it-was-stopped-manually" id="toc-entry-342">11.63&nbsp;&nbsp;&nbsp;Allow a job to detect if it was stopped manually</a></li>
<li><a class="reference internal" href="index.html#detect-if-a-job-stopped-before-reaching-its-respawn-limit" id="toc-entry-343">11.64&nbsp;&nbsp;&nbsp;Detect if a job stopped before reaching its respawn limit</a></li>
<li><a class="reference internal" href="index.html#detecting-a-job-respawning" id="toc-entry-344">11.65&nbsp;&nbsp;&nbsp;Detecting a job respawning</a></li>
<li><a class="reference internal" href="index.html#detecting-a-job-hitting-its-respawn-limit" id="toc-entry-345">11.66&nbsp;&nbsp;&nbsp;Detecting a job hitting its respawn limit</a></li>
<li><a class="reference internal" href="index.html#identifying-jobs-that-may-need-a-respawn-stanza" id="toc-entry-346">11.67&nbsp;&nbsp;&nbsp;Identifying jobs that may need a respawn stanza</a></li>
<li><a class="reference internal" href="index.html#creating-a-systemv-service-that-communicates-with-upstart-ubuntu-specific" id="toc-entry-347">11.68&nbsp;&nbsp;&nbsp;Creating a SystemV Service that Communicates with Upstart U</a></li>
<li><a class="reference internal" href="index.html#running-a-job-in-a-cgroup-ubuntu-specific" id="toc-entry-348">11.69&nbsp;&nbsp;&nbsp;Running a job in a cgroup U</a></li>
<li><a class="reference internal" href="index.html#making-a-job-respawn-indefinitely" id="toc-entry-349">11.70&nbsp;&nbsp;&nbsp;Making a job respawn indefinitely</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#test-your-knowledge" id="toc-entry-350">12&nbsp;&nbsp;&nbsp;Test Your Knowledge</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#questions-about-start-on" id="toc-entry-351">12.1&nbsp;&nbsp;&nbsp;Questions about <cite>start on</cite></a></li>
<li><a class="reference internal" href="index.html#general-questions" id="toc-entry-352">12.2&nbsp;&nbsp;&nbsp;General Questions</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#common-problems" id="toc-entry-353">13&nbsp;&nbsp;&nbsp;Common Problems</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#cannot-start-a-job" id="toc-entry-354">13.1&nbsp;&nbsp;&nbsp;Cannot Start a Job</a></li>
<li><a class="reference internal" href="index.html#cannot-stop-a-job" id="toc-entry-355">13.2&nbsp;&nbsp;&nbsp;Cannot stop a job</a></li>
<li><a class="reference internal" href="index.html#strange-error-when-running-start-stop-restart-or-initctl-emit" id="toc-entry-356">13.3&nbsp;&nbsp;&nbsp;Strange Error When Running <tt class="docutils literal">start</tt>/<tt class="docutils literal">stop</tt>/<tt class="docutils literal">restart</tt> or <tt class="docutils literal">initctl emit</tt></a></li>
<li><a class="reference internal" href="index.html#the-initctl-command-shows-the-wrong-pid" id="toc-entry-357">13.4&nbsp;&nbsp;&nbsp;The <tt class="docutils literal">initctl</tt> command shows "the wrong PID"</a></li>
<li><a class="reference internal" href="index.html#symbolic-links-don-t-work-in-etc-init" id="toc-entry-358">13.5&nbsp;&nbsp;&nbsp;Symbolic Links don't work in <tt class="docutils literal">/etc/init</tt></a></li>
<li><a class="reference internal" href="index.html#sometimes-status-shows-pid-but-other-times-does-not" id="toc-entry-359">13.6&nbsp;&nbsp;&nbsp;Sometimes <tt class="docutils literal">status</tt> shows PID, but other times does not</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#upstart-in-debian-and-ubuntu-debian-and-ubuntu-specific" id="toc-entry-360">14&nbsp;&nbsp;&nbsp;Upstart in Debian and Ubuntu (D , U)</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#packaging" id="toc-entry-361">14.1&nbsp;&nbsp;&nbsp;Packaging</a></li>
<li><a class="reference internal" href="index.html#system-v-compatibility-link-debian-and-ubuntu-specific" id="toc-entry-362">14.2&nbsp;&nbsp;&nbsp;System V Compatibility Link (D , U)</a></li>
<li><a class="reference internal" href="index.html#fun-with-job-files-debian-and-ubuntu-specific" id="toc-entry-363">14.3&nbsp;&nbsp;&nbsp;Fun with Job Files (D , U)</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#identify-missing-system-jobs-debian-and-ubuntu-specific" id="toc-entry-364">14.3.1&nbsp;&nbsp;&nbsp;Identify Missing System Jobs (D , U)</a></li>
<li><a class="reference internal" href="index.html#identify-modified-system-jobs-debian-and-ubuntu-specific" id="toc-entry-365">14.3.2&nbsp;&nbsp;&nbsp;Identify Modified System Jobs (D , U)</a></li>
<li><a class="reference internal" href="index.html#identify-non-packaged-system-jobs-debian-and-ubuntu-specific" id="toc-entry-366">14.3.3&nbsp;&nbsp;&nbsp;Identify Non-Packaged System Jobs (D , U)</a></li>
<li><a class="reference internal" href="index.html#re-install-all-packages-with-missing-or-modified-system-job-files-debian-and-ubuntu-specific" id="toc-entry-367">14.3.4&nbsp;&nbsp;&nbsp;Re-install all Packages with Missing or Modified System Job Files (D , U)</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="index.html#testing" id="toc-entry-368">15&nbsp;&nbsp;&nbsp;Testing</a></li>
<li><a class="reference internal" href="index.html#daemon-behaviour" id="toc-entry-369">16&nbsp;&nbsp;&nbsp;Daemon Behaviour</a></li>
<li><a class="reference internal" href="index.html#precepts-for-creating-a-job-configuration-file" id="toc-entry-370">17&nbsp;&nbsp;&nbsp;Precepts for Creating a Job Configuration File</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#determining-the-value-of-expect" id="toc-entry-371">17.1&nbsp;&nbsp;&nbsp;Determining the value of <tt class="docutils literal">expect</tt></a></li>
<li><a class="reference internal" href="index.html#start-on-and-stop-on-condition" id="toc-entry-372">17.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">start on</tt> and <tt class="docutils literal">stop on</tt> condition</a></li>
<li><a class="reference internal" href="index.html#services" id="toc-entry-373">17.3&nbsp;&nbsp;&nbsp;Services</a></li>
<li><a class="reference internal" href="index.html#ubuntu-rules-ubuntu-specific" id="toc-entry-374">17.4&nbsp;&nbsp;&nbsp;Ubuntu Rules (U)</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#console-attributes" id="toc-entry-375">17.4.1&nbsp;&nbsp;&nbsp;Console attributes</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="index.html#debugging" id="toc-entry-376">18&nbsp;&nbsp;&nbsp;Debugging</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#obtaining-a-list-of-events" id="toc-entry-377">18.1&nbsp;&nbsp;&nbsp;Obtaining a List of Events</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#add-verbose-or-debug-to-the-kernel-command-line" id="toc-entry-378">18.1.1&nbsp;&nbsp;&nbsp;Add <tt class="docutils literal"><span class="pre">--verbose</span></tt> or <tt class="docutils literal"><span class="pre">--debug</span></tt> to the kernel command-line</a></li>
<li><a class="reference internal" href="index.html#change-the-log-priority" id="toc-entry-379">18.1.2&nbsp;&nbsp;&nbsp;Change the log-priority</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#see-the-environment-a-job-runs-in" id="toc-entry-380">18.2&nbsp;&nbsp;&nbsp;See the Environment a Job Runs In</a></li>
<li><a class="reference internal" href="index.html#checking-how-a-service-might-react-when-run-as-a-job" id="toc-entry-381">18.3&nbsp;&nbsp;&nbsp;Checking How a Service Might React When Run as a Job</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#determining-why-your-service-fails-to-start" id="toc-entry-382">18.3.1&nbsp;&nbsp;&nbsp;Determining why your Service Fails to Start</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#obtaining-a-log-of-a-script-section" id="toc-entry-383">18.4&nbsp;&nbsp;&nbsp;Obtaining a log of a Script Section</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#upstart-1-4-and-above" id="toc-entry-384">18.4.1&nbsp;&nbsp;&nbsp;Upstart 1.4 (and above)</a></li>
<li><a class="reference internal" href="index.html#versions-of-upstart-older-than-1-4" id="toc-entry-385">18.4.2&nbsp;&nbsp;&nbsp;Versions of Upstart older than 1.4</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#log-script-section-output-to-syslog" id="toc-entry-386">18.5&nbsp;&nbsp;&nbsp;Log Script Section Output to Syslog</a></li>
<li><a class="reference internal" href="index.html#checking-a-job-configuration-file-for-syntax-errors" id="toc-entry-387">18.6&nbsp;&nbsp;&nbsp;Checking a Job Configuration File for Syntax Errors</a></li>
<li><a class="reference internal" href="index.html#check-a-script-section-for-errors" id="toc-entry-388">18.7&nbsp;&nbsp;&nbsp;Check a Script Section for Errors</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#older-versions-of-upstart" id="toc-entry-389">18.7.1&nbsp;&nbsp;&nbsp;Older versions of Upstart</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#debugging-a-script-which-appears-to-be-behaving-oddly" id="toc-entry-390">18.8&nbsp;&nbsp;&nbsp;Debugging a Script Which Appears to be Behaving Oddly</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#recovery" id="toc-entry-391">19&nbsp;&nbsp;&nbsp;Recovery</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#boot-into-recovery-mode" id="toc-entry-392">19.1&nbsp;&nbsp;&nbsp;Boot into Recovery Mode</a></li>
<li><a class="reference internal" href="index.html#boot-to-a-shell-directly" id="toc-entry-393">19.2&nbsp;&nbsp;&nbsp;Boot to a shell directly</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#advanced-topics" id="toc-entry-394">20&nbsp;&nbsp;&nbsp;Advanced Topics</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#changing-the-default-shell" id="toc-entry-395">20.1&nbsp;&nbsp;&nbsp;Changing the Default Shell</a></li>
<li><a class="reference internal" href="index.html#running-a-script-section-with-python" id="toc-entry-396">20.2&nbsp;&nbsp;&nbsp;Running a script Section with Python</a></li>
<li><a class="reference internal" href="index.html#running-a-script-section-with-perl" id="toc-entry-397">20.3&nbsp;&nbsp;&nbsp;Running a script Section with Perl</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#development-and-testing" id="toc-entry-398">21&nbsp;&nbsp;&nbsp;Development and Testing</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#warnings" id="toc-entry-399">21.1&nbsp;&nbsp;&nbsp;Warnings</a></li>
<li><a class="reference internal" href="index.html#precautions-and-practises" id="toc-entry-400">21.2&nbsp;&nbsp;&nbsp;Precautions and Practises</a></li>
<li><a class="reference internal" href="index.html#code-style" id="toc-entry-401">21.3&nbsp;&nbsp;&nbsp;Code Style</a></li>
<li><a class="reference internal" href="index.html#development-advice" id="toc-entry-402">21.4&nbsp;&nbsp;&nbsp;Development Advice</a></li>
<li><a class="reference internal" href="index.html#setting-up-an-upstart-development-environment" id="toc-entry-403">21.5&nbsp;&nbsp;&nbsp;Setting up an Upstart Development Environment</a></li>
<li><a class="reference internal" href="index.html#setting-up-an-upstart-nih-development-environment" id="toc-entry-404">21.6&nbsp;&nbsp;&nbsp;Setting up an Upstart+NIH Development Environment</a></li>
<li><a class="reference internal" href="index.html#upstart-objects" id="toc-entry-405">21.7&nbsp;&nbsp;&nbsp;Upstart Objects</a></li>
<li><a class="reference internal" href="index.html#unit-tests" id="toc-entry-406">21.8&nbsp;&nbsp;&nbsp;Unit Tests</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#building-within-a-chroot" id="toc-entry-407">21.8.1&nbsp;&nbsp;&nbsp;Building Within a Chroot</a></li>
<li><a class="reference internal" href="index.html#statistics" id="toc-entry-408">21.8.2&nbsp;&nbsp;&nbsp;Statistics</a></li>
<li><a class="reference internal" href="index.html#test-coverage" id="toc-entry-409">21.8.3&nbsp;&nbsp;&nbsp;Test Coverage</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#enable-full-compiler-warnings" id="toc-entry-410">21.9&nbsp;&nbsp;&nbsp;Enable Full Compiler Warnings</a></li>
<li><a class="reference internal" href="index.html#running-upstart-as-a-non-privileged-user" id="toc-entry-411">21.10&nbsp;&nbsp;&nbsp;Running Upstart as a Non-Privileged User</a></li>
<li><a class="reference internal" href="index.html#useful-tools-for-debugging-with-d-bus" id="toc-entry-412">21.11&nbsp;&nbsp;&nbsp;Useful tools for Debugging with D-Bus</a></li>
<li><a class="reference internal" href="index.html#debugging-a-job" id="toc-entry-413">21.12&nbsp;&nbsp;&nbsp;Debugging a Job</a></li>
<li><a class="reference internal" href="index.html#debugging-another-instance-of-upstart-running-as-root-with-pid-1" id="toc-entry-414">21.13&nbsp;&nbsp;&nbsp;Debugging Another Instance of Upstart Running as root with PID 1</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#method-1-crazy" id="toc-entry-415">21.13.1&nbsp;&nbsp;&nbsp;Method 1 (crazy)</a></li>
<li><a class="reference internal" href="index.html#method-2-saner" id="toc-entry-416">21.13.2&nbsp;&nbsp;&nbsp;Method 2 (saner)</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#nih" id="toc-entry-417">21.14&nbsp;&nbsp;&nbsp;NIH</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#memory-handling" id="toc-entry-418">21.14.1&nbsp;&nbsp;&nbsp;Memory Handling</a></li>
<li><a class="reference internal" href="index.html#the-nih-parent-pointer" id="toc-entry-419">21.14.2&nbsp;&nbsp;&nbsp;The NIH Parent Pointer</a></li>
<li><a class="reference internal" href="index.html#nih-free" id="toc-entry-420">21.14.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">nih_free()</tt></a></li>
<li><a class="reference internal" href="index.html#nih-must" id="toc-entry-421">21.14.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">NIH_MUST()</tt></a></li>
<li><a class="reference internal" href="index.html#error-handling" id="toc-entry-422">21.14.5&nbsp;&nbsp;&nbsp;Error Handling</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#impact-of-ignoring-a-raised-error" id="toc-entry-423">21.14.5.1&nbsp;&nbsp;&nbsp;Impact of Ignoring a Raised Error</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#output" id="toc-entry-424">21.14.6&nbsp;&nbsp;&nbsp;Output</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#creating-a-new-object" id="toc-entry-425">21.15&nbsp;&nbsp;&nbsp;Creating a New Object</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#template-for-a-new-foo" id="toc-entry-426">21.15.1&nbsp;&nbsp;&nbsp;Template for a new "foo"</a></li>
<li><a class="reference internal" href="index.html#basic-test-example-for-a-new-foo" id="toc-entry-427">21.15.2&nbsp;&nbsp;&nbsp;Basic Test Example for a New "foo"</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#adding-a-new-initctl-command" id="toc-entry-428">21.16&nbsp;&nbsp;&nbsp;Adding a new <tt class="docutils literal">initctl</tt> command</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#adding-a-new-non-job-command" id="toc-entry-429">21.16.1&nbsp;&nbsp;&nbsp;Adding a New non-Job Command</a></li>
<li><a class="reference internal" href="index.html#adding-a-new-job-class-command" id="toc-entry-430">21.16.2&nbsp;&nbsp;&nbsp;Adding a New Job Class Command</a></li>
<li><a class="reference internal" href="index.html#adding-a-new-job-command" id="toc-entry-431">21.16.3&nbsp;&nbsp;&nbsp;Adding a New Job Command</a></li>
<li><a class="reference internal" href="index.html#generating-the-d-bus-bindings" id="toc-entry-432">21.16.4&nbsp;&nbsp;&nbsp;Generating the D-Bus Bindings</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#test-alloc-fail" id="toc-entry-433">21.17&nbsp;&nbsp;&nbsp;<tt class="docutils literal">TEST_ALLOC_FAIL</tt></a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#improved-test-example-for-a-new-foo-with-a-bug" id="toc-entry-434">21.17.1&nbsp;&nbsp;&nbsp;Improved Test Example for a New "foo" (with a bug)</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#test-alloc-safe" id="toc-entry-435">21.18&nbsp;&nbsp;&nbsp;<tt class="docutils literal">TEST_ALLOC_SAFE</tt></a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#final-test-example-for-a-new-foo" id="toc-entry-436">21.18.1&nbsp;&nbsp;&nbsp;Final Test Example for a New "foo"</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#basic-debugging" id="toc-entry-437">21.19&nbsp;&nbsp;&nbsp;Basic Debugging</a></li>
<li><a class="reference internal" href="index.html#debugging-upstart-as-a-non-privileged-user" id="toc-entry-438">21.20&nbsp;&nbsp;&nbsp;Debugging Upstart as a Non-Privileged User</a></li>
<li><a class="reference internal" href="index.html#debugging-upstart-as-root" id="toc-entry-439">21.21&nbsp;&nbsp;&nbsp;Debugging Upstart as <tt class="docutils literal">root</tt></a></li>
<li><a class="reference internal" href="index.html#debug-tip-using-destructors" id="toc-entry-440">21.22&nbsp;&nbsp;&nbsp;Debug Tip Using Destructors</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#lists" id="toc-entry-441">21.22.1&nbsp;&nbsp;&nbsp;Lists</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#removing-elements-from-a-list" id="toc-entry-442">21.22.1.1&nbsp;&nbsp;&nbsp;Removing Elements from a List</a></li>
<li><a class="reference internal" href="index.html#moving-an-element-between-lists" id="toc-entry-443">21.22.1.2&nbsp;&nbsp;&nbsp;Moving an Element Between Lists</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#hashes" id="toc-entry-444">21.22.2&nbsp;&nbsp;&nbsp;Hashes</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#using-hashes" id="toc-entry-445">21.22.2.1&nbsp;&nbsp;&nbsp;Using Hashes</a></li>
<li><a class="reference internal" href="index.html#nih-hash-string-new" id="toc-entry-446">21.22.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">nih_hash_string_new()</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#trees" id="toc-entry-447">21.22.3&nbsp;&nbsp;&nbsp;Trees</a></li>
<li><a class="reference internal" href="index.html#avoiding-problems" id="toc-entry-448">21.22.4&nbsp;&nbsp;&nbsp;Avoiding Problems</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#debugger-magic" id="toc-entry-449">21.23&nbsp;&nbsp;&nbsp;Debugger Magic</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#nihlist" id="toc-entry-450">21.23.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">NihList</tt></a></li>
<li><a class="reference internal" href="index.html#nihhash" id="toc-entry-451">21.23.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">NihHash</tt></a></li>
<li><a class="reference internal" href="index.html#nih-iterators" id="toc-entry-452">21.23.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">nih_iterators</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#development-utilities" id="toc-entry-453">21.24&nbsp;&nbsp;&nbsp;Development Utilities</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#upstart-menu-sh" id="toc-entry-454">21.24.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">upstart_menu.sh</tt></a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#enabling-upstart-menu-sh-debian-and-ubuntu-specific" id="toc-entry-455">21.24.1.1&nbsp;&nbsp;&nbsp;Enabling <tt class="docutils literal">upstart_menu.sh</tt> D , U</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="index.html#gotchas" id="toc-entry-456">21.25&nbsp;&nbsp;&nbsp;Gotchas</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#known-issues" id="toc-entry-457">22&nbsp;&nbsp;&nbsp;Known Issues</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#restarting-jobs-with-complex-conditions" id="toc-entry-458">22.1&nbsp;&nbsp;&nbsp;Restarting Jobs with Complex Conditions</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#advice" id="toc-entry-459">22.1.1&nbsp;&nbsp;&nbsp;Advice</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#using-expect-with-script-sections" id="toc-entry-460">22.2&nbsp;&nbsp;&nbsp;Using <tt class="docutils literal">expect</tt> with <tt class="docutils literal">script</tt> sections</a></li>
<li><a class="reference internal" href="index.html#bugs" id="toc-entry-461">22.3&nbsp;&nbsp;&nbsp;Bugs</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#support" id="toc-entry-462">23&nbsp;&nbsp;&nbsp;Support</a></li>
<li><a class="reference internal" href="index.html#references" id="toc-entry-463">24&nbsp;&nbsp;&nbsp;References</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#manual-pages" id="toc-entry-464">24.1&nbsp;&nbsp;&nbsp;Manual Pages</a></li>
<li><a class="reference internal" href="index.html#web-sites" id="toc-entry-465">24.2&nbsp;&nbsp;&nbsp;Web Sites</a></li>
<li><a class="reference internal" href="index.html#mailing-list" id="toc-entry-466">24.3&nbsp;&nbsp;&nbsp;Mailing List</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#answers-to-test" id="toc-entry-467">25&nbsp;&nbsp;&nbsp;Answers to Test</a></li>
<li><a class="reference internal" href="index.html#footnotes" id="toc-entry-468">26&nbsp;&nbsp;&nbsp;Footnotes</a></li>
<li><a class="reference internal" href="index.html#colophon" id="toc-entry-469">27&nbsp;&nbsp;&nbsp;Colophon</a></li>
<li><a class="reference internal" href="index.html#appendices" id="toc-entry-470">28&nbsp;&nbsp;&nbsp;Appendices</a><ul class="auto-toc">
<li><a class="reference internal" href="index.html#ubuntu-well-known-events-ubuntu-specific" id="toc-entry-471">28.1&nbsp;&nbsp;&nbsp;Ubuntu Well-Known Events (U)</a></li>
</ul>
</li>
<li><a class="reference internal" href="index.html#footer" id="toc-entry-472">29&nbsp;&nbsp;&nbsp;Footer</a></li>
</ul>
</div>
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<!-- BODY -->
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<div class="section" id="meta">
<h1><a class="toc-backref" href="index.html#toc-entry-1">1&nbsp;&nbsp;&nbsp;Meta</a></h1>
<div class="section" id="document-version">
<h2><a class="toc-backref" href="index.html#toc-entry-2">1.1&nbsp;&nbsp;&nbsp;Document Version</a></h2>
<p>This is document edit 218.</p>
<p>See <a class="reference internal" href="index.html#footer">footer</a> for further details.</p>
</div>
<div class="section" id="authors">
<h2><a class="toc-backref" href="index.html#toc-entry-3">1.2&nbsp;&nbsp;&nbsp;Authors</a></h2>
<table class="docutils field-list" frame="void" rules="none">
<colgroup><col class="field-name">
<col class="field-body">
</colgroup><tbody valign="top">
<tr class="field"><th class="field-name">Authors:</th><td class="field-body"><ul class="first last simple">
<li>James Hunt &lt;<a class="reference external" href="mailto:james.hunt%40canonical.com">james<span>.</span>hunt<span>@</span>canonical<span>.</span>com</a>&gt;</li>
<li>Clint Byrum (Canonical, HP)</li>
</ul>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="acknowledgements">
<h2><a class="toc-backref" href="index.html#toc-entry-4">1.3&nbsp;&nbsp;&nbsp;Acknowledgements</a></h2>
<p>The Authors are grateful to the following individuals who have provided
valuable input to this document:</p>
<ul class="simple">
<li>Colin Watson (Canonical)</li>
<li>Scott James Remnant (Canonical, Google), author of <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a>.</li>
<li>James Page (Canonical)</li>
<li>Joel Ebel (Google)</li>
<li>Mark Russell (Canonical)</li>
<li>Bradley Ayers</li>
<li>Kenneth Porter</li>
<li>Roberto Alsina (Canonical), <a class="reference external" href="http://docutils.sourceforge.net/rst.html">reStructuredText</a> Guru.</li>
</ul>
</div>
<div class="section" id="purpose">
<h2><a class="toc-backref" href="index.html#toc-entry-5">1.4&nbsp;&nbsp;&nbsp;Purpose</a></h2>
<p>The purpose of this document is multi-faceted. It is intended as:</p>
<ul class="simple">
<li>A gentle introduction to Upstart.</li>
<li>A Cookbook of recipes and best-practises for solving common and not so
common problems.</li>
<li>An extended guide to the configuration syntax of Upstart.</li>
</ul>
<p>It attempts to explain the intricacies of <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> with worked examples
and lots of details.</p>
<p>Note that the reference documentation for <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> will <em>always</em> be the
manual pages: this is merely a supplement to them.</p>
</div>
<div class="section" id="suggestions-and-errata">
<h2><a class="toc-backref" href="index.html#toc-entry-6">1.5&nbsp;&nbsp;&nbsp;Suggestions and Errata</a></h2>
<p>Bad documentation is often worse than no documentation. If you find a
problem with this document, however small...</p>
<ul class="simple">
<li>spelling error</li>
<li>grammatical error</li>
<li>factual error</li>
<li>inconsistency</li>
<li>lack of clarity</li>
<li>ambiguous or misleading content</li>
<li>missing information</li>
<li><em>et cetera</em></li>
</ul>
<p>... or if you'd like to see some particular feature covered <em>please</em>
raise a bug report on the Upstart Cookbook <a class="reference external" href="https://launchpad.net/upstart-cookbook">project website</a> so that we
can improve this work:</p>
<ul class="simple">
<li><a class="reference external" href="https://bugs.launchpad.net/upstart-cookbook/+filebug">https://bugs.launchpad.net/upstart-cookbook/+filebug</a></li>
</ul>
<p>As an incentive you will be credited in the <a class="reference internal" href="index.html#acknowledgements">Acknowledgements</a> section.</p>
</div>
<div class="section" id="coverage">
<h2><a class="toc-backref" href="index.html#toc-entry-7">1.6&nbsp;&nbsp;&nbsp;Coverage</a></h2>
<p>There are essentially two major versions of Upstart covered by this
document:</p>
<div class="section" id="upstream-upstart">
<h3><a class="toc-backref" href="index.html#toc-entry-8">1.6.1&nbsp;&nbsp;&nbsp;Upstream Upstart</a></h3>
<p>This is the pure, or "vanilla" version which is designed to work on any
Linux system:</p>
<ul>
<li><p class="first">Homepage</p>
<p><a class="reference external" href="http://launchpad.net/upstart">http://launchpad.net/upstart</a></p>
</li>
<li><p class="first">Bug Reports</p>
<p><a class="reference external" href="http://bugs.launchpad.net/upstart">http://bugs.launchpad.net/upstart</a></p>
</li>
<li><p class="first">Questions</p>
<p><a class="reference external" href="https://answers.launchpad.net/upstart/+addquestion">https://answers.launchpad.net/upstart/+addquestion</a></p>
</li>
</ul>
</div>
<div class="section" id="debian-and-ubuntu-version-of-upstart">
<h3><a class="toc-backref" href="index.html#toc-entry-9">1.6.2&nbsp;&nbsp;&nbsp;Debian and Ubuntu Version of Upstart</a></h3>
<p>The <a class="reference external" href="http://www.debian.org/">Debian</a> and <a class="reference external" href="http://www.ubuntu.com/">Ubuntu</a>-packaged version <a class="footnote-reference" href="index.html#upstart-written-for-ubuntu" id="footnote-reference-1">[17]</a>.</p>
<p>This is a "debianised" version of Upstart (in other words, a version
packaged for <a class="reference external" href="http://www.debian.org/">Debian</a> and derivatives). It includes a few minor changes
specifically for running Upstart on <a class="reference external" href="http://www.debian.org/">Debian</a> and <a class="reference external" href="http://www.ubuntu.com/">Ubuntu</a> systems, namely:</p>
<ul class="simple">
<li>Change to the way the console is initialised, to work with <a class="reference external" href="http://www.freedesktop.org/wiki/Software/Plymouth">Plymouth</a>.</li>
<li>Initramfs to root filesystem context hand-off changes.</li>
</ul>
<p>Links:</p>
<ul>
<li><p class="first">Homepage</p>
<p><a class="reference external" href="http://launchpad.net/ubuntu/+source/upstart">http://launchpad.net/ubuntu/+source/upstart</a></p>
</li>
<li><p class="first">Bug Reports</p>
<p><a class="reference external" href="http://bugs.launchpad.net/ubuntu/+source/upstart">http://bugs.launchpad.net/ubuntu/+source/upstart</a></p>
</li>
<li><p class="first">Questions</p>
<p><a class="reference external" href="https://answers.launchpad.net/ubuntu/+source/upstart/+addquestion">https://answers.launchpad.net/ubuntu/+source/upstart/+addquestion</a></p>
</li>
</ul>
</div>
<div class="section" id="availability">
<h3><a class="toc-backref" href="index.html#toc-entry-10">1.6.3&nbsp;&nbsp;&nbsp;Availability</a></h3>
<p>Upstart is relied upon by millions of systems across a number of
different Operating Systems including:</p>
<ul class="simple">
<li>Google's Chrome OS</li>
<li>Google's Chromium OS</li>
<li>Red Hat's <a class="reference external" href="http://www.redhat.com/rhel">RHEL</a> 6 <a class="footnote-reference" href="index.html#rhel-upstart" id="footnote-reference-2">[38]</a></li>
<li><a class="reference external" href="http://www.ubuntu.com/">Ubuntu</a></li>
</ul>
<p>It is also available as an option for other systems such as:</p>
<ul class="simple">
<li><a class="reference external" href="http://www.debian.org/">Debian</a></li>
<li><a class="reference external" href="http://fedoraproject.org/">Fedora</a></li>
</ul>
</div>
<div class="section" id="releases">
<h3><a class="toc-backref" href="index.html#toc-entry-11">1.6.4&nbsp;&nbsp;&nbsp;Releases</a></h3>
<p>Table of official Upstart releases:</p>
<table border="1" class="docutils">
<caption>Upstart Releases.</caption>
<colgroup>
<col width="61%">
<col width="39%">
</colgroup>
<thead valign="bottom">
<tr><th class="head">Release Date</th>
<th class="head">Version</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>2009-07-21</td>
<td>0.6.2</td>
</tr>
<tr><td>2009-08-02</td>
<td>0.6.3</td>
</tr>
<tr><td>2010-02-04</td>
<td>0.6.5</td>
</tr>
<tr><td>2010-04-27</td>
<td>0.6.6</td>
</tr>
<tr><td>2010-12-14</td>
<td>0.6.7</td>
</tr>
<tr><td>2011-03-01</td>
<td>1.0</td>
</tr>
<tr><td>2011-03-16</td>
<td>1.1</td>
</tr>
<tr><td>2011-03-22</td>
<td>1.2</td>
</tr>
<tr><td>2011-06-14</td>
<td>1.3</td>
</tr>
<tr><td>2011-12-13</td>
<td>1.4</td>
</tr>
<tr><td>2012-03-22</td>
<td>1.5</td>
</tr>
<tr><td>2012-11-15</td>
<td>1.6</td>
</tr>
<tr><td>2012-12-07</td>
<td>1.6.1</td>
</tr>
<tr><td>2013-03-04</td>
<td>1.7</td>
</tr>
<tr><td>2013-03-22</td>
<td>1.8</td>
</tr>
<tr><td>2013-06-28</td>
<td>1.9</td>
</tr>
<tr><td>2013-07-04</td>
<td>1.9.1</td>
</tr>
<tr><td>2013-08-23</td>
<td>1.10</td>
</tr>
<tr><td>2013-11-14</td>
<td>1.11</td>
</tr>
<tr><td>2014-03-07</td>
<td>1.12</td>
</tr>
<tr><td>2014-03-11</td>
<td>1.12.1</td>
</tr>
<tr><td>2014-07-11</td>
<td>1.13</td>
</tr>
<tr><td>2014-07-16</td>
<td>1.13.1</td>
</tr>
<tr><td>2014-09-04</td>
<td>1.13.2</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="debian-specific-and-ubuntu-specific-content-debian-and-ubuntu-specific">
<h3><a class="toc-backref" href="index.html#toc-entry-12">1.6.5&nbsp;&nbsp;&nbsp;Debian-specific and Ubuntu-Specific Content (<img alt="D" class="debian-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/4926319605052bdf09442836fd8d799b236e5db8"> , <img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719">)</a></h3>
<p>This document is written with <a class="reference external" href="http://www.debian.org/">Debian</a> and <a class="reference external" href="http://www.ubuntu.com/">Ubuntu</a> in mind, but will
attempt to identify <a class="reference external" href="http://www.debian.org/">Debian</a>-specific and <a class="reference external" href="http://www.ubuntu.com/">Ubuntu</a>-specific behaviour
where appropriate by showing one of these icons (or both if the content
applies to both Debian and Ubuntu):</p>
<ul class="simple">
<li>Debian-specific icon: <img alt="D" class="debian-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/4926319605052bdf09442836fd8d799b236e5db8"> (displays as "<tt class="docutils literal">D</tt>" on section headings).</li>
<li>Ubuntu-specific icon: <img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719"> (displays as "<tt class="docutils literal">U</tt>" on section headings).</li>
</ul>
</div>
</div>
<div class="section" id="audience">
<h2><a class="toc-backref" href="index.html#toc-entry-13">1.7&nbsp;&nbsp;&nbsp;Audience</a></h2>
<p>This document is targeted at:</p>
<ul class="simple">
<li>Users interested in learning about <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a>.</li>
<li>System Administrators looking to make the most of the capabilities of <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a>.</li>
<li>Developers and Packagers who wish to package their application to work
with <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a>.</li>
</ul>
</div>
<div class="section" id="document-preparation">
<h2><a class="toc-backref" href="index.html#toc-entry-14">1.8&nbsp;&nbsp;&nbsp;Document Preparation</a></h2>
<p>This document is written in <a class="reference external" href="http://docutils.sourceforge.net/rst.html">reStructuredText</a>, a textual markup
language. The document was prepared using the following tools:</p>
<ul class="simple">
<li><a class="reference external" href="http://www.vim.org/">Vim</a> editor.</li>
<li><a class="reference external" href="http://www.gnu.org/software/emacs">Emacs</a> editor with <a class="reference external" href="http://www.orgmode.org/">Org-Mode</a> for tables.</li>
<li><a class="reference external" href="http://www.jave.de/">Jave</a> for ASCII graphics.</li>
</ul>
</div>
<div class="section" id="document-availability">
<h2><a class="toc-backref" href="index.html#toc-entry-15">1.9&nbsp;&nbsp;&nbsp;Document Availability</a></h2>
<p>The source for this document is available here:</p>
<ul class="simple">
<li><a class="reference external" href="https://code.launchpad.net/~upstart-documenters/upstart-cookbook/trunk">https://code.launchpad.net/~upstart-documenters/upstart-cookbook/trunk</a></li>
</ul>
<p>The latest version of this document should always be available from:</p>
<ul class="simple">
<li><a class="reference external" href="http://upstart.ubuntu.com/cookbook/">http://upstart.ubuntu.com/cookbook/</a></li>
<li><a class="reference external" href="http://upstart.ubuntu.com/cookbook/upstart_cookbook.pdf">http://upstart.ubuntu.com/cookbook/upstart_cookbook.pdf</a></li>
</ul>
</div>
<div class="section" id="warning">
<h2><a class="toc-backref" href="index.html#toc-entry-16">1.10&nbsp;&nbsp;&nbsp;Warning</a></h2>
<p>This document aims to aid understanding of Upstart and identify some hopefully
useful "canned" solutions and advice to common problems and questions.</p>
<p>The authors have taken as much care as possible in the preparation of this
document. However, you are advised strongly to exercise extreme caution when
changing critical system facilities such as the <tt class="docutils literal">init</tt> daemon. Most
situations are recoverable and advice is provided in this document, but if your
system explodes in a ball of fire or becomes unusable as a result of a
suggestion from this document, you alone have the intellectual pleasure of
fixing your systems.</p>
</div>
</div>
<div class="section" id="typographical-conventions">
<h1><a class="toc-backref" href="index.html#toc-entry-17">2&nbsp;&nbsp;&nbsp;Typographical Conventions</a></h1>
<div class="section" id="commands-and-configuration-stanzas">
<h2><a class="toc-backref" href="index.html#toc-entry-18">2.1&nbsp;&nbsp;&nbsp;Commands and configuration stanzas</a></h2>
<p>Throughout this document a fixed-width font such as <tt class="docutils literal">this</tt> will be used to
denote commands, brief command output and configuration stanzas.</p>
</div>
<div class="section" id="user-input-and-command-output">
<h2><a class="toc-backref" href="index.html#toc-entry-19">2.2&nbsp;&nbsp;&nbsp;User Input and Command Output</a></h2>
<p>An indented block will be used to denote user input and command output.</p>
<div class="section" id="non-privileged-user">
<h3><a class="toc-backref" href="index.html#toc-entry-20">2.2.1&nbsp;&nbsp;&nbsp;Non-Privileged User</a></h3>
<p>Indented lines starting with a dollar character ('<tt class="docutils literal">$</tt>') are used to
denote the shell prompt (followed by optional commands) for a
non-privileged user. Command output is shown by indented lines not
preceded by the dollar character:</p>
<pre class="literal-block">$ echo hello
hello
</pre>
</div>
<div class="section" id="super-user">
<h3><a class="toc-backref" href="index.html#toc-entry-21">2.2.2&nbsp;&nbsp;&nbsp;Super-User</a></h3>
<p>Indented lines starting with a hash (or "pound") character ('<tt class="docutils literal">#</tt>') are
used to denote the shell prompt (followed by optional commands) for the
root user. Command output is shown by indented lines not preceded by the
hash character <a class="footnote-reference" href="index.html#using-sudo" id="footnote-reference-3">[14]</a>:</p>
<pre class="literal-block"># whoami
root
</pre>
<p>Note that some examples make use of <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/sudo.8.html">sudo(8)</a> to show the command
should be run as root: the example above could thus be written:</p>
<pre class="literal-block">$ sudo whoami
root
</pre>
<p>This latter approach is clearer in the context where a comment is also
specified using the hash character.</p>
</div>
</div>
<div class="section" id="configuration-examples">
<h2><a class="toc-backref" href="index.html#toc-entry-22">2.3&nbsp;&nbsp;&nbsp;Configuration Examples</a></h2>
<p>An indented block is also used to show examples of job configuration:</p>
<pre class="literal-block">script
  # a config file
end script
</pre>
</div>
</div>
<div class="section" id="introduction">
<h1><a class="toc-backref" href="index.html#toc-entry-23">3&nbsp;&nbsp;&nbsp;Introduction</a></h1>
<div class="section" id="what-is-upstart">
<h2><a class="toc-backref" href="index.html#toc-entry-24">3.1&nbsp;&nbsp;&nbsp;What is Upstart?</a></h2>
<p>Quoting from <a class="reference external" href="http://upstart.ubuntu.com/">http://upstart.ubuntu.com/</a>,</p>
<blockquote>
Upstart is an event-based replacement for the <tt class="docutils literal">/sbin/init</tt> daemon
which handles starting of tasks and services during boot, stopping them
during shutdown and supervising them while the system is running.</blockquote>
<p>The "<tt class="docutils literal">init</tt>" or "system initialisation" process on Unix and Linux
systems has process ID (PID) "<tt class="docutils literal">1</tt>". That is to say, it is the first
process to start when the system boots (ignoring the initrd/initramfs).
As the quote shows, Upstart is an "<tt class="docutils literal">init</tt>" replacement for the
traditional Unix "System V" "<tt class="docutils literal">init</tt>" system. Upstart provides the same
facilities as the traditional "<tt class="docutils literal">init</tt>" system, but surpasses it in
many ways.</p>
<div class="section" id="reliability">
<h3><a class="toc-backref" href="index.html#toc-entry-25">3.1.1&nbsp;&nbsp;&nbsp;Reliability</a></h3>
<p>Upstart is written using the <a class="reference external" href="http://launchpad.net/libnih">NIH Utility Library</a> ("<tt class="docutils literal">libnih</tt>"). This
is a very small, efficient and safe library of generic routines. It is
designed for applications that run early in the boot sequence
("plumbing"). Reliability and safety is critically important for an
<tt class="docutils literal">init</tt> daemon since:</p>
<ul class="simple">
<li>it runs as the super-user.</li>
<li>it is responsible for managing critical system services.</li>
<li>if init exits for any reason, the kernel panics.</li>
</ul>
<p>To help ensure reliability and avoid regressions, Upstart and the NIH Utility
Library both come with comprehensive test suites. See <a class="reference internal" href="index.html#unit-tests">Unit Tests</a> for further
information.</p>
</div>
<div class="section" id="design-history">
<h3><a class="toc-backref" href="index.html#toc-entry-26">3.1.2&nbsp;&nbsp;&nbsp;Design History</a></h3>
<p>Upstart was created due to fundamental limitations in existing systems.
Those systems can be categorized into two types:</p>
<ul class="simple">
<li>System V init system</li>
<li>Dependency-based init systems</li>
</ul>
<p>To understand why Upstart was written and why its revolutionary design
was chosen, it is necessary to consider these two classes of init
system.</p>
<div class="section" id="critique-of-the-system-v-init-system">
<h4><a class="toc-backref" href="index.html#toc-entry-27">3.1.2.1&nbsp;&nbsp;&nbsp;Critique of the System V init System</a></h4>
<div class="section" id="sysv-benefits">
<h5><a class="toc-backref" href="index.html#toc-entry-28">3.1.2.1.1&nbsp;&nbsp;&nbsp;SysV Benefits</a></h5>
<div class="section" id="simplicity">
<h6><a class="toc-backref" href="index.html#toc-entry-29">3.1.2.1.1.1&nbsp;&nbsp;&nbsp;Simplicity</a></h6>
<p>Creating service files is easy with SystemV init since they are simply
shell scripts. To enable/disable a service in a particular runlevel, you
only need to create/remove a symbolic link in a particular directory or
set of directories.</p>
</div>
<div class="section" id="guaranteed-ordering-of-services">
<h6><a class="toc-backref" href="index.html#toc-entry-30">3.1.2.1.1.2&nbsp;&nbsp;&nbsp;Guaranteed Ordering of Services</a></h6>
<p>This is achieved by init running the scripts pointed to by the symbolic
links in sequence. The relative order in which init invokes these
scripts is determined by a numeric element in the name: lower numbered
services run before higher numbered services.</p>
</div>
</div>
<div class="section" id="sysv-limitations">
<h5><a class="toc-backref" href="index.html#toc-entry-31">3.1.2.1.2&nbsp;&nbsp;&nbsp;SysV Limitations</a></h5>
<div class="section" id="non-optimal-performance">
<h6><a class="toc-backref" href="index.html#toc-entry-32">3.1.2.1.2.1&nbsp;&nbsp;&nbsp;Non-Optimal Performance</a></h6>
<p>The traditional sequential boot system was appropriate for the time it
was invented, but by modern standards it is "slow" in the sense that it
makes no use of parallelism.</p>
<p>It was designed to be simple and efficient for Administrators to manage.
However, this model does not make full use of modern system resources,
particularly once it is recognised that multiple services can often be
run simultaneously.</p>
<p>A common "hack" used by Administrators is to circumvent the
serialisation by running their service in the background, such that some
degree of parallelism is possible. The fact that this hack is required
and is common on such systems demonstrates clearly the flaw in that
system.</p>
</div>
<div class="section" id="server-centric">
<h6><a class="toc-backref" href="index.html#toc-entry-33">3.1.2.1.2.2&nbsp;&nbsp;&nbsp;Server-Centric</a></h6>
<p>In the days of colossal Unix systems with hundreds of concurrent users,
where reboots were rare, the traditional SysV approach was perfect. If
hardware needed replacing, a system shutdown was scheduled, the shutdown
performed, the new hardware was installed and the system was brought
back on-line.</p>
<p>However, the world has now moved on. From an Ubuntu perspective, a
significant proportion of users run the desktop edition on portable
devices where they may reboot multiple times a day.</p>
</div>
<div class="section" id="assumes-static-hardware-at-all-times">
<h6><a class="toc-backref" href="index.html#toc-entry-34">3.1.2.1.2.3&nbsp;&nbsp;&nbsp;Assumes Static Hardware at all Times</a></h6>
<p>Modern Linux systems can deal with new hardware devices being added and
removed dynamically ("hot-plug"). The traditional SysV init system itself
is incapable of handling such a dynamically changing system.</p>
</div>
<div class="section" id="every-service-does-heavy-lifting">
<h6><a class="toc-backref" href="index.html#toc-entry-35">3.1.2.1.2.4&nbsp;&nbsp;&nbsp;Every Service Does Heavy Lifting</a></h6>
<p>Most service files are fairly formulaic. For example, they might:</p>
<ul class="simple">
<li>perform initial checks, such as:<ul>
<li>ensuring no other instance of a daemon is running.</li>
<li>checking the existence of a directory or file.</li>
<li>removing old cache files.</li>
</ul>
</li>
<li>ensure dependent daemons are running.</li>
<li>spawn the main service.</li>
</ul>
<p>The most difficult and time costly operation these services perform is
that of handling dependent daemons. The <a class="reference external" href="http://www.linuxbase.org/">LSB</a> specifies helper
utilities that these services can make use of, but arguably each service
shouldn't need to be handling this activity <em>themselves</em>: the init
system itself should do it on behalf of the services it manages.</p>
</div>
</div>
</div>
<div class="section" id="critique-of-dependency-based-init-systems">
<h4><a class="toc-backref" href="index.html#toc-entry-36">3.1.2.2&nbsp;&nbsp;&nbsp;Critique of Dependency-Based init Systems</a></h4>
<div class="section" id="benefits-of-dependency-based-init">
<h5><a class="toc-backref" href="index.html#toc-entry-37">3.1.2.2.1&nbsp;&nbsp;&nbsp;Benefits of Dependency-based init</a></h5>
<div class="section" id="recognises-services-require-other-services">
<h6><a class="toc-backref" href="index.html#toc-entry-38">3.1.2.2.1.1&nbsp;&nbsp;&nbsp;Recognises Services Require Other Services</a></h6>
<p>The recognition that services often need to make use of other services
is an important improvement over SystemV init systems. It places a
bigger responsibility on the init system itself and reduces the
complexity and work that needs to be performed by individual service
files.</p>
</div>
</div>
<div class="section" id="limitations-of-dependency-based-init">
<h5><a class="toc-backref" href="index.html#toc-entry-39">3.1.2.2.2&nbsp;&nbsp;&nbsp;Limitations of Dependency-based init</a></h5>
<div class="section" id="does-not-recognise-dynamic-nature-of-linux">
<h6><a class="toc-backref" href="index.html#toc-entry-40">3.1.2.2.2.1&nbsp;&nbsp;&nbsp;Does Not Recognise Dynamic Nature of Linux</a></h6>
<p>The main problem with dependency-based init systems is that they
approach the problem from the "wrong direction". Again, this is due to
their not recognising the dynamic nature of modern Linux systems.</p>
<p>For example, if a dependency-based init system wished to start say
<a class="reference external" href="http://www.mysql.com/">MySQL</a>, it would <em>first</em> start all the dependent services that MySQL
needed. This sounds perfectly reasonable.</p>
<p>However, consider how such a system would approach the problem of
dealing with a user who plugs in an external monitor. Maybe we'd like
our system to display some sort of configuration dialogue so the user
can choose how they want to use their new monitor in combination with
their existing laptop display. This can only be "hacked" with a
dependency-based init system since you do not know when the new screen
will be plugged. So, your choices are either:</p>
<ul>
<li><p class="first">Do nothing.</p>
<p>Corresponds to an inability to handle this scenario.</p>
</li>
<li><p class="first">Have a daemon that hangs around polling for new hardware being
plugged.</p>
<p>Wasteful and inefficient.</p>
</li>
</ul>
<p>What you really want is a system that detects such asynchronous events
and when the conditions are right for a service to run, the service is
started.</p>
<p>This can be summarised as:</p>
<blockquote>
<ul>
<li><p class="first">Upstart starts a service when its required conditions are met.</p>
<p>The service (job configuration file) only needs to specify the
conditions that allow the service to run, and the executable to run
the service itself.</p>
</li>
<li><p class="first">Dependency-based init systems meet a service's dependencies before
starting them.</p>
<p>Each service generally does this using a brute-force approach of
forcing all the dependencies to start.</p>
<p>Note that the init system itself is not doing the heavy-lifting:
that is left up to each service itself (!)</p>
</li>
</ul>
</blockquote>
<p>This summary is worth considering carefully as the distinction between
the two types of system is subtle but important.</p>
<p>The other problem with dependency-based init systems is that they
require a dependency-solver which is often complex and not always
optimal.</p>
</div>
</div>
</div>
<div class="section" id="upstart-s-design-why-it-is-revolutionary">
<h4><a class="toc-backref" href="index.html#toc-entry-41">3.1.2.3&nbsp;&nbsp;&nbsp;Upstart's Design: Why It Is Revolutionary</a></h4>
<p>It was necessary to outline the limitations of the SysV and
dependency-based init systems to appreciate why Upstart is special...</p>
<p>Upstart is revolutionary as it recognises <em>and was designed
specifically for</em> a dynamic system. It handles asynchronicity by
emitting events. This too is revolutionary.</p>
<p>Upstart emits "events" which services can register an interest in. When
an event -- or combination of events -- is emitted that satisfies some
service's requirements, Upstart will automatically start or stop that
service. If multiple jobs have the same "start on" condition, Upstart
will start those jobs ''in parallel''. To be manifest: Upstart handles
starting the "dependent" services itself - this is not handled by the
service file itself as it is with dependency-based systems.</p>
<p>Further, Upstart is being guided by the ultimate arbiter of hardware
devices: the kernel.</p>
<p>In essence, Upstart is an event engine: it creates events, handles the
consequences of those events being emitted and starts and stops
processes as required. Like the best Unix software, it does this job
very well. It is efficient, fast, flexible <em>and reliable</em>. It makes use
of "helper" daemons (such as the <a class="reference internal" href="index.html#upstart-udev-bridge">upstart-udev-bridge</a> and the
<a class="reference internal" href="index.html#upstart-socket-bridge">upstart-socket-bridge</a>) to inject new types of events into the system
and react to these events. This design is sensible and clean: the init
system itself must not be compromised since if it fails, the kernel
panics. Therefore, any functionality which is not considered "core"
functionality is farmed out to other daemons.</p>
<p>See <a class="footnote-reference" href="index.html#upstart-spec" id="footnote-reference-4">[35]</a> for further details.</p>
</div>
</div>
<div class="section" id="performance">
<h3><a class="toc-backref" href="index.html#toc-entry-42">3.1.3&nbsp;&nbsp;&nbsp;Performance</a></h3>
<p>Upstart was designed with performance in mind. It makes heavy use of the
<a class="reference external" href="http://launchpad.net/libnih">NIH Utility Library</a> which is optimised for efficient early boot
environments. Additionally, Upstart's design is lightweight, efficient
and elegant. At its heart it is an event-based messaging system that has
the ability to control and monitor processes. Upstart is designed to
manage services running in parallel. It will only start services when
the conditions they have specified are met.</p>
</div>
<div class="section" id="server">
<h3><a class="toc-backref" href="index.html#toc-entry-43">3.1.4&nbsp;&nbsp;&nbsp;Server</a></h3>
<p>Upstart is used by Ubuntu for the <a class="reference external" href="http://www.ubuntu.com/business/desktop/overview">Ubuntu Desktop</a> and for <a class="reference external" href="http://www.ubuntu.com/business/server/overview">Ubuntu
Server</a> (and as a result of this, it is also used in the <a class="reference external" href="http://www.ubuntu.com/business/cloud/overview">Ubuntu
Cloud</a>). Why is Upstart also compelling in a server environment?</p>
<div class="section" id="boot-performance">
<h4><a class="toc-backref" href="index.html#toc-entry-44">3.1.4.1&nbsp;&nbsp;&nbsp;Boot Performance</a></h4>
<p>Some say that boot performance is not important on servers, possibly
since the time taken to bring RAID arrays on-line is significantly longer
than the time it takes to boot the operating system. However, nobody
seriously wants their system to take longer than necessary to boot.</p>
<p>Consider also the case for Cloud deployments, which of course run
on servers. Here, boot speed is very important as it affects the time
taken to deploy a new server instance. The faster you can deploy new
services to handle an increasing workload the better the experience for
your customers.</p>
</div>
<div class="section" id="failure-modes">
<h4><a class="toc-backref" href="index.html#toc-entry-45">3.1.4.2&nbsp;&nbsp;&nbsp;Failure Modes</a></h4>
<p>It's a fact that systems and software are getting more complex. In the
old days of Unix, runlevels encompassed every major mode of operation
you might want your system to handle. However, expectations have
changed. Nowadays, we expect systems to react to problems (and maybe
even "self-heal" the simple ones).</p>
<p>The landscape has changed and Upstart is fully able to accommodate such
changes since its design is clean, elegant and abstract. Crucially,
Upstart is not tied to the rigid runlevel system. Indeed, Upstart has no
knowledge of <a class="reference internal" href="index.html#runlevels">runlevels</a> internally, but it supports them trivially with
events. And since events are so abstract, they are highly flexible
building blocks for higher-level constructs. Added to which, since
Upstart's events are dynamic, the system can be configured for a myriad
of possible system behaviours and failure modes and have it react
accordingly.</p>
</div>
</div>
</div>
</div>
<div class="section" id="concepts-and-terminology">
<h1><a class="toc-backref" href="index.html#toc-entry-46">4&nbsp;&nbsp;&nbsp;Concepts and Terminology</a></h1>
<p>The main concepts in Upstart are "events" and "jobs". Understanding the
difference between the two is crucial.</p>
<div class="section" id="job">
<h2><a class="toc-backref" href="index.html#toc-entry-47">4.1&nbsp;&nbsp;&nbsp;Job</a></h2>
<p>A "<cite>unit of work</cite>" - generally either a "<cite>Task</cite>" or a "<cite>Service</cite>". <span class="target" id="jobs">Jobs</span>
are defined in a <a class="reference internal" href="index.html#job-configuration-file">Job configuration file</a>.</p>
<div class="section" id="job-types">
<h3><a class="toc-backref" href="index.html#toc-entry-48">4.1.1&nbsp;&nbsp;&nbsp;Job Types</a></h3>
<div class="section" id="task-job">
<h4><a class="toc-backref" href="index.html#toc-entry-49">4.1.1.1&nbsp;&nbsp;&nbsp;Task Job</a></h4>
<p>A <cite>Task Job</cite> is one which runs a short-running process, that is, a
program which might still take a long time to run, but which has a
definite lifetime and end state.</p>
<p>For example, deleting a file could be a <cite>Task Job</cite> since the command starts,
deletes the file in question (which might take some time if the file is
huge) and then the delete command ends.</p>
<p>In this book <cite>Task Jobs</cite> are often referred to as <cite>tasks</cite>.</p>
</div>
<div class="section" id="service-job">
<h4><a class="toc-backref" href="index.html#toc-entry-50">4.1.1.2&nbsp;&nbsp;&nbsp;Service Job</a></h4>
<p>A <cite>Service Job</cite> is a long-running (or <a class="reference external" href="http://manpages.ubuntu.com/manpages/man3/daemon.3.html">daemon(3)</a> process). It is the
opposite of a <cite>Task Job</cite> since a <cite>Service Job</cite> might never end of its
own accord.</p>
<p>Examples of <cite>Service Jobs</cite> are entities such as databases, webservers or
ftp servers.</p>
</div>
<div class="section" id="abstract-job">
<h4><a class="toc-backref" href="index.html#toc-entry-51">4.1.1.3&nbsp;&nbsp;&nbsp;Abstract Job</a></h4>
<p>There is one other type of job which has <em>no</em> script sections or <tt class="docutils literal">exec</tt>
stanzas. Such abstract jobs <em>can</em> still be started and stopped, but will
have no corresponding child process (PID). In fact, starting such a job
will result in it "running" perpetually if not stopped by an
Administrator. Abstract jobs exist only within <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> itself but can
be very useful. See for example:</p>
<ul class="simple">
<li><a class="reference internal" href="index.html#jobs-that-run-forever">Jobs that "Run Forever"</a></li>
<li><a class="reference internal" href="index.html#synchronisation">Synchronisation</a></li>
</ul>
</div>
</div>
<div class="section" id="job-states">
<h3><a class="toc-backref" href="index.html#toc-entry-52">4.1.2&nbsp;&nbsp;&nbsp;Job States</a></h3>
<p>The table below shows all possible Job States and the legal transitions
between them. States are exposed to users via the <tt class="docutils literal">status</tt> field in the
output of the <a class="reference internal" href="index.html#initctl-status">initctl status</a> command.</p>
<table border="1" class="docutils">
<caption>Job State Transitions.</caption>
<colgroup>
<col width="24%">
<col width="24%">
<col width="53%">
</colgroup>
<thead valign="bottom">
<tr><th class="head" rowspan="2"><p class="first">Current</p>
<p class="last">State</p>
</th>
<th class="head" colspan="2">Goal</th>
</tr>
<tr><th class="head"><tt class="docutils literal">start</tt></th>
<th class="head"><tt class="docutils literal">stop</tt></th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">waiting</tt></td>
<td><tt class="docutils literal">starting</tt></td>
<td>n/a</td>
</tr>
<tr><td><tt class="docutils literal">starting</tt></td>
<td><tt class="docutils literal">security</tt></td>
<td><tt class="docutils literal">stopping</tt></td>
</tr>
<tr><td><tt class="docutils literal">security</tt></td>
<td><tt class="docutils literal"><span class="pre">pre-start</span></tt></td>
<td><tt class="docutils literal">stopping</tt></td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">pre-start</span></tt></td>
<td><tt class="docutils literal">spawned</tt></td>
<td><tt class="docutils literal">stopping</tt></td>
</tr>
<tr><td><tt class="docutils literal">spawned</tt></td>
<td><tt class="docutils literal"><span class="pre">post-start</span></tt></td>
<td><tt class="docutils literal">stopping</tt></td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">post-start</span></tt></td>
<td><tt class="docutils literal">running</tt></td>
<td><tt class="docutils literal">stopping</tt></td>
</tr>
<tr><td><tt class="docutils literal">running</tt></td>
<td><tt class="docutils literal">stopping</tt></td>
<td><tt class="docutils literal"><span class="pre">pre-stop</span></tt> or <tt class="docutils literal">stopping</tt> <a class="footnote-reference" href="index.html#a" id="footnote-reference-5">[15]</a></td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">pre-stop</span></tt></td>
<td><tt class="docutils literal">running</tt></td>
<td><tt class="docutils literal">stopping</tt></td>
</tr>
<tr><td><tt class="docutils literal">stopping</tt></td>
<td><tt class="docutils literal">killed</tt></td>
<td><tt class="docutils literal">killed</tt></td>
</tr>
<tr><td><tt class="docutils literal">killed</tt></td>
<td><tt class="docutils literal"><span class="pre">post-stop</span></tt></td>
<td><tt class="docutils literal"><span class="pre">post-stop</span></tt></td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">post-stop</span></tt></td>
<td><tt class="docutils literal">starting</tt></td>
<td><tt class="docutils literal">waiting</tt></td>
</tr>
</tbody>
</table>
<p>For example, if the job is currently in state <tt class="docutils literal">starting</tt>, and its goal
is <tt class="docutils literal">start</tt>, it will then move to the <tt class="docutils literal"><span class="pre">pre-start</span></tt> state.</p>
<p>Note that jobs may change state so quickly that you may not be able to
observe all the values above in the <tt class="docutils literal">initctl</tt> output. However, you
will see the transitions if you raise the log-priority to <tt class="docutils literal">debug</tt> or
<tt class="docutils literal">info</tt>. See <a class="reference internal" href="index.html#initctl-log-priority">initctl log-priority</a> for details.</p>
<p>Details of states:</p>
<ul class="simple">
<li><tt class="docutils literal">waiting</tt> : initial state.</li>
<li><tt class="docutils literal">starting</tt> : job is about to start.</li>
<li><tt class="docutils literal">security</tt> : job is having its AppArmor security policy loaded (see
<a class="reference internal" href="index.html#apparmor-load">apparmor load</a>).</li>
<li><tt class="docutils literal"><span class="pre">pre-start</span></tt> : running <a class="reference internal" href="index.html#pre-start">pre-start</a> section.</li>
<li><tt class="docutils literal">spawned</tt> : about to run <cite>script</cite> or <a class="reference internal" href="index.html#exec">exec</a> section.</li>
<li><tt class="docutils literal"><span class="pre">post-start</span></tt> : running <a class="reference internal" href="index.html#post-start">post-start</a> section.</li>
<li><tt class="docutils literal">running</tt> : interim state set after <a class="reference internal" href="index.html#post-start">post-start</a> section
processed denoting job is running (But it may have no associated PID!)</li>
<li><tt class="docutils literal"><span class="pre">pre-stop</span></tt> : running <a class="reference internal" href="index.html#pre-stop">pre-stop</a> section.</li>
<li><tt class="docutils literal">stopping</tt> : interim state set after <a class="reference internal" href="index.html#pre-stop">pre-stop</a> section
processed.</li>
<li><tt class="docutils literal">killed</tt> : job is about to be stopped.</li>
<li><tt class="docutils literal"><span class="pre">post-stop</span></tt> : running <a class="reference internal" href="index.html#post-stop">post-stop</a> section.</li>
</ul>
<p>State transitions diagram for versions of Upstart up to and including
version 1.12.1 (green lines represent <tt class="docutils literal">goal=start</tt>, red lines represent <tt class="docutils literal">goal=stop</tt>):</p>
<div class="figure align-center">
<img alt="upstart state diagram" src="./upstart-states.png" style="width: 1535.8px; height: 345.79999999999995px;">
<p class="caption">State transitions (up to and including Upstart version 1.12.1).</p>
</div>
<p>State transitions diagram for Upstart version 1.13 and newer
(green lines represent <tt class="docutils literal">goal=start</tt>, red lines represent <tt class="docutils literal">goal=stop</tt>):</p>
<div class="figure align-center">
<img alt="upstart state diagram" src="./upstart-states-new.png" style="width: 716.8px; height: 1573.6px;">
<p class="caption">State transitions (Upstart version 1.13 and upwards).</p>
</div>
<div class="section" id="viewing-state-transitions">
<h4><a class="toc-backref" href="index.html#toc-entry-53">4.1.2.1&nbsp;&nbsp;&nbsp;Viewing State Transitions</a></h4>
<p>To view state transitions:</p>
<ol class="arabic simple">
<li><a class="reference internal" href="index.html#change-the-log-priority">Change the log-priority</a> to <tt class="docutils literal">debug</tt></li>
<li>"<tt class="docutils literal">tail <span class="pre">-f</span></tt>" your system log file</li>
<li>start/stop/restart a job or emit an event.</li>
</ol>
</div>
</div>
<div class="section" id="job-environment">
<h3><a class="toc-backref" href="index.html#toc-entry-54">4.1.3&nbsp;&nbsp;&nbsp;Job Environment</a></h3>
<p>When Upstart runs a job, it provides it with a very restrictive
environment which contains just two system variables:</p>
<ul class="simple">
<li><tt class="docutils literal">TERM</tt></li>
<li><tt class="docutils literal">PATH</tt></li>
</ul>
<p>Upstart itself will also potentially set some special variables the job
can use. See <a class="reference internal" href="index.html#standard-environment-variables">Standard Environment Variables</a> for further details.</p>
<p>If your <a class="reference internal" href="index.html#system-job">system job</a> needs further variables to be set, you can use the
<a class="reference internal" href="index.html#env">env</a> and <a class="reference internal" href="index.html#export">export</a> stanzas.</p>
<p><a class="reference internal" href="index.html#session-jobs">Session Jobs</a> are different. They too can use <a class="reference internal" href="index.html#env">env</a> and <a class="reference internal" href="index.html#export">export</a>,
but they already inherit the environment of the <a class="reference internal" href="index.html#session-init">Session Init</a> that is
supervising them. However, further to that, Session Jobs can also
influence the environment of the processes that comprise both a single
job and all subsequent jobs. See the "env" commands in the <a class="reference internal" href="index.html#initctl-commands-summary">initctl
Commands Summary</a> for details.</p>
</div>
</div>
<div class="section" id="job-configuration-file">
<h2><a class="toc-backref" href="index.html#toc-entry-55">4.2&nbsp;&nbsp;&nbsp;Job Configuration File</a></h2>
<p>A <a class="reference internal" href="index.html#job">Job</a> is defined in a <cite>Job Configuration File</cite> (or more simply a
<cite>conf file</cite>) which is a plain text file containing one or more
<cite>stanzas</cite>. <span class="target" id="job-configuration-files">Job configuration files</span> are named:</p>
<pre class="literal-block">&lt;name&gt;.conf
</pre>
<p>Where "<tt class="docutils literal">&lt;name&gt;</tt>" should reflect the application being run or the
service being provided.</p>
<p>Job configuration files can exist in two types of location, depending on
whether they are a <a class="reference internal" href="index.html#system-job">System Job</a> or a <a class="reference internal" href="index.html#user-job">User Job</a>.</p>
<p>Note that it is common to refer to a Job configuration file as a "job",
although technically a job is a running instance of a Job configuration
file.</p>
<div class="section" id="system-job">
<h3><a class="toc-backref" href="index.html#toc-entry-56">4.2.1&nbsp;&nbsp;&nbsp;System Job</a></h3>
<p>All <span class="target" id="system-jobs">system jobs</span> by default live in the following directory:</p>
<pre class="literal-block">/etc/init/
</pre>
<p>This directory <em>can</em> be overridden by specifying the
<tt class="docutils literal"><span class="pre">--confdir=&lt;directory&gt;</span></tt> option to the init daemon, however this is a
specialist option which users should not need to use.</p>
</div>
<div class="section" id="user-job">
<h3><a class="toc-backref" href="index.html#toc-entry-57">4.2.2&nbsp;&nbsp;&nbsp;User Job</a></h3>
<p><em>Deprecated as of Upstart v1.7</em>: see <a class="reference internal" href="index.html#session-job">Session Job</a>.</p>
<p>Upstart 1.3 introduced <span class="target" id="user-jobs">user jobs</span>, allowing non-privileged users to
create jobs by placing <a class="reference internal" href="index.html#job-configuration-files">job configuration files</a> in the following
directory:</p>
<pre class="literal-block">$HOME/.init/
</pre>
<p>This feature is not currently enabled in Ubuntu (up to and including
11.10 ("Oneiric Ocelot")).</p>
<p>The syntax for such jobs is identical for "system jobs".</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Currently, a user job cannot be created with the same name as
a system job: the system job will take precedence.</p>
</div>
<p>Controlling user jobs is the same as for system jobs: use <a class="reference internal" href="index.html#initctl">initctl</a>,
<a class="reference internal" href="index.html#start">start</a>, <a class="reference internal" href="index.html#stop">stop</a>, <em>et cetera</em>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Stanzas which manipulate resources limits (such as <a class="reference internal" href="index.html#limit">limit</a>,
<tt class="docutils literal">nice</tt>, and <tt class="docutils literal">oom</tt>) may cause a job to fail to start should the
value provided to such a stanza attempt to exceed the maximum value the
users privilege level allows.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">User jobs cannot currently take advantage of job logging. If a user
job does specify <a class="reference internal" href="index.html#console-log">console log</a>, it is considered to have specified
<a class="reference internal" href="index.html#console-none">console none</a>. Logging of user jobs is planned for the next release
of Upstart.</p>
</div>
<div class="section" id="enabling">
<h4><a class="toc-backref" href="index.html#toc-entry-58">4.2.2.1&nbsp;&nbsp;&nbsp;Enabling</a></h4>
<p>To enable user jobs, the administrator must modify the <cite>D-Bus</cite>
configuration file "<cite>Upstart.conf</cite>" to allow non-root users access to
all the Upstart D-Bus methods and properties. On an Ubuntu system the
file to modify is:</p>
<pre class="literal-block">/etc/dbus-1/system.d/Upstart.conf
</pre>
<p>The Upstream Upstart 1.3 distribution already includes a "<cite>Upstart.conf</cite>"
file containing the required changes.</p>
</div>
</div>
<div class="section" id="session-job">
<h3><a class="toc-backref" href="index.html#toc-entry-59">4.2.3&nbsp;&nbsp;&nbsp;Session Job</a></h3>
<p><em>As of Upstart v1.7</em></p>
<p><span class="target" id="session-jobs">Session Jobs</span> are analogous to the old <a class="reference internal" href="index.html#user-jobs">User Jobs</a>. Unlike the old
User Jobs, Session Jobs are not managed by Upstart running as PID 1 -
they are managed by the users own <a class="reference internal" href="index.html#session-init">Session Init</a>.</p>
<p>Unlike when Upstart runs as PID 1, a Session Init can read its <a class="reference internal" href="index.html#job-configuration-files">Job
Configuration files</a> from multiple directories. The list of
directories jobs are read from is as follows (in order):</p>
<ul class="simple">
<li><tt class="docutils literal">$XDG_CONFIG_HOME/upstart/</tt> (or <tt class="docutils literal"><span class="pre">$HOME/.config/upstart/</span></tt> if <tt class="docutils literal">$XDG_CONFIG_HOME</tt> not set).</li>
<li><tt class="docutils literal"><span class="pre">$HOME/.init/</span></tt> (deprecated - supported for legacy <a class="reference internal" href="index.html#user-jobs">User Jobs</a>).</li>
<li><tt class="docutils literal">$XDG_CONFIG_DIRS</tt></li>
<li><tt class="docutils literal">/usr/share/upstart/sessions/</tt></li>
</ul>
<p>The name of each job is taken to be the basename when any of the
directory names above have been removed. For example, if a <a class="reference internal" href="index.html#job-configuration-file">job
configuration file</a> exists as
<tt class="docutils literal"><span class="pre">$HOME/.config/upstart/hello/world.conf</span></tt>, its name will be
"<tt class="docutils literal">hello/world</tt>" whereas if a job configuration file exists as
<tt class="docutils literal">/usr/share/upstart/sessions/foo/bar.conf</tt>, its name will be
"<tt class="docutils literal">foo/bar</tt>".</p>
<p>Upstart resolves any name collisions by simply accepting the first valid
job (or <a class="reference internal" href="index.html#override-file">override file</a>) that it finds. For example, if the following
two file exist:</p>
<pre class="literal-block">$HOME/.init/foo.conf
$HOME/.config/upstart/foo.conf
</pre>
<p>Only the first, <tt class="docutils literal"><span class="pre">$HOME/.init/foo.conf</span></tt> will be used. Whereas if the
following files exist:</p>
<pre class="literal-block">$HOME/.init/foo.conf
$HOME/.config/upstart/foo.conf
$HOME/.config/upstart/foo.override
</pre>
<p>Upstart will first read <tt class="docutils literal"><span class="pre">$HOME/.init/foo.conf</span></tt>, and then apply any
changes in <tt class="docutils literal"><span class="pre">$HOME/.config/upstart/foo.override</span></tt>.</p>
</div>
<div class="section" id="odd-jobs">
<h3><a class="toc-backref" href="index.html#toc-entry-60">4.2.4&nbsp;&nbsp;&nbsp;Odd Jobs</a></h3>
<div class="section" id="job-with-start-on-but-no-stop-on">
<h4><a class="toc-backref" href="index.html#toc-entry-61">4.2.4.1&nbsp;&nbsp;&nbsp;Job with <tt class="docutils literal">start on</tt>, but no <tt class="docutils literal">stop on</tt></a></h4>
<p>A job does not necessarily need a <a class="reference internal" href="index.html#stop-on">stop on</a> stanza. If it lacks one,
any running instances can still be stopped by an Administrator running
either of:</p>
<ul class="simple">
<li><tt class="docutils literal">initctl stop &lt;job&gt;</tt></li>
<li><tt class="docutils literal">stop &lt;job&gt;</tt></li>
</ul>
<p>However, if such a job is not stopped, it may be stopped either by
another job, or some other facility <a class="footnote-reference" href="index.html#ubuntu-kill-jobs" id="footnote-reference-6">[32]</a>. Worst case, if
nothing else stops it, all processes will obviously be killed when the
system is powered off.</p>
</div>
<div class="section" id="job-with-stop-on-but-no-start-on">
<h4><a class="toc-backref" href="index.html#toc-entry-62">4.2.4.2&nbsp;&nbsp;&nbsp;Job with <tt class="docutils literal">stop on</tt>, but no <tt class="docutils literal">start on</tt></a></h4>
<p>If a job has no <a class="reference internal" href="index.html#start-on">start on</a> stanza, it can <em>only</em> be started manually by
an Administrator running either of:</p>
<ul class="simple">
<li><tt class="docutils literal">initctl start &lt;job&gt;</tt></li>
<li><tt class="docutils literal">start &lt;job&gt;</tt></li>
</ul>
<p>If any job instances are running at system shutdown time, <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> will
stop them.</p>
</div>
<div class="section" id="job-with-no-stop-on-or-start-on">
<h4><a class="toc-backref" href="index.html#toc-entry-63">4.2.4.3&nbsp;&nbsp;&nbsp;Job with no <tt class="docutils literal">stop on</tt> or <tt class="docutils literal">start on</tt></a></h4>
<p>Such a job can only be controlled by an Administrator. See <a class="reference internal" href="index.html#job-with-start-on-but-no-stop-on">Job with
start on, but no stop on</a> and <a class="reference internal" href="index.html#job-with-stop-on-but-no-start-on">Job with stop on, but no start on</a>.</p>
</div>
<div class="section" id="minimal-job-configuration">
<h4><a class="toc-backref" href="index.html#toc-entry-64">4.2.4.4&nbsp;&nbsp;&nbsp;Minimal Job Configuration</a></h4>
<p>What is the minimum content of a job configuration file? Interestingly
enough, to be valid a job configuration file:</p>
<ul class="simple">
<li>must not be empty</li>
<li>must be syntactically correct</li>
<li>must contain at least one legal stanza</li>
</ul>
<p>Therefore, some examples of minimal job configuration files are:</p>
<ul>
<li><p class="first">Comments only:</p>
<pre class="literal-block"># this is an abstract job containing only a comment
</pre>
</li>
<li><p class="first"><tt class="docutils literal">author</tt> stanza only:</p>
<pre class="literal-block">author "foo"
</pre>
</li>
<li><p class="first"><tt class="docutils literal">description</tt> stanza only:</p>
<pre class="literal-block">description "this is an abstract job"
</pre>
</li>
</ul>
<p>As shown, these are all example of <a class="reference internal" href="index.html#abstract-job">Abstract Job</a> configuration files.</p>
</div>
</div>
</div>
<div class="section" id="session-init">
<h2><a class="toc-backref" href="index.html#toc-entry-65">4.3&nbsp;&nbsp;&nbsp;Session Init</a></h2>
<p><em>As of Upstart v1.7</em>, Upstart has the ability to run as a non-PID 1
process (see <a class="reference internal" href="index.html#upstart-user-sessions-spec">upstart-user-sessions-spec</a> for full details).</p>
<p>But why would you want to run <em>another</em> instance of Upstart?  Well, due
to its elegant <a class="reference internal" href="index.html#upstart-s-design-why-it-is-revolutionary">design</a> which assumes a dynamic system, it is
perfectly suited to managing a users session. Traditionally, this job
has been handled by applications such as "<tt class="docutils literal"><span class="pre">gnome-session</span></tt>", but by
moving to an Upstart-based design a lot of benefits come "for free":</p>
<ul class="simple">
<li>Event-based desktop.</li>
<li>Start desktop elements as-and-when needed or appropriate.</li>
<li>All the power of Upstarts process supervision.</li>
<li>Automatic logging of every job that runs. See <a class="reference internal" href="index.html#console-log">console log</a>.</li>
</ul>
<p>To run a Session Init, simply arrange for the first process that starts
a session to be run as "<tt class="docutils literal">init <span class="pre">--user</span></tt>". As when running as PID 1, the
Session Init will emit the "<cite>startup</cite>" event that jobs can use to react
to. All jobs that are managed by a Session Init have their parent set to
the Session Init, <em>not</em> the system init. This is because a Session Init
process is a true "sub-init". <a class="reference internal" href="index.html#jobs">Jobs</a> are loaded from potentially
multiple directories. See <a class="reference internal" href="index.html#session-job">Session Job</a> for details.</p>
<p>The advent of Session Inits removes all need for <a class="reference internal" href="index.html#user-jobs">User Jobs</a>. These
continue to be supported since the Session Init still reads the job
configuration files from the User Job directory, but that directory is
deprecated. See <a class="reference internal" href="index.html#session-job">Session Job</a> for further details.</p>
<div class="section" id="non-graphical-sessions-ubuntu-specific">
<h3><a class="toc-backref" href="index.html#toc-entry-66">4.3.1&nbsp;&nbsp;&nbsp;Non-graphical Sessions (<img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719">)</a></h3>
<p>As of Ubuntu Saucy Salamander (13.10), a <a class="reference internal" href="index.html#session-init">Session Init</a> is used to
manage the default graphical user session.</p>
<p>However, what if you want to use a <a class="reference internal" href="index.html#session-init">Session Init</a> on a server? This is
not fully supported right now, but can be achieved as follows.</p>
<p>Create <em>two</em> <a class="reference internal" href="index.html#system-job">System Job</a> similar to the following...</p>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">session-init-setup.conf</span></tt>:</p>
<pre class="literal-block"> start on runlevel [2345]
 stop on runlevel [!2345]

 task

 # XXX: configurable
 env user=james

 export user

 script
   uid=$(getent passwd "$user"|cut -d: -f3)
   gid=$(getent passwd "$user"|cut -d: -f4)

   # Create directory that would normally be
   # created by PAM when a user logs in.
   export XDG_RUNTIME_DIR="/run/user/$uid"
   mkdir -p "$XDG_RUNTIME_DIR"
   chmod 0700 "$XDG_RUNTIME_DIR"
   chown "$uid:$gid" "$XDG_RUNTIME_DIR"

  start session_init USER="$user"
end script
</pre>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">session-init.conf</span></tt>:</p>
<pre class="literal-block">instance $USER

stop on runlevel [016]

script
  uid=$(getent passwd "$USER"|cut -d: -f3)
  HOME=$(getent passwd "$USER"|cut -d: -f6)

  export XDG_RUNTIME_DIR="/run/user/$uid"
  export HOME

  exec su -s /bin/sh -c 'exec "$0" "$@"' $USER -- init --user
end script
</pre>
</li>
</ul>
<p>Notes:</p>
<ul class="simple">
<li>Two jobs are required since the <a class="reference internal" href="index.html#setuid">setuid</a> and <a class="reference internal" href="index.html#setgid">setgid</a> stanzas:<ul>
<li>Apply to all job processes. Hence, it is not possible for a single
job running as a non-privileged user to create the directory tree
required by <tt class="docutils literal">$XDG_RUNTIME_DIR</tt>.</li>
<li>Do not currently expand variables.</li>
</ul>
</li>
<li>It is imperative to set <tt class="docutils literal">$HOME</tt> and <tt class="docutils literal">$XDG_RUNTIME_DIR</tt> in the
Session Inits environment:<ul>
<li><tt class="docutils literal">$HOME</tt> is needed by most user applications.</li>
<li><tt class="docutils literal">$XDG_RUNTIME_DIR</tt> is needed by the Session Init.</li>
</ul>
</li>
</ul>
<p>The <tt class="docutils literal"><span class="pre">session-init-setup</span></tt> job will start when the system is in a
suitable state (disks mounted writeable and networking up). That job
will start the <tt class="docutils literal"><span class="pre">session-init</span></tt> <a class="reference internal" href="index.html#instance">instance</a> job which will start the
actual Session Init (which will read <a class="reference internal" href="index.html#job-configuration-files">Job Configuration Files</a> from the
usual locations for a <a class="reference internal" href="index.html#session-init">Session Init</a>).</p>
<p>To start a Session Init manually:</p>
<pre class="literal-block">$ start session-init-setup
session-init-setup stop/waiting
$ status session-init USER=james
session-init (james) start/running, process 2442
$
</pre>
<p>Note that it is possible to specify that only certain Job Configuration
File directories are read for a Session Init by specifying the
<tt class="docutils literal"><span class="pre">--confdir</span></tt> option multiple times. For example:</p>
<pre class="literal-block">init --user --confdir /etc/james/ --confdir /etc/bob/
</pre>
<p>Now, the Session Init will <em>only</em> read Job Configuration Files from
<tt class="docutils literal">/etc/james/</tt> and <tt class="docutils literal">/etc/bob/</tt>.</p>
<p>Note that this behaviour is Session Init-specific: without <tt class="docutils literal"><span class="pre">--user</span></tt>,
the system Upstart would read Job Configuration Files from the
<tt class="docutils literal">/etc/bob/</tt> directory <em>only</em>.</p>
<div class="section" id="joining-a-session">
<h4><a class="toc-backref" href="index.html#toc-entry-67">4.3.1.1&nbsp;&nbsp;&nbsp;Joining a Session</a></h4>
<p>If you have multiple sessions running for a user, or have started a
Session Init from a <a class="reference internal" href="index.html#system-job">System Job</a> as shown in the example above, it is
possible to "join" the appropriate session by simply setting the
<tt class="docutils literal">$UPSTART_SESSION</tt> environment variable.</p>
<p>For example:</p>
<pre class="literal-block">$ echo $UPSTART_SESSION

$ echo $XDG_RUNTIME_DIR

$ export XDG_RUNTIME_DIR=/run/user/$(id -u)
$ initctl list-sessions
2983 unix:abstract=/com/ubuntu/upstart-session/1000/2983
$ export UPSTART_SESSION=unix:abstract=/com/ubuntu/upstart-session/1000/2983
$ initctl list
dbus start/running, process 3188
upstart-file-bridge start/running, process 3339
gnome-settings-daemon start/running, process 3206
re-exec stop/waiting
upstart-event-bridge start/running, process 3192
    :
    :
$
</pre>
<p>The <a class="reference internal" href="index.html#initctl-list">initctl list</a> command above will now list jobs in the users
session specified by the <tt class="docutils literal">$UPSTART_SESSION</tt> environment variable.</p>
</div>
</div>
</div>
<div class="section" id="event">
<h2><a class="toc-backref" href="index.html#toc-entry-68">4.4&nbsp;&nbsp;&nbsp;Event</a></h2>
<p>A notification is sent by Upstart to all interested parties (either jobs
or other events). <span class="target" id="events">Events</span> can generally be thought of as "<a class="reference internal" href="index.html#signals">signals</a>",
"<a class="reference internal" href="index.html#methods">methods</a>", or "<a class="reference internal" href="index.html#hooks">hooks</a>" <a class="footnote-reference" href="index.html#events-are-like" id="footnote-reference-7">[25]</a>, depending on how they are
emitted and/or consumed.</p>
<p>Events are <em>emitted</em> (created and then broadcast) to the entire <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a>
system. Note that it is not possible to stop any other job or event from
seeing an event when it is emitted.</p>
<p>If there are no jobs which have registered an interest in an event in
either their <a class="reference internal" href="index.html#start-on">start on</a> or <a class="reference internal" href="index.html#stop-on">stop on</a> conditions, the event has no
effect on the system.</p>
<p>Events can be created by an administrator at any time using:</p>
<pre class="literal-block"># initctl emit &lt;event&gt;
</pre>
<p>Note that some events are "special". See the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/upstart-events.7.html">upstart-events(7)</a> manual
page for a list.</p>
<p>Note also that an event name with the same name as a job is allowed.</p>
<p>Jobs are often started or stopped as a result of <em>other</em> jobs starting or
stopping. Upstart has a special set of events that it emits to announce
these job state transitions. You'll probably notice that these events have
the same names as some of the job states described in <a class="reference internal" href="index.html#job-states">Job States</a>,
however it's important to appreciate that these are <em>not</em> describing the
same thing. Task states are not events, and events are not task states. See
<a class="reference internal" href="index.html#events-not-states">Events, not States</a> for details.</p>
<p>These events are as follows:</p>
<dl class="docutils">
<dt><tt class="docutils literal">starting</tt></dt>
<dd>This event is emitted by Upstart when a job has been scheduled to run and is
<em>about to start</em> executing.</dd>
<dt><tt class="docutils literal">started</tt></dt>
<dd>This event is emitted by Upstart when a job is now running. Note that a job
does not <em>have</em> to have an associated program or script so "running" does not
necessarily imply that any additional process is executing.</dd>
<dt><tt class="docutils literal">stopping</tt></dt>
<dd>This event is emitted by Upstart when a job is <em>about to be stopped</em>.</dd>
<dt><tt class="docutils literal">stopped</tt></dt>
<dd>This event is emitted by Upstart when a job has completed (successfully or
otherwise).</dd>
</dl>
<p>See <a class="reference internal" href="index.html#job-lifecycle">Job Lifecycle</a> for further details.</p>
<p>To help reinforce the difference, consider how Upstart itself starts:
See the <a class="reference internal" href="index.html#startup-process">Startup Process</a>.</p>
<ol class="arabic simple">
<li>It performs its internal initialization.</li>
<li>Upstart itself emits a single event called <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/startup.7.html">startup(7)</a>. This event
triggers the rest of the system to initialize. Note that there is no
"startup" job (and hence no <tt class="docutils literal">/etc/init/startup.conf</tt> file).</li>
<li><a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/init.8.html">init(8)</a> runs the mountall job (as defined in <tt class="docutils literal">/etc/init/mountall.conf</tt>)
since the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/startup.7.html">startup(7)</a> event satisfies <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/mountall.8.html">mountall(8)</a>'s requirement: "<tt class="docutils literal">start
on startup</tt>".</li>
<li>The <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/mountall.8.html">mountall(8)</a> job in turn emits a number of events (including
<a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/local-filesystems.7.html">local-filesystems(7)</a> and <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/all-swaps.7.html">all-swaps(7)</a>). See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/upstart-events.7.html">upstart-events(7)</a>
for further details.</li>
</ol>
<p><a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> provides three different <strong>types</strong> of Events.</p>
<div class="section" id="event-types">
<h3><a class="toc-backref" href="index.html#toc-entry-69">4.4.1&nbsp;&nbsp;&nbsp;Event Types</a></h3>
<div class="section" id="signals">
<h4><a class="toc-backref" href="index.html#toc-entry-70">4.4.1.1&nbsp;&nbsp;&nbsp;Signals</a></h4>
<p>A <cite>Signal Event</cite> is a <em>non-blocking (or asynchronous) event</em>. Emitting an
event of this type returns immediately, allowing the caller to continue.
Quoting from <a class="footnote-reference" href="index.html#keybuk-events-are-like-signals" id="footnote-reference-8">[26]</a>:</p>
<blockquote>
The announcer of a signal cares not whether anybody cared about it,
and doesn't wait around to see whether anything happened.  As far as the
announcer cares, it's informational only.</blockquote>
<p>Signal Events are created using the <tt class="docutils literal"><span class="pre">--no-wait</span></tt> option to the <tt class="docutils literal">initctl
emit</tt> command like this:</p>
<pre class="literal-block"># initctl emit --no-wait mysignal
</pre>
<p>The non-blocking behaviour directly affects the emitter by allowing it to
continue processing without having to wait for any jobs which make
use of the event. Jobs which make <em>use</em> of the event (via <a class="reference internal" href="index.html#start-on">start on</a> or <a class="reference internal" href="index.html#stop-on">stop
on</a>) are also affected, as they're unable to stop, delay, or in any other way
"hold up" the operation of the emitter.</p>
</div>
<div class="section" id="methods">
<h4><a class="toc-backref" href="index.html#toc-entry-71">4.4.1.2&nbsp;&nbsp;&nbsp;Methods</a></h4>
<p>A <cite>Method Event</cite> is a <em>blocking (or synchronous) event</em> which is usually
coupled with a <cite>task</cite>. It acts like a method or function call in
programming languages in that the caller is requesting that some work be
done. The caller waits for the work to be done, and if problems were
encountered, it expects to be informed of this fact.</p>
<p>Emitting a Method Event is simple:</p>
<pre class="literal-block"># initctl emit mymethod
</pre>
<p>This is exactly like a <cite>Signal Event</cite>, except the event is being emitted
synchronously such that the emitter has to wait until the <tt class="docutils literal">initctl</tt>
command completes. Once the <tt class="docutils literal">initctl</tt> command has completed, there are
two possible outcomes for the task that starts on Event <tt class="docutils literal">mymethod</tt>:</p>
<ul class="simple">
<li>The task runs successfully.</li>
<li>The task failed for some reason.</li>
</ul>
<p>Assuming we have a job configuration file <tt class="docutils literal">/etc/init/myapp.conf</tt> like
this:</p>
<pre class="literal-block">start on mymethod
task
exec /usr/bin/myapp $ACTION
</pre>
<p>You could start the <tt class="docutils literal">myapp</tt> job and check if the "method" worked as
follows:</p>
<pre class="literal-block"># initctl emit mymethod ACTION=do_something
[ $? -ne 0 ] &amp;&amp; { echo "ERROR: myapp failed"; exit 1; }
</pre>
</div>
<div class="section" id="hooks">
<h4><a class="toc-backref" href="index.html#toc-entry-72">4.4.1.3&nbsp;&nbsp;&nbsp;Hooks</a></h4>
<p>A <cite>Hook Event</cite> is a <em>blocking (or synchronous) event</em>. Quoting from
<a class="footnote-reference" href="index.html#keybuk-events-are-like-hooks" id="footnote-reference-9">[27]</a>:</p>
<blockquote>
"A hook is somewhere between a signal and a method. It's a
notification that something changed on the system, but unlike a signal,
the emitter waits for it to complete before carrying on."</blockquote>
<p>Hooks are therefore used to flag to all interested parties that
something is about to happen.</p>
<p>The canonical examples of Hooks are the two job events <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/starting.7.html">starting(7)</a>
and <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/stopping.7.html">stopping(7)</a>, emitted by <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> to indicate that a job is <em>about
to start</em> and <em>about to stop</em> respectively.</p>
</div>
</div>
<div class="section" id="events-not-states">
<h3><a class="toc-backref" href="index.html#toc-entry-73">4.4.2&nbsp;&nbsp;&nbsp;Events, not States</a></h3>
<p>Although Upstart does use states internally (and these are exposed via
the list and status commands in <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/initctl.8.html">initctl(8)</a>), events are the way that job
configuration files specify the desired behaviour of jobs:
<a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/starting.7.html">starting(7)</a>, <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/started.7.html">started(7)</a>, <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/stopping.7.html">stopping(7)</a>, <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/stopped.7.html">stopped(7)</a> are events,
not states. These events are emitted "just prior" to the particular
transition occurring. For example, the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/starting.7.html">starting(7)</a> event is emitted
just before the job associated with this event is actually queued for
start by Upstart.</p>
</div>
</div>
<div class="section" id="job-lifecycle">
<h2><a class="toc-backref" href="index.html#toc-entry-74">4.5&nbsp;&nbsp;&nbsp;Job Lifecycle</a></h2>
<div class="section" id="starting-a-job">
<h3><a class="toc-backref" href="index.html#toc-entry-75">4.5.1&nbsp;&nbsp;&nbsp;Starting a Job</a></h3>
<ol class="arabic">
<li><p class="first">Initially the job is "at rest" with a goal of <tt class="docutils literal">stop</tt> and a state of
<tt class="docutils literal">waiting</tt> (shown as <tt class="docutils literal">stop/waiting</tt> by the <a class="reference internal" href="index.html#initctl-list">initctl list</a> and
<a class="reference internal" href="index.html#initctl-status">initctl status</a> commands).</p>
</li>
<li><p class="first">The goal is changed from <tt class="docutils literal">stop</tt> to <tt class="docutils literal">start</tt> indicating the job is attempting to start.</p>
</li>
<li><p class="first">The state is changed from <tt class="docutils literal">waiting</tt> to <tt class="docutils literal">starting</tt>.</p>
</li>
<li><p class="first">The <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/starting.7.html">starting(7)</a> event is emitted denoting the job is "about to start".</p>
</li>
<li><p class="first">Any jobs whose <a class="reference internal" href="index.html#start-on">start on</a> (or <a class="reference internal" href="index.html#stop-on">stop on</a>) condition would be
satisfied by this job starting are started (or stopped respectively).</p>
</li>
<li><p class="first">The <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/starting.7.html">starting(7)</a> event completes.</p>
</li>
<li><p class="first">The state is changed from <tt class="docutils literal">starting</tt> to <tt class="docutils literal"><span class="pre">pre-start</span></tt>.</p>
</li>
<li><p class="first">If the pre-start stanza exists, the pre-start process is spawned.</p>
</li>
<li><p class="first">If the pre-start process fails, the goal is changed from <tt class="docutils literal">start</tt> to
<tt class="docutils literal">stop</tt>, and the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/stopping.7.html">stopping(7)</a> and <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/stopped.7.html">stopped(7)</a> events are emitted with
appropriate variables set denoting the error.</p>
</li>
<li><p class="first">Assuming the pre-start did not fail or did not call "<tt class="docutils literal">stop</tt>", the
main process is spawned.</p>
</li>
<li><p class="first">The state is changed from <tt class="docutils literal"><span class="pre">pre-start</span></tt> to <tt class="docutils literal">spawned</tt>.</p>
</li>
<li><p class="first">Upstart then ascertains the final PID for the job which may be a
descendent of the immediate child process if <a class="reference internal" href="index.html#expect-fork">expect fork</a> or
<a class="reference internal" href="index.html#expect-daemon">expect daemon</a> has been specified.</p>
</li>
<li><p class="first">The state is changed from <tt class="docutils literal">spawned</tt> to <tt class="docutils literal"><span class="pre">post-start</span></tt>.</p>
</li>
<li><p class="first">If the <a class="reference internal" href="index.html#post-start">post-start</a> stanza exists, the post-start process is spawned.</p>
</li>
<li><p class="first">The state is changed from <tt class="docutils literal"><span class="pre">post-start</span></tt> to <tt class="docutils literal">running</tt>.</p>
</li>
<li><p class="first">The <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/started.7.html">started(7)</a> event is emitted.</p>
<p>For <a class="reference internal" href="index.html#services">services</a>, when this event completes the main process will now be
fully running. If the job refers to a <a class="reference internal" href="index.html#task">task</a>, it will now have completed
(successfully or otherwise).</p>
</li>
<li><p class="first">Any jobs whose <a class="reference internal" href="index.html#start-on">start on</a> (or <a class="reference internal" href="index.html#stop-on">stop on</a>) condition would be
satisfied by this job being started are started (or stopped
respectively).</p>
</li>
</ol>
</div>
<div class="section" id="stopping-a-job">
<h3><a class="toc-backref" href="index.html#toc-entry-76">4.5.2&nbsp;&nbsp;&nbsp;Stopping a Job</a></h3>
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<ol class="arabic">
<li><p class="first">Assuming the job is fully running, it will have a goal of <tt class="docutils literal">start</tt>
and a state of <tt class="docutils literal">running</tt> (shown as <tt class="docutils literal">start/running</tt> by the <a class="reference internal" href="index.html#initctl-list">initctl list</a>
and <a class="reference internal" href="index.html#initctl-status">initctl status</a> commands).</p>
</li>
<li><p class="first">The goal is changed from <tt class="docutils literal">start</tt> to <tt class="docutils literal">stop</tt> indicating the job is attempting to stop.</p>
</li>
<li><p class="first">The state is changed from <tt class="docutils literal">running</tt> to <tt class="docutils literal"><span class="pre">pre-stop</span></tt>.</p>
</li>
<li><p class="first">If the <a class="reference internal" href="index.html#pre-stop">pre-stop</a> stanza exists, the pre-stop process is spawned.</p>
</li>
<li><p class="first">The state is changed from <tt class="docutils literal"><span class="pre">pre-stop</span></tt> to <tt class="docutils literal">stopping</tt>.</p>
</li>
<li><p class="first">The <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/stopping.7.html">stopping(7)</a> event is emitted.</p>
<p>The <tt class="docutils literal">stopping</tt> event has a number of associated environment
variables:</p>
<blockquote>
<ul>
<li><p class="first"><tt class="docutils literal">JOB</tt></p>
<p>The name of the job this event refers to.</p>
</li>
<li><p class="first"><tt class="docutils literal">INSTANCE</tt></p>
<p>The name of the <a class="reference internal" href="index.html#instance">instance</a> of the job this event refers to.
This will be empty for single-instance jobs (those jobs that have not
specified the <a class="reference internal" href="index.html#instance">instance</a> stanza).</p>
</li>
<li><p class="first"><tt class="docutils literal">RESULT</tt></p>
<p>This variable will have the value "<tt class="docutils literal">ok</tt>" if the job exited
normally or "<tt class="docutils literal">failed</tt>" if the job exited due to failure. Note
that Upstart's view of success and failure can be modified using the
<a class="reference internal" href="index.html#normal-exit">normal exit</a> stanza.</p>
</li>
<li><p class="first"><tt class="docutils literal">PROCESS</tt></p>
<p>The name of the script section that resulted in the failure. This
variable is not set if <tt class="docutils literal">RESULT=ok</tt>. If set, the variable will
have one of the following values:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">pre-start</span></tt></li>
<li><tt class="docutils literal"><span class="pre">post-start</span></tt></li>
<li><tt class="docutils literal">main</tt> (denoting the <tt class="docutils literal">script</tt> or <tt class="docutils literal">exec</tt> stanza)</li>
<li><tt class="docutils literal"><span class="pre">pre-stop</span></tt></li>
<li><tt class="docutils literal"><span class="pre">post-stop</span></tt></li>
<li><tt class="docutils literal">respawn</tt> (denoting the job attempted to exceed its respawn limit)</li>
</ul>
</li>
<li><p class="first"><tt class="docutils literal">EXIT_STATUS</tt> <em>or</em> <tt class="docutils literal">EXIT_SIGNAL</tt></p>
<p>Either <tt class="docutils literal">EXIT_STATUS</tt> or <tt class="docutils literal">EXIT_SIGNAL</tt> will be set, depending
on whether the job exited itself (<tt class="docutils literal">EXIT_STATUS</tt>) or was stopped
as a result of a signal (<tt class="docutils literal">EXIT_SIGNAL</tt>).</p>
<p>If neither variable is set, the process in question failed to spawn
(for example, because the specified command to run was not found).</p>
</li>
</ul>
</blockquote>
</li>
<li><p class="first">Any jobs whose <a class="reference internal" href="index.html#start-on">start on</a> (or <a class="reference internal" href="index.html#stop-on">stop on</a>) condition would be
satisfied by this job stopping are started (or stopped respectively).</p>
</li>
<li><p class="first">The main process is stopped:</p>
<ul>
<li><p class="first">The signal specified by the <a class="reference internal" href="index.html#kill-signal">kill signal</a> stanza is sent to the
process group of the main process. (such that all processes belonging to
the jobs main process are killed). By default this signal is
<tt class="docutils literal">SIGTERM</tt>.</p>
<blockquote>
<p>See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/signal.7.html">signal(7)</a> and <a class="reference external" href="http://manpages.ubuntu.com/manpages/man5/init.5.html">init(5)</a>.</p>
</blockquote>
</li>
<li><p class="first">Upstart waits for up to <a class="reference internal" href="index.html#kill-timeout">kill timeout</a> seconds (default <tt class="docutils literal">5</tt>
seconds) for the process to end.</p>
</li>
<li><p class="first">If the process is still running after the timeout, a <tt class="docutils literal">SIGKILL</tt>
signal is sent to the process which cannot be ignored and will forcibly
stop the processes in the process group.</p>
</li>
</ul>
</li>
<li><p class="first">The state is changed from <tt class="docutils literal">killed</tt> to <tt class="docutils literal"><span class="pre">post-stop</span></tt>.</p>
</li>
<li><p class="first">If the <a class="reference internal" href="index.html#post-stop">post-stop</a> stanza exists, the post-stop process is spawned.</p>
</li>
<li><p class="first">The state is changed from <tt class="docutils literal"><span class="pre">post-stop</span></tt> to <tt class="docutils literal">waiting</tt>.</p>
</li>
<li><p class="first">The <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/stopped.7.html">stopped(7)</a> event is emitted.</p>
<p>When this event completes, the job is fully stopped.</p>
</li>
<li><p class="first">Any jobs whose <a class="reference internal" href="index.html#start-on">start on</a> (or <a class="reference internal" href="index.html#stop-on">stop on</a>) condition would be
satisfied by this job being stopped are started (or stopped
respectively).</p>
</li>
</ol>
<p>Note: this information is also available in <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/upstart-events.7.html">upstart-events(7)</a>.</p>
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
</div>
</div>
<div class="section" id="ordering">
<h2><a class="toc-backref" href="index.html#toc-entry-77">4.6&nbsp;&nbsp;&nbsp;Ordering</a></h2>
<div class="section" id="order-in-which-events-are-emitted">
<h3><a class="toc-backref" href="index.html#toc-entry-78">4.6.1&nbsp;&nbsp;&nbsp;Order in which Events are Emitted</a></h3>
<p>As a general rule, <em>you cannot rely upon the the order in which events
will be emitted</em>. Your system is dynamic and Upstart responds to changes
<em>as-and-when</em> they occur (for example hot-plug events).</p>
<p>That said, most systems which use <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> provide a number of
"well-known" events which you <em>can</em> rely upon.</p>
<p>For example on <a class="reference external" href="http://www.ubuntu.com/">Ubuntu</a>, these are documented in the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/upstart-events.7.html">upstart-events(7)</a>
man page, which is included within this document for convenience in
appendix <a class="reference internal" href="index.html#ubuntu-well-known-events-ubuntu-specific">Ubuntu Well-Known Events (ubuntu-specific)</a>.</p>
</div>
<div class="section" id="order-in-which-jobs-which-start-on-the-same-event-are-run">
<h3><a class="toc-backref" href="index.html#toc-entry-79">4.6.2&nbsp;&nbsp;&nbsp;Order in Which Jobs Which <cite>start on</cite> the Same Event are Run</a></h3>
<p>Assume you have three jobs like this:</p>
<ul>
<li><p class="first"><tt class="docutils literal">/etc/init/X.conf</tt></p>
<pre class="literal-block">start on event-A
</pre>
</li>
<li><p class="first"><tt class="docutils literal">/etc/init/Y.conf</tt></p>
<pre class="literal-block">start on event-A
</pre>
</li>
<li><p class="first"><tt class="docutils literal">/etc/init/Z.conf</tt></p>
<pre class="literal-block">start on event-A
</pre>
</li>
</ul>
<p><strong>Question:</strong> If event <tt class="docutils literal"><span class="pre">event-A</span></tt> is emitted, which job will run first?</p>
<p><strong>Answer:</strong> It is not possible to say, and indeed <em>you should not make any
assumptions about the order in which jobs with the same conditions run
in</em>.</p>
</div>
<div class="section" id="ordering-of-stop-start-operations">
<h3><a class="toc-backref" href="index.html#toc-entry-80">4.6.3&nbsp;&nbsp;&nbsp;Ordering of Stop/Start Operations</a></h3>
<div class="section" id="single-job">
<h4><a class="toc-backref" href="index.html#toc-entry-81">4.6.3.1&nbsp;&nbsp;&nbsp;Single Job</a></h4>
<p>Imagine a job configuration file <tt class="docutils literal">/etc/init/odd.conf</tt> like this:</p>
<pre class="literal-block">start on event-A
stop  on event-A

script
  sleep 999
end script
</pre>
<p>Would Upstart be happy with this? Actually, yes it would! Upstart <em>always</em>
handles <cite>stop on</cite> stanzas before handling <cite>start on</cite> stanzas. This means that
this strange job would first be stopped (if it's currently running), then it
would be started.</p>
<p>We can see what happens when we run this job more clearly when we increase the
log priority to debug (see <a class="reference internal" href="index.html#change-the-log-priority">Change the log-priority</a>):</p>
<pre class="literal-block"># initctl log-priority debug
</pre>
<p>Now, we can watch the state transitions by viewing the system log.</p>
<div class="section" id="if-job-is-not-currently-running">
<h5><a class="toc-backref" href="index.html#toc-entry-82">4.6.3.1.1&nbsp;&nbsp;&nbsp;If Job is Not Currently Running</a></h5>
<pre class="literal-block"># status odd
odd stop/waiting
# initctl emit event-A
# status odd
odd start/running, process 9474
</pre>
<p>And here is an example from the system log (with annotations) showing what
happened:</p>
<pre class="literal-block">event_new: Pending event-A event               # Upstart emitted the event.
Handling event-A event
event_pending_handle_jobs: New instance odd    # Job instance created.
odd goal changed from stop to start            # Since job not running,
odd state changed from waiting to starting     # change goal to "start".
event_new: Pending starting event
Handling starting event
event_finished: Finished starting event
odd state changed from starting to pre-start
odd state changed from pre-start to spawned
odd main process (9474)                        # Start script section.
odd state changed from spawned to post-start
odd state changed from post-start to running   # Job now fully started.
event_new: Pending started event
Handling started event
event_finished: Finished started event
event_finished: Finished event-A event
</pre>
</div>
<div class="section" id="if-job-is-currently-running">
<h5><a class="toc-backref" href="index.html#toc-entry-83">4.6.3.1.2&nbsp;&nbsp;&nbsp;If Job is Currently Running</a></h5>
<pre class="literal-block"># status odd
odd stop/waiting
# start odd
odd start/running, process 11416    # Note this PID!
# status odd
odd start/running, process 11416
# initctl emit event-A
# status odd
odd start/running, process 11428    # Look! It changed!
</pre>
<p>Here is an example from the system log showing what happened in more detail.
First the entries relating to starting the job:</p>
<pre class="literal-block">odd goal changed from stop to start
odd state changed from waiting to starting
event_new: Pending starting event
Handling starting event
event_finished: Finished starting event
odd state changed from starting to pre-start
odd state changed from pre-start to spawned
odd main process (11416)
odd state changed from spawned to post-start
odd state changed from post-start to running
event_new: Pending started event
Handling started event
event_finished: Finished started event
</pre>
<p>Now, the event is emitted:</p>
<pre class="literal-block">event_new: Pending event-A event
Handling event-A event
odd goal changed from start to stop             # Job already running, so stop it.
odd state changed from running to pre-stop
odd state changed from pre-stop to stopping
event_new: Pending stopping event
event_pending_handle_jobs: New instance odd
odd goal changed from stop to start
Handling stopping event
event_finished: Finished stopping event
odd state changed from stopping to killed
Sending TERM signal to odd main process (11416) # Forcibly stop existing job process.
odd main process (11416) killed by TERM signal  # Successfully stopped it.
odd state changed from killed to post-stop
odd state changed from post-stop to starting
event_new: Pending starting event
Handling starting event
event_finished: Finished starting event
odd state changed from starting to pre-start
odd state changed from pre-start to spawned
odd main process (11428)                        # New instance of job started with new PID.
odd state changed from spawned to post-start
odd state changed from post-start to running
event_new: Pending started event
Handling started event
event_finished: Finished started event
event_finished: Finished event-A event
</pre>
</div>
</div>
<div class="section" id="multiple-jobs">
<h4><a class="toc-backref" href="index.html#toc-entry-84">4.6.3.2&nbsp;&nbsp;&nbsp;Multiple Jobs</a></h4>
<p>Upstart guarantees that jobs which <a class="reference internal" href="index.html#stop-on">stop on</a> a particular event are
processed before jobs that <a class="reference internal" href="index.html#start-on">start on</a> <em>the same event</em>.</p>
<p>Consider two jobs like this:</p>
<ul>
<li><p class="first"><tt class="docutils literal">A.conf</tt>:</p>
<pre class="literal-block">start on startup
stop on foo
</pre>
</li>
<li><p class="first"><tt class="docutils literal">B.conf</tt>:</p>
<pre class="literal-block">start on foo
</pre>
</li>
</ul>
<p>Assuming that job "<tt class="docutils literal">A</tt>" is already running, if the "<tt class="docutils literal">foo</tt>" event is
emitted, Upstart will always stop job "<tt class="docutils literal">A</tt>" before starting job
"<tt class="docutils literal">B</tt>".</p>
</div>
</div>
</div>
<div class="section" id="runlevels">
<h2><a class="toc-backref" href="index.html#toc-entry-85">4.7&nbsp;&nbsp;&nbsp;Runlevels</a></h2>
<p>A runlevel is a single-byte name for a particular system configuration.
Runlevels for <a class="reference external" href="http://www.debian.org/">Debian</a> and <a class="reference external" href="http://www.ubuntu.com/">Ubuntu</a> systems are generally as follows
<a class="footnote-reference" href="index.html#any-number-of-runlevels" id="footnote-reference-10">[34]</a>:</p>
<ul class="simple">
<li><tt class="docutils literal">0</tt> : System halt.</li>
<li><tt class="docutils literal">1</tt> : Single-User mode.</li>
<li><tt class="docutils literal">2</tt> : Graphical multi-user plus networking (<strong>DEFAULT</strong>)</li>
<li><tt class="docutils literal">3</tt> : Same as "<tt class="docutils literal">2</tt>", but not used.</li>
<li><tt class="docutils literal">4</tt> : Same as "<tt class="docutils literal">2</tt>", but not used.</li>
<li><tt class="docutils literal">5</tt> : Same as "<tt class="docutils literal">2</tt>", but not used.</li>
<li><tt class="docutils literal">6</tt> : System reboot.</li>
</ul>
<p>There are also a few pseudo-runlevels:</p>
<ul class="simple">
<li><tt class="docutils literal">N</tt> : The previous runlevel cannot be determined.</li>
<li><tt class="docutils literal">S</tt> : Alias for Single-User mode.</li>
</ul>
<div class="section" id="display-runlevel">
<h3><a class="toc-backref" href="index.html#toc-entry-86">4.7.1&nbsp;&nbsp;&nbsp;Display Runlevel</a></h3>
<p>To display your current and previous runlevels separated by a space
character, run the <tt class="docutils literal">/sbin/runlevel</tt> command. Note that if this command
is unable to determine the system runlevel, it may display simply
"<tt class="docutils literal">unknown</tt>":</p>
<pre class="literal-block">$ runlevel
N 2
</pre>
<p>The output above shows that:</p>
<ul class="simple">
<li>there was no <em>previous</em> runlevel (the system was booted and went
straight to the <em>current</em> runlevel).</li>
<li>the current runlevel is "<tt class="docutils literal">2</tt>".</li>
</ul>
</div>
<div class="section" id="change-runlevel-immediately">
<h3><a class="toc-backref" href="index.html#toc-entry-87">4.7.2&nbsp;&nbsp;&nbsp;Change Runlevel Immediately</a></h3>
<p>To change runlevel immediately, use one of the commands below:</p>
<ul class="simple">
<li><a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/reboot.8.html">reboot(8)</a></li>
<li><a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/shutdown.8.html">shutdown(8)</a></li>
<li><a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/telinit.8.html">telinit(8)</a></li>
</ul>
</div>
<div class="section" id="changing-the-default-runlevel">
<h3><a class="toc-backref" href="index.html#toc-entry-88">4.7.3&nbsp;&nbsp;&nbsp;Changing the Default Runlevel</a></h3>
<div class="section" id="permanently">
<h4><a class="toc-backref" href="index.html#toc-entry-89">4.7.3.1&nbsp;&nbsp;&nbsp;Permanently</a></h4>
<p>To change the default runlevel the system will boot into, modify the
variable <tt class="docutils literal">DEFAULT_RUNLEVEL</tt> in file <tt class="docutils literal"><span class="pre">/etc/init/rc-sysinit.conf</span></tt>. For
example, to make the system boot by default to single user mode, set:</p>
<pre class="literal-block">env DEFAULT_RUNLEVEL=1
</pre>
</div>
<div class="section" id="single-boot">
<h4><a class="toc-backref" href="index.html#toc-entry-90">4.7.3.2&nbsp;&nbsp;&nbsp;Single Boot</a></h4>
<p>If you want to change the default runlevel for a single boot, rather
than making the change permanent by modify the <tt class="docutils literal"><span class="pre">rc-sysinit.conf</span></tt> file,
simply append the variable to the kernel command line:</p>
<pre class="literal-block">DEFAULT_RUNLEVEL=1
</pre>
<p>Traditionally, the default runlevel was encoded in file
<tt class="docutils literal">/etc/inittab</tt>.  However, with Upstart, this file is no longer used
(it is supported by Upstart, but its use is deprecated).</p>
</div>
</div>
</div>
</div>
<div class="section" id="system-phases">
<h1><a class="toc-backref" href="index.html#toc-entry-91">5&nbsp;&nbsp;&nbsp;System Phases</a></h1>
<p>The information in this section relates to an Ubuntu system.</p>
<p>To obtain a better understanding of how jobs and events relate at
startup and shutdown time, see <a class="reference internal" href="index.html#visualising-jobs-and-events">Visualising Jobs and Events</a>.</p>
<div class="section" id="startup">
<h2><a class="toc-backref" href="index.html#toc-entry-92">5.1&nbsp;&nbsp;&nbsp;Startup</a></h2>
<p>At boot, after the initramfs system has been run (for setting up RAID,
unlocking encrypted file system volumes, <em>et cetera</em>), Upstart will be
given control. The initramfs environment will <a class="reference external" href="http://manpages.ubuntu.com/manpages/man3/exec.3.html">exec(3)</a> <tt class="docutils literal">/sbin/init</tt>
(this is the main Upstart binary) and cause it to run as PID 1.</p>
<div class="section" id="startup-process">
<h3><a class="toc-backref" href="index.html#toc-entry-93">5.1.1&nbsp;&nbsp;&nbsp;Startup Process</a></h3>
<p>Note that in this section we assume the default runlevel is "<tt class="docutils literal">2</tt>".
See <a class="reference internal" href="index.html#changing-the-default-runlevel">Changing the Default Runlevel</a> for further details.</p>
<ol class="arabic">
<li><p class="first">Upstart performs its internal initialization.</p>
</li>
<li><p class="first">Upstart itself emits a single <em>event</em> called <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/startup.7.html">startup(7)</a>.</p>
<p>This event triggers the rest of the system to initialize
<a class="footnote-reference" href="index.html#no-startup-file" id="footnote-reference-11">[33]</a>.</p>
</li>
<li><p class="first"><a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/init.8.html">init(8)</a> runs a small number of <em>jobs</em> which specify the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/startup.7.html">startup(7)</a>
event in their <a class="reference internal" href="index.html#start-on">start on</a> condition.</p>
<p>The most notable of these is the <tt class="docutils literal">mountall</tt> job which mounts your
disks and filesystems.</p>
</li>
<li><p class="first">The <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/mountall.8.html">mountall(8)</a> job in turn emits a number of events.</p>
<p>These include <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/local-filesystems.7.html">local-filesystems(7)</a>, <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/virtual-filesystems.7.html">virtual-filesystems(7)</a> and
<a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/all-swaps.7.html">all-swaps(7)</a>. See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/upstart-events.7.html">upstart-events(7)</a> for further details.</p>
</li>
<li><p class="first">The <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/virtual-filesystems.7.html">virtual-filesystems(7)</a> event causes the <tt class="docutils literal">udev</tt> job to start.</p>
</li>
<li><p class="first">The <tt class="docutils literal">udev</tt> job causes the <a class="reference internal" href="index.html#upstart-udev-bridge">upstart-udev-bridge</a> job to start.</p>
</li>
<li><p class="first">The <a class="reference internal" href="index.html#upstart-udev-bridge">upstart-udev-bridge</a> job will at some point emit the
"<tt class="docutils literal"><span class="pre">net-device-up</span> IFACE=lo</tt>" event signifying the local network
(for example, <tt class="docutils literal">127.0.0.0</tt> for IPv4) is available.</p>
</li>
<li><p class="first">After the last filesystem is mounted, <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/mountall.8.html">mountall(8)</a> will emit the
<tt class="docutils literal">filesystem</tt> event.</p>
</li>
<li><p class="first">Since the <a class="reference internal" href="index.html#start-on">start on</a> condition for the <tt class="docutils literal"><span class="pre">rc-sysinit</span></tt> job is:</p>
<pre class="literal-block">start on filesystem and net-device-up IFACE=lo
</pre>
<p>Upstart will then start the <tt class="docutils literal"><span class="pre">rc-sysinit</span></tt> job.</p>
</li>
<li><p class="first">The <tt class="docutils literal"><span class="pre">rc-sysinit</span></tt> job calls the <tt class="docutils literal">telinit</tt> command, passing it the
runlevel to move to:</p>
<pre class="literal-block">telinit 2
</pre>
</li>
<li><p class="first">The <tt class="docutils literal">telinit</tt> command emits the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/runlevel.7.html">runlevel(7)</a> event as:</p>
<pre class="literal-block">runlevel RUNLEVEL=2 PREVLEVEL=N
</pre>
<p>Note that this is <em>all</em> the <tt class="docutils literal">telinit</tt> command does  it runs no
commands itself to change runlevel!</p>
<p>See <a class="reference internal" href="index.html#runlevels">Runlevels</a> for further information on runlevels.</p>
</li>
<li><p class="first">The <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/runlevel.7.html">runlevel(7)</a> event causes many other Upstart jobs to start,
including <tt class="docutils literal">/etc/init/rc.conf</tt> which starts the legacy SystemV init
system.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="shutdown">
<h2><a class="toc-backref" href="index.html#toc-entry-94">5.2&nbsp;&nbsp;&nbsp;Shutdown</a></h2>
<div class="section" id="observations">
<h3><a class="toc-backref" href="index.html#toc-entry-95">5.2.1&nbsp;&nbsp;&nbsp;Observations</a></h3>
<p>There are some important points related to system shutdown:</p>
<ul>
<li><p class="first">Upstart never shuts down itself</p>
<p>Upstart will "die" when the system is powered off, but if <em>it</em> ever
exits, that is a bug.</p>
</li>
<li><p class="first">Upstart never stops a job with no <a class="reference internal" href="index.html#stop-on">stop on</a> condition.</p>
</li>
<li><p class="first">Ubuntu employs both Upstart and SysV jobs.</p>
<p>Ubuntu currently employs a hybrid system where core services are handled
by Upstart, but additional services can be run in the legacy SystemV
mode. This may seem odd, but consider that there are thousands of
packages available in Ubuntu via the Universe and Multiverse
repositories and <em>hundreds</em> of services. To avoid having to change every
package to work with Upstart, Upstart allows packages to utilize their
existing SystemV (and thus Debian-compatible) scripts.</p>
</li>
</ul>
</div>
<div class="section" id="shutdown-process">
<h3><a class="toc-backref" href="index.html#toc-entry-96">5.2.2&nbsp;&nbsp;&nbsp;Shutdown Process</a></h3>
<p>To initiate a shutdown, perform one of the following actions:</p>
<ul>
<li><p class="first">Click "Shut Down..." (or equivalent) in your graphical environment (for example Gnome)</p>
</li>
<li><p class="first">Run the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/shutdown.8.html">shutdown(8)</a> command, for example:</p>
<pre class="literal-block"># shutdown -h now
</pre>
</li>
</ul>
<p>The following steps will now be taken:</p>
<ol class="arabic">
<li><p class="first">Assuming the current runlevel is "<tt class="docutils literal">2</tt>", either of the actions above
will cause Upstart to emit the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/runlevel.7.html">runlevel(7)</a> event like this:</p>
<pre class="literal-block">runlevel RUNLEVEL=0 PREVLEVEL=2
</pre>
</li>
<li><p class="first">The job <tt class="docutils literal">/etc/init/rc.conf</tt> will be run.</p>
<p>This job calls <tt class="docutils literal">/etc/init.d/rc</tt> passing it the new runlevel ("<tt class="docutils literal">0</tt>").</p>
</li>
<li><p class="first">The SystemV system will then invoke the necessary scripts in
<tt class="docutils literal">/etc/rc0.d/</tt> to stop SystemV services.</p>
</li>
<li><p class="first">One of the scripts run is <tt class="docutils literal">/etc/init.d/sendsigs</tt>.</p>
<p>This script will kill any remaining processes not already stopped
(including Upstart processes).</p>
</li>
</ol>
</div>
</div>
<div class="section" id="reboot">
<h2><a class="toc-backref" href="index.html#toc-entry-97">5.3&nbsp;&nbsp;&nbsp;Reboot</a></h2>
<p>To initiate a reboot, perform one of the following actions:</p>
<ul>
<li><p class="first">Click "Restart..." (or equivalent) in your graphical environment (for example Gnome)</p>
</li>
<li><p class="first">Run the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/shutdown.8.html">shutdown(8)</a> command specifying the "<tt class="docutils literal"><span class="pre">-r</span></tt>" option, for example:</p>
<pre class="literal-block"># shutdown -r now
</pre>
</li>
<li><p class="first">Run the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/reboot.8.html">reboot(8)</a> command:</p>
<pre class="literal-block"># reboot
</pre>
</li>
</ul>
<p>The following will steps will now be taken:</p>
<ol class="arabic">
<li><p class="first">Assuming the current runlevel is "<tt class="docutils literal">2</tt>", whichever command is run
above will cause Upstart to emit the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/runlevel.7.html">runlevel(7)</a> event like this:</p>
<pre class="literal-block">runlevel RUNLEVEL=6 PREVLEVEL=2
</pre>
</li>
<li><p class="first">The job <tt class="docutils literal">/etc/init/rc.conf</tt> will be run.</p>
<p>This job calls <tt class="docutils literal">/etc/init.d/rc</tt> passing it the new runlevel ("<tt class="docutils literal">6</tt>").</p>
</li>
<li><p class="first">The SystemV system will then invoke the necessary scripts in
<tt class="docutils literal">/etc/rc6.d/</tt> to stop SystemV services.</p>
</li>
<li><p class="first">One of the scripts run is <tt class="docutils literal">/etc/init.d/sendsigs</tt>.</p>
<p>This script will kill any remaining processes not already stopped
(including Upstart processes).</p>
</li>
</ol>
</div>
<div class="section" id="single-user-mode">
<h2><a class="toc-backref" href="index.html#toc-entry-98">5.4&nbsp;&nbsp;&nbsp;Single-User Mode</a></h2>
<p>When booting direct into single-user mode, the <tt class="docutils literal">runlevel</tt> command will
show:</p>
<pre class="literal-block"># runlevel
N S
</pre>
<p>See <a class="reference internal" href="index.html#runlevels">Runlevels</a>.</p>
</div>
<div class="section" id="recovery-mode-ubuntu-specific">
<h2><a class="toc-backref" href="index.html#toc-entry-99">5.5&nbsp;&nbsp;&nbsp;Recovery Mode (<img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719">)</a></h2>
<p><a class="reference external" href="http://www.ubuntu.com/">Ubuntu</a> provides a recovery mode in case your system experiences
problems. This is handled by the <tt class="docutils literal"><span class="pre">friendly-recovery</span></tt> package. If you
select a "<cite>recovery mode</cite>" option on the Grub menu. This makes the
initramfs pass a flag to Upstart which ensures that the
<cite>/etc/init/friendly-recovery.conf</cite> Upstart job is the first job run
after Upstart starts. As a result, this job has full control over the
system and provides a friendly menu that allows users to check disks
with <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/fsck.8.html">fsck(8)</a>, repair your package database and so on.</p>
</div>
<div class="section" id="failsafe-mode-ubuntu-specific">
<h2><a class="toc-backref" href="index.html#toc-entry-100">5.6&nbsp;&nbsp;&nbsp;Failsafe Mode (<img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719">)</a></h2>
<p>This is a new phase introduced in Ubuntu 11.10 that borrows an idea from
Google's Chrome OS. A new job called <cite>failsafe</cite> has been introduced that
checks to ensure the system has reached a particular state. If the
expected state is not attained, the job reboots the system automatically.</p>
</div>
</div>
<div class="section" id="configuration">
<h1><a class="toc-backref" href="index.html#toc-entry-101">6&nbsp;&nbsp;&nbsp;Configuration</a></h1>
<p>This section lists a number of job configuration file stanzas, giving
example usage for each. The reference for your specific version of
<a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> will be available in the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man5/init.5.html">init(5)</a> man page.
<a class="footnote-reference" href="index.html#ubuntu-specific-config" id="footnote-reference-12">[18]</a></p>
<div class="section" id="stanzas-by-category">
<h2><a class="toc-backref" href="index.html#toc-entry-102">6.1&nbsp;&nbsp;&nbsp;Stanzas by Category</a></h2>
<table border="1" class="docutils">
<caption>Configuration Stanzas by Category
         (detail in brackets show version of Upstart stanza added)</caption>
<colgroup>
<col width="45%">
<col width="30%">
<col width="25%">
</colgroup>
<thead valign="bottom">
<tr><th class="head">Category</th>
<th class="head">Stanzas</th>
<th class="head">Added in Version</th>
</tr>
</thead>
<tbody valign="top">
<tr><td rowspan="6">Process Definition</td>
<td><a class="reference internal" href="index.html#exec">exec</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#pre-start">pre-start</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#post-start">post-start</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#pre-stop">pre-stop</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#post-stop">post-stop</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#script">script</a></td>
<td>&nbsp;</td>
</tr>
<tr><td rowspan="3">Event Definition</td>
<td><a class="reference internal" href="index.html#manual">manual</a></td>
<td>0.6.7</td>
</tr>
<tr><td><a class="reference internal" href="index.html#start-on">start on</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#stop-on">stop on</a></td>
<td>&nbsp;</td>
</tr>
<tr><td rowspan="2">Job Environment</td>
<td><a class="reference internal" href="index.html#env">env</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#export">export</a></td>
<td>&nbsp;</td>
</tr>
<tr><td rowspan="4">Services, tasks and respawning</td>
<td><a class="reference internal" href="index.html#normal-exit">normal exit</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#respawn">respawn</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#respawn-limit">respawn limit</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#task">task</a></td>
<td>&nbsp;</td>
</tr>
<tr><td>Instances</td>
<td><a class="reference internal" href="index.html#instance">instance</a></td>
<td>&nbsp;</td>
</tr>
<tr><td rowspan="5">Documentation</td>
<td><a class="reference internal" href="index.html#author">author</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#description">description</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#emits">emits</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#version">version</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#usage">usage</a></td>
<td>1.5</td>
</tr>
<tr><td rowspan="15">Process environment</td>
<td><a class="reference internal" href="index.html#apparmor-load">apparmor load</a></td>
<td>1.9</td>
</tr>
<tr><td><a class="reference internal" href="index.html#apparmor-switch">apparmor switch</a></td>
<td>1.9</td>
</tr>
<tr><td><a class="reference internal" href="index.html#cgroup">cgroup</a></td>
<td>1.13</td>
</tr>
<tr><td><a class="reference internal" href="index.html#console-none">console none</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#console-log">console log</a></td>
<td>1.4</td>
</tr>
<tr><td><a class="reference internal" href="index.html#console-output">console output</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#console-owner">console owner</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#chdir">chdir</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#chroot">chroot</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#limit">limit</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#nice">nice</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#oom-score">oom score</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#setgid">setgid</a></td>
<td>1.4</td>
</tr>
<tr><td><a class="reference internal" href="index.html#setuid">setuid</a></td>
<td>1.4</td>
</tr>
<tr><td><a class="reference internal" href="index.html#umask">umask</a></td>
<td>&nbsp;</td>
</tr>
<tr><td rowspan="6">Process Control</td>
<td><a class="reference internal" href="index.html#expect-fork">expect fork</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#expect-daemon">expect daemon</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#expect-stop">expect stop</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#kill-signal">kill signal</a></td>
<td>1.3</td>
</tr>
<tr><td><a class="reference internal" href="index.html#kill-timeout">kill timeout</a></td>
<td>&nbsp;</td>
</tr>
<tr><td><a class="reference internal" href="index.html#reload-signal">reload signal</a></td>
<td>1.10</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="apparmor">
<h2><a class="toc-backref" href="index.html#toc-entry-103">6.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">apparmor</tt></a></h2>
<div class="section" id="apparmor-load">
<h3><a class="toc-backref" href="index.html#toc-entry-104">6.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">apparmor load</tt></a></h3>
<p>Load specified <a class="reference external" href="http://wiki.apparmor.net/index.php/Main_Page">AppArmor Mandatory Access Control system</a> profile into
the kernel prior to starting the job. The main job process (as specified
by <a class="reference internal" href="index.html#exec">exec</a> or <a class="reference internal" href="index.html#script">script</a>) will be confined to this profile.</p>
<p>Syntax:</p>
<pre class="literal-block">apparmor load &lt;profile-path&gt;
</pre>
<p>Notes:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">&lt;profile-path&gt;</span></tt> must be an absolute path.</li>
<li>The job will fail if the profile doesn't exist, or the profile fails
to load.</li>
</ul>
<p>Example:</p>
<pre class="literal-block">apparmor load /etc/apparmor.d/usr.sbin.cupsd
exec /usr/sbin/cupsd -F
</pre>
</div>
<div class="section" id="apparmor-switch">
<h3><a class="toc-backref" href="index.html#toc-entry-105">6.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">apparmor switch</tt></a></h3>
<p>Run main job process with already-loaded <a class="reference external" href="http://wiki.apparmor.net/index.php/Main_Page">AppArmor Mandatory Access
Control system</a> profile.</p>
<p>Syntax:</p>
<pre class="literal-block">apparmor switch &lt;profile-name&gt;
</pre>
<p>Notes:</p>
<ul class="simple">
<li>The job will fail if the profile named does not exist, or is not
already loaded.</li>
</ul>
<p>Example:</p>
<pre class="literal-block">apparmor switch /usr/bin/cupsd
exec /usr/sbin/cupsd -F
</pre>
</div>
</div>
<div class="section" id="author">
<h2><a class="toc-backref" href="index.html#toc-entry-106">6.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">author</tt></a></h2>
<p>Syntax:</p>
<pre class="literal-block">author &lt;string&gt;
</pre>
<p>Quoted name (and maybe contact details) of author of this <a class="reference internal" href="index.html#job-configuration-file">Job
Configuration File</a>.</p>
<p>Example:</p>
<pre class="literal-block">author "Scott James Remnant &lt;scott@netsplit.com&gt;"
</pre>
</div>
<div class="section" id="cgroup">
<h2><a class="toc-backref" href="index.html#toc-entry-107">6.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">cgroup</tt></a></h2>
<p>Upstart 1.13 supports cgroups with the aid of <a class="reference external" href="https://cgmanager.linuxcontainers.org/">cgmanager</a> (see
<a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/cgmanager.8.html">cgmanager(8)</a>).</p>
<p>A new "<tt class="docutils literal">cgroup</tt>" stanza is introduced that allows job processes to be
run within the specified cgroup.</p>
<p>Syntax:</p>
<pre class="literal-block">cgroup CONTROLLER [ NAME ] [ KEY VALUE ]
</pre>
<p>This allows the job to specify the control group <em>all</em> job processes will run
in and optionally specify a setting for the particular cgroup.</p>
<p>Important:</p>
<ul class="simple">
<li>This stanza will be ignored if the version of Upstart is new
enough to support cgroups but has been built without cgroup support.</li>
<li>This stanza will also be ignored if the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/init.8.html">init(8)</a> daemon has had
cgroup support disabled at boot time (see <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/init.8.html">init(8)</a>).</li>
<li>A job which specifies this stanza will not be started until both
its start on condition is met and the address of the cgroup manager has been
communicated to the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/init.8.html">init(8)</a> daemon using the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/initctl.8.html">initctl(8)</a> command
<a class="reference internal" href="index.html#initctl-notify-cgroup-manager-address">initctl notify-cgroup-manager-address</a>.</li>
</ul>
<p>If only the cgroup controller (such as <tt class="docutils literal">memory</tt>, <tt class="docutils literal">cpuset</tt>, <tt class="docutils literal">blkio</tt>) is
specified, a job-specific cgroup will be created and the job processes placed
in it. The form of this cgroup is:</p>
<pre class="literal-block">upstart/$UPSTART_JOB
</pre>
<p>... or if the job specifies the instance stanza the group will be
the expanded value of:</p>
<pre class="literal-block">upstart/$UPSTART_JOB-$UPSTART_INSTANCE
</pre>
<p>Any forward slashes in <tt class="docutils literal">$UPSTART_JOB</tt> and <tt class="docutils literal">$UPSTART_INSTANCE</tt> will
be replaced with underscore ("<tt class="docutils literal">_</tt>") characters.</p>
<p>This default cgroup for the job may be specified explicitly
within a <tt class="docutils literal">NAME</tt> using the special variable "<tt class="docutils literal">$UPSTART_CGROUP</tt>". This
variable is not an environment variable and is only valid within the context of
the cgroup stanza.</p>
<p>If <tt class="docutils literal">NAME</tt> is not specified or does not contain "<tt class="docutils literal">$UPSTART_CGROUP</tt>", the job
processes will not be placed in an upstart-specific group.</p>
<p>Note that this special variable cannot be specified with enclosing braces around the name.</p>
<p>No validation is performed on the specified values until the job is due to be
started.</p>
<p>If the <tt class="docutils literal">CONTROLLER</tt> is invalid, or the <tt class="docutils literal">NAME</tt> cannot be created or the
<tt class="docutils literal">KEY</tt> or <tt class="docutils literal">VALUE</tt> are invalid, the job will be failed.</p>
<p>The <tt class="docutils literal">NAME</tt> argument may contain any valid variable and can also contain
forward slashes to run the job processes in a sub-cgroup.</p>
<p>If any argument contains space characters, it must be quoted.</p>
<p>If a KEY is specified, a <tt class="docutils literal">VALUE</tt> must also be specified (even it is simply an
empty string).</p>
<p>The stanza maybe specified multiple times. The last occurence will be used
except in the scenario where each occurence specifies a different KEY in which
case all the keys and values will be applied.</p>
<p>It is not an error if <tt class="docutils literal">NAME</tt> already exists.</p>
<p>Valid syntax examples:</p>
<ul>
<li><p class="first">Implicit <tt class="docutils literal">NAME</tt>, no setting:</p>
<pre class="literal-block">cgroup CONTROLLER
</pre>
</li>
<li><p class="first">Explicit <tt class="docutils literal">NAME</tt>, no setting:</p>
<pre class="literal-block">cgroup CONTROLLER NAME
</pre>
</li>
<li><p class="first">Implicit <tt class="docutils literal">NAME</tt> with setting:</p>
<pre class="literal-block">cgroup CONTROLLER KEY VALUE
</pre>
</li>
<li><p class="first">Explicit <tt class="docutils literal">NAME</tt> with setting:</p>
<pre class="literal-block">cgroup CONTROLLER NAME KEY VALUE
</pre>
</li>
</ul>
<p>Examples:</p>
<ul>
<li><p class="first">Run all job processes in the default <tt class="docutils literal">cpu</tt> cgroup controller group:</p>
<pre class="literal-block">cgroup cpu
</pre>
</li>
<li><p class="first">As above:</p>
<pre class="literal-block">cgroup cpu $UPSTART_CGROUP
</pre>
</li>
<li><p class="first">As above:</p>
<pre class="literal-block">cgroup cpu "$UPSTART_CGROUP"
</pre>
</li>
<li><p class="first">Attempt to place the job processes in a non-job-specific cgroup:</p>
<pre class="literal-block">cgroup cpu "a-well-known-cgroup"
</pre>
</li>
<li><p class="first">The job will only start once the manager is up and running and will have a
50MB memory limit, be restricted to CPU ids 0 and 1 and have a 1MB/s write
limit to the block device 8:16. The job will fail to start if the system has
less than 50MB of RAM or less than 2 CPUs:</p>
<pre class="literal-block">cgroup memory $UPSTART_CGROUP limit_in_bytes 52428800
cgroup cpuset $UPSTART_CGROUP cpus 0-1
cgroup blkio slowio throttle.write_bps_device "8:16 1048576"
</pre>
</li>
</ul>
</div>
<div class="section" id="console">
<h2><a class="toc-backref" href="index.html#toc-entry-108">6.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">console</tt></a></h2>
<p>For all versions of Upstart prior to v1.4, the default value for <tt class="docutils literal">console</tt>
was <tt class="docutils literal">console none</tt>. As of Upstart 1.4, the default value is <tt class="docutils literal">console log</tt>.
If you are using Upstart 1.4 or later and wish to retain the old default, boot
specifying the <tt class="docutils literal"><span class="pre">--no-log</span></tt> command-line option. An alternative is to boot
using the <tt class="docutils literal"><span class="pre">--default-console</span> &lt;value&gt;</tt> option which allows the default
<tt class="docutils literal">console</tt> value for jobs to be specified. Using this option it is possible to
set the default to <tt class="docutils literal">none</tt> but still honour jobs that specify explicitly
<a class="reference internal" href="index.html#console-log">console log</a>.</p>
<div class="section" id="console-log">
<h3><a class="toc-backref" href="index.html#toc-entry-109">6.5.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">console log</tt></a></h3>
<p>Connects standard input to <tt class="docutils literal">/dev/null</tt>. Standard output and standard
error are connected to one end of a pseudo-terminal such that any job
output is automatically logged to a file in directory
<tt class="docutils literal">/var/log/upstart/</tt> for System Jobs and <tt class="docutils literal">$XDG_CACHE_HOME/upstart/</tt>
(or <tt class="docutils literal"><span class="pre">$HOME/.cache/upstart/</span></tt> if <tt class="docutils literal">$XDG_CACHE_HOME</tt> is not set) for
<a class="reference internal" href="index.html#session-jobs">Session Jobs</a>.</p>
<p>The log directory can be changed by specifying the <tt class="docutils literal"><span class="pre">--logdir</span>
&lt;directory&gt;</tt> command-line option.</p>
<p>If a <a class="reference internal" href="index.html#user-job">User Job</a> running in a pre-Upstart 1.7 environment specifies this
stanza, Upstart will treat
the job as if it had specified <a class="reference internal" href="index.html#console-none">console none</a>.</p>
</div>
<div class="section" id="console-none">
<h3><a class="toc-backref" href="index.html#toc-entry-110">6.5.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">console none</tt></a></h3>
<p>Connects the job's standard input, standard output and standard error
file descriptors to <tt class="docutils literal">/dev/null</tt>.</p>
</div>
<div class="section" id="console-output">
<h3><a class="toc-backref" href="index.html#toc-entry-111">6.5.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">console output</tt></a></h3>
<p>Connects the job's standard input, standard output and standard error
file descriptors to the console device.</p>
<div class="section" id="example-of-console-output">
<h4><a class="toc-backref" href="index.html#toc-entry-112">6.5.3.1&nbsp;&nbsp;&nbsp;Example of <tt class="docutils literal">console output</tt></a></h4>
<pre class="literal-block">console output

pre-start script

  # Perform whatever checks you like here (maybe checking
  # '/etc/default/foo' to see if the service is enabled # or not).
  #
  # if there are no problems detected, simply "exit 0", else do
  # something like this...

  # display an error message to stderr *on the console* and also write
  # the same message to the system log.
  logger -is -t "$UPSTART_JOB" "ERROR: foo!"

  # tell Upstart not to start the main process for the job.
  exit 1
end script

# this service doesn't do much :-)
exec sleep 999
</pre>
<p>See <a class="reference internal" href="index.html#pre-start">pre-start</a>.</p>
</div>
</div>
<div class="section" id="console-owner">
<h3><a class="toc-backref" href="index.html#toc-entry-113">6.5.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">console owner</tt></a></h3>
<p>Identical to <a class="reference internal" href="index.html#console-output">console output</a> except that additionally it makes the job the
owner of the console device. This means it will receive certain signals from
the kernel when special key combinations such as Control-C are pressed.</p>
</div>
</div>
<div class="section" id="chdir">
<h2><a class="toc-backref" href="index.html#toc-entry-114">6.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">chdir</tt></a></h2>
<p>Syntax:</p>
<pre class="literal-block">chdir &lt;directory&gt;
</pre>
<p>Runs the job's processes with a working directory in the specified
directory instead of the root of the filesystem.</p>
<p>Example:</p>
<pre class="literal-block">chdir /var/mydaemon
</pre>
</div>
<div class="section" id="chroot">
<h2><a class="toc-backref" href="index.html#toc-entry-115">6.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal">chroot</tt></a></h2>
<p>Syntax:</p>
<pre class="literal-block">chroot &lt;directory&gt;
</pre>
<p>Runs the job's processes in a <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/chroot.8.html">chroot(8)</a> environment underneath the
specified directory.</p>
<p>Note that the specified directory must have all the necessary system libraries
for the process to be run, often including <tt class="docutils literal">/bin/sh</tt>.</p>
<p>Example:</p>
<pre class="literal-block">chroot /srv/chroots/oneiric
</pre>
</div>
<div class="section" id="description">
<h2><a class="toc-backref" href="index.html#toc-entry-116">6.8&nbsp;&nbsp;&nbsp;<tt class="docutils literal">description</tt></a></h2>
<p>Syntax:</p>
<pre class="literal-block">description &lt;string&gt;
</pre>
<p>One line quoted description of <a class="reference internal" href="index.html#job-configuration-file">Job Configuration File</a>. For example:</p>
<pre class="literal-block">description "OpenSSH server"
</pre>
</div>
<div class="section" id="emits">
<h2><a class="toc-backref" href="index.html#toc-entry-117">6.9&nbsp;&nbsp;&nbsp;<tt class="docutils literal">emits</tt></a></h2>
<p>Syntax:</p>
<pre class="literal-block">emits &lt;values&gt;
</pre>
<p>Specifies the events the job configuration file generates (directly or
indirectly via a child process). This stanza can be specified multiple
times for each event emitted. This stanza can also use the following
shell wildcard meta-characters to simplify the specification:</p>
<ul class="simple">
<li>asterisk ("<tt class="docutils literal">*</tt>")</li>
<li>question mark ("<tt class="docutils literal">?</tt>")</li>
<li>square brackets ("<tt class="docutils literal">[</tt>"  and "<tt class="docutils literal">]</tt>")</li>
</ul>
<p>For example, <a class="reference internal" href="index.html#upstart-udev-bridge">upstart-udev-bridge</a> can emit a large number of
events. Rather than having to specify every possible event, since the
form of the event names is consistent, a single  <tt class="docutils literal">emits</tt> stanza
can be specified to cover all possible events:</p>
<pre class="literal-block">emits *-device-*
</pre>
<p>Further Examples:</p>
<pre class="literal-block">emits foo-event bar-event wibble-event
emits hello
</pre>
</div>
<div class="section" id="end-script">
<h2><a class="toc-backref" href="index.html#toc-entry-118">6.10&nbsp;&nbsp;&nbsp;<tt class="docutils literal">end script</tt></a></h2>
<p>This pseudo-stanza acts as a terminator for script sections:</p>
<ul class="simple">
<li><a class="reference internal" href="index.html#script">script</a>.</li>
<li><a class="reference internal" href="index.html#pre-start">pre-start</a> script.</li>
<li><a class="reference internal" href="index.html#post-start">post-start</a> script.</li>
<li><a class="reference internal" href="index.html#pre-stop">pre-stop</a> script.</li>
<li><a class="reference internal" href="index.html#post-start">post-start</a> script.</li>
</ul>
</div>
<div class="section" id="env">
<h2><a class="toc-backref" href="index.html#toc-entry-119">6.11&nbsp;&nbsp;&nbsp;<tt class="docutils literal">env</tt></a></h2>
<p>Syntax:</p>
<pre class="literal-block">env KEY[=VALUE]
</pre>
<p>Allows an environment variable to be set which is accessible in all
script sections.</p>
<p>Example:</p>
<pre class="literal-block">env myvar="hello world"

script
  echo "myvar='$myvar'" &gt; /run/script.log
end script
</pre>
<p>See <a class="reference internal" href="index.html#environment-variables">Environment Variables</a>.</p>
</div>
<div class="section" id="exec">
<h2><a class="toc-backref" href="index.html#toc-entry-120">6.12&nbsp;&nbsp;&nbsp;<tt class="docutils literal">exec</tt></a></h2>
<p>Syntax:</p>
<pre class="literal-block">exec COMMAND [ ARG ]...
</pre>
<p>Stanza that allows the specification of a single-line command to run. Note that
if this command-line contains any shell meta-characters, it will be passed
through a shell prior to being executed. This ensures that shell redirection
and variable expansion occur as expected.</p>
<p>Example:</p>
<pre class="literal-block">exec /usr/bin/my-daemon --option foo -v
</pre>
</div>
<div class="section" id="expect">
<h2><a class="toc-backref" href="index.html#toc-entry-121">6.13&nbsp;&nbsp;&nbsp;<tt class="docutils literal">expect</tt></a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This stanza is <em>extremely</em> important: read this section carefully!</p>
</div>
<p><a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> will keep track of the process ID that it thinks belongs to a
job. If a job has specified the <a class="reference internal" href="index.html#instance">instance</a> stanza, Upstart will track
the PIDs for each unique instance of that job.</p>
<p>If you do not specify the <tt class="docutils literal">expect</tt> stanza, Upstart will track the life
cycle of the <em>first</em> PID that it executes in the <a class="reference internal" href="index.html#exec">exec</a> or <a class="reference internal" href="index.html#script">script</a>
stanzas. However, most Unix services will "daemonize", meaning that they
will create a new process (using <a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/fork.2.html">fork(2)</a>) which is a child of the
initial process. Often services will "double fork" to ensure they have
no association whatsoever with the initial process. (Note that no
services will fork more than twice initially since there is no
additional benefit in doing so).</p>
<p>In this case, Upstart must have a way to track it, so you can use
<a class="reference internal" href="index.html#expect-fork">expect fork</a>, or <a class="reference internal" href="index.html#expect-daemon">expect daemon</a> which allows Upstart to use
<a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/ptrace.2.html">ptrace(2)</a> to "count forks".</p>
<p>To allow Upstart to determine the <em>final</em> process ID for a job, it needs
to know how many times that process will call <a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/fork.2.html">fork(2)</a>. Upstart itself
cannot know the answer to this question since once a daemon is running,
it could then fork a number of "worker" processes which could themselves
fork any number of times. Upstart cannot be expected to know which
PID is the "master" in this case, considering it does not know if worker
processes will be created at all, let alone how many times, or how many
times the process will fork initially. As such, it is necessary to
<em>tell</em> Upstart which PID is the "master" or parent PID. This is achieved
using the <tt class="docutils literal">expect</tt> stanza.</p>
<p>The syntax is simple, but you do need to know <em>how many times your
service forks</em>.</p>
<p>Note that most daemons fork twice.</p>
<p>If your daemon has a "don't daemonize" or "run in the foreground" mode,
then it's much simpler to use that and not run with fork following. One
issue with that though, is that Upstart will emit the <tt class="docutils literal">started
JOB=yourjob</tt> event as soon as it has executed your daemon, which may be
before it has had time to listen for incoming connections or fully
initialize.</p>
<p>A final point: the <tt class="docutils literal">expect</tt> stanza <em>only</em> applies to <a class="reference internal" href="index.html#exec">exec</a> and
<a class="reference internal" href="index.html#script">script</a> stanzas: it has <em>no</em> effect on <a class="reference internal" href="index.html#pre-start">pre-start</a> and <a class="reference internal" href="index.html#post-start">post-start</a>.</p>
<p>It's important to note that the "<tt class="docutils literal">expect</tt>" stanza is thus being used
for two different but complementary tasks:</p>
<ul class="simple">
<li>Identifying service readiness.</li>
<li>PID tracking.</li>
</ul>
<div class="section" id="expect-fork">
<h3><a class="toc-backref" href="index.html#toc-entry-122">6.13.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">expect fork</tt></a></h3>
<p><a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> will expect the process executed to call <a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/fork.2.html">fork(2)</a> exactly <em>once</em>.</p>
<p>Some daemons fork a new copy of themselves on <tt class="docutils literal">SIGHUP</tt>, which means when the
Upstart <a class="reference internal" href="index.html#reload">reload</a> command is used, Upstart will lose track of this daemon. In
this case, <tt class="docutils literal">expect fork</tt> cannot be used. See <a class="reference internal" href="index.html#daemon-behaviour">Daemon Behaviour</a>.</p>
</div>
<div class="section" id="expect-daemon">
<h3><a class="toc-backref" href="index.html#toc-entry-123">6.13.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">expect daemon</tt></a></h3>
<p><a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> will expect the process executed to call <a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/fork.2.html">fork(2)</a> exactly <em>twice</em>.</p>
</div>
<div class="section" id="expect-stop">
<h3><a class="toc-backref" href="index.html#toc-entry-124">6.13.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">expect stop</tt></a></h3>
<p>Specifies that the job's main process will raise the <tt class="docutils literal">SIGSTOP</tt> signal
to indicate that it is ready. <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/init.8.html">init(8)</a> will wait for this signal and
then:</p>
<ol class="arabic simple">
<li>Immediately send the process <tt class="docutils literal">SIGCONT</tt> to allow it to continue.</li>
<li>Run the job's <a class="reference internal" href="index.html#post-start">post-start</a> script (if any).</li>
</ol>
<p>Only then will Upstart consider the job to be running.</p>
</div>
<div class="section" id="how-to-establish-fork-count">
<h3><a class="toc-backref" href="index.html#toc-entry-125">6.13.4&nbsp;&nbsp;&nbsp;How to Establish Fork Count</a></h3>
<p>If the application you are attempting to create a Job Configuration File
does not document how many times it forks, you can run it with a tool
such as <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/strace.1.html">strace(1)</a> which will allow you to count the number of forks.
For example:</p>
<pre class="literal-block"># Trace all children of /usr/bin/myapp
$ sudo strace -o /tmp/strace.log -fFv /usr/bin/myapp --arg foo --hello wibble &amp;

# After allowing some "reasonable" time for the app to start, kill it and strace
$ sudo killall -9 strace

# Display the number of forks
#
#   1 =&gt; specify "expect fork"
#   2 =&gt; specify "expect daemon"
#
$ sudo egrep "\&lt;(fork|clone)\&gt;\(" /tmp/strace.log | wc | awk '{print $1}'
</pre>
</div>
<div class="section" id="implications-of-misspecifying-expect">
<h3><a class="toc-backref" href="index.html#toc-entry-126">6.13.5&nbsp;&nbsp;&nbsp;Implications of Misspecifying <tt class="docutils literal">expect</tt></a></h3>
<p>The table below summarizes the behaviour resulting for every combination
of <a class="reference internal" href="index.html#expect">expect</a> stanza and number of <a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/fork.2.html">fork(2)</a> calls:</p>
<table border="1" class="docutils">
<caption>Expect Stanza Behaviour</caption>
<colgroup>
<col width="10%">
<col width="31%">
<col width="31%">
<col width="28%">
</colgroup>
<thead valign="bottom">
<tr><th class="head">&nbsp;</th>
<th class="head" colspan="3">Specification of Expect Stanza</th>
</tr>
<tr><th class="head">Forks</th>
<th class="head">no <tt class="docutils literal">expect</tt></th>
<th class="head"><tt class="docutils literal">expect fork</tt></th>
<th class="head"><tt class="docutils literal">expect daemon</tt></th>
</tr>
</thead>
<tbody valign="top">
<tr><td>0</td>
<td>Correct</td>
<td><a class="reference internal" href="index.html#start">start</a> hangs</td>
<td><a class="reference internal" href="index.html#start">start</a> hangs</td>
</tr>
<tr><td>1</td>
<td>Wrong pid tracked </td>
<td>Correct</td>
<td><a class="reference internal" href="index.html#start">start</a> hangs</td>
</tr>
<tr><td>2</td>
<td>Wrong pid tracked </td>
<td>Wrong pid tracked </td>
<td>Correct</td>
</tr>
</tbody>
</table>
<p>Key:</p>
<blockquote>
'<tt class="docutils literal"></tt>' - No PID will be displayed.</blockquote>
</div>
<div class="section" id="recovery-on-misspecification-of-expect">
<h3><a class="toc-backref" href="index.html#toc-entry-127">6.13.6&nbsp;&nbsp;&nbsp;Recovery on Misspecification of <tt class="docutils literal">expect</tt></a></h3>
<div class="section" id="when-start-hangs">
<h4><a class="toc-backref" href="index.html#toc-entry-128">6.13.6.1&nbsp;&nbsp;&nbsp;When <tt class="docutils literal">start</tt> hangs</a></h4>
<p>The <a class="reference internal" href="index.html#start">start</a> command will "hang" if you have misspecified the <a class="reference internal" href="index.html#expect">expect</a> stanza
by telling Upstart to expect more <a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/fork.2.html">fork(2)</a> calls than your application
actually makes.</p>
<p>To resolve the situation:</p>
<ol class="arabic">
<li><p class="first">Interrupt the <a class="reference internal" href="index.html#start">start</a> command by using "<tt class="docutils literal">CONTROL+c</tt>"
(or sending the process the <tt class="docutils literal">SIGINT</tt> signal).</p>
</li>
<li><p class="first">Run the <a class="reference internal" href="index.html#initctl-status">initctl status</a> command for your job.
You will see something like:</p>
<pre class="literal-block">myjob start/spawned, process 1234
</pre>
<p>You'll notice that the PID shown <em>is</em> actually correct since Upstart has
tracked the initial PID.</p>
</li>
<li><p class="first"><a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/kill.1.html">Kill(1)</a> the PID of your application.</p>
</li>
<li><p class="first">Re-run the <a class="reference internal" href="index.html#initctl-status">initctl status</a> command for your job.
You will see something like:</p>
<pre class="literal-block">myjob stop/waiting
</pre>
</li>
<li><p class="first">Correct the <a class="reference internal" href="index.html#expect">expect</a> stanza specification in the job configuration file.</p>
</li>
</ol>
</div>
<div class="section" id="when-wrong-pid-is-tracked">
<h4><a class="toc-backref" href="index.html#toc-entry-129">6.13.6.2&nbsp;&nbsp;&nbsp;When Wrong PID is Tracked</a></h4>
<p>If you have misspecified the <a class="reference internal" href="index.html#expect">expect</a> stanza by telling Upstart to expect
fewer <a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/fork.2.html">fork(2)</a> calls than your application actually makes, Upstart will be
unable to manage it since it will be looking at the wrong PID. The <a class="reference internal" href="index.html#start">start</a>
command <em>will</em> start your job, but it will show unexpected output (the goal and
state will be shown as <tt class="docutils literal">stop/waiting</tt>).</p>
<p>To resolve the situation:</p>
<ol class="arabic">
<li><p class="first">Run the <a class="reference internal" href="index.html#initctl-status">initctl status</a> command for your job.
You will see something like:</p>
<pre class="literal-block">myjob stop/waiting
</pre>
<p>Notice that no PID is displayed.</p>
</li>
<li><p class="first">Find your jobs PID using <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/ps.1.html">ps(1)</a>.
(If you're struggling to find it, remember that the parent PID will always be "<tt class="docutils literal">1</tt>").</p>
</li>
<li><p class="first"><a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/kill.1.html">Kill(1)</a> the PID of your application.</p>
</li>
<li><p class="first">Correct the <a class="reference internal" href="index.html#expect">expect</a> stanza specification in the job configuration file.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="section" id="export">
<h2><a class="toc-backref" href="index.html#toc-entry-130">6.14&nbsp;&nbsp;&nbsp;<tt class="docutils literal">export</tt></a></h2>
<p>Export variables previously set with <a class="reference internal" href="index.html#env">env</a> to <em>all</em> events that result
from this job. See for example <a class="reference internal" href="index.html#job-lifecycle">Job Lifecycle</a>.</p>
<p>Note that <em>no</em> leading dollar sign (<tt class="docutils literal">$</tt>) is specified.</p>
<p>Example:</p>
<pre class="literal-block">env myvar="hello world"
export myvar
</pre>
</div>
<div class="section" id="instance">
<h2><a class="toc-backref" href="index.html#toc-entry-131">6.15&nbsp;&nbsp;&nbsp;<tt class="docutils literal">instance</tt></a></h2>
<p>Sometimes you want to run the same job, but with different arguments.
The variable that defines the unique instance of this job is defined
with <tt class="docutils literal">instance</tt>.</p>
<div class="section" id="a-simple-instance-example">
<h3><a class="toc-backref" href="index.html#toc-entry-132">6.15.1&nbsp;&nbsp;&nbsp;A Simple Instance Example</a></h3>
<p>Let us start with a simple example which we will call "<tt class="docutils literal">foo.conf</tt>":</p>
<pre class="literal-block">instance $BAR

script
  . /etc/default/myapp-${BAR}

  echo "hello from instance $BAR"
  sleep 999
end script
</pre>
<p>The example above defines an instance job by specifying the <tt class="docutils literal">instance</tt>
stanza followed by the <em>name</em> of a variable (note that you <em>MUST</em>
specify the dollar sign ('<tt class="docutils literal">$</tt>').</p>
<p>Note that the <strong>entire</strong> job <em>is</em> the instance job: providing the
<tt class="docutils literal">instance</tt> stanza allows Upstart to make each running version of this
job unique.</p>
<p>The job first sources an instance-specific configuration file
("<tt class="docutils literal"><span class="pre">myapp-${BAR}</span></tt>") then displays a message. Note again that we're now
<em>using</em> that instance variable <tt class="docutils literal">$BAR</tt>.</p>
<p>So, let's start an instance of this job:</p>
<pre class="literal-block">$ sudo start foo
start: Unknown parameter: BAR
</pre>
<p>Oops! We forgot to specify the particular value for the <tt class="docutils literal">BAR</tt> variable
which makes each instance unique. Lets try again:</p>
<pre class="literal-block">$ sudo start foo BAR=bar
foo (bar) start/running, process 1234
</pre>
<p>So, we now have one instance running. Let's start another:</p>
<pre class="literal-block">$ sudo start foo BAR=bar
start: Job is already running: foo (bar)
</pre>
<p>Oops! We tried to run another instance with the same instance name
(well, the same value of the <tt class="docutils literal">BAR</tt> variable technically). Lets try
again:</p>
<pre class="literal-block">$ sudo start foo BAR=baz
foo (baz) start/running, process 1235
</pre>
<p>Okay. We should now have two instance running, but let us confirm that:</p>
<pre class="literal-block">$ initctl list | grep ^foo
foo (bar) start/running, process 1234
foo (baz) start/running, process 1235
</pre>
<p>Good - Upstart is running two instances as expected. Notice the instance
name in brackets after the job name in the <a class="reference internal" href="index.html#initctl">initctl</a> output above.</p>
<p>We will start one more instance:</p>
<pre class="literal-block">$ sudo start foo BAR="hello world"
$ initctl list | grep ^foo
foo (bar) start/running, process 1234
foo (baz) start/running, process 1235
foo (hello world) start/running, process 1236
</pre>
<p>Let's try to stop the instances:</p>
<pre class="literal-block">$ sudo stop foo
stop: Unknown parameter: BAR
</pre>
<p>That fails as Upstart needs to know <em>which</em> instance to stop and we
didn't specify an instance value for the <tt class="docutils literal">BAR</tt> instance variable.
Rather than stopping each instance in turn, let's script it so that we
can stop then all in one go:</p>
<pre class="literal-block">$ initctl list | grep "^foo " | cut -d\( -f2 | cut -d\) -f1 | while read i
do
  sudo stop foo BAR="$i"
done
foo stop/waiting
foo stop/waiting
foo stop/waiting
$
</pre>
<p>All unique instances of the <tt class="docutils literal">foo</tt> job are now stopped.</p>
</div>
<div class="section" id="another-instance-example">
<h3><a class="toc-backref" href="index.html#toc-entry-133">6.15.2&nbsp;&nbsp;&nbsp;Another Instance Example</a></h3>
<p>Lets say that once <tt class="docutils literal">memcached</tt> is up and running, we want to start a queue
worker for each directory in <tt class="docutils literal">/var/lib/queues</tt>:</p>
<pre class="literal-block"># queue-workers

start on started memcached

task

script
  for dir in `ls /var/lib/queues` ; do
    start queue-worker QUEUE=$dir
  done
end script
</pre>
<p>And now:</p>
<pre class="literal-block"># queue-worker

stop on stopping memcached

respawn

instance $QUEUE

exec /usr/local/bin/queue-worker $QUEUE
</pre>
<p>In this way, Upstart will keep them all running with the specified
arguments, and stop them if <tt class="docutils literal">memcached</tt> is ever stopped.</p>
<p>The <tt class="docutils literal">instance</tt> stanza is designed to make a running job unique.</p>
<p>Notes:</p>
<ul>
<li><p class="first">the stanza isn't restricted to a single value. You can do silly things like
the following if you wish:</p>
<pre class="literal-block">instance ${myvar1}hello${myvar2}-foo/\wibble${var3}{$JOB}
</pre>
<p>See <a class="reference internal" href="index.html#multiple-running-job-instances-without-pid">Multiple Running Job Instances Without PID</a> for another crazy
real-life example.</p>
</li>
<li><p class="first">You <em>must</em> include at least one variable and it <em>must</em> have a leading dollar
sign (<tt class="docutils literal">$</tt>):</p>
<pre class="literal-block"># GOOD (value can be changed by specifying different values
# for the variable called 'foo')
instance $foo

# BAD (value will always be the string literal "foo")
instance foo
</pre>
</li>
<li><p class="first">If you attempt to start a job with the <tt class="docutils literal">instance</tt> stanza, but forget to
provide the required variables, you will get an error since Upstart cannot
then guarantee uniqueness. For example, if you have a job configuration file
<tt class="docutils literal">foo.conf</tt> such as this:</p>
<pre class="literal-block">instance $bar

script
  sleep 999
end script
</pre>
<p>Attempting to start it <em>without</em> specifying a value for foo will fail:</p>
<pre class="literal-block"># start foo
start: Unknown parameter: bar
</pre>
<p>Let's try again:</p>
<pre class="literal-block"># start foo bar=1
foo (1) start/running, process 30003
</pre>
<p>And now let's start another instance:</p>
<pre class="literal-block"># start foo bar="hello 1,2,3"
foo (hello 1,2,3) start/running, process 30008
</pre>
<p>Finally, let's see the current state of our two job instances:</p>
<pre class="literal-block">$ initctl list|grep ^foo
foo (1) start/running, process 30003
foo (hello 1,2,3) start/running, process 30008
</pre>
</li>
</ul>
<p>Note that to obtain correct <a class="reference internal" href="index.html#restart">restart</a> behaviour, you would need to do
something like the following:</p>
<pre class="literal-block"># worker.conf
instance $id
exec myworker name=$id

# workers.conf
pre-start script
    for inst in a b c
    do
        start worker id=$inst
    done
end script

post-stop script
    for inst in `initctl list|grep "^worker "|awk '{print $2}'|tr -d ')'|tr -d '('`
    do
        stop worker id=$inst
    done
end script
</pre>
<p>Note that "<tt class="docutils literal">workers.conf</tt>" has no main <a class="reference internal" href="index.html#exec">exec</a> or <a class="reference internal" href="index.html#script">script</a> section - this
"master" job will run (without a pid) for the duration that the slave or children
(individual "<tt class="docutils literal">worker</tt>") job instances run:</p>
<pre class="literal-block">$ initctl list|grep ^worker
worker stop/waiting
workers stop/waiting
$ start workers
workers start/running
$ initctl list|grep ^worker
worker (c) start/running, process 12226
worker (b) start/running, process 12223
worker (a) start/running, process 12221
workers start/running
$ restart workers
workers start/running
$ initctl list|grep ^worker
worker (c) start/running, process 12246
worker (b) start/running, process 12244
worker (a) start/running, process 12242
workers start/running
$ stop workers
workers stop/waiting
$ initctl list|grep ^worker
worker stop/waiting
workers stop/waiting
</pre>
<p>Note further that if any worker fails to start or stop, this wil fail the
overall "<tt class="docutils literal">workers</tt>" job. If you don't want this behaviour, use the "<tt class="docutils literal">||
true</tt>" trick:</p>
<pre class="literal-block"># workers.conf
pre-start script
    for inst in a b c
    do
        start worker id=$inst || :
    done
end script

post-stop script
    for inst in `initctl list|grep "^worker "|awk '{print $2}'|tr -d ')'|tr -d '('`
    do
        stop worker id=$inst || :
    done
end script
</pre>
</div>
<div class="section" id="starting-an-instance-job-without-specifying-an-instance-value">
<h3><a class="toc-backref" href="index.html#toc-entry-134">6.15.3&nbsp;&nbsp;&nbsp;Starting an Instance Job Without Specifying an Instance Value</a></h3>
<p>Note that if you have a job which makes use of <tt class="docutils literal">instance</tt> but which
may need to be run manually by an administrator, it is possible to
"cheat" and allow them to start the job <em>without</em> specifying an explicit
instance value:</p>
<pre class="literal-block"># /etc/init/trickery.conf
start on foo

instance $UPSTART_EVENTS
env UPSTART_EVENTS=
</pre>
<p>Now, an Administrator can start this job as follows:</p>
<pre class="literal-block"># start trickery
</pre>
<p>And this will work even if there is already a running instance of the
<tt class="docutils literal">trickery</tt> job (assuming the existing instance was started
automatically).</p>
<p>This bit of trickery relies upon the fact that Upstart will set the
<tt class="docutils literal">$UPSTART_EVENTS</tt> environment variable before starting this job as a
result of its <a class="reference internal" href="index.html#start-on">start on</a> condition becoming true. In this case, Upstart
would therefore set <tt class="docutils literal"><span class="pre">UPSTART_EVENTS='foo'</span></tt>.</p>
<p>However, since the job sets a null default value for this variable, when
an Administrator starts the job, <tt class="docutils literal">UPSTART_EVENTS</tt> will be set to a
null value. This empty value is enough to make that instance unique
(since there are no other instances with a null instance value!)</p>
<p>See <a class="reference internal" href="index.html#environment-variables">Environment Variables</a> for details of <tt class="docutils literal">$UPSTART_EVENTS</tt>.</p>
</div>
</div>
<div class="section" id="kill-signal">
<h2><a class="toc-backref" href="index.html#toc-entry-135">6.16&nbsp;&nbsp;&nbsp;<tt class="docutils literal">kill signal</tt></a></h2>
<p>Specifies the stopping signal, <tt class="docutils literal">SIGTERM</tt> by default, a job's main
process will receive when stopping the running job.</p>
<p>The signal should be specified as a full name (for example <tt class="docutils literal">SIGTERM</tt>)
or a partial name (for example <tt class="docutils literal">TERM</tt>). Note that it is possible to
specify the signal as a number (for example <tt class="docutils literal">15</tt>) although this should be
avoided if at all possible since signal numbers may differ between systems.</p>
<p>Examples:</p>
<pre class="literal-block">kill signal INT
kill signal SIGINT
</pre>
<p>Note that if you are running an older version of Upstart without this
feature, and you have an application which breaks with the normal
conventions for shutdown signal, you can simulate it to some degree by
using <a class="reference internal" href="index.html#start-stop-daemon-8">start-stop-daemon(8)</a> with the <tt class="docutils literal"><span class="pre">--signal</span></tt> option:</p>
<pre class="literal-block">start on some-event

env cmd=/usr/bin/foo

exec start-stop-daemon --start --exec $cmd

pre-stop exec start-stop-daemon --signal QUIT --stop --exec $cmd
</pre>
</div>
<div class="section" id="kill-timeout">
<h2><a class="toc-backref" href="index.html#toc-entry-136">6.17&nbsp;&nbsp;&nbsp;<tt class="docutils literal">kill timeout</tt></a></h2>
<p>The number of seconds <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> will wait before killing a process. The
default is 5 seconds.</p>
<p>Example:</p>
<pre class="literal-block">kill timeout 20
</pre>
</div>
<div class="section" id="limit">
<h2><a class="toc-backref" href="index.html#toc-entry-137">6.18&nbsp;&nbsp;&nbsp;<tt class="docutils literal">limit</tt></a></h2>
<p>Provides the ability to specify resource limits for a job.</p>
<p>For example, to allow a job to open any number of files, specify:</p>
<pre class="literal-block">limit nofile unlimited unlimited
</pre>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If a user job specifies this stanza, it may fail to start should it
specify a value greater than the users privilege level allows.</p>
</div>
<p>For further details on the available limits see <a class="reference external" href="http://manpages.ubuntu.com/manpages/man5/init.5.html">init(5)</a> and
<a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/getrlimit.2.html">getrlimit(2)</a>.</p>
</div>
<div class="section" id="manual">
<h2><a class="toc-backref" href="index.html#toc-entry-138">6.19&nbsp;&nbsp;&nbsp;<tt class="docutils literal">manual</tt></a></h2>
<p><em>Added in Upstart v0.6.7</em></p>
<p>This stanza will tell Upstart to ignore the start on / stop on stanzas. It is
useful for keeping the logic and capability of a job on the system while not
having it automatically start at boot-up.</p>
<p>Example:</p>
<pre class="literal-block">manual
</pre>
</div>
<div class="section" id="nice">
<h2><a class="toc-backref" href="index.html#toc-entry-139">6.20&nbsp;&nbsp;&nbsp;<tt class="docutils literal">nice</tt></a></h2>
<p>Change the jobs scheduling priority from the default. See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/nice.1.html">nice(1)</a>.</p>
<p>Example:</p>
<pre class="literal-block"># run with lowest priority
nice 19
</pre>
</div>
<div class="section" id="normal-exit">
<h2><a class="toc-backref" href="index.html#toc-entry-140">6.21&nbsp;&nbsp;&nbsp;<tt class="docutils literal">normal exit</tt></a></h2>
<p>Used to change Upstart's idea of what a "normal" exit status is.
Conventionally, processes exit with status <tt class="docutils literal">0</tt> (zero) to denote success
and non-zero to denote failure. If your application can exit with exit
status <tt class="docutils literal">13</tt> and you want <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> to consider this as an normal
(successful) exit, then you can specify:</p>
<pre class="literal-block">normal exit 0 13
</pre>
<p>You can even specify signals. A signal can be specified either as a full
name (for example <tt class="docutils literal">SIGTERM</tt>) or a partial name (for example <tt class="docutils literal">TERM</tt>);</p>
<p>For example, to consider exit codes <cite>0</cite> and <cite>13</cite> as success and also to
consider the program to have completed successfully if it exits on
signal <tt class="docutils literal">SIGUSR1</tt> and <tt class="docutils literal">SIGWINCH</tt>, specify:</p>
<pre class="literal-block">normal exit 0 13 SIGUSR1 SIGWINCH
</pre>
<p>Equivalently, you could specify:</p>
<pre class="literal-block">normal exit 0 13 USR1 WINCH
</pre>
</div>
<div class="section" id="oom-score">
<h2><a class="toc-backref" href="index.html#toc-entry-141">6.22&nbsp;&nbsp;&nbsp;<tt class="docutils literal">oom score</tt></a></h2>
<p>Linux has an "Out of Memory" killer facility. This is a feature of the
kernel that will detect if a process is consuming increasingly more
memory. Once "triggered", the kernel automatically takes action by
killing the rogue process to avoid it impacting the system adversely.</p>
<p>Normally the OOM killer regards all processes equally, this stanza
advises the kernel to treat this job differently.</p>
<p>The "adjustment" value provided to this stanza may be an integer value
from <tt class="docutils literal"><span class="pre">-999</span></tt> (very unlikely to be killed by the OOM killer) up to
<tt class="docutils literal">1000</tt> (very likely to be killed by the  OOM killer).  It  may also
be the special value <tt class="docutils literal">never</tt> to have the job ignored by the OOM killer
entirely (potentially dangerous unless you <em>really</em> trust the
application in all possible system scenarios).</p>
<p>Example:</p>
<pre class="literal-block"># this application is a "resource hog"
oom score 1000

expect daemon
respawn
exec /usr/bin/leaky-app
</pre>
</div>
<div class="section" id="post-start">
<h2><a class="toc-backref" href="index.html#toc-entry-142">6.23&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">post-start</span></tt></a></h2>
<p>Syntax:</p>
<pre class="literal-block">post-start exec|script
</pre>
<p>Script or process to run <em>after</em> the main process has been spawned, but before
the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/started.7.html">started(7)</a> event has been emitted.</p>
<p>Use this stanza when a delay (or some arbitrary condition) must be satisfied
before an executed job is considered "started". An example is <a class="reference external" href="http://www.mysql.com/">MySQL</a>. After
executing it, it may need to perform recovery operations before accepting
network traffic. Rather than start dependent services, you can have a
post-start like this:</p>
<pre class="literal-block">post-start script
  while ! mysqladmin ping localhost ; do sleep 1 ; done
end script
</pre>
</div>
<div class="section" id="post-stop">
<h2><a class="toc-backref" href="index.html#toc-entry-143">6.24&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">post-stop</span></tt></a></h2>
<p>Syntax:</p>
<pre class="literal-block">post-stop exec|script
</pre>
<p>There are times where the cleanup done in <a class="reference internal" href="index.html#pre-start">pre-start</a> is not
enough. Ultimately, the cleanup should be done both pre-start and
<a class="reference internal" href="index.html#post-stop">post-stop</a>, to ensure the service starts with a consistent environment,
and does not leave behind anything that it shouldn't.</p>
<p><tt class="docutils literal">exec /some/directory/script</tt></p>
<p>If it is possible, you'll want to run your daemon with a simple <tt class="docutils literal">exec</tt>
line. Something like this:</p>
<pre class="literal-block">exec /usr/bin/mysqld
</pre>
<p>If you need to do some scripting before starting the daemon, script works fine here. Here is one example of using a script stanza that may be non-obvious:</p>
<pre class="literal-block"># statd - NSM status monitor

description   "NSM status monitor"
author                "Steve Langasek &lt;steve.langasek@canonical.com&gt;"

start on (started portmap or mounting TYPE=nfs)
stop on stopping portmap

expect fork
respawn

env DEFAULTFILE=/etc/default/nfs-common

pre-start script
    if [ -f "$DEFAULTFILE" ]; then
        . "$DEFAULTFILE"
    fi

    [ "x$NEED_STATD" != xno ] || { stop; exit 0; }

    start portmap || true
    status portmap | grep -q start/running
    exec sm-notify
end script

script
    if [ -f "$DEFAULTFILE" ]; then
        . "$DEFAULTFILE"
    fi

    if [ "x$NEED_STATD" != xno ]; then
        exec rpc.statd -L $STATDOPTS
    fi
end script
</pre>
<p>Because this job is marked <a class="reference internal" href="index.html#respawn">respawn</a>, an exit of <tt class="docutils literal">0</tt> is "ok" and will
not force a respawn (only exiting with a non-<tt class="docutils literal">0</tt> exit or being killed by
an unexpected signal causes a respawn), this script stanza is used to
start the optional daemon <tt class="docutils literal">rpc.statd</tt> based on the defaults file. If
<tt class="docutils literal">NEED_STATD=no</tt> is in <tt class="docutils literal"><span class="pre">/etc/default/nfs-common</span></tt>, this job will run
this snippet of script, and then the script will exit with <tt class="docutils literal">0</tt> as its
return code. Upstart will not respawn it, but just gracefully see that
it has stopped on its own, and return to <tt class="docutils literal">stopped</tt> status. If,
however, <tt class="docutils literal">rpc.statd</tt> had been run, it would stay in the
<tt class="docutils literal">start/running</tt> state and be tracked normally.</p>
</div>
<div class="section" id="pre-start">
<h2><a class="toc-backref" href="index.html#toc-entry-144">6.25&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">pre-start</span></tt></a></h2>
<p>Syntax:</p>
<pre class="literal-block">pre-start exec|script
</pre>
<p>Use this stanza to prepare the environment for the job. Clearing out cache/tmp
dirs is a good idea, but any heavy logic is discouraged, as Upstart job files
should read like configuration files, not so much like complicated software.</p>
<pre class="literal-block">pre-start script
  [ -d "/var/cache/squid" ] || squid -k
end script
</pre>
<p>Another possibility is to cancel the start of the job for some reason. One
good reason is that it's clear from the system configuration that a service is
not needed:</p>
<pre class="literal-block">pre-start script
  if ! grep -q 'parent=foo' /etc/bar.conf ; then
    stop ; exit 0
  fi
end script
</pre>
<p>Note that the "<tt class="docutils literal">stop</tt>" command did not receive any arguments. This is a
shortcut available to jobs where the "<tt class="docutils literal">stop</tt>" command will look at the
current environment and determine that you mean to stop the current job.</p>
<div class="section" id="pre-start-example-debian-and-ubuntu-specific">
<h3><a class="toc-backref" href="index.html#toc-entry-145">6.25.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">pre-start</span></tt> example (<img alt="D" class="debian-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/4926319605052bdf09442836fd8d799b236e5db8"> , <img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719">)</a></h3>
<p>On <a class="reference external" href="http://www.ubuntu.com/">Ubuntu</a>, the common <tt class="docutils literal"><span class="pre">pre-start</span></tt> idiom is to use
<tt class="docutils literal">/etc/default/myapp</tt>, so the example would become:</p>
<pre class="literal-block">pre-start script

  # stop job from continuing if no config file found for daemon
  [ ! -f /etc/default/myapp ] &amp;&amp; { stop; exit 0; }

  # source the config file
  . /etc/default/myapp

  # stop job from continuing if admin has not enabled service in
  # config file.
  [ -z "$ENABLED" ] &amp;&amp; { stop; exit 0; }

end script
</pre>
<p>This is safe since the job will not start (technically it won't progress
beyond the <tt class="docutils literal"><span class="pre">pre-start</span></tt> stage) if:</p>
<ul class="simple">
<li>the config file does not exist.</li>
<li>the config file has not been modified to enable the service.</li>
</ul>
<p>Note that the example above assumes your applications configuration file
is shell-compatible (in other words it contains <tt class="docutils literal"><span class="pre">name="value"</span></tt>
entries). If this is not the case, just use <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/grep.1.html">grep(1)</a> or similar:</p>
<pre class="literal-block">enabled=$(grep ENABLED=1 $CONFIG)
[ -z "$enabled" ] &amp;&amp; exit 0
</pre>
<p>Or something like this:</p>
<pre class="literal-block">if ! grep -q DISABLED=false /etc/default/myapp; then
  stop ; exit 0
fi
</pre>
<p>See <a class="reference internal" href="index.html#example-of-console-output">Example of console output</a> for another of example where you can
display an error message if the job detects it should not be started.</p>
</div>
</div>
<div class="section" id="pre-stop">
<h2><a class="toc-backref" href="index.html#toc-entry-146">6.26&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">pre-stop</span></tt></a></h2>
<p>Syntax:</p>
<pre class="literal-block">pre-stop exec|script
</pre>
<p>The <tt class="docutils literal"><span class="pre">pre-stop</span></tt> stanza will be executed <em>before</em> the job's <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/stopping.7.html">stopping(7)</a>
event is emitted and <strong>before the main process is killed</strong>.</p>
<p>Stopping a job involves sending <tt class="docutils literal">SIGTERM</tt> to it. If there is anything that
needs to be done before <tt class="docutils literal">SIGTERM</tt>, do it here. Arguably, services should
handle <tt class="docutils literal">SIGTERM</tt> very gracefully, so this shouldn't be necessary. However, if
the service takes more than <a class="reference internal" href="index.html#kill-timeout">kill timeout</a> seconds (default, 5 seconds) then
it will be sent <tt class="docutils literal">SIGKILL</tt>, so if there is anything critical, like a flush to
disk, and raising <a class="reference internal" href="index.html#kill-timeout">kill timeout</a> is not an option, pre-stop is not a bad place
to do it. <a class="footnote-reference" href="index.html#pre-stop-bug" id="footnote-reference-13">[20]</a></p>
<p>You can also use this stanza to cancel the stop, in a similar fashion
to the way one can cancel the start in the <a class="reference internal" href="index.html#pre-start">pre-start</a>.</p>
</div>
<div class="section" id="reload-signal">
<h2><a class="toc-backref" href="index.html#toc-entry-147">6.27&nbsp;&nbsp;&nbsp;<tt class="docutils literal">reload signal</tt></a></h2>
<p>Specifies the signal that Upstart will send to the jobs main process
when the job needs to be reloaded (the default is <tt class="docutils literal">SIGHUP</tt>).</p>
<p>The signal should be specified as a full name (for example
<tt class="docutils literal">SIGHUP</tt>) or a partial name (for example <tt class="docutils literal">HUP</tt>). Note that it is
possible to specify the signal as a number (for example <tt class="docutils literal">1</tt>) although
this should be avoided if at all possible since signal numbers may
differ between systems.</p>
<p>Examples:</p>
<pre class="literal-block">reload signal SIGUSR1
reload signal USR1
</pre>
</div>
<div class="section" id="respawn">
<h2><a class="toc-backref" href="index.html#toc-entry-148">6.28&nbsp;&nbsp;&nbsp;<tt class="docutils literal">respawn</tt></a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you are creating a new Job Configuration File, <em>do not</em> specify
the <tt class="docutils literal">respawn</tt> stanza until you are fully satisfied you have specified
the <a class="reference internal" href="index.html#expect">expect</a> stanza correctly. If you <em>do</em>, you will find the behaviour
potentially very confusing.</p>
</div>
<p>Without this stanza, a job that exits quietly transitions into the
<tt class="docutils literal">stop/waiting</tt> state, no matter how it exited.</p>
<p>With this stanza, whenever the main script/exec exits, without the goal of the
job having been changed to <tt class="docutils literal">stop</tt>, the job will be started again. This
includes running <a class="reference internal" href="index.html#pre-start">pre-start</a>, <a class="reference internal" href="index.html#post-start">post-start</a> and <a class="reference internal" href="index.html#post-stop">post-stop</a>. Note that
<a class="reference internal" href="index.html#pre-stop">pre-stop</a> will not be run.</p>
<p>There are a number of reasons why you may or may not want to use this. For
most traditional network services this makes good sense. If the tracked
process exits for some reason that wasn't the administrator's intent,
you probably want to start it back up again.</p>
<p>Likewise, for tasks, (see below), respawning means that you want that
task to be retried until it exits with zero (0) as its exit code.</p>
<p>One situation where it may seem like respawn should be avoided, is when
a daemon does not respond well to <tt class="docutils literal">SIGTERM</tt> for stopping it. You may
believe that you need to send the service its shutdown command without
Upstart being involved, and therefore, you don't want to use respawn
because Upstart will keep trying to start your service back up when you
told it to shutdown.</p>
<p>However, the appropriate way to handle that situation is a <a class="reference internal" href="index.html#pre-stop">pre-stop</a> which
runs this shutdown command. Since the job's goal will already be 'stop'
when a pre-stop is run, you can shutdown the process through any means,
and the process won't be re-spawned (even with the respawn stanza).</p>
<p>Note that if a job is respawned, the variable "<tt class="docutils literal">$PROCESS</tt>" will be set
to the name of the job process that failed (for example
"<tt class="docutils literal"><span class="pre">pre-start</span></tt>" or "<tt class="docutils literal">main</tt>"). See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/stopped.7.html">stopped(7)</a> for further details.</p>
<p>Further note that if the job <em>does not specify</em> the <a class="reference internal" href="index.html#respawn-limit">respawn limit</a>
stanza <em>as well as</em> the <tt class="docutils literal">respawn</tt> stanza, the job will have the
default respawn limit applied (see <a class="reference internal" href="index.html#respawn-limit">respawn limit</a>).</p>
</div>
<div class="section" id="respawn-limit">
<h2><a class="toc-backref" href="index.html#toc-entry-149">6.29&nbsp;&nbsp;&nbsp;<tt class="docutils literal">respawn limit</tt></a></h2>
<p>Yes, this is <em>different</em> to a plain <a class="reference internal" href="index.html#respawn">respawn</a>: specifying <tt class="docutils literal">respawn
limit</tt> <em>does not</em> imply <tt class="docutils literal">respawn</tt>.</p>
<p>Syntax:</p>
<pre class="literal-block">respawn limit COUNT INTERVAL | unlimited
</pre>
<p>Example:</p>
<pre class="literal-block"># respawn the job up to 10 times within a 5 second period.
# If the job exceeds these values, it will be stopped and
# marked as failed.
respawn
respawn limit 10 5

# respawn the job indefinitely
respawn limit unlimited
</pre>
<p>Respawning is subject to a limit. If the job is respawned more than
<tt class="docutils literal">COUNT</tt> times in <tt class="docutils literal">INTERVAL</tt> seconds, it will be considered to be
having deeper problems and will be stopped. Default <tt class="docutils literal">COUNT</tt> is <tt class="docutils literal">10</tt>.
Default <tt class="docutils literal">INTERVAL</tt> is <tt class="docutils literal">5</tt> seconds.</p>
<p>To have the job respawn indefinitely, specify an argument of
"<tt class="docutils literal">unlimited</tt>". However, care should be taken using this option: does
your service really stop that frequently? Should it?</p>
<p>Specifying <em>either</em> <tt class="docutils literal">COUNT</tt> or <tt class="docutils literal">INTERVAL</tt> as <tt class="docutils literal">0</tt> (zero) implies
<tt class="docutils literal">unlimited</tt>.</p>
<p>Note that <tt class="docutils literal">respawn</tt> only applies to automatic respawns and not the
<a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/restart.8.html">restart(8)</a> command.</p>
<p>If the job has been respawned up to its respawn limit, the variable
"<tt class="docutils literal">$PROCESS</tt>" will be set to "<tt class="docutils literal">respawn</tt>" to denote that the respawn
limit was reached. See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/stopped.7.html">stopped(7)</a> for further details.</p>
</div>
<div class="section" id="script">
<h2><a class="toc-backref" href="index.html#toc-entry-150">6.30&nbsp;&nbsp;&nbsp;<tt class="docutils literal">script</tt></a></h2>
<p>Allows the specification of a multi-line block of shell code to be
executed. Block is terminated by <a class="reference internal" href="index.html#end-script">end script</a>.</p>
</div>
<div class="section" id="setgid">
<h2><a class="toc-backref" href="index.html#toc-entry-151">6.31&nbsp;&nbsp;&nbsp;<tt class="docutils literal">setgid</tt></a></h2>
<p><em>Added in Upstart v1.4</em></p>
<p>Syntax:</p>
<pre class="literal-block">setgid &lt;groupname&gt;
</pre>
<p>Changes to the group <tt class="docutils literal">&lt;groupname&gt;</tt> before running the job's process.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Note that <em>all</em> processes (<a class="reference internal" href="index.html#pre-start">pre-start</a>, <a class="reference internal" href="index.html#post-stop">post-stop</a>, <em>et cetera</em>) will
be run with the group specified.</p>
</div>
<p>If this stanza is unspecified, the primary group of the user specified in
the setuid block is used. If both stanzas are unspecified, the job will
run with its group ID set to 0 in the case of system jobs, and as the primary
group of the user in the case of User Jobs.</p>
<p>Example:</p>
<pre class="literal-block">setgid apache
</pre>
</div>
<div class="section" id="setuid">
<h2><a class="toc-backref" href="index.html#toc-entry-152">6.32&nbsp;&nbsp;&nbsp;<tt class="docutils literal">setuid</tt></a></h2>
<p><em>Added in Upstart v1.4</em></p>
<p>Syntax:</p>
<pre class="literal-block">setuid &lt;username&gt;
</pre>
<p>Changes to the user <tt class="docutils literal">&lt;username&gt;</tt> before running the job's process.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Note that <em>all</em> processes (<a class="reference internal" href="index.html#pre-start">pre-start</a>, <a class="reference internal" href="index.html#post-stop">post-stop</a>, <em>et cetera</em>) will
be run as the user specified.</p>
</div>
<p>If this stanza is unspecified, the job will run as root in the case of system
jobs, and as the user in the case of User Jobs.</p>
<p>Note that System jobs using the <tt class="docutils literal">setuid</tt> stanza are still system jobs,
and can not be controlled by an unprivileged user, even if the
<tt class="docutils literal">setuid</tt> stanza specifies that user.</p>
<p>Note that if you specify an invalid username in the <tt class="docutils literal">setuid</tt> stanza, Upstart will log an error <em>if</em> it is in <a class="reference internal" href="index.html#initctl-log-priority">Debug Mode</a>.</p>
<p>For example, if job <tt class="docutils literal">foo</tt> specifies an invalid <tt class="docutils literal">setuid</tt> username:</p>
<pre class="literal-block">$ sudo initctl log-priority debug
$ sudo start foo
start: Job failed to start
$ sudo dmesg | grep setuid
[ 4942.908486] init: Failed to spawn foo main process: unable to find setuid user
</pre>
<p>Although the username is not logged, it is clear there is a problem with the
<tt class="docutils literal">setuid</tt> stanza for the specified <tt class="docutils literal">foo</tt> job.</p>
</div>
<div class="section" id="start-on">
<h2><a class="toc-backref" href="index.html#toc-entry-153">6.33&nbsp;&nbsp;&nbsp;<tt class="docutils literal">start on</tt></a></h2>
<p>This stanza defines the set of <a class="reference internal" href="index.html#events">Events</a> that will cause the <a class="reference internal" href="index.html#job">Job</a> to
be automatically started.</p>
<p>Syntax:</p>
<pre class="literal-block">start on EVENT [[KEY=]VALUE]... [and|or...]
</pre>
<p>Each <a class="reference internal" href="index.html#event">event</a> <tt class="docutils literal">EVENT</tt> is given by its name. Multiple events are permitted using the
operators "<tt class="docutils literal">and</tt>" and "<tt class="docutils literal">or</tt>" and complex expressions may be performed with
parentheses (within which line breaks are permitted).</p>
<p>You may also match on the <a class="reference internal" href="index.html#environment-variables">environment variables</a> contained within the event
by specifying the <tt class="docutils literal">KEY</tt> and expected <tt class="docutils literal">VALUE</tt>. If you know the order in
which the variables are given to the event you may omit the <tt class="docutils literal">KEY</tt>.</p>
<p><tt class="docutils literal">VALUE</tt> may contain wildcard matches and globs as permitted by <a class="reference external" href="http://manpages.ubuntu.com/manpages/man3/fnmatch.3.html">fnmatch(3)</a>
and may expand the value of any variable defined with the env stanza.</p>
<p>Negation is permitted by using "<tt class="docutils literal">!=</tt>" between the <tt class="docutils literal">KEY</tt> and <tt class="docutils literal">VALUE</tt>.</p>
<p>Note that if the job is <em>already running</em> and is not an <a class="reference internal" href="index.html#instance">instance</a> job, if the
<tt class="docutils literal">start on</tt> condition becomes true (again), no further action will be taken.</p>
<p>Note that the <tt class="docutils literal">start on</tt> stanza expects a token to follow <em>on the same
line</em>. Thus:</p>
<pre class="literal-block"># ERROR: invalid
start on
  foo or bar

# OK
start on foo or bar
</pre>
<p>If no environment variables are specified via <tt class="docutils literal">KEY</tt> to restrict the match,
the condition will match all instances of the specified event.</p>
<p>See <a class="reference internal" href="index.html#really-understanding-start-on-and-stop-on">Really understanding start on and stop on</a> for further details.</p>
<div class="section" id="normal-start">
<h3><a class="toc-backref" href="index.html#toc-entry-154">6.33.1&nbsp;&nbsp;&nbsp;Normal start</a></h3>
<p>If you are just writing an upstart job that needs to start the service
after the basic facilities are up, either of these will work:</p>
<pre class="literal-block">start on (local-filesystems and net-device-up IFACE!=lo)
</pre>
<p>or:</p>
<pre class="literal-block">start on runlevel [2345]
</pre>
<p>The difference in whether to use the more generic 'runlevel' or the more
explicit <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/local-filesystems.7.html">local-filesystems(7)</a> and <tt class="docutils literal"><span class="pre">net-device-up</span></tt> events should be
guided by your job's behaviour. If your service will come up without a
valid network interface (for instance, it binds to <tt class="docutils literal">0.0.0.0</tt>, or uses
<a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/setsockopt.2.html">setsockopt(2)</a> <tt class="docutils literal">SO_FREEBIND</tt>), then the <tt class="docutils literal">runlevel</tt> event is
preferable, as your service will start a bit earlier and start in
parallel with other services.</p>
<p>However if your service requires that a non-loopback interface is configured
for some reason (i.e., it will not start without broadcasting capabilities),
then explicitly saying "once a non loopback device has come up" can help.</p>
<p>In addition, services may be aggregated around an abstract job, such as
<tt class="docutils literal"><span class="pre">network-services</span></tt>:</p>
<pre class="literal-block">start on started network-services
</pre>
<p>The network-services job is a generic job that most network services should
follow in releases where it is available. <a class="footnote-reference" href="index.html#networkservices" id="footnote-reference-14">[19]</a> This allows the
system administrator and/or the distribution maintainers to change the general
startup of services that don't need any special case start on criteria.</p>
<p>We use the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/started.7.html">started(7)</a> event so that anything that must be started before all
network services can do "<tt class="docutils literal">start on starting <span class="pre">network-services</span></tt>".</p>
</div>
<div class="section" id="start-depends-on-another-service">
<h3><a class="toc-backref" href="index.html#toc-entry-155">6.33.2&nbsp;&nbsp;&nbsp;Start depends on another service</a></h3>
<pre class="literal-block">start on started other-service
</pre>
</div>
<div class="section" id="start-must-precede-another-service">
<h3><a class="toc-backref" href="index.html#toc-entry-156">6.33.3&nbsp;&nbsp;&nbsp;Start must precede another service</a></h3>
<pre class="literal-block">start on starting other-service
</pre>
<p>Example: your web app needs <tt class="docutils literal">memcached</tt> to be started before <tt class="docutils literal">apache</tt>:</p>
<pre class="literal-block">start on starting apache2
stop on stopped apache2
respawn

exec /usr/sbin/memcached
</pre>
</div>
</div>
<div class="section" id="stop-on">
<h2><a class="toc-backref" href="index.html#toc-entry-157">6.34&nbsp;&nbsp;&nbsp;<tt class="docutils literal">stop on</tt></a></h2>
<p>This stanza defines the set of <a class="reference internal" href="index.html#events">Events</a> that will cause the <a class="reference internal" href="index.html#job">Job</a> to
be automatically stopped if it is already running.</p>
<p>Syntax:</p>
<pre class="literal-block">stop on EVENT [[KEY=]VALUE]... [and|or...]
</pre>
<p>Like the <a class="reference internal" href="index.html#stop-on">stop on</a> stanza, <tt class="docutils literal">start on</tt> expects a token to follow <em>on the same
line</em>:</p>
<pre class="literal-block"># ERROR: invalid
stop on
  foo or bar

# OK
stop on foo or bar
</pre>
<p>See <a class="reference internal" href="index.html#start-on">start on</a> for further syntax details.</p>
<div class="section" id="normal-shutdown">
<h3><a class="toc-backref" href="index.html#toc-entry-158">6.34.1&nbsp;&nbsp;&nbsp;Normal shutdown</a></h3>
<pre class="literal-block">stop on runlevel [016]
</pre>
<p>Or if a generic job is available such as <tt class="docutils literal"><span class="pre">network-services</span></tt>
<a class="footnote-reference" href="index.html#networkservices" id="footnote-reference-15">[19]</a></p>
<pre class="literal-block">stop on stopping network-services
</pre>
</div>
<div class="section" id="stop-before-depended-upon-service">
<h3><a class="toc-backref" href="index.html#toc-entry-159">6.34.2&nbsp;&nbsp;&nbsp;Stop before depended-upon service</a></h3>
<pre class="literal-block">stop on stopping other-service
</pre>
<p>Note that this also will stop when <tt class="docutils literal"><span class="pre">other-service</span></tt> is restarted, so
you will generally want to couple this with the <a class="reference internal" href="index.html#start-on">start on</a> condition:</p>
<pre class="literal-block">start on started other-service
</pre>
</div>
<div class="section" id="stop-after-dependent-service">
<h3><a class="toc-backref" href="index.html#toc-entry-160">6.34.3&nbsp;&nbsp;&nbsp;Stop after dependent service</a></h3>
<pre class="literal-block">stop on stopped other-service
</pre>
</div>
</div>
<div class="section" id="task">
<h2><a class="toc-backref" href="index.html#toc-entry-161">6.35&nbsp;&nbsp;&nbsp;<tt class="docutils literal">task</tt></a></h2>
<p>In concept, a task is just a short lived job. In practice, this is accomplished
by changing how the transition from a goal of "stop" to "start" is handled.</p>
<p>Without the 'task' keyword, the events that cause the job to start will be
unblocked as soon as the job is <em>started</em>. This means the job has emitted a
<a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/starting.7.html">starting(7)</a> event, run its <a class="reference internal" href="index.html#pre-start">pre-start</a>, begun its script/exec, and
<a class="reference internal" href="index.html#post-start">post-start</a>, and emitted its <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/started.7.html">started(7)</a> event.</p>
<p>With task, the events that lead to this job starting will be blocked until the
job has completely transitioned back to <em>stopped</em>. This means that the job has
run up to the previously mentioned <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/started.7.html">started(7)</a> event, <em>and</em> has also
completed its <a class="reference internal" href="index.html#post-stop">post-stop</a>, and emitted its <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/stopped.7.html">stopped(7)</a> event.</p>
<p>Typically, <tt class="docutils literal">task</tt> is for something that you just want to run and finish
completely when a certain event happens.</p>
<pre class="literal-block"># pre-warm-memcache

start on started memcached

task

exec /path/to/pre-warm-memcached
</pre>
<p>So you can have another job that starts your background queue worker
once the local memcached is pre-warmed:</p>
<pre class="literal-block"># queue-worker

start on stopped pre-warm-memcache
stop on stopping memcached

respawn

exec /usr/local/bin/queue-worker
</pre>
<p>The key concept demonstrated above is that we "<tt class="docutils literal">start on stopped
<span class="pre">pre-warm-memcache</span></tt>". This means that we don't start until the task has
completed. If we were to use <tt class="docutils literal">started</tt> instead of <tt class="docutils literal">stopped</tt>, we
would start our queue worker as soon as <tt class="docutils literal"><span class="pre">/path/to/pre-warm-memcached</span></tt>
had been started running.</p>
<p>We could also accomplish this without mentioning the pre-warm in the
queue-worker job by doing this:</p>
<pre class="literal-block"># queue-worker

start on started memcached
stop on stopping memcached

respawn

exec /usr/local/bin/queue-worker

# pre-warm-memcache

start on starting queue-worker
task
exec /path/to/pre-warm-memcache
</pre>
<p>If we did not use "<tt class="docutils literal">task</tt>" in the above example, queue-worker would be
allowed to start as soon as we executed <tt class="docutils literal"><span class="pre">/path/to/pre-warm-memcache</span></tt>,
which means it might potentially start before the cache was warmed.</p>
</div>
<div class="section" id="umask">
<h2><a class="toc-backref" href="index.html#toc-entry-162">6.36&nbsp;&nbsp;&nbsp;<tt class="docutils literal">umask</tt></a></h2>
<p>Syntax:</p>
<pre class="literal-block">umask &lt;value&gt;
</pre>
<p>Set the file mode creation mask for the process. <tt class="docutils literal">&lt;value&gt;</tt> should be
an octal value for the mask. See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/umask.2.html">umask(2)</a> for more details.</p>
<p>Example:</p>
<pre class="literal-block">umask 0002
</pre>
</div>
<div class="section" id="usage">
<h2><a class="toc-backref" href="index.html#toc-entry-163">6.37&nbsp;&nbsp;&nbsp;<tt class="docutils literal">usage</tt></a></h2>
<p>Brief message explaining how to start the job in question. Most useful
for instance jobs which require environment variable parameters to be
specified before they can be started.</p>
<p>Syntax:</p>
<pre class="literal-block">usage &lt;string&gt;
</pre>
<p>Example:</p>
<pre class="literal-block">instance $DB
usage "DB - name of database instance"
</pre>
<p>If a job specifies the <tt class="docutils literal">usage</tt> stanza, attempting to start the job
without specifying the correct variables will display the usage
statement. Additionally, the usage can be queried using <a class="reference internal" href="index.html#initctl-usage">initctl
usage</a>.</p>
</div>
<div class="section" id="version">
<h2><a class="toc-backref" href="index.html#toc-entry-164">6.38&nbsp;&nbsp;&nbsp;<tt class="docutils literal">version</tt></a></h2>
<p>Syntax:</p>
<pre class="literal-block">version &lt;string&gt;
</pre>
<p>This stanza may contain version information about the job, such as
revision control or package version number. It is not used or
interpreted by <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/init.8.html">init(8)</a> in any way.</p>
<p>Example:</p>
<pre class="literal-block">version "1.0.2a-beta4"
</pre>
</div>
</div>
<div class="section" id="command-line-options">
<h1><a class="toc-backref" href="index.html#toc-entry-165">7&nbsp;&nbsp;&nbsp;Command-Line Options</a></h1>
<p>The table below lists the command-line options accepted by the Upstart
init daemon.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Under normal conditions, you should not need to specify <em>any</em>
command-line options to Upstart. A number of these options were added
specifically for testing Upstart itself and if used without due care
can stop your system from booting (for example specifying
<tt class="docutils literal"><span class="pre">--no-startup-event</span></tt>). Therefore you should be <em>extremely</em>
careful specifying <em>any</em> command-line options to Upstart unless you
understand the implications of doing so.</p>
</div>
<table border="1" class="docutils">
<caption>Command-line Options</caption>
<colgroup>
<col width="27%">
<col width="56%">
<col width="17%">
</colgroup>
<thead valign="bottom">
<tr><th class="head">Option Name</th>
<th class="head">Description</th>
<th class="head">Added in Version</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal"><span class="pre">--append-confdir=DIR</span></tt></td>
<td>Specify directory to read job configuration files from
after the default(s).</td>
<td>1.13</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">--chroot-sessions</span></tt></td>
<td>Enable chroot sessions.</td>
<td>1.13</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">--confdir=DIR</span></tt></td>
<td>Specify alternate job configuration file directory
(<a class="reference internal" href="index.html#system-job">System Job</a> default: <tt class="docutils literal">/etc/init/</tt>)</td>
<td>1.3</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">--debug</span></tt></td>
<td>Enable Informational and debug messages</td>
<td>0.1.0</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">--default-console=VALUE</span></tt></td>
<td>Specify default value for jobs not specifying <a class="reference internal" href="index.html#console">console</a>
(default: <tt class="docutils literal">none</tt> (Upstart &lt; 1.4), else <tt class="docutils literal">log</tt>)</td>
<td>1.4</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">--help</span></tt></td>
<td>Show usage statement for init</td>
<td>0.1.0</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">--logdir=DIR</span></tt></td>
<td>Specify alternate log directory
(<a class="reference internal" href="index.html#system-job">System Job</a> default: <tt class="docutils literal">/var/log/upstart/</tt>)</td>
<td>1.4</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">--no-cgroups</span></tt></td>
<td>Make the <a class="reference internal" href="index.html#cgroup">cgroup</a> stanza a NOP.</td>
<td>1.13</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">--no-dbus</span></tt></td>
<td>Stop PID 1 connecting to D-Bus system bus</td>
<td>1.11</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">--no-inherit-env</span></tt></td>
<td>Stop <a class="reference internal" href="index.html#session-jobs">Session Jobs</a> using the <a class="reference internal" href="index.html#session-init">Session Init</a> environment</td>
<td>1.7</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">--no-log</span></tt></td>
<td>Disable job logging (all job output is discarded)</td>
<td>1.4</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">--no-sessions</span></tt></td>
<td>Disable chroot sessions (name is historical).
Removed in Upstart 1.13 (since the default is to disable).</td>
<td>1.3</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">--no-startup-event</span></tt></td>
<td>Disable emitting an event at startup</td>
<td>1.3</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">--prepend-confdir=DIR</span></tt></td>
<td>Specify directory to read job configuration files from
before the default(s).</td>
<td>1.13</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">-q</span></tt> , <tt class="docutils literal"><span class="pre">--quiet</span></tt></td>
<td>Reduce output to errors only</td>
<td>0.1.0</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">--session</span></tt></td>
<td>Use D-Bus session bus rather than D-Bus system bus</td>
<td>1.3</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">--startup-event=NAME</span></tt></td>
<td>Specify an alternative initial event
(default: <tt class="docutils literal">startup</tt> event)</td>
<td>1.3</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">--user</span></tt></td>
<td>Run a <a class="reference internal" href="index.html#session-init">Session Init</a></td>
<td>1.7</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">-v</span></tt> , <tt class="docutils literal"><span class="pre">--verbose</span></tt></td>
<td>Increase output to include informational messages</td>
<td>0.1.0</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">--version</span></tt></td>
<td>Display version information</td>
<td>0.1.0</td>
</tr>
</tbody>
</table>
<p>Notes:</p>
<ul class="simple">
<li>An alternative to <tt class="docutils literal"><span class="pre">--debug</span></tt> and <tt class="docutils literal"><span class="pre">--verbose</span></tt> is to modify the
message level at runtime by using <a class="reference internal" href="index.html#initctl-log-priority">initctl log-priority</a>.</li>
<li><tt class="docutils literal"><span class="pre">--no-dbus</span></tt> effectively makes <a class="reference internal" href="index.html#upstart-event-bridge">upstart-event-bridge</a> impotent: no
system-level events will be propagated to the <a class="reference internal" href="index.html#session-init">Session Init</a>.</li>
</ul>
</div>
<div class="section" id="explanations">
<h1><a class="toc-backref" href="index.html#toc-entry-166">8&nbsp;&nbsp;&nbsp;Explanations</a></h1>
<div class="section" id="really-understanding-start-on-and-stop-on">
<h2><a class="toc-backref" href="index.html#toc-entry-167">8.1&nbsp;&nbsp;&nbsp;Really understanding <tt class="docutils literal">start on</tt> and <tt class="docutils literal">stop on</tt></a></h2>
<p>(Note: This section focuses on <a class="reference internal" href="index.html#start-on">start on</a>, but the information also applies
to <a class="reference internal" href="index.html#stop-on">stop on</a> unless explicitly specified).</p>
<p>The <tt class="docutils literal">start on</tt> stanza needs careful contemplation. Consider this example:</p>
<pre class="literal-block">start on started mysql
</pre>
<p>The syntax above is actually a short-hand way of writing:</p>
<pre class="literal-block">start on started JOB=mysql
</pre>
<p>Remember that <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/started.7.html">started(7)</a> is an event which <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> emits automatically
when the <tt class="docutils literal">mysql</tt> job has <em>started to run</em>. The whole <a class="reference internal" href="index.html#start-on">start on</a> stanza can
be summarized as:</p>
<pre class="literal-block">start on &lt;event&gt; [&lt;vars_to_match_event_on&gt;]
</pre>
<p>Where <tt class="docutils literal">&lt;vars_to_match_event_on&gt;</tt> is optional, but if specified comprises one
or more variables.</p>
<p>A slight variation of the above:</p>
<pre class="literal-block">start on started JOB=mydb DBNAME=foobar
</pre>
<p>This example shows that the fictitious job above would only be started when
the <tt class="docutils literal">mydb</tt> database server brings the <tt class="docutils literal">foobar</tt> database on-line.
Correspondingly, file <tt class="docutils literal">/etc/init/mydb.conf</tt> would need to specify "<tt class="docutils literal">export
DBNAME</tt>" and be started like this:</p>
<pre class="literal-block">start mydb DBNAME=foobar
</pre>
<p>Looking at a slightly more complex real-life example:</p>
<pre class="literal-block"># /etc/init/alsa-mixer-save.conf
start on starting rc RUNLEVEL=[06]
</pre>
<p>This job says,</p>
<blockquote>
<dl class="docutils">
<dt>"Run when the <tt class="docutils literal">rc</tt> job emits the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/starting.7.html">starting(7)</a> event, but only if the</dt>
<dd>environment variable <tt class="docutils literal">RUNLEVEL</tt> equals either <tt class="docutils literal">0</tt> (halt) or <tt class="docutils literal">6</tt>
(reboot)".</dd>
</dl>
</blockquote>
<p>If we again add in the implicit variable it becomes clearer:</p>
<pre class="literal-block"># /etc/init/alsa-mixer-save.conf
start on starting JOB=rc RUNLEVEL=[06]
</pre>
<p>But where does the <tt class="docutils literal">RUNLEVEL</tt> environment variable come from? Well,
variables are exported in a job configuration file to related jobs. Thus, the
answer is <a class="reference internal" href="index.html#the-rc-job">The rc Job</a>.</p>
<p>If you look at this job configuration file, you will see, as deduced:</p>
<pre class="literal-block">export RUNLEVEL
</pre>
<div class="section" id="the-rc-job">
<h3><a class="toc-backref" href="index.html#toc-entry-168">8.1.1&nbsp;&nbsp;&nbsp;The <tt class="docutils literal">rc</tt> Job</a></h3>
<p>The <tt class="docutils literal">rc</tt> job configuration file is well worth considering:</p>
<pre class="literal-block"># /etc/init/rc.conf
start on runlevel [0123456]
stop on runlevel [!$RUNLEVEL]

export RUNLEVEL
export PREVLEVEL

console output
env INIT_VERBOSE

task

exec /etc/init.d/rc $RUNLEVEL
</pre>
<p>It says in essence,</p>
<blockquote>
"Run the SysV init script as <tt class="docutils literal">/etc/init.d/rc $RUNLEVEL</tt> when
<a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/telinit.8.html">telinit(8)</a> emits the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/runlevel.7.html">runlevel(7)</a> event for any runlevel".</blockquote>
<p>However, note the <a class="reference internal" href="index.html#stop-on">stop on</a> condition:</p>
<pre class="literal-block">stop on runlevel [!$RUNLEVEL]
</pre>
<p>This requires some explanation. The manual page for <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/runlevel.7.html">runlevel(7)</a> explains
that the <tt class="docutils literal">runlevel</tt> event specifies two variables in the following order:</p>
<ul>
<li><p class="first"><tt class="docutils literal">RUNLEVEL</tt></p>
<p>The new "goal" runlevel the system is changing to.</p>
</li>
<li><p class="first"><tt class="docutils literal">PREVLEVEL</tt></p>
<p>The previous system runlevel (which may be set to an empty value).</p>
</li>
</ul>
<p>Thus, the <a class="reference internal" href="index.html#stop-on">stop on</a> condition is saying:</p>
<blockquote>
"Stop the <tt class="docutils literal">rc</tt> job when the <tt class="docutils literal">runlevel</tt> event is emitted <em>and</em> the
<tt class="docutils literal">RUNLEVEL</tt> variable matches '<tt class="docutils literal"><span class="pre">[!$RUNLEVEL]</span></tt>'.</blockquote>
<p>This admittedly does initially appear nonsensical. The way to read the statement above though is:</p>
<blockquote>
"Stop the <tt class="docutils literal">rc</tt> job when the <tt class="docutils literal">runlevel</tt> event is emitted and the
<tt class="docutils literal">RUNLEVEL</tt> variable is <em>not</em> set to the <em>current value</em> of the <tt class="docutils literal">RUNLEVEL</tt>
variable."</blockquote>
<p>So, if the runlevel is currently "<tt class="docutils literal">2</tt>" (full graphical multi-user under
<a class="reference external" href="http://www.ubuntu.com/">Ubuntu</a>), the <tt class="docutils literal">RUNLEVEL</tt> variable will be set to <tt class="docutils literal">RUNLEVEL=2</tt>. The
condition will thus evaluate to:</p>
<pre class="literal-block">stop on runlevel [!2]
</pre>
<p>This is just a safety measure. What it is saying is:</p>
<ul class="simple">
<li><em>if</em> the <tt class="docutils literal">rc</tt> job (which is a short-running <a class="reference internal" href="index.html#task">Task</a>) is still running when
the system changes to a <em>different</em> runlevel (a runlevel other than "<tt class="docutils literal">2</tt>"
here), <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> will stop it.</li>
<li>If it is <em>not</em> running when the system changes to a different runlevel, no
action will be taken to stop the job (since it has already stopped).</li>
</ul>
<p>However, note that when the system moves to a new runlevel, <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> will then
immediately <em>re-run</em> the job at the <em>new</em> runlevel since the <a class="reference internal" href="index.html#start-on">start on</a>
condition specifies that this job should be started in <em>every</em> runlevel.</p>
<p>Since this job has specified the <tt class="docutils literal">runlevel</tt> event, it automatically gets
access to the variables set by this event (<tt class="docutils literal">RUNLEVEL</tt> and <tt class="docutils literal">PREVLEVEL</tt>).
However, note that these two variables are also exported. The reason for this
is to allow other jobs which <a class="reference internal" href="index.html#start-on">start on</a> or <a class="reference internal" href="index.html#stop-on">stop on</a> the <tt class="docutils literal">rc</tt> job to make
use of these variables (which were set by the <tt class="docutils literal">runlevel</tt> event).</p>
<p>See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/runlevel.7.html">runlevel(7)</a> for further details.</p>
</div>
</div>
<div class="section" id="environment-variables">
<h2><a class="toc-backref" href="index.html#toc-entry-169">8.2&nbsp;&nbsp;&nbsp;Environment Variables</a></h2>
<p>Upstart allows you to set environment variables which will be accessible to the
jobs whose job configuration files they are defined in. Environment
variables are set using the <a class="reference internal" href="index.html#env">env</a> keyword.</p>
<p>For example:</p>
<pre class="literal-block"># /etc/init/env.conf
env TESTING=123

script
  # prints "TESTING='123'" to system log
  logger -t $0 "TESTING='$TESTING'"
end script
</pre>
<p>Further, we can pass environment variables defined in <em>events</em> to jobs
using the <a class="reference internal" href="index.html#env">env</a> stanza and the <a class="reference internal" href="index.html#export">export</a> stanza. Assume we have two job
configuration files, <tt class="docutils literal">A.conf</tt> and <tt class="docutils literal">B.conf</tt>:</p>
<pre class="literal-block"># /etc/init/A.conf
start on wibble
export foo

# /etc/init/B.conf
start on started A
script
  logger "value of foo is '$foo'"
end script
</pre>
<p>If we now run the following command, both jobs <tt class="docutils literal">A</tt> and <tt class="docutils literal">B</tt> will run,
causing <tt class="docutils literal">B</tt> to write "<tt class="docutils literal">value of foo is 'bar'</tt>" to the system log:</p>
<pre class="literal-block"># initctl emit wibble foo=bar
</pre>
<p>Note that a variables value can always be overridden by specifying a new
value on the command-line. For example:</p>
<pre class="literal-block">start on wibble
env var=hello

script
  logger "value of var is '$var'"
end script
</pre>
<p>When we emit the required event...:</p>
<pre class="literal-block"># initctl emit wibble var=world
</pre>
<p>... the system log will have recorded:</p>
<pre class="literal-block">value of var is 'world'
</pre>
<p>Note that a <a class="reference internal" href="index.html#job-configuration-file">Job Configuration File</a> does <em>not</em> have access to a user's
environment variables, not even the superuser. This is not possible
since all job processes created are children of <tt class="docutils literal">init</tt> which does not
have a user's environment.</p>
<p>However, using the technique above, it is possible to inject a variable from a
user's environment into a job indirectly:</p>
<pre class="literal-block"># initctl emit wibble foo=bar USER=$USER
</pre>
<p>As another example of environment variables, consider this job configuration
file <a class="footnote-reference" href="index.html#pre-stop-bug" id="footnote-reference-16">[20]</a>:</p>
<pre class="literal-block">env var=bar
export var

pre-start script
  logger "pre-start: before: var=$var"

  var=pre-start
  export var

  logger "pre-start: after: var=$var"
end script

post-start script
  logger "post-start: before: var=$var"

  var=post-start
  export var

  logger "post-start: after: var=$var"
end script

script
  logger "script: before: var=$var"

  var=main
  export var

  logger "script: after: var=$var"
end script

post-stop script
  logger "post-stop: before: var=$var"

  var=post-stop
  export var

  logger "post-stop: after: var=$var"
end script
</pre>
<p>This will generate output in your system log as follows (the timestamp
and hostname have been removed, and the output formatted to make it clearer):</p>
<pre class="literal-block">logger: pre-start:  before: var=bar
logger: pre-start:   after: var=pre-start

logger: post-start: before: var=bar
logger: post-start:  after: var=post-start

logger: script:     before: var=bar
logger: script:      after: var=main

logger: post-stop:  before: var=bar
logger: post-stop:   after: var=post-stop
</pre>
<p>As shown, every script section receives the value of <tt class="docutils literal">$var</tt> as <tt class="docutils literal">bar</tt>,
but if any script section changes the value, it only affects <em>that</em>
particular script sections copy of the variable. To summarize:</p>
<blockquote>
A script section cannot modify the value of a variable defined in a
job configuration file <em>for other script sections</em>.</blockquote>
<div class="section" id="restrictions">
<h3><a class="toc-backref" href="index.html#toc-entry-170">8.2.1&nbsp;&nbsp;&nbsp;Restrictions</a></h3>
<p>Environment variables do not expand in <a class="reference internal" href="index.html#start-on">start on</a> or <a class="reference internal" href="index.html#stop-on">stop on</a> conditions:</p>
<pre class="literal-block">env FOO=bar
start on $FOO
</pre>
<p>This will start the job in question when the "<tt class="docutils literal">$FOO</tt>" event is emitted,
<strong>not</strong> when the event "<cite>bar</cite>" is emitted:</p>
<pre class="literal-block"># job above *NOT* started
initctl emit bar

# job above started!
initctl emit '$FOO'
</pre>
<p>Similarly, the following will not work:</p>
<pre class="literal-block">start on starting $FOO
start on starting JOB=$FOO
</pre>
</div>
<div class="section" id="standard-environment-variables">
<h3><a class="toc-backref" href="index.html#toc-entry-171">8.2.2&nbsp;&nbsp;&nbsp;Standard Environment Variables</a></h3>
<p>The table below shows all variables set by <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> itself. Note that
variables prefixed by "<tt class="docutils literal">UPSTART_</tt>" are variables set within a <em>jobs</em>
environment, whereas the remainder are set within an events environment
(see the following table).</p>
<table border="1" class="docutils">
<caption>Upstart Environment Variables.</caption>
<colgroup>
<col width="16%">
<col width="22%">
<col width="62%">
</colgroup>
<thead valign="bottom">
<tr><th class="head">Variable</th>
<th class="head">Brief Description</th>
<th class="head">Details</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">EXIT_SIGNAL</tt></td>
<td>Signal causing job to exit</td>
<td>String such as "<tt class="docutils literal">HUP</tt>" or "<tt class="docutils literal">TERM</tt>", or numeric for unknown signals</td>
</tr>
<tr><td><tt class="docutils literal">EXIT_STATUS</tt></td>
<td>Exit code of job</td>
<td>&nbsp;</td>
</tr>
<tr><td><tt class="docutils literal">INSTANCE</tt></td>
<td>Instance name of <tt class="docutils literal">$JOB</tt></td>
<td>Variable set but with no value if <a class="reference internal" href="index.html#instance">instance</a> stanza not specified</td>
</tr>
<tr><td><tt class="docutils literal">JOB</tt></td>
<td>Name of job</td>
<td>&nbsp;</td>
</tr>
<tr><td><tt class="docutils literal">PROCESS</tt></td>
<td>Name of Job process type</td>
<td>"<tt class="docutils literal">main</tt>", "<tt class="docutils literal"><span class="pre">pre-start</span></tt>", "<tt class="docutils literal"><span class="pre">post-start</span></tt>", "<tt class="docutils literal"><span class="pre">pre-stop</span></tt>", "<tt class="docutils literal"><span class="pre">post-stop</span></tt>" or "<tt class="docutils literal">respawn</tt>"</td>
</tr>
<tr><td><tt class="docutils literal">RESULT</tt></td>
<td>Whether job was successful</td>
<td>"<tt class="docutils literal">ok</tt>" or "<tt class="docutils literal">failed</tt>"</td>
</tr>
<tr><td><tt class="docutils literal">UPSTART_EVENTS</tt></td>
<td>Events that caused job to start</td>
<td>Space-separated. Event environment not provided</td>
</tr>
<tr><td><tt class="docutils literal">UPSTART_FDS</tt></td>
<td>File descriptor</td>
<td>Number of the file descriptor corresponding to the listening <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/socket-event.7.html">socket-event(7)</a> socket</td>
</tr>
<tr><td><tt class="docutils literal">UPSTART_INSTANCE</tt></td>
<td>Instance name of <tt class="docutils literal">$UPSTART_JOB</tt></td>
<td>&nbsp;</td>
</tr>
<tr><td><tt class="docutils literal">UPSTART_JOB</tt></td>
<td>Name of current job</td>
<td>&nbsp;</td>
</tr>
<tr><td><tt class="docutils literal">UPSTART_SESSION</tt></td>
<td><a class="reference internal" href="index.html#session-init">Session Init</a> D-Bus socket</td>
<td>Allows <a class="reference internal" href="index.html#initctl">initctl</a> command to communicate with the appropriate <a class="reference internal" href="index.html#session-init">Session Init</a></td>
</tr>
<tr><td><tt class="docutils literal">UPSTART_STOP_EVENTS</tt></td>
<td>Events that caused job to stop</td>
<td>Space-separated. Event environment not provided</td>
</tr>
</tbody>
</table>
<p>The following table lists the variables from the table above which are
set when job events are emitted, and which are thus available from
within a jobs environment.</p>
<table border="1" class="docutils">
<caption>Environment Variables by Event.</caption>
<colgroup>
<col width="31%">
<col width="69%">
</colgroup>
<thead valign="bottom">
<tr><th class="head">Event</th>
<th class="head">Variables Set in Event Environment</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/starting.7.html">starting(7)</a></td>
<td><ul class="first last simple">
<li><tt class="docutils literal">INSTANCE</tt></li>
<li><tt class="docutils literal">JOB</tt></li>
</ul>
</td>
</tr>
<tr><td><a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/started.7.html">started(7)</a></td>
<td><ul class="first last simple">
<li><tt class="docutils literal">INSTANCE</tt></li>
<li><tt class="docutils literal">JOB</tt></li>
</ul>
</td>
</tr>
<tr><td><a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/stopping.7.html">stopping(7)</a></td>
<td><ul class="first last simple">
<li><tt class="docutils literal">INSTANCE</tt></li>
<li><tt class="docutils literal">JOB</tt></li>
<li><tt class="docutils literal">RESULT</tt></li>
<li><tt class="docutils literal">PROCESS</tt> *</li>
<li><tt class="docutils literal">EXIT_STATUS</tt> </li>
<li><tt class="docutils literal">EXIT_SIGNAL</tt> </li>
</ul>
</td>
</tr>
<tr><td><a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/stopped.7.html">stopped(7)</a></td>
<td><ul class="first last simple">
<li><tt class="docutils literal">INSTANCE</tt></li>
<li><tt class="docutils literal">JOB</tt></li>
<li><tt class="docutils literal">RESULT</tt></li>
<li><tt class="docutils literal">PROCESS</tt> *</li>
<li><tt class="docutils literal">EXIT_STATUS</tt> </li>
<li><tt class="docutils literal">EXIT_SIGNAL</tt> </li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Notes that some variables (those marked with '<tt class="docutils literal">*</tt>' and '<tt class="docutils literal"></tt>') are only
set when the job fails:</p>
<ul class="simple">
<li><tt class="docutils literal">PROCESS</tt> will always be set.</li>
<li>Either <tt class="docutils literal">EXIT_STATUS</tt> or <tt class="docutils literal">EXIT_SIGNAL</tt> will be set.</li>
</ul>
<p>Note carefully the distinction between <tt class="docutils literal">JOB</tt> and <tt class="docutils literal">UPSTART_JOB</tt>. If a
job "<tt class="docutils literal">bar.conf</tt>" specifies a <a class="reference internal" href="index.html#start-on">start on</a> condition of:</p>
<pre class="literal-block">start on starting foo
</pre>
<p>and does not specify the <a class="reference internal" href="index.html#instance">instance</a> stanza, when job "<tt class="docutils literal">foo</tt>" starts,
the environment of the "<tt class="docutils literal">bar</tt>" job will contain:</p>
<pre class="literal-block">JOB=foo
UPSTART_JOB=bar
UPSTART_EVENTS=starting
INSTANCE=
</pre>
</div>
</div>
<div class="section" id="job-with-multiple-duplicate-stanzas">
<h2><a class="toc-backref" href="index.html#toc-entry-172">8.3&nbsp;&nbsp;&nbsp;Job with Multiple Duplicate Stanzas</a></h2>
<p>The way in which Upstart parses the job configuration files means that
"the last entry wins". That is to say, every job configuration file must
be syntactically correct, but if you had a file such as:</p>
<pre class="literal-block">start on event-A
start on starting job-B
start on event-C or starting job-D
</pre>
<p>This job will have a <a class="reference internal" href="index.html#start-on">start on</a> condition of:</p>
<pre class="literal-block">start on event-C or starting job-D
</pre>
<p>...since that is the last <a class="reference internal" href="index.html#start-on">start on</a> condition specified.</p>
<p>For <a class="reference internal" href="index.html#start-on">start on</a>, <a class="reference internal" href="index.html#stop-on">stop on</a> and <tt class="docutils literal">emits</tt> stanzas, you can confirm
Upstart's decision, you can use the <tt class="docutils literal">initctl <span class="pre">show-config</span></tt> command like
this:</p>
<pre class="literal-block">initctl show-config myjob
</pre>
<p>For the example above, the output would be:</p>
<pre class="literal-block">start on event-C or starting job-D
</pre>
</div>
<div class="section" id="job-specifying-same-condition-in-start-on-on-stop-on">
<h2><a class="toc-backref" href="index.html#toc-entry-173">8.4&nbsp;&nbsp;&nbsp;Job Specifying Same Condition in <tt class="docutils literal">start on</tt> on <tt class="docutils literal">stop on</tt></a></h2>
<p>See <a class="reference internal" href="index.html#ordering-of-stop-start-operations">Ordering of Stop/Start Operations</a>.</p>
</div>
</div>
<div class="section" id="features">
<h1><a class="toc-backref" href="index.html#toc-entry-174">9&nbsp;&nbsp;&nbsp;Features</a></h1>
<div class="section" id="d-bus-service-activation">
<h2><a class="toc-backref" href="index.html#toc-entry-175">9.1&nbsp;&nbsp;&nbsp;D-Bus Service Activation</a></h2>
<p>As of <a class="reference external" href="http://dbus.freedesktop.org/">D-Bus</a> version 1.4.1-0ubuntu2 (in Ubuntu), you can have <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a>
start a <a class="reference external" href="http://dbus.freedesktop.org/">D-Bus</a> service rather than <a class="reference external" href="http://dbus.freedesktop.org/">D-Bus</a>. This is useful because it is
then possible to create <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> jobs that start or stop when <a class="reference external" href="http://dbus.freedesktop.org/">D-Bus</a>
services start.</p>
<p>See <a class="reference internal" href="index.html#run-a-job-when-a-user-logs-in">Run a Job When a User Logs in</a> for an example.</p>
</div>
</div>
<div class="section" id="tools">
<h1><a class="toc-backref" href="index.html#toc-entry-176">10&nbsp;&nbsp;&nbsp;Tools</a></h1>
<p>Upstart provides a number of additional tools to:</p>
<ul class="simple">
<li>help manage your system</li>
<li>create Upstart events from other sources</li>
</ul>
<div class="section" id="utilities">
<h2><a class="toc-backref" href="index.html#toc-entry-177">10.1&nbsp;&nbsp;&nbsp;Utilities</a></h2>
<div class="section" id="reload">
<h3><a class="toc-backref" href="index.html#toc-entry-178">10.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">reload</tt></a></h3>
<p>Symbolically linked to <a class="reference internal" href="index.html#initctl">initctl</a>, causing the following to be run:</p>
<pre class="literal-block">initctl reload &lt;job&gt;
</pre>
<p>This will send a running job the <tt class="docutils literal">SIGHUP</tt> signal. By convention,
daemons receiving this signal reload their configuration or in some way
re-initialize themselves (keeping the same PID).</p>
</div>
<div class="section" id="restart">
<h3><a class="toc-backref" href="index.html#toc-entry-179">10.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">restart</tt></a></h3>
<p>Symbolically linked to <a class="reference internal" href="index.html#initctl">initctl</a>, causing the following to be run:</p>
<pre class="literal-block">initctl restart &lt;job&gt;
</pre>
<p>Stops and then starts a job.</p>
<p>Note that <tt class="docutils literal">restart</tt> is <em>not</em> the same as running <a class="reference internal" href="index.html#stop">stop</a> followed by
<a class="reference internal" href="index.html#start">start</a> since the <tt class="docutils literal">restart</tt> command will <em>retain</em> the original job
configuration whereas stopping the job and restarting it will load the
latest job configuration from disk.</p>
<p>Further note that if the job contains <a class="reference internal" href="index.html#post-stop">post-stop</a>, <a class="reference internal" href="index.html#pre-start">pre-start</a> or
<a class="reference internal" href="index.html#post-start">post-start</a> stanzas, these will <em>NOT</em> be run for a restart. However,
a <a class="reference internal" href="index.html#pre-stop">pre-stop</a> stanza <em>will</em> be run.</p>
</div>
<div class="section" id="runlevel">
<h3><a class="toc-backref" href="index.html#toc-entry-180">10.1.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">runlevel</tt></a></h3>
<p>See <a class="reference internal" href="index.html#runlevels">Runlevels</a>.</p>
</div>
<div class="section" id="start">
<h3><a class="toc-backref" href="index.html#toc-entry-181">10.1.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">start</tt></a></h3>
<p>Symbolically linked to <a class="reference internal" href="index.html#initctl">initctl</a>, causing the following to be run:</p>
<pre class="literal-block">initctl start &lt;job&gt;
</pre>
<p>Starts a job.</p>
<div class="section" id="attempting-to-start-an-already-running-job">
<h4><a class="toc-backref" href="index.html#toc-entry-182">10.1.4.1&nbsp;&nbsp;&nbsp;Attempting to Start an Already Running Job</a></h4>
<p>If you try to start a job that is already running and which does <em>not</em>
specify the <a class="reference internal" href="index.html#instance">instance</a> stanza, you will get the following error:</p>
<pre class="literal-block"># start myjob
start: Job is already running: myjob
</pre>
</div>
<div class="section" id="attempting-to-start-a-job-that-requires-an-instance-variable">
<h4><a class="toc-backref" href="index.html#toc-entry-183">10.1.4.2&nbsp;&nbsp;&nbsp;Attempting to Start a Job that requires an Instance Variable</a></h4>
<p>If you try to start a job that specifies the <a class="reference internal" href="index.html#instance">instance</a> stanza, you
will need to specify the appropriate variable. If you do not, you will
get an error. For example, assuming <tt class="docutils literal">myjob.conf</tt> specified <tt class="docutils literal">instance
$foo</tt>:</p>
<pre class="literal-block"># start myjob
start: Unknown parameter: foo
</pre>
<p>To resolve this, specify some value for the variable in question:</p>
<pre class="literal-block"># start myjob foo="hello, world"
</pre>
</div>
</div>
<div class="section" id="stop">
<h3><a class="toc-backref" href="index.html#toc-entry-184">10.1.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">stop</tt></a></h3>
<p>Symbolically linked to <a class="reference internal" href="index.html#initctl">initctl</a>, causing the following to be run:</p>
<pre class="literal-block">initctl stop &lt;job&gt;
</pre>
<p>Stops a job.</p>
<div class="section" id="attempting-to-stop-an-already-stopped-job">
<h4><a class="toc-backref" href="index.html#toc-entry-185">10.1.5.1&nbsp;&nbsp;&nbsp;Attempting to Stop an Already Stopped Job</a></h4>
<p>If you try to stop a job that is not running, you will get the following
error:</p>
<pre class="literal-block"># stop myjob
stop: unknown instance
</pre>
</div>
<div class="section" id="attempting-to-stop-a-job-that-requires-an-instance-variable">
<h4><a class="toc-backref" href="index.html#toc-entry-186">10.1.5.2&nbsp;&nbsp;&nbsp;Attempting to Stop a Job that requires an Instance Variable</a></h4>
<p>If you try to stop a job that specifies the <a class="reference internal" href="index.html#instance">instance</a> stanza without
specifying the particular instance you wish to stop, you will get an
error:</p>
<pre class="literal-block"># stop myjob
stop: Unknown parameter: foo
</pre>
<p>To resolve this, specify the value for the variable in question:</p>
<pre class="literal-block"># stop myjob foo=...
</pre>
<p>Where "<tt class="docutils literal">...</tt>" must be replaced by a legitimate value for one of the
instances as specified in the output of "<tt class="docutils literal">initctl status myjob</tt>".</p>
</div>
</div>
<div class="section" id="initctl">
<h3><a class="toc-backref" href="index.html#toc-entry-187">10.1.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl</tt></a></h3>
<p>This is the primary command used by users and Administrators to interact
with Upstart.</p>
<ul class="simple">
<li>Run <tt class="docutils literal">initctl help</tt> to see the available commands.</li>
<li>Run <tt class="docutils literal">initctl <span class="pre">--help</span></tt> to see the overall options available.</li>
<li>Run <tt class="docutils literal">initctl &lt;command&gt; <span class="pre">--help</span></tt> to see options for the specified command.</li>
</ul>
<p>Commands to manipulate jobs:</p>
<ul class="simple">
<li><a class="reference internal" href="index.html#reload">reload</a></li>
<li><a class="reference internal" href="index.html#restart">restart</a></li>
<li><a class="reference internal" href="index.html#start">start</a></li>
<li><a class="reference internal" href="index.html#stop">stop</a></li>
</ul>
<div class="section" id="initctl-commands-summary">
<h4><a class="toc-backref" href="index.html#toc-entry-188">10.1.6.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl</tt> Commands Summary</a></h4>
<table border="1" class="docutils">
<caption>Summary of initctl commands</caption>
<colgroup>
<col width="32%">
<col width="54%">
<col width="13%">
</colgroup>
<thead valign="bottom">
<tr><th class="head">Command</th>
<th class="head">Description</th>
<th class="head">Added in Version</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><a class="reference internal" href="index.html#initctl-check-config">initctl check-config</a></td>
<td>Check for unreachable jobs/event conditions</td>
<td>1.3</td>
</tr>
<tr><td><a class="reference internal" href="index.html#initctl-emit">initctl emit</a></td>
<td>Emit an event</td>
<td>0.3.0</td>
</tr>
<tr><td><a class="reference internal" href="index.html#initctl-get-env">initctl get-env</a></td>
<td>Retrieve a variable from the job environment table</td>
<td>1.7</td>
</tr>
<tr><td><a class="reference internal" href="index.html#initctl-help">initctl help</a></td>
<td>Display list of commands</td>
<td>0.3.0</td>
</tr>
<tr><td><a class="reference internal" href="index.html#initctl-list">initctl list</a></td>
<td>List known jobs</td>
<td>0.2.0</td>
</tr>
<tr><td><a class="reference internal" href="index.html#initctl-list-env">initctl list-env</a></td>
<td>List job environment table</td>
<td>1.7</td>
</tr>
<tr><td><a class="reference internal" href="index.html#initctl-list-sessions">initctl list-sessions</a></td>
<td>List running User Sessions</td>
<td>1.7</td>
</tr>
<tr><td><a class="reference internal" href="index.html#initctl-log-priority">initctl log-priority</a></td>
<td>Change the minimum priority of log messages displayed by the init daemon</td>
<td>0.3.8</td>
</tr>
<tr><td><a class="reference internal" href="index.html#initctl-notify-cgroup-manager-address">initctl notify-cgroup-manager-address</a></td>
<td>Inform Upstart of address of cgroup manager</td>
<td>1.13</td>
</tr>
<tr><td><a class="reference internal" href="index.html#initctl-notify-disk-writeable">initctl notify-disk-writeable</a></td>
<td>Inform Upstart that disk is now writeable</td>
<td>1.5</td>
</tr>
<tr><td><a class="reference internal" href="index.html#initctl-reload">initctl reload</a></td>
<td>Send HUP signal to job</td>
<td>0.6.5</td>
</tr>
<tr><td><a class="reference internal" href="index.html#initctl-reload-configuration">initctl reload-configuration</a></td>
<td>Reload the configuration</td>
<td>0.6.0</td>
</tr>
<tr><td><a class="reference internal" href="index.html#initctl-restart">initctl restart</a></td>
<td>Restart job</td>
<td>0.6.0</td>
</tr>
<tr><td><a class="reference internal" href="index.html#initctl-reset-env">initctl reset-env</a></td>
<td>Revert the the job environment table to its default values</td>
<td>1.7</td>
</tr>
<tr><td><a class="reference internal" href="index.html#initctl-set-env">initctl set-env</a></td>
<td>Store a variable from the job environment table</td>
<td>1.7</td>
</tr>
<tr><td><a class="reference internal" href="index.html#initctl-show-config">initctl show-config</a></td>
<td>Show emits, start on and stop on details for job(s)</td>
<td>1.3</td>
</tr>
<tr><td><a class="reference internal" href="index.html#initctl-start">initctl start</a></td>
<td>Start job</td>
<td>0.1.0</td>
</tr>
<tr><td><a class="reference internal" href="index.html#initctl-status">initctl status</a></td>
<td>Query status of job</td>
<td>0.1.0</td>
</tr>
<tr><td><a class="reference internal" href="index.html#initctl-stop">initctl stop</a></td>
<td>Stop job</td>
<td>0.1.0</td>
</tr>
<tr><td><a class="reference internal" href="index.html#initctl-unset-env">initctl unset-env</a></td>
<td>Remove a variable from the job environment table</td>
<td>1.7</td>
</tr>
<tr><td><a class="reference internal" href="index.html#initctl-usage">initctl usage</a></td>
<td>Show job usage message if available</td>
<td>1.5</td>
</tr>
<tr><td><a class="reference internal" href="index.html#initctl-version">initctl version</a></td>
<td>Request the version of the init daemon</td>
<td>0.3.8</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="initctl-check-config">
<h4><a class="toc-backref" href="index.html#toc-entry-189">10.1.6.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl <span class="pre">check-config</span></tt></a></h4>
<p>The <tt class="docutils literal">initctl <span class="pre">check-config</span></tt> command can be used to check that the
events and jobs a job configuration file references are "known" to the
system. This is important, since if a System Administrator were to
inadvertently force the removal of a package, or inadvertently delete a
critical job configuration file, the system may no longer boot. Usage is
simple:</p>
<pre class="literal-block">$ # search all job configuration files for "unreachable" conditions
$ initctl check-config

$ # search specified job configuration file for unreachable conditions
$ initctl check-config &lt;job&gt;
</pre>
<p>Some job configuration files -- such as <tt class="docutils literal">plymouth.conf</tt> -- have
complex <a class="reference internal" href="index.html#start-on">start on</a> conditions which look for any of a number of jobs.
As long as one valid set of events can be satisfied, <tt class="docutils literal"><span class="pre">check-config</span></tt>
will be happy. However, to see if it found any missing jobs or events,
specify the <tt class="docutils literal"><span class="pre">--warn</span></tt> option. Note that the first invocation returns no
output, denoting that no problems have been found:</p>
<pre class="literal-block">$ initctl check-config plymouth
$ initctl check-config --warn plymouth
plymouth
  start on: unknown job uxlaunch
  start on: unknown job lightdm
  start on: unknown job lxdm
  start on: unknown job xdm
  start on: unknown job kdm
$
</pre>
<p>Note that this is <strong>not</strong> an error condition since although
<tt class="docutils literal"><span class="pre">check-config</span></tt> cannot satisfy any of these jobs, it <strong>can</strong> satisfy
the overall configuration for <tt class="docutils literal">plymouth</tt> (by the <tt class="docutils literal">gdm</tt> job - see
<tt class="docutils literal">plymouth.conf</tt> on Ubuntu).</p>
<p>Note that the <tt class="docutils literal"><span class="pre">check-config</span></tt> command relies on the <a class="reference internal" href="index.html#emits">emits</a> stanza to
be correctly specified for each job configuration file that emits an
event (see <a class="reference external" href="http://manpages.ubuntu.com/manpages/man5/init.5.html">init(5)</a>). See also <a class="footnote-reference" href="index.html#checking-jobs-and-events-blog" id="footnote-reference-17">[30]</a>.</p>
</div>
<div class="section" id="initctl-emit">
<h4><a class="toc-backref" href="index.html#toc-entry-190">10.1.6.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl emit</tt></a></h4>
<p>Generates an arbitrary event.</p>
<p>Example:</p>
<pre class="literal-block"># initctl emit hello-world
</pre>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">If you attempt to emit an event and it blocks (appears to
hang), this is because there are other jobs which have a <a class="reference internal" href="index.html#start-on">start on</a>
or <a class="reference internal" href="index.html#stop-on">stop on</a> condition which contains this event. See <a class="reference internal" href="index.html#event-types">Event Types</a>
for further details.</p>
</div>
</div>
<div class="section" id="initctl-get-env">
<h4><a class="toc-backref" href="index.html#toc-entry-191">10.1.6.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl <span class="pre">get-env</span></tt></a></h4>
<p>Retrieve value of a job environment variable. See <a class="reference internal" href="index.html#job-environment">Job
Environment</a>.</p>
<p>Example:</p>
<pre class="literal-block">$ initctl get-env foo
bar
$
</pre>
</div>
<div class="section" id="initctl-help">
<h4><a class="toc-backref" href="index.html#toc-entry-192">10.1.6.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl help</tt></a></h4>
<p>Displays a list of <tt class="docutils literal">initctl</tt> commands.</p>
</div>
<div class="section" id="initctl-list">
<h4><a class="toc-backref" href="index.html#toc-entry-193">10.1.6.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl list</tt></a></h4>
<p>The <tt class="docutils literal">list</tt> command simply aggregates the status of all job instances. See
<a class="reference internal" href="index.html#initctl-status">initctl status</a>.</p>
<p>Examples:</p>
<pre class="literal-block"># show all Session Jobs
$ initctl list

# show all System Jobs
$ initctl --system list
</pre>
</div>
<div class="section" id="initctl-list-env">
<h4><a class="toc-backref" href="index.html#toc-entry-194">10.1.6.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl <span class="pre">list-env</span></tt></a></h4>
<p>Show all variables in the job environment table. See <a class="reference internal" href="index.html#job-environment">Job Environment</a>.</p>
<p>Note that all <a class="reference internal" href="index.html#session-jobs">Session Jobs</a> inherit the environment of the <a class="reference internal" href="index.html#session-init">Session
Init</a>.</p>
<p>Note:</p>
<ul class="simple">
<li>In Upstart 1.7 and 1.8 the job environment table <em>only</em> contained
variables explicitly set by <a class="reference internal" href="index.html#initctl-set-env">initctl set-env</a>.</li>
<li>In Upstart 1.9 and above, the job environment table contains <em>all</em>
variables inherited by the <a class="reference internal" href="index.html#session-init">Session Init</a>.</li>
</ul>
</div>
<div class="section" id="initctl-list-sessions">
<h4><a class="toc-backref" href="index.html#toc-entry-195">10.1.6.8&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl <span class="pre">list-sessions</span></tt></a></h4>
<p>List all running sessions being managed by a <a class="reference internal" href="index.html#session-init">Session Init</a>. The format
of this command is:</p>
<pre class="literal-block">&lt;pid&gt; &lt;socket&gt;
</pre>
<p>Where <tt class="docutils literal">&lt;pid&gt;</tt> is the process ID of the running Session Init instance
and  <tt class="docutils literal">&lt;socket&gt;</tt> is the private D-Bus socket address the Session Init
listens on.</p>
</div>
<div class="section" id="initctl-log-priority">
<h4><a class="toc-backref" href="index.html#toc-entry-196">10.1.6.9&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl <span class="pre">log-priority</span></tt></a></h4>
<p>To change the priority with which Upstart logs messages to the system
log, you can change the log priority at any time using <tt class="docutils literal"><span class="pre">log-priority</span></tt>
command as follows:</p>
<pre class="literal-block">initctl log-priority &lt;priority&gt;
</pre>
<p>Where <tt class="docutils literal">&lt;priority&gt;</tt> may be one of:</p>
<ul class="simple">
<li><tt class="docutils literal">debug</tt></li>
<li><tt class="docutils literal">info</tt></li>
<li><tt class="docutils literal">message</tt></li>
<li><tt class="docutils literal">warn</tt></li>
<li><tt class="docutils literal">error</tt></li>
<li><tt class="docutils literal">fatal</tt></li>
</ul>
<p>For example:</p>
<pre class="literal-block"># same as "--verbose"
$ sudo initctl log-priority info

# same as "--debug"
$ sudo initctl log-priority debug
</pre>
<p>The default priority is <tt class="docutils literal">message</tt>:</p>
<pre class="literal-block">$ initctl log-priority
message
</pre>
<p>If the log-priority is changed, it can be reverted to the default like
this:</p>
<pre class="literal-block"># return to default value
$ sudo initctl log-priority message
</pre>
<p>Note that you will need to check the configuration for your system
logging daemon (generally <a class="reference external" href="http://manpages.ubuntu.com/manpages/man3/syslog.3.html">syslog(3)</a> or <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/rsyslogd.8.html">rsyslogd(8)</a>) to establish
where it logs the output.</p>
<p>the output of these options is handled by your systems look at the
particular daemons configuration to know where to find the output.</p>
<p>For a standard Ubuntu Maverick (10.10) system, the output will be sent
to file <tt class="docutils literal">/var/log/daemon.log</tt>, whilst on newer Ubuntu systems such as
Ubuntu Natty (11.04), the output will be directed to file <tt class="docutils literal">/var/log/syslog</tt>.</p>
</div>
<div class="section" id="initctl-notify-cgroup-manager-address">
<h4><a class="toc-backref" href="index.html#toc-entry-197">10.1.6.10&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl <span class="pre">notify-cgroup-manager-address</span></tt></a></h4>
<p>Command to inform Upstart of the address the cgroup manager is listening on.
See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/cgmanager.8.html">cgmanager(8)</a>.</p>
</div>
<div class="section" id="initctl-notify-disk-writeable">
<h4><a class="toc-backref" href="index.html#toc-entry-198">10.1.6.11&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl <span class="pre">notify-disk-writeable</span></tt></a></h4>
<p>Command that is used to notify Upstart that the log disk is writeable
<a class="footnote-reference" href="index.html#tell-upstart-disk-writeable" id="footnote-reference-18">[11]</a>.</p>
<p>This is an indication to Upstart that it can flush the log of job output
for jobs that <em>ended</em> before the log disk became writeable. If logging
is enabled, this command <em>must</em> be called once the disks become
writeable.</p>
</div>
<div class="section" id="initctl-reload">
<h4><a class="toc-backref" href="index.html#toc-entry-199">10.1.6.12&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl reload</tt></a></h4>
<p>Causes the <tt class="docutils literal">SIGHUP</tt> signal to be sent to the main job process since
this signal is commonly used to inform an application to re-initialize
itself. Note that the jobs associated <a class="reference internal" href="index.html#job-configuration-file">Job Configuration File</a> is <em>not</em>
re-read.</p>
</div>
<div class="section" id="initctl-reload-configuration">
<h4><a class="toc-backref" href="index.html#toc-entry-200">10.1.6.13&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl <span class="pre">reload-configuration</span></tt></a></h4>
<p>Force the init daemon to reload its configuration files.</p>
<p>It is generally not necessary to call this command since the init daemon
watches its configuration directories with <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/inotify.7.html">inotify(7)</a> and automatically
reloads in cases of changes.</p>
<p>Note that no jobs will be started by this command.</p>
</div>
<div class="section" id="initctl-reset-env">
<h4><a class="toc-backref" href="index.html#toc-entry-201">10.1.6.14&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl <span class="pre">reset-env</span></tt></a></h4>
<p>Applies to <a class="reference internal" href="index.html#session-jobs">Session Jobs</a> only.</p>
<p>Return the job environment table to its default values. See <a class="reference internal" href="index.html#job-environment">Job
Environment</a>.</p>
</div>
<div class="section" id="initctl-restart">
<h4><a class="toc-backref" href="index.html#toc-entry-202">10.1.6.15&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl restart</tt></a></h4>
<p>Cause the associated job to be killed and respawned. Note that this <em>does
not</em> cause the job to re-read its <a class="reference internal" href="index.html#job-configuration-file">Job Configuration File</a>: to force
this, stop the job and then start it.</p>
</div>
<div class="section" id="initctl-set-env">
<h4><a class="toc-backref" href="index.html#toc-entry-203">10.1.6.16&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl <span class="pre">set-env</span></tt></a></h4>
<p>Applies to <a class="reference internal" href="index.html#session-jobs">Session Jobs</a> only.</p>
<p>Adds or updates a variable in the job environment table. See <a class="reference internal" href="index.html#job-environment">Job
Environment</a>.</p>
<p>Note that as of upstart 1.13, multiple name/value pairs may be specified.</p>
<p>Example:</p>
<pre class="literal-block">$ initctl set-env foo='hello world'
</pre>
</div>
<div class="section" id="initctl-show-config">
<h4><a class="toc-backref" href="index.html#toc-entry-204">10.1.6.17&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl <span class="pre">show-config</span></tt></a></h4>
<p>The <tt class="docutils literal">initctl <span class="pre">show-config</span></tt> command can be used to display details of
how Upstart has parsed one or more job configuration files. The command
displays the <a class="reference internal" href="index.html#start-on">start on</a>, <a class="reference internal" href="index.html#stop-on">stop on</a> and <a class="reference internal" href="index.html#emits">emits</a> stanzas. This might
seem rather pointless, but it is extremely useful since:</p>
<ul>
<li><p class="first">The command will fully-bracket all <a class="reference internal" href="index.html#start-on">start on</a> and <a class="reference internal" href="index.html#stop-on">stop on</a>
conditions.</p>
<p>This shows how Upstart has parsed complex conditions.  For example, if
job <tt class="docutils literal">myjob</tt> specified a <a class="reference internal" href="index.html#start-on">start on</a> condition:</p>
<pre class="literal-block">start on starting a or b and stopping c or d
</pre>
<p>The command would return:</p>
<pre class="literal-block">myjob:
  start on (((starting a or b) and stopping c) or d)
</pre>
</li>
<li><p class="first">The command can produce machine parseable output showing the types of
entities by specifying the "<tt class="docutils literal"><span class="pre">--enumerate</span></tt>" option.</p>
<p>For example, the job above would be displayed as:</p>
<pre class="literal-block">myjob
  start on starting (job: a, env:)
  start on b (job:, env:)
  start on stopping (job: c, env:)
  start on d (job:, env:)
</pre>
<p>Thus,</p>
<ul class="simple">
<li><tt class="docutils literal">a</tt> is a job (with triggering event <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/starting.7.html">starting(7)</a>).</li>
<li><tt class="docutils literal">b</tt> is an event.</li>
<li><tt class="docutils literal">c</tt> is a job (with triggering event <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/stopping.7.html">stopping(7)</a>).</li>
<li><tt class="docutils literal">d</tt> is an event.</li>
</ul>
</li>
<li><p class="first">The command shows the environment for the events.</p>
<p>Assuming a (ridiculous) <a class="reference internal" href="index.html#start-on">start on</a> condition of:</p>
<pre class="literal-block">start on event-a foo=bar a=b c=22 d="hello world" or stopped job-a e=123 f=blah or hello world=2a or starting foo foo=foo
</pre>
<p>Then:</p>
<pre class="literal-block">$ initctl show-config --enumerate myjob
myjob
  start on event-a (job:, env: foo=bar a=b c=22 d=hello world)
  start on stopped (job: job-a, env: e=123 f=blah)
  start on hello (job:, env: world=2a)
  start on starting (job: foo, env: foo=foo)
</pre>
<p>As shown, this makes the condition (slightly!) easier to understand:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">event-a</span></tt> is an event with 4 environment variables:<ul>
<li><tt class="docutils literal">foo=bar</tt></li>
<li><tt class="docutils literal">a=b</tt></li>
<li><tt class="docutils literal">c=22</tt></li>
<li><tt class="docutils literal">d=hello world</tt></li>
</ul>
</li>
<li><tt class="docutils literal"><span class="pre">job-a</span></tt> is a job with triggering event <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/stopped.7.html">stopped(7)</a> and 2 environment
variables:<ul>
<li><tt class="docutils literal">e=123</tt></li>
<li><tt class="docutils literal">f=blah</tt></li>
</ul>
</li>
<li><tt class="docutils literal">hello</tt> is an event with 1 environment variable:<ul>
<li><tt class="docutils literal">world=2a</tt></li>
</ul>
</li>
<li><tt class="docutils literal">foo</tt> is a job with triggering event <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/starting.7.html">starting(7)</a> and 1 environment
variable:<ul>
<li><tt class="docutils literal">foo=foo</tt></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>See also <a class="footnote-reference" href="index.html#job-visualisation-blog" id="footnote-reference-19">[29]</a>.</p>
</div>
<div class="section" id="initctl-start">
<h4><a class="toc-backref" href="index.html#toc-entry-205">10.1.6.18&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl start</tt></a></h4>
<p>Start the specified job or job instance.</p>
</div>
<div class="section" id="initctl-status">
<h4><a class="toc-backref" href="index.html#toc-entry-206">10.1.6.19&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl status</tt></a></h4>
<p>The <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/status.8.html">status(8)</a> command shows the status <em>of all running instances</em> of
a particular job.</p>
<p>Prior to Upstart 1.7, running this command as a non-privileged user
would list both System Jobs and User Jobs (see <a class="reference internal" href="index.html#system-job">System Job</a> and <a class="reference internal" href="index.html#user-job">User
Job</a>). However, as of Upstart 1.7, if this command (or <a class="reference internal" href="index.html#initctl-list">initctl list</a>)
is run from within a session, it will only list <a class="reference internal" href="index.html#session-jobs">Session Jobs</a>.</p>
<p>To see system jobs from within a session, specify the "<tt class="docutils literal"><span class="pre">--system</span></tt>"
command-line option like this:</p>
<pre class="literal-block"># show Session Jobs
$ initctl status myjob

# show System Jobs
$ initctl --system somejob
</pre>
<p>The format of the output can be summarized as follows:</p>
<pre class="literal-block">&lt;job&gt; [ (&lt;instance&gt;)]&lt;goal&gt;/&lt;status&gt;[, process &lt;PID&gt;]
        [&lt;section&gt; process &lt;PID&gt;]
</pre>
<p>Considering each field:</p>
<ul>
<li><p class="first"><tt class="docutils literal">&lt;job&gt;</tt> is the name of the job</p>
<p>Essentially, this is the name of the job configuration file, less the
path and without the "<tt class="docutils literal">.conf</tt>" extension. Thus,
<tt class="docutils literal">/etc/init/myjob.conf</tt> would display as "<tt class="docutils literal">myjob</tt>".</p>
</li>
<li><p class="first"><tt class="docutils literal">&lt;instance&gt;</tt> is the job instance.</p>
<p>See <a class="reference internal" href="index.html#instance">instance</a> and <a class="reference internal" href="index.html#determining-how-to-stop-a-job-with-multiple-running-instances">Determining How to Stop a Job with Multiple
Running Instances</a>.</p>
</li>
<li><p class="first"><tt class="docutils literal">&lt;goal&gt;</tt></p>
<p>Every job has a goal of either <tt class="docutils literal">start</tt> or <tt class="docutils literal">stop</tt> where the goal is
the <em>target</em> the job is <em>aiming</em> for. It may not achieve this target,
but the goal shows the "direction" the job is heading in: it is either
trying to be started, or be stopped.</p>
<ul class="simple">
<li>When a <a class="reference internal" href="index.html#task-job">Task Job</a> starts, its goal will be <tt class="docutils literal">start</tt> and once the
task in question has completed, Upstart will change its goal to
<tt class="docutils literal">stop</tt>.</li>
<li>When a <a class="reference internal" href="index.html#service-job">Service Job</a> starts, its goal will be <tt class="docutils literal">start</tt> and will
remain so until either the jobs <a class="reference internal" href="index.html#stop-on">stop on</a> condition becomes true, or an
Administrator manually stops the job using <a class="reference internal" href="index.html#stop">stop</a>.</li>
</ul>
</li>
<li><p class="first"><tt class="docutils literal">&lt;status&gt;</tt></p>
<p>The job instances status. See <a class="reference internal" href="index.html#job-states">Job States</a>.</p>
</li>
<li><p class="first"><tt class="docutils literal">&lt;PID&gt;</tt> is the process ID of the running process corresponding to
<tt class="docutils literal">&lt;job&gt;</tt>.</p>
<p>See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/ps.1.html">ps(1)</a>.</p>
</li>
<li><p class="first"><tt class="docutils literal">&lt;section&gt;</tt> is a <tt class="docutils literal">script</tt> or <tt class="docutils literal">exec</tt> section (such as <tt class="docutils literal"><span class="pre">pre-stop</span></tt>).</p>
</li>
</ul>
<p>Lets look at some examples...</p>
<div class="section" id="single-job-instance-running-without-pid">
<h5><a class="toc-backref" href="index.html#toc-entry-207">10.1.6.19.1&nbsp;&nbsp;&nbsp;Single Job Instance Running without PID</a></h5>
<p>Here is the summarised syntax:</p>
<pre class="literal-block">&lt;job&gt; &lt;goal&gt;/&lt;status&gt;
</pre>
<p>Example:</p>
<pre class="literal-block">ufw start/running
</pre>
<p>You may be forgiven for thinking this rather curious specimen is an
<a class="reference internal" href="index.html#abstract-job">Abstract Job</a>. Although you cannot determine the fact from the output
above, this job is <em>not</em> an abstract job. If you look at its job
configuration file <tt class="docutils literal">/etc/init/ufw.conf</tt>, you'll see the following:</p>
<pre class="literal-block">description     "Uncomplicated firewall"

# Make sure we start before an interface receives traffic
start on (starting network-interface
          or starting network-manager
          or starting networking)

stop on runlevel [!023456]

console output

pre-start exec /lib/ufw/ufw-init start quiet
post-stop exec /lib/ufw/ufw-init stop
</pre>
<p>Notice the last two lines above. The firewall job configuration file has a
<a class="reference internal" href="index.html#pre-start">pre-start</a> section and a <a class="reference internal" href="index.html#post-stop">post-stop</a> section, but <em>no</em> <tt class="docutils literal">script</tt> or
<tt class="docutils literal">exec</tt> section. So, once Upstart has run the <a class="reference internal" href="index.html#pre-start">pre-start</a> command and
the job is "running", it won't actually have a PID (since the
<a class="reference internal" href="index.html#pre-start">pre-start</a> command will have finished and there is no further command
to run until the job stops).</p>
</div>
<div class="section" id="single-job-instance-running-job-with-pid">
<h5><a class="toc-backref" href="index.html#toc-entry-208">10.1.6.19.2&nbsp;&nbsp;&nbsp;Single Job Instance Running Job with PID</a></h5>
<p>A single <a class="reference internal" href="index.html#instance">instance</a> of a running job can be summarized like this:</p>
<pre class="literal-block">&lt;job&gt; &lt;goal&gt;/&lt;status&gt;, process &lt;PID&gt;
</pre>
<p>This is possibly the "most common case" of jobs you will see. For example:</p>
<pre class="literal-block">cups start/running, process 1733
</pre>
<p>Where:</p>
<ul class="simple">
<li><tt class="docutils literal">&lt;job&gt;</tt> is "<tt class="docutils literal">cups</tt>" (<tt class="docutils literal">/etc/init/cups.conf</tt>).</li>
<li><tt class="docutils literal">&lt;goal&gt;</tt> is "<tt class="docutils literal">start</tt>"</li>
<li><tt class="docutils literal">&lt;status&gt;</tt> is "<tt class="docutils literal">running</tt>"</li>
<li><tt class="docutils literal">&lt;process&gt;</tt> is "<tt class="docutils literal">1733</tt>" (as shown by <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/ps.1.html">ps(1)</a>).</li>
</ul>
</div>
<div class="section" id="single-job-instance-running-with-multiple-pids">
<h5><a class="toc-backref" href="index.html#toc-entry-209">10.1.6.19.3&nbsp;&nbsp;&nbsp;Single Job Instance Running with Multiple PIDs</a></h5>
<p>This can be summarized as:</p>
<pre class="literal-block">&lt;job&gt; &lt;goal&gt;/&lt;status&gt;, process &lt;PID&gt;
  &lt;section&gt; process &lt;PID&gt;
</pre>
<p>For example:</p>
<pre class="literal-block">ureadahead stop/pre-stop, process 227
      pre-stop process 5579
</pre>
<p>What is going on here? Picking this apart we have:</p>
<ul class="simple">
<li><tt class="docutils literal">ureadahead</tt> is the job
(<tt class="docutils literal">/etc/init/ureadahead.conf</tt>).</li>
<li><tt class="docutils literal">stop</tt> is the goal (job is trying to stop).</li>
<li><tt class="docutils literal"><span class="pre">pre-stop</span></tt> is the job status (it is running the <a class="reference internal" href="index.html#pre-stop">pre-stop</a> section as PID
<tt class="docutils literal">5579</tt>).</li>
<li>the <tt class="docutils literal">script</tt> or <tt class="docutils literal">exec</tt> stanza is also running under PID <tt class="docutils literal">227</tt>. See
<a class="reference internal" href="index.html#pre-stop">pre-stop</a> for further details.</li>
</ul>
</div>
<div class="section" id="multiple-running-job-instances-without-pid">
<h5><a class="toc-backref" href="index.html#toc-entry-210">10.1.6.19.4&nbsp;&nbsp;&nbsp;Multiple Running Job Instances Without PID</a></h5>
<p>Summary:</p>
<pre class="literal-block">&lt;job&gt; (&lt;instance&gt;) &lt;goal&gt;/&lt;status&gt; (&lt;instance&gt;)
&lt;job&gt; (&lt;instance&gt;) &lt;goal&gt;/&lt;status&gt; (&lt;instance&gt;)
</pre>
<p>A job with multiple instances might look a little strange initially. Here is
an example:</p>
<pre class="literal-block">network-interface (lo) start/running
network-interface (eth0) start/running
</pre>
<p>Where:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">network-interface</span></tt> is the job
(<tt class="docutils literal"><span class="pre">/etc/init/network-interface.conf</span></tt>).</li>
<li>job instances are:<ul>
<li><tt class="docutils literal">lo</tt></li>
<li><tt class="docutils literal">eth0</tt></li>
</ul>
</li>
<li><tt class="docutils literal">start</tt> is the goal (job instances are currently running).</li>
<li><tt class="docutils literal">running</tt> is the job status (it is running).</li>
</ul>
<p>A slightly more complex example:</p>
<pre class="literal-block">network-interface-security (network-manager) start/running
network-interface-security (network-interface/eth0) start/running
network-interface-security (network-interface/lo) start/running
network-interface-security (networking) start/running
</pre>
<p>Where:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">network-interface-security</span></tt> is the job
(<tt class="docutils literal"><span class="pre">/etc/init/network-interface-security.conf</span></tt>).</li>
<li>job instances are:<ul>
<li><tt class="docutils literal"><span class="pre">network-manager</span></tt></li>
<li><tt class="docutils literal"><span class="pre">network-interface/eth0</span></tt></li>
<li><tt class="docutils literal"><span class="pre">network-interface/lo</span></tt></li>
<li><tt class="docutils literal">networking</tt></li>
</ul>
</li>
<li><tt class="docutils literal">start</tt> is the goal (job instances are currently running).</li>
<li><tt class="docutils literal">running</tt> is the job status (it is running).</li>
</ul>
<p>Let's look at the main elements of the corresponding job configuration file:</p>
<pre class="literal-block">start on (starting network-interface
          or starting network-manager
          or starting networking)

instance $JOB${INTERFACE:+/}${INTERFACE:-}

pre-start script
  # ...
end script
</pre>
<p>Again, this job has no <tt class="docutils literal">script</tt> or <tt class="docutils literal">exec</tt> section, but it does have a
<a class="reference internal" href="index.html#pre-start">pre-start</a> script section. Also, note the interesting <a class="reference internal" href="index.html#instance">instance</a> stanza.
This explains the rather odd-looking instance names listed above.</p>
</div>
<div class="section" id="multiple-running-job-instances-with-pids">
<h5><a class="toc-backref" href="index.html#toc-entry-211">10.1.6.19.5&nbsp;&nbsp;&nbsp;Multiple Running Job Instances With PIDs</a></h5>
<p>Summary:</p>
<pre class="literal-block">&lt;job&gt; (&lt;instance&gt;) &lt;goal&gt;/&lt;status&gt; (&lt;instance&gt;), process &lt;PID&gt;
</pre>
<p>For example:</p>
<pre class="literal-block">foo (1) start/running, process 30003
foo (hello 1,2,3) start/running, process 30008
</pre>
<p>Where:</p>
<ul class="simple">
<li><tt class="docutils literal">foo</tt> is the job (<tt class="docutils literal">/etc/init/foo.conf</tt>).</li>
<li><tt class="docutils literal">start</tt> is the goal (it is not trying to stop).</li>
<li><tt class="docutils literal">running</tt> is the job status (it is running).</li>
<li>instances are:<ul>
<li><tt class="docutils literal">1</tt> (PID <tt class="docutils literal">30003</tt>)</li>
<li><tt class="docutils literal">hello 1,2,3</tt> (PID <tt class="docutils literal">30008</tt>)</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="multiple-running-job-instances-with-multiple-pids">
<h5><a class="toc-backref" href="index.html#toc-entry-212">10.1.6.19.6&nbsp;&nbsp;&nbsp;Multiple Running Job Instances With Multiple PIDs</a></h5>
<p>Summary:</p>
<pre class="literal-block">&lt;job&gt; (&lt;instance&gt;) &lt;goal&gt;/&lt;status&gt; (&lt;instance&gt;), process &lt;PID&gt;
        &lt;section&gt; process &lt;PID&gt;
</pre>
<p>For example:</p>
<pre class="literal-block">myjob (foo) stop/pre-stop, process 31677
        pre-stop process 31684
myjob (bar) stop/pre-stop, process 31679
        pre-stop process 31687
myjob (bzr) stop/pre-stop, process 31681
        pre-stop process 31690
</pre>
<p>Where:</p>
<ul class="simple">
<li><tt class="docutils literal">myjob</tt> is the job (<tt class="docutils literal">/etc/init/myjob.conf</tt>).</li>
<li><tt class="docutils literal">stop</tt> is the goal (job is trying to stop).</li>
<li><tt class="docutils literal"><span class="pre">pre-stop</span></tt> is the job status (it is running the <a class="reference internal" href="index.html#pre-stop">pre-stop</a> section for
each instance).</li>
<li>instances are:<ul>
<li><tt class="docutils literal">foo</tt> (PID <tt class="docutils literal">31677</tt>, with <tt class="docutils literal"><span class="pre">pre-stop</span></tt> PID <tt class="docutils literal">31684</tt>)</li>
<li><tt class="docutils literal">bar</tt> (PID <tt class="docutils literal">31679</tt>, with <tt class="docutils literal"><span class="pre">pre-stop</span></tt> PID <tt class="docutils literal">31687</tt>)</li>
<li><tt class="docutils literal">baz</tt> (PID <tt class="docutils literal">31681</tt>, with <tt class="docutils literal"><span class="pre">pre-stop</span></tt> PID <tt class="docutils literal">31690</tt>)</li>
</ul>
</li>
</ul>
<p>It is instructive to see how we got to the output above. Here is the job configuration file:</p>
<pre class="literal-block">instance $foo

exec sleep 999

pre-stop script
  sleep 999
end script
</pre>
<p>We then started three instances like this:</p>
<pre class="literal-block"># for i in foo bar baz; do start -n myjob foo=$i; done
</pre>
<p>Note we used the "<tt class="docutils literal"><span class="pre">-n</span></tt>" option to <a class="reference internal" href="index.html#start">start</a> to ensure we didn't have to wait
for each instance to complete before starting the next.</p>
<p>Now all three instances are running:</p>
<pre class="literal-block"># initctl list|grep -A 1 ^inst
myjob start/running (foo), process 31677
myjob start/running (bar), process 31679
myjob start/running (baz), process 31681
</pre>
<p>To trigger the <a class="reference internal" href="index.html#pre-stop">pre-stop</a>, we need to stop the instances:</p>
<pre class="literal-block"># for i in foo bar baz; do stop -n myjob foo=$i; done
myjob (foo) stop/pre-stop, process 31677
      pre-stop process 31684
myjob (bar) stop/pre-stop, process 31679
      pre-stop process 31687
myjob (baz) stop/pre-stop, process 31681
      pre-stop process 31690
</pre>
<p>Now, running <a class="reference internal" href="index.html#initctl">initctl</a> will show the output at the start of this section.</p>
</div>
<div class="section" id="stopped-job">
<h5><a class="toc-backref" href="index.html#toc-entry-213">10.1.6.19.7&nbsp;&nbsp;&nbsp;Stopped Job</a></h5>
<p>Summary:</p>
<pre class="literal-block">&lt;job&gt; &lt;goal&gt;/&lt;status&gt;
</pre>
<p>A job that is not running (has no instances):</p>
<pre class="literal-block">rc stop/waiting
</pre>
<p>Where:</p>
<ul class="simple">
<li><tt class="docutils literal">rc</tt> is the job (<tt class="docutils literal">/etc/init/rc.conf</tt>).</li>
<li><tt class="docutils literal">stop</tt> is the goal (it is not trying to start).</li>
<li><tt class="docutils literal">waiting</tt> is the job status (it is not running).</li>
</ul>
</div>
</div>
<div class="section" id="initctl-stop">
<h4><a class="toc-backref" href="index.html#toc-entry-214">10.1.6.20&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl stop</tt></a></h4>
<p>Stop the specified job or job instance.</p>
</div>
<div class="section" id="initctl-unset-env">
<h4><a class="toc-backref" href="index.html#toc-entry-215">10.1.6.21&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl <span class="pre">unset-env</span></tt></a></h4>
<p>Applies to <a class="reference internal" href="index.html#session-jobs">Session Jobs</a> only.</p>
<p>Discards the specified variable from the job environment table. See <a class="reference internal" href="index.html#job-environment">Job
Environment</a>.</p>
<p>Note that as of Upstart 1.9, any variable inherited from when the <a class="reference internal" href="index.html#session-init">Session
Init</a> starts can be unset.</p>
<p>Note that as of Upstart 1.13, multiple name/value pairs may be specified.</p>
</div>
<div class="section" id="initctl-usage">
<h4><a class="toc-backref" href="index.html#toc-entry-216">10.1.6.22&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl usage</tt></a></h4>
<p>This command allows the usage for a job to be queried:</p>
<pre class="literal-block">$ initctl usage &lt;job&gt;
</pre>
<p>Note that if a job is specified which does not use the <a class="reference internal" href="index.html#usage">usage</a> stanza,
no usage will be displayed.</p>
</div>
<div class="section" id="initctl-version">
<h4><a class="toc-backref" href="index.html#toc-entry-217">10.1.6.23&nbsp;&nbsp;&nbsp;<tt class="docutils literal">initctl version</tt></a></h4>
<p>Display the version of the init daemon. To display the version of
<tt class="docutils literal">initctl</tt> itself, run:</p>
<pre class="literal-block">initctl --version
</pre>
</div>
</div>
<div class="section" id="init-checkconf">
<h3><a class="toc-backref" href="index.html#toc-entry-218">10.1.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">init-checkconf</span></tt></a></h3>
<p>The <tt class="docutils literal"><span class="pre">init-checkconf</span></tt> script performs checks on a job configuration
file <em>prior</em> to installing it in <tt class="docutils literal">/etc/init/</tt>. The script must be run
as a non-<tt class="docutils literal">root</tt> user for all versions prior to that provided by Upstart
1.12.</p>
<p>To ensure that you haven't misused the Upstart syntax, use the
<tt class="docutils literal"><span class="pre">init-checkconf</span></tt> command:</p>
<pre class="literal-block">$ init-checkconf myjob.conf
</pre>
<p>See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/init-checkconf.8.html">init-checkconf(8)</a> for further details.</p>
</div>
<div class="section" id="upstart-monitor">
<h3><a class="toc-backref" href="index.html#toc-entry-219">10.1.8&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">upstart-monitor</span></tt></a></h3>
<p><em>Added in Upstart v1.8</em> (requires at least Upstart v1.7).</p>
<p>The <tt class="docutils literal"><span class="pre">upstart-monitor</span></tt> is a utility that is used to display Upstart
events as they are emitted.</p>
<p>It is useful to:</p>
<ul class="simple">
<li>Understand how Upstart is managing your <a class="reference internal" href="index.html#system-jobs">system jobs</a>.</li>
<li>Understand how a <a class="reference internal" href="index.html#session-init">Session Init</a> is managing your <a class="reference internal" href="index.html#session-jobs">session jobs</a>.</li>
<li>Determine the <a class="reference internal" href="index.html#start-on">start on</a> and <a class="reference internal" href="index.html#stop-on">stop on</a> conditions for jobs you are creating.</li>
</ul>
<p>The utility can run either as a command-line (CLI) application:</p>
<div class="figure align-center">
<img alt="upstart-monitor in CLI mode." src="./upstart-monitor-cli.png" style="width: 350.7px; height: 107.8px;">
</div>
<p>It can also run as as a GUI:</p>
<div class="figure align-center">
<img alt="upstart-monitor in GUI mode." src="./upstart-monitor-gui.png" style="width: 448.0px; height: 200.89999999999998px;">
</div>
<p>If the required GUI libraries are not available, it will automatically
run in CLI mode.</p>
</div>
<div class="section" id="mountall-debian-and-ubuntu-specific">
<h3><a class="toc-backref" href="index.html#toc-entry-220">10.1.9&nbsp;&nbsp;&nbsp;<tt class="docutils literal">mountall</tt> (<img alt="D" class="debian-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/4926319605052bdf09442836fd8d799b236e5db8"> , <img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719">)</a></h3>
<p><strong>NOTE</strong>: <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/mountall.8.html">mountall(8)</a> is a <a class="reference external" href="http://www.debian.org/">Debian</a> and <a class="reference external" href="http://www.ubuntu.com/">Ubuntu</a> specific extension.</p>
<p>The <tt class="docutils literal">mountall</tt> daemon is the program that mounts your filesystems
during boot on an Ubuntu system. It does this by parsing both
<tt class="docutils literal">/etc/fstab</tt> and its own fstab file <tt class="docutils literal">/lib/init/fstab</tt>, and mounting
the filesystems it finds listed. Additionally, it handles running
<a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/fsck.8.html">fsck(8)</a>.</p>
<p>See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man5/fstab.html">fstab(5)</a>.</p>
<div class="section" id="mountall-events">
<h4><a class="toc-backref" href="index.html#toc-entry-221">10.1.9.1&nbsp;&nbsp;&nbsp;Mountall events</a></h4>
<p>Mountall also emits a number of useful events. For <em>every</em> filesystem it
determines needs to be mounted, it will emit up to 2 events:</p>
<blockquote>
<ul class="simple">
<li><tt class="docutils literal">mounting</tt></li>
<li><tt class="docutils literal">mounted</tt></li>
</ul>
</blockquote>
<p>Additional to the couplet above, <tt class="docutils literal">mountall</tt> also emits the following
"well-known" events. The sections below provide details.</p>
<p>The <tt class="docutils literal">mountall</tt> daemon is unusual in emitting such a number of events.
However, it does this to provide as much flexibility as possible since
making disks and filesystem available is such an important part of the
boot process (and a lot of other jobs need to be notified when certain
mounts become available).</p>
<div class="section" id="mounting">
<h5><a class="toc-backref" href="index.html#toc-entry-222">10.1.9.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">mounting</tt></a></h5>
<p>Emitted when a particular filesystem is about to be mounted.</p>
<p>See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/mounting.7.html">mounting(7)</a>.</p>
</div>
<div class="section" id="mounted">
<h5><a class="toc-backref" href="index.html#toc-entry-223">10.1.9.1.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">mounted</tt></a></h5>
<p>Emitted by when a particular filesystem has been mounted successfully.</p>
<p>Note that if a filesystem failed to mount, no corresponding <tt class="docutils literal">mounted</tt>
event will be emitted.</p>
<p>See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/mounted.7.html">mounted(7)</a>.</p>
</div>
<div class="section" id="all-swaps">
<h5><a class="toc-backref" href="index.html#toc-entry-224">10.1.9.1.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">all-swaps</span></tt></a></h5>
<p>Emitted when all swap devices are mounted.</p>
<p>See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/all-swaps.7.html">all-swaps(7)</a>.</p>
</div>
<div class="section" id="filesystem">
<h5><a class="toc-backref" href="index.html#toc-entry-225">10.1.9.1.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">filesystem</tt></a></h5>
<p>Emitted after <a class="reference internal" href="index.html#mountall-debian-and-ubuntu-specific">mountall (debian-and-ubuntu-specific)</a> has mounted (or
at least attempted to mount) all filesystems.</p>
<p>See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/filesystem.html">filesystem(7)</a>.</p>
</div>
<div class="section" id="virtual-filesystems">
<h5><a class="toc-backref" href="index.html#toc-entry-226">10.1.9.1.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">virtual-filesystems</span></tt></a></h5>
<p>Emitted after the last virtual filesystem has been mounted.</p>
<p>See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/virtual-filesystems.7.html">virtual-filesystems(7)</a>.</p>
</div>
<div class="section" id="local-filesystems">
<h5><a class="toc-backref" href="index.html#toc-entry-227">10.1.9.1.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">local-filesystems</span></tt></a></h5>
<p>Emitted after the last local filesystem has been mounted.</p>
<p>See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/local-filesystems.7.html">local-filesystems(7)</a>.</p>
</div>
<div class="section" id="remote-filesystems">
<h5><a class="toc-backref" href="index.html#toc-entry-228">10.1.9.1.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">remote-filesystems</span></tt></a></h5>
<p>Emitted after the last remote filesystem has been mounted.</p>
<p>See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/remote-filesystems.7.html">remote-filesystems(7)</a>.</p>
</div>
</div>
<div class="section" id="mountall-event-summary">
<h4><a class="toc-backref" href="index.html#toc-entry-229">10.1.9.2&nbsp;&nbsp;&nbsp;Mountall Event Summary</a></h4>
<!-- # FIXME: is it possible to embed a literal block in a table? -->
<pre class="literal-block">+------------------------------------------------------------+---------------------+
|mounting MOUNTPOINT=/virtual-1                              |  mounting TYPE=swap |
|mounted  MOUNTPOINT=/virtual-1                              |  mounted  TYPE=swap |
|     :                                                      |  all-swaps          |
|mounting MOUNTPOINT=/virtual-n                              |                     |
|mounted  MOUNTPOINT=/virtual-n                              |                     |
|virtual-filesystems                                         |                     |
+-----------------------------+------------------------------+                     |
|mounting MOUNTPOINT=/local-1 |mounting MOUNTPOINT=/remote-1 |                     |
|mounted  MOUNTPOINT=/local-1 |mounted  MOUNTPOINT=/remote-1 |                     |
|     :                       |     :                        |                     |
|mounting MOUNTPOINT=/local-n |mounting MOUNTPOINT=/remote-n |                     |
|mounted  MOUNTPOINT=/local-n |mounted  MOUNTPOINT=/remote-n |                     |
|local-filesystems            |remote-filesystems            |                     |
+-----------------------------+------------------------------+---------------------+
|filesystem                                                                        |
+----------------------------------------------------------------------------------+
</pre>
<p>The diagram above shows the different event flows when <tt class="docutils literal">mountall</tt>
runs. Note in particular that columns should be considered as independent "threads" of
execution (can happen at any time and independently), and rows are
sequential: rows lower down the chart occur at at later time than those
higher up the chart.</p>
<p>Notes on <tt class="docutils literal">mountall</tt> event emission:</p>
<blockquote>
<ul class="simple">
<li>swap partitions are processed at any time.</li>
<li>virtual filesystems are processed at any time.</li>
<li>virtual filesystems are processed before local or remote filesystems
(regardless of their ordering in <tt class="docutils literal">/etc/fstab</tt>).</li>
<li>local and remote filesystems are mounted at any time after the last
virtual filesystem has been mounted.</li>
</ul>
</blockquote>
<p>See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/mounting.7.html">mounting(7)</a> and <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/mounted.7.html">mounted(7)</a>. For a concise summary of all
available events generated by <tt class="docutils literal">mountall</tt>, see <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/upstart-events.7.html">upstart-events(7)</a>.</p>
</div>
<div class="section" id="mountall-examples">
<h4><a class="toc-backref" href="index.html#toc-entry-230">10.1.9.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">mountall</tt> Examples</a></h4>
<p>The examples which follow were generated using the following job
configuration file <tt class="docutils literal">/etc/init/get_mountall.conf</tt>:</p>
<pre class="literal-block">start on (local-filesystems
      or (mounting
      or (mounted
      or (virtual-filesystems
      or (remote-filesystems
      or (all-swaps or filesystem))))))

script
  echo "\n`env`" &gt;&gt; /dev/.initramfs/mountall.log
end script
</pre>
<p>Script output:</p>
<pre class="literal-block">MOUNTPOINT=/proc
UPSTART_INSTANCE=
UPSTART_JOB=get_mountall
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
OPTIONS=nodev,noexec,nosuid
TYPE=proc
UPSTART_EVENTS=mounted
PWD=/
DEVICE=proc

MOUNTPOINT=/sys/fs/fuse/connections
UPSTART_INSTANCE=
UPSTART_JOB=get_mountall
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
OPTIONS=optional
TYPE=fusectl
UPSTART_EVENTS=mounted
PWD=/
DEVICE=fusectl

MOUNTPOINT=/dev/pts
UPSTART_INSTANCE=
UPSTART_JOB=get_mountall
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
OPTIONS=noexec,nosuid,gid=tty,mode=0620
TYPE=devpts
UPSTART_EVENTS=mounted
PWD=/
DEVICE=none

MOUNTPOINT=/sys/kernel/debug
UPSTART_INSTANCE=
UPSTART_JOB=get_mountall
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
OPTIONS=optional
TYPE=debugfs
UPSTART_EVENTS=mounted
PWD=/
DEVICE=none

MOUNTPOINT=/sys/kernel/security
UPSTART_INSTANCE=
UPSTART_JOB=get_mountall
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
OPTIONS=optional
TYPE=securityfs
UPSTART_EVENTS=mounting
PWD=/
DEVICE=none

MOUNTPOINT=/sys/kernel/security
UPSTART_INSTANCE=
UPSTART_JOB=get_mountall
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
OPTIONS=optional
TYPE=securityfs
UPSTART_EVENTS=mounted
PWD=/
DEVICE=none

MOUNTPOINT=/dev/shm
UPSTART_INSTANCE=
UPSTART_JOB=get_mountall
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
OPTIONS=nosuid,nodev
TYPE=tmpfs
UPSTART_EVENTS=mounting
PWD=/
DEVICE=none

MOUNTPOINT=/dev/shm
UPSTART_INSTANCE=
UPSTART_JOB=get_mountall
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
OPTIONS=nosuid,nodev
TYPE=tmpfs
UPSTART_EVENTS=mounted
PWD=/
DEVICE=none

MOUNTPOINT=/var/run
UPSTART_INSTANCE=
UPSTART_JOB=get_mountall
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
OPTIONS=mode=0755,nosuid,showthrough
TYPE=tmpfs
UPSTART_EVENTS=mounting
PWD=/
DEVICE=none

MOUNTPOINT=/var/run
UPSTART_INSTANCE=
UPSTART_JOB=get_mountall
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
OPTIONS=mode=0755,nosuid,showthrough
TYPE=tmpfs
UPSTART_EVENTS=mounted
PWD=/
DEVICE=none

MOUNTPOINT=/var/lock
UPSTART_INSTANCE=
UPSTART_JOB=get_mountall
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
OPTIONS=nodev,noexec,nosuid,showthrough
TYPE=tmpfs
UPSTART_EVENTS=mounting
PWD=/
DEVICE=none

MOUNTPOINT=/var/lock
UPSTART_INSTANCE=
UPSTART_JOB=get_mountall
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
OPTIONS=nodev,noexec,nosuid,showthrough
TYPE=tmpfs
UPSTART_EVENTS=mounted
PWD=/
DEVICE=none

MOUNTPOINT=/lib/init/rw
UPSTART_INSTANCE=
UPSTART_JOB=get_mountall
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
OPTIONS=mode=0755,nosuid,optional
TYPE=tmpfs
UPSTART_EVENTS=mounted
PWD=/
DEVICE=none

UPSTART_INSTANCE=
UPSTART_JOB=get_mountall
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
UPSTART_EVENTS=virtual-filesystems
PWD=/

UPSTART_INSTANCE=
UPSTART_JOB=get_mountall
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
UPSTART_EVENTS=remote-filesystems
PWD=/

MOUNTPOINT=none
UPSTART_INSTANCE=
UPSTART_JOB=get_mountall
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
OPTIONS=sw
TYPE=swap
UPSTART_EVENTS=mounting
PWD=/
DEVICE=/dev/disk/by-uuid/b67802dc-35f9-4153-9957-ef04c7af6a1f

MOUNTPOINT=none
UPSTART_INSTANCE=
UPSTART_JOB=get_mountall
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
OPTIONS=sw
TYPE=swap
UPSTART_EVENTS=mounted
PWD=/
DEVICE=/dev/disk/by-uuid/b67802dc-35f9-4153-9957-ef04c7af6a1f

UPSTART_INSTANCE=
UPSTART_JOB=get_mountall
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
UPSTART_EVENTS=all-swaps
PWD=/

MOUNTPOINT=/
UPSTART_INSTANCE=
UPSTART_JOB=get_mountall
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
OPTIONS=errors=remount-ro
TYPE=ext4
UPSTART_EVENTS=mounting
PWD=/
DEVICE=/dev/disk/by-uuid/b68c4bc0-6342-411c-878a-a576b3a255b3

MOUNTPOINT=/
UPSTART_INSTANCE=
UPSTART_JOB=get_mountall
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
OPTIONS=errors=remount-ro
TYPE=ext4
UPSTART_EVENTS=mounted
PWD=/
DEVICE=/dev/disk/by-uuid/b68c4bc0-6342-411c-878a-a576b3a255b3

MOUNTPOINT=/tmp
UPSTART_INSTANCE=
UPSTART_JOB=get_mountall
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
OPTIONS=defaults
TYPE=none
UPSTART_EVENTS=mounting
PWD=/
DEVICE=none

MOUNTPOINT=/tmp
UPSTART_INSTANCE=
UPSTART_JOB=get_mountall
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
OPTIONS=defaults
TYPE=none
UPSTART_EVENTS=mounted
PWD=/
DEVICE=none

UPSTART_INSTANCE=
UPSTART_JOB=get_mountall
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
UPSTART_EVENTS=local-filesystems
PWD=/

UPSTART_INSTANCE=
UPSTART_JOB=get_mountall
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
UPSTART_EVENTS=filesystem
PWD=/
</pre>
</div>
</div>
</div>
<div class="section" id="bridges">
<h2><a class="toc-backref" href="index.html#toc-entry-231">10.2&nbsp;&nbsp;&nbsp;Bridges</a></h2>
<p>Bridges react to events from some other (non-Upstart) source and create
corresponding Upstart events.</p>
<table border="1" class="docutils">
<caption>Summary of available bridges.</caption>
<colgroup>
<col width="46%">
<col width="54%">
</colgroup>
<thead valign="bottom">
<tr><th class="head">Bridge</th>
<th class="head">Added in Version</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><a class="reference internal" href="index.html#upstart-dbus-bridge">upstart-dbus-bridge</a></td>
<td>1.9</td>
</tr>
<tr><td><a class="reference internal" href="index.html#upstart-dconf-bridge">upstart-dconf-bridge</a></td>
<td>1.10</td>
</tr>
<tr><td><a class="reference internal" href="index.html#upstart-event-bridge">upstart-event-bridge</a></td>
<td>1.7</td>
</tr>
<tr><td><a class="reference internal" href="index.html#upstart-file-bridge">upstart-file-bridge</a></td>
<td>1.8</td>
</tr>
<tr><td><a class="reference internal" href="index.html#upstart-local-bridge">upstart-local-bridge</a></td>
<td>1.10</td>
</tr>
<tr><td><a class="reference internal" href="index.html#upstart-socket-bridge">upstart-socket-bridge</a></td>
<td>1.3 (bundled for first time)</td>
</tr>
<tr><td><a class="reference internal" href="index.html#upstart-udev-bridge">upstart-udev-bridge</a></td>
<td>1.3 (bundled for first time)</td>
</tr>
</tbody>
</table>
<div class="section" id="plymouth-upstart-bridge-ubuntu-specific">
<h3><a class="toc-backref" href="index.html#toc-entry-232">10.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">plymouth-upstart-bridge</span></tt> (<img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719">)</a></h3>
<p>The <tt class="docutils literal"><span class="pre">plymouth-upstart-bridge</span></tt> is an <a class="reference external" href="http://www.ubuntu.com/">Ubuntu</a>-specific facility to allow
<a class="reference external" href="http://www.freedesktop.org/wiki/Software/Plymouth">Plymouth</a> to display <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> state changes on the boot splash screen.</p>
<p>See the <a class="reference external" href="https://wiki.ubuntu.com/Plymouth">Plymouth Ubuntu wiki</a> page for more information on Plymouth.</p>
</div>
<div class="section" id="upstart-socket-bridge">
<h3><a class="toc-backref" href="index.html#toc-entry-233">10.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">upstart-socket-bridge</span></tt></a></h3>
<p>The Upstart socket bridge is an out-of-process application that "listens" for
jobs that announce they "<tt class="docutils literal">start on socket</tt>". The bridge arranges for the jobs
in question to be started automatically <em>at the point the first client
connection</em> is made on the socket specified in their start on condition. See
<a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/socket-event.7.html">socket-event(7)</a>.</p>
<p>This is a useful "lazy" facility in that it allows for applications which are
expensive to load to be started "<cite>on demand</cite>" rather than simply at some point
on every boot: if you have no customers to your web site one day, there is
probably no point in starting your database server. The downside to using the
bridge being that the first client connection will probably be slower than
subsequent connections to allow the application time to start.</p>
<p>Supported socket types:</p>
<ul class="simple">
<li>Unix sockets.</li>
<li>Abstract sockets.</li>
<li>IPv4 sockets.</li>
<li>IPv6 sockets (requires version provided with Upstart 1.12, or above).</li>
</ul>
</div>
<div class="section" id="upstart-udev-bridge">
<h3><a class="toc-backref" href="index.html#toc-entry-234">10.2.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">upstart-udev-bridge</span></tt></a></h3>
<p>The <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/udev.7.html">udev(7)</a> bridge creates Upstart events from udev events.
As documented in <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/upstart-udev-bridge.html">upstart-udev-bridge(8)</a>, Upstart will create events named:</p>
<pre class="literal-block">&lt;subsystem&gt;-device-&lt;action&gt;
</pre>
<p>Where:</p>
<ul class="simple">
<li><tt class="docutils literal">&lt;subsystem&gt;</tt> is the udev subsystem.</li>
<li><tt class="docutils literal">&lt;action&gt;</tt> is the udev action.</li>
</ul>
<p><a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> maps the three actions below to new names, but any other actions are
left unmolested:</p>
<ul class="simple">
<li><tt class="docutils literal">add</tt> becomes <tt class="docutils literal">added</tt></li>
<li><tt class="docutils literal">change</tt> becomes  <tt class="docutils literal">changed</tt></li>
<li><tt class="docutils literal">deleted</tt> becomes <tt class="docutils literal">removed</tt></li>
</ul>
<p>To see a list of possible Upstart events for your system:</p>
<pre class="literal-block">for subsystem in /sys/class/*
do
  for action in added changed removed
  do
    echo "${subsystem}-device-${action}"
  done
done
</pre>
<p>Alternatively, you could parse the following:</p>
<pre class="literal-block"># udevadm info --export-db
</pre>
<p>To monitor udev events:</p>
<pre class="literal-block">$ udevadm monitor --environment
</pre>
<p>And now for some examples...</p>
<p>If a job <tt class="docutils literal"><span class="pre">job-A</span></tt> specified a <tt class="docutils literal">start on</tt> condition of:</p>
<pre class="literal-block">start on (graphics-device-added or drm-device-added)
</pre>
<p>To see what sort of information is available to this job, we can add the usual debugging information:</p>
<pre class="literal-block">start on (graphics-device-added or drm-device-added)
script
  echo "`env`" &gt; /dev/.initramfs/job-A.log
end script
</pre>
<p>Here is an example of the log:</p>
<pre class="literal-block">DEV_LOG=3
DEVNAME=/dev/fb0
UPSTART_INSTANCE=
ACTION=add
SEQNUM=1176
MAJOR=29
KERNEL=fb0
DEVPATH=/devices/platform/efifb.0/graphics/fb0
UPSTART_JOB=job-A
TERM=linux
SUBSYSTEM=graphics
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
MINOR=0
UPSTART_EVENTS=graphics-device-added
PWD=/
PRIMARY_DEVICE_FOR_DISPLAY=1
</pre>
<p>Another example specifying a <tt class="docutils literal">start on</tt> containing <tt class="docutils literal"><span class="pre">net-device-added</span></tt>:</p>
<pre class="literal-block">ID_BUS=pci
UDEV_LOG=3
UPSTART_INSTANCE=
ID_VENDOR_FROM_DATABASE=Realtek Semiconductor Co., Ltd.
ACTION=add
SEQNUM=1171
MATCHADDR=52:54:00:12:34:56
IFINDEX=2
KERNEL=eth0
DEVPATH=/devices/pci0000:00/0000:00:03.0/net/eth0
UPSTART_JOB=job-A
TERM=linux
SUBSYSTEM=net
ID_MODEL_ID=0x8139
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
ID_MM_CANDIDATE=1
ID_MODEL_FROM_DATABASE=RTL-8139/8139C/8139C+
UPSTART_EVENTS=net-device-added
INTERFACE=eth0
PWD=/
MATCHIFTYPE=1
ID_VENDOR_ID=0x10ec
</pre>
<p>Plugging in a USB webcam will generate an <tt class="docutils literal"><span class="pre">input-device-added</span></tt> event:</p>
<pre class="literal-block">DEV_LOG=3
DEVNAME=/dev/input/event12
UPSTART_INSTANCE=
ACTION=add
SEQNUM=2689
XKBLAYOUT=gb
MAJOR=13
ID_INPUT=1
KERNEL=event12
DEVPATH=/devices/pci0000:00/0000:00:1d.0/usb2/2-1/2-1.2/input/input33/event12
UPSTART_JOB=test_camera
TERM=linux
DEVLINKS=/dev/char/13:76 /dev/input/by-path/pci-0000:00:1d.0-event
SUBSYSTEM=input
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
MINOR=76
DISPLAY=:0.0
ID_INPUT_KEY=1
ID_PATH=pci-0000:00:1d.0
UPSTART_EVENTS=input-device-added
PWD=/
</pre>
<p>Note: you may get additional events if it also includes a microphone or other sensors.</p>
<p>Plugging in a USB headset (headphones plus a microphone) will probably
generate <em>three</em> events:</p>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">sound-device-added</span></tt> (for the headphones):</p>
<blockquote>
<pre class="literal-block">UPSTART_INSTANCE=
ACTION=add
SEQNUM=2637
KERNEL=card2
DEVPATH=/devices/pci0000:00/0000:00:1d.0/usb2/2-1/2-1.2/2-1.2:1.0/sound/card2
UPSTART_JOB=test_sound
TERM=linux
SUBSYSTEM=sound
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
UPSTART_EVENTS=sound-device-added
PWD=/
</pre>
</blockquote>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">usb-device-added</span></tt>   (also for the headphones):</p>
<blockquote>
<pre class="literal-block">UDEV_LOG=3
DEVNAME=/dev/bus/usb/002/027
UPSTART_INSTANCE=
ACTION=add
SEQNUM=2635
BUSNUM=002
MAJOR=189
KERNEL=2-1.2
DEVPATH=/devices/pci0000:00/0000:00:1d.0/usb2/2-1/2-1.2
UPSTART_JOB=test_usb
ID_MODEL_ENC=Logitech\x20USB\x20Headset
ID_USB_INTERFACES=:010100:010200:030000:
ID_MODEL=Logitech_USB_Headset
TERM=linux
DEVLINKS=/dev/char/189:154
ID_SERIAL=Logitech_Logitech_USB_Headset
SUBSYSTEM=usb
UPOWER_VENDOR=Logitech, Inc.
ID_MODEL_ID=0a0b
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
MINOR=154
TYPE=0/0/0
UPSTART_EVENTS=usb-device-added
ID_VENDOR_ENC=Logitech
DEVNUM=027
PRODUCT=46d/a0b/1013
PWD=/
ID_VENDOR=Logitech
DEVTYPE=usb_device
ID_VENDOR_ID=046d
ID_REVISION=1013
</pre>
</blockquote>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">input-device-added</span></tt> (for the microphone):</p>
<blockquote>
<pre class="literal-block">UDEV_LOG=3
UPSTART_INSTANCE=
ACTION=add
PHYS="usb-0000:00:1d.0-1.2/input3"
SEQNUM=2645
EV==13
KERNEL=input31
DEVPATH=/devices/pci0000:00/0000:00:1d.0/usb2/2-1/2-1.2/2-1.2:1.3/input/input31
UPSTART_JOB=test_input
MSC==10
NAME="Logitech Logitech USB Headset"
TERM=linux
SUBSYSTEM=input
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
MODALIAS=input:b0003v046Dp0A0Be0100-e0,1,4,k72,73,ram4,lsfw
KEY==c0000 0 0 0
UPSTART_EVENTS=input-device-added
PRODUCT=3/46d/a0b/100
PWD=/
</pre>
</blockquote>
</li>
</ul>
<div class="section" id="careful-use-of-udev-events">
<h4><a class="toc-backref" href="index.html#toc-entry-235">10.2.3.1&nbsp;&nbsp;&nbsp;Careful Use of udev Events</a></h4>
<p>You need to be careful when using the <tt class="docutils literal"><span class="pre">upstart-udev-bridge</span></tt> since
certain devices are <em>NOT</em> ready at the point the kernel generates the
original udev event: in these circumstances, all the kernel is saying is
"I have this device", not "I have this device <em>and it is ready to use</em>".</p>
<p>The problem is that the kernel does not know when the device is ready
and neither can Upstart know this. The kernel is simply signalling that
the device has either:</p>
<ul class="simple">
<li>become available
(once the <tt class="docutils literal"><span class="pre">upstart-udev-bridge</span></tt> emits the "<tt class="docutils literal"><span class="pre">*-device-added</span></tt>" event).</li>
<li>changed state somehow
(once the <tt class="docutils literal"><span class="pre">upstart-udev-bridge</span></tt> emits the <em>one or more</em>
"<tt class="docutils literal"><span class="pre">*-device-changed</span></tt>" events).</li>
</ul>
<p>So, for example, just because you have received a "<tt class="docutils literal"><span class="pre">usb-device-added</span></tt>"
event for your USB modem does not guarantee that the modem is
operational.</p>
<p>Unfortunately, every device acts differently, so you really do need
specialist knowledge of the device in question.</p>
<p>However, a general rule of thumb is that a device is ready once Upstart has
emitted a "<tt class="docutils literal">changed</tt>" event for the device which also includes a
"<tt class="docutils literal">ID_</tt>" variable in that events environment. This is of particular
importance for "<tt class="docutils literal">block</tt>" devices and "<tt class="docutils literal">sound</tt>" devices.</p>
</div>
</div>
<div class="section" id="upstart-event-bridge">
<h3><a class="toc-backref" href="index.html#toc-entry-236">10.2.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">upstart-event-bridge</span></tt></a></h3>
<p><em>Added in Upstart v1.7</em></p>
<p>An instance of the <tt class="docutils literal"><span class="pre">upstart-event-bridge</span></tt> runs for each logged in
user and proxies system-level events down to the users session. In plain
English, this means all events emitted by a <a class="reference internal" href="index.html#system-job">system job</a> become visible to
jobs running as the user.</p>
<p>To allow Session Jobs to distinguish between User Events and System
Events, the <tt class="docutils literal"><span class="pre">upstart-event-bridge</span></tt> prefixes all system events with
"<tt class="docutils literal">:sys:</tt>". So for example, when the "<tt class="docutils literal">foo</tt>" system job starts, at
the <em>system</em> level the following event will be emitted:</p>
<pre class="literal-block">started JOB=foo
</pre>
<p>That event is visible to all System Jobs, but is <em>invisible</em> to Session
Jobs. However, the following event will be emitted by the
<tt class="docutils literal"><span class="pre">upstart-event-bridge</span></tt> to allow Session Jobs to react to the "<tt class="docutils literal">foo</tt>"
system job starting:</p>
<pre class="literal-block">:sys:started JOB=foo
</pre>
</div>
<div class="section" id="upstart-file-bridge">
<h3><a class="toc-backref" href="index.html#toc-entry-237">10.2.5&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">upstart-file-bridge</span></tt></a></h3>
<p><em>Added in Upstart v1.8</em></p>
<p>The <tt class="docutils literal"><span class="pre">upstart-file-bridge</span></tt> allows jobs to react to file events. It
currently uses <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/inotify.7.html">inotify(7)</a> and is available both for <a class="reference internal" href="index.html#system-jobs">System Jobs</a>
and <a class="reference internal" href="index.html#session-jobs">Session Jobs</a>.</p>
<p>Syntax:</p>
<pre class="literal-block">start on file FILE=PATH EVENT=TYPE [MATCH=PATH]
</pre>
<div class="section" id="examples">
<h4><a class="toc-backref" href="index.html#toc-entry-238">10.2.5.1&nbsp;&nbsp;&nbsp;Examples</a></h4>
<p>Start a job when file is created, modified or deleted:</p>
<pre class="literal-block">start on file FILE=/run/app.pid
</pre>
<p>Start job when file is created (only):</p>
<pre class="literal-block">start on file FILE=/run/app.pid EVENT=create
</pre>
<p>Start job when any files within a directory are created, modified or
deleted:</p>
<pre class="literal-block">start on file FILE=/var/log/
</pre>
<p>Start job when files that match a glob pattern are created in the
indicated directory:</p>
<pre class="literal-block">start on file FILE=/var/crash/*.crash EVENT=create
</pre>
<p>For more details, see <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/upstart-file-bridge.8.html">upstart-file-bridge(8)</a> and <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/file-event.7.html">file-event(7)</a>.</p>
</div>
</div>
<div class="section" id="upstart-dbus-bridge">
<h3><a class="toc-backref" href="index.html#toc-entry-239">10.2.6&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">upstart-dbus-bridge</span></tt></a></h3>
<p><em>Added in Upstart v1.9</em></p>
<p>The <tt class="docutils literal"><span class="pre">upstart-dbus-bridge</span></tt> allows jobs to react to <a class="reference external" href="http://dbus.freedesktop.org/">D-Bus</a> signals.</p>
<p>Syntax:</p>
<pre class="literal-block">dbus SIGNAL=SIGNAL INTERFACE=INTERFACE PATH=PATH SENDER=SENDER DESTINATION=DESTINATION
</pre>
<div class="section" id="example">
<h4><a class="toc-backref" href="index.html#toc-entry-240">10.2.6.1&nbsp;&nbsp;&nbsp;Example</a></h4>
<p>Start a job when D-Bus signal <tt class="docutils literal">NameAcquired</tt> is received:</p>
<pre class="literal-block">start on dbus SIGNAL=NameAcquired INTERFACE=org.freedesktop.DBus PATH=/org/freedesktop/DBus SENDER=org.freedesktop.DBus
</pre>
<p>See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/upstart-dbus-bridge.8.html">upstart-dbus-bridge(8)</a> and <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/dbus-event.7.html">dbus-event(7)</a> for further details.</p>
</div>
</div>
<div class="section" id="upstart-dconf-bridge">
<h3><a class="toc-backref" href="index.html#toc-entry-241">10.2.7&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">upstart-dconf-bridge</span></tt></a></h3>
<p><em>Added in Upstart v1.10</em></p>
<p>The <tt class="docutils literal"><span class="pre">upstart-dconf-bridge</span></tt> is a <a class="reference internal" href="index.html#session-init">Session Init</a> only bridge that
allows <a class="reference internal" href="index.html#session-jobs">Session Jobs</a> to react to <a class="reference external" href="https://wiki.gnome.org/dconf">DConf</a> database changes.</p>
</div>
<div class="section" id="upstart-local-bridge">
<h3><a class="toc-backref" href="index.html#toc-entry-242">10.2.8&nbsp;&nbsp;&nbsp;<tt class="docutils literal"><span class="pre">upstart-local-bridge</span></tt></a></h3>
<p><em>Added in Upstart v1.10</em></p>
<p>The <tt class="docutils literal"><span class="pre">upstart-local-bridge</span></tt> is a specialist bridge that allows jobs to
react to name/value pairs sent to a local socket created by the bridge.</p>
</div>
</div>
</div>
<div class="section" id="cookbook-and-best-practises">
<h1><a class="toc-backref" href="index.html#toc-entry-243">11&nbsp;&nbsp;&nbsp;Cookbook and Best Practises</a></h1>
<div class="section" id="list-all-jobs">
<h2><a class="toc-backref" href="index.html#toc-entry-244">11.1&nbsp;&nbsp;&nbsp;List All Jobs</a></h2>
<p>To list all jobs on the system along with their states, run:</p>
<pre class="literal-block">$ initctl list
</pre>
<p>See <a class="reference internal" href="index.html#initctl">initctl</a>.</p>
</div>
<div class="section" id="list-all-jobs-with-no-stop-on-condition">
<h2><a class="toc-backref" href="index.html#toc-entry-245">11.2&nbsp;&nbsp;&nbsp;List All Jobs With No <tt class="docutils literal">stop on</tt> Condition</a></h2>
<pre class="literal-block"># list all jobs (stopped and running instances), and compact down
# to actual job names.
initctl list | awk '{print $1}' | sort -u | while read job
do
  # identify jobs with no "stop on"
  initctl show-config -e $job | grep -q "^  stop on" || echo "$job"
done
</pre>
</div>
<div class="section" id="list-all-events-that-jobs-are-interested-in-on-your-system">
<h2><a class="toc-backref" href="index.html#toc-entry-246">11.3&nbsp;&nbsp;&nbsp;List All Events That Jobs Are Interested In On Your System</a></h2>
<p>Here is another example of how <tt class="docutils literal">initctl <span class="pre">show-config</span></tt> can be useful:</p>
<pre class="literal-block">initctl show-config -e | egrep -i "(start|stop) on" | awk '{print $3}' | sort -u
</pre>
</div>
<div class="section" id="create-an-event">
<h2><a class="toc-backref" href="index.html#toc-entry-247">11.4&nbsp;&nbsp;&nbsp;Create an Event</a></h2>
<p>To create, or "emit" an event, use <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/initctl.8.html">initctl(8)</a> specifying the emit
command.</p>
<p>For example, to emit the hello event, you would run:</p>
<pre class="literal-block"># initctl emit hello
</pre>
<p>This event will be "broadcast" to all <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> jobs.</p>
<p>If you are creating a job configuration file for a new application, you
probably do not need to do this though, since <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> emits events on
behalf of a job whenever the job changes state.</p>
<p>A simple configuration file like that shown below may suffice for your
application:</p>
<pre class="literal-block"># /etc/init/myapp.conf
description "run my app under Upstart"
task
exec /path/to/myapp
</pre>
</div>
<div class="section" id="create-an-event-alias">
<h2><a class="toc-backref" href="index.html#toc-entry-248">11.5&nbsp;&nbsp;&nbsp;Create an Event Alias</a></h2>
<p>Say you have an event, but want to create a different name for it, you
can simulate a new name by creating a new <em>job</em> which:</p>
<ul class="simple">
<li>has a <a class="reference internal" href="index.html#start-on">start on</a> that matches the event you want to "rename"</li>
<li>is a task</li>
<li>emits the new name for the event</li>
</ul>
<p>For example, if you wanted to create an alias for a particular flavour
of the <tt class="docutils literal">runlevel</tt> event called "<tt class="docutils literal">shutdown</tt>" which would be emitted
when the system was shutdown, you could create a job configuration file
called <tt class="docutils literal">/etc/init/shutdown.conf</tt> containing:</p>
<pre class="literal-block">start on runlevel RUNLEVEL=0
task
exec initctl emit shutdown
</pre>
<p>Note that this isn't a true alias since:</p>
<ul class="simple">
<li>there are now <em>two</em> events which will be generated when the system is
shutting down:<ul>
<li><tt class="docutils literal">runlevel RUNLEVEL=0</tt></li>
<li><tt class="docutils literal">shutdown</tt></li>
</ul>
</li>
<li>the two events will be delivered by <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> at <em>slightly</em> different
times (<tt class="docutils literal">shutdown</tt> will be emitted just fractionally before
<tt class="docutils literal">runlevel RUNLEVEL=0</tt>).</li>
</ul>
<p>However, the overall result might suffice for your purposes such that
you could create a job configuration file like the following which will
run (and complete) just before your system changes to runlevel <cite>0</cite> (in
other words halts):</p>
<pre class="literal-block">start on shutdown
task
exec backup_my_machine.sh
</pre>
<div class="section" id="change-the-type-of-an-event">
<h3><a class="toc-backref" href="index.html#toc-entry-249">11.5.1&nbsp;&nbsp;&nbsp;Change the Type of an Event</a></h3>
<p>Note that along with creating a new <em>name</em> for an event, you could make
your alias be a different <em>type</em> of event. See <a class="reference internal" href="index.html#event-types">Event Types</a> for
further details.</p>
</div>
</div>
<div class="section" id="synchronisation">
<h2><a class="toc-backref" href="index.html#toc-entry-250">11.6&nbsp;&nbsp;&nbsp;Synchronisation</a></h2>
<p>Upstart is very careful to ensure when a condition becomes true that it
<strong>starts</strong> all relevant jobs <em>in sequence</em> (see <a class="reference internal" href="index.html#order-in-which-jobs-which-start-on-the-same-event-are-run">Order in Which Jobs
Which start on the Same Event are Run</a>). However, although Upstart has
<em>started</em> them one after another <em>they might still be running at the
same time</em>. For example, assume the following:</p>
<ul>
<li><p class="first"><tt class="docutils literal">/etc/init/X.conf</tt></p>
<pre class="literal-block">start on event-A
script
  echo "`date`: $UPSTART_JOB started" &gt;&gt; /tmp/test.log
  sleep 2
  echo "`date`: $UPSTART_JOB stopped" &gt;&gt; /tmp/test.log
end script
</pre>
</li>
<li><p class="first"><tt class="docutils literal">/etc/init/Y.conf</tt></p>
<pre class="literal-block">start on event-A

script
  echo "`date`: $UPSTART_JOB started" &gt;&gt; /tmp/test.log
  sleep 2
  echo "`date`: $UPSTART_JOB stopped" &gt;&gt; /tmp/test.log
end script
</pre>
</li>
<li><p class="first"><tt class="docutils literal">/etc/init/Z.conf</tt></p>
<pre class="literal-block">start on event-A

script
  echo "`date`: $UPSTART_JOB started" &gt;&gt; /tmp/test.log
  sleep 2
  echo "`date`: $UPSTART_JOB stopped" &gt;&gt; /tmp/test.log
end script
</pre>
</li>
</ul>
<p>Running the following will cause all the jobs above to run <em>in some
order</em>:</p>
<pre class="literal-block"># initctl emit event-A
</pre>
<p>Here is sample output of <tt class="docutils literal">/tmp/test.log</tt>:</p>
<pre class="literal-block">Thu Mar 31 10:20:44 BST 2011: Y started
Thu Mar 31 10:20:44 BST 2011: X started
Thu Mar 31 10:20:44 BST 2011: Z started
Thu Mar 31 10:20:46 BST 2011: Y stopped
Thu Mar 31 10:20:46 BST 2011: Z stopped
Thu Mar 31 10:20:46 BST 2011: X stopped
</pre>
<p>There are a few points to note about this output:</p>
<ul class="simple">
<li>All jobs start "around the same time" but are <em>started</em> sequentially.</li>
<li>The order the jobs are initiated by Upstart cannot be predicted.</li>
<li><em>All three jobs are running concurrently</em>.</li>
</ul>
<p>It is possible with a bit of thought to create a simple framework for
synchronisation. Take the following job configuration file
<tt class="docutils literal">/etc/init/synchronise.conf</tt>:</p>
<pre class="literal-block">manual
</pre>
<p>This one-line <a class="reference internal" href="index.html#abstract-job">Abstract Job</a> configuration file is extremely
interesting in that:</p>
<ul class="simple">
<li>Since it includes the <a class="reference internal" href="index.html#manual">manual</a> keyword, a job created from it can
only be started manually.</li>
<li>Only a single instance of a job created from this configuration can
exist (since no <a class="reference internal" href="index.html#instance">instance</a> stanza has been specified).</li>
</ul>
<p>What this means is that we can use a job based on this configuration as
a simple synchronisation device.</p>
<p>The astute reader may observe that <tt class="docutils literal">synchronise</tt> has similar
semantics to a POSIX pthread condition variable.</p>
<p>Now we have our synchronisation primitive, how do we use it? Here is an
example which we'll call <tt class="docutils literal">/etc/init/test_synchronise.conf</tt>:</p>
<pre class="literal-block">start on stopped synchronise

# allow multiple instances
instance $N

# this is not a service
task

pre-start script
  # "lock"
  start synchronise || true
end script

script
  # do something here, knowing that you have exclusive access
  # to some resource that you are using the "synchronise"
  # job to protect.
  echo "`date`: $UPSTART_JOB ($N) started" &gt;&gt; /tmp/test.log
  sleep 2
  echo "`date`: $UPSTART_JOB ($N) stopped" &gt;&gt; /tmp/test.log
end script

post-stop script
  # "unlock"
  stop synchronise || true
end script
</pre>
<p>For example, to run <tt class="docutils literal">3</tt> instances of this job, run:</p>
<pre class="literal-block">for n in $(seq 3)
do
  start test_synchronise N=$n
done
</pre>
<p>Here is sample output of <tt class="docutils literal">/tmp/test.log</tt>:</p>
<pre class="literal-block">Thu Mar 31 10:32:20 BST 2011: test_synchronise (1) started
Thu Mar 31 10:32:22 BST 2011: test_synchronise (1) stopped
Thu Mar 31 10:32:22 BST 2011: test_synchronise (2) started
Thu Mar 31 10:32:24 BST 2011: test_synchronise (2) stopped
Thu Mar 31 10:32:25 BST 2011: test_synchronise (3) started
Thu Mar 31 10:32:27 BST 2011: test_synchronise (3) stopped
</pre>
<p>The main observation here:</p>
<ul class="simple">
<li>Each instance of the job <em>started</em> <strong>and stopped</strong> before any other
instance ran.</li>
</ul>
<p>Like condition variables, this technique require collaboration from all
parties. Note that you cannot know the order in which each instance of the
<tt class="docutils literal">test_synchronise</tt> job will run.</p>
<p>Note too that it is not necessary to use instances here. All that is
required is that your chosen set of jobs all collaborate in their
handling of the "lock". Instances make this simple since you can spawn
any number of jobs from a single "template" job configuration file.</p>
</div>
<div class="section" id="determine-if-job-was-started-by-an-event-or-by-start">
<h2><a class="toc-backref" href="index.html#toc-entry-251">11.7&nbsp;&nbsp;&nbsp;Determine if Job was Started by an Event or by "<tt class="docutils literal">start</tt>"</a></h2>
<p>A job that specifies a <a class="reference internal" href="index.html#start-on">start on</a> condition can be started in two ways:</p>
<ul class="simple">
<li>by Upstart itself when the <a class="reference internal" href="index.html#start-on">start on</a> condition becomes true.</li>
<li>by running, "<tt class="docutils literal">start &lt;job&gt;</tt>".</li>
</ul>
<p>Interestingly, it is possible for a job to establish how it was started
by considering the <tt class="docutils literal">UPSTART_EVENTS</tt> variable:</p>
<ul class="simple">
<li>If the <tt class="docutils literal">UPSTART_EVENTS</tt> variable is set in the job environment, the job was started by an event.</li>
<li>If the <tt class="docutils literal">UPSTART_EVENTS</tt> variable is <em>not</em> set in the job environment, the job was started by
the <tt class="docutils literal">start</tt> command.</li>
</ul>
<p>Note that this technique does not allow you to determine definitively if
the job was started <em>manually</em> by an Administrator since it is possible
that if the <tt class="docutils literal">UPSTART_EVENTS</tt> variable is <em>not</em> set that the job was
started by <em>another job</em> calling <tt class="docutils literal">start</tt> inside a <tt class="docutils literal">script</tt> section.</p>
</div>
<div class="section" id="stop-a-job-from-running-if-a-pre-start-condition-fails">
<h2><a class="toc-backref" href="index.html#toc-entry-252">11.8&nbsp;&nbsp;&nbsp;Stop a Job from Running if A <tt class="docutils literal"><span class="pre">pre-start</span></tt> Condition Fails</a></h2>
<p>If you wish a job to not be run if a <tt class="docutils literal"><span class="pre">pre-start</span></tt> condition fails:</p>
<pre class="literal-block">pre-start script
  # main process will not be run if /some/file does not exist
  test -f /some/file || { stop ; exit 0; }
end script

script
  # main process is run here
end script
</pre>
</div>
<div class="section" id="run-a-job-only-when-an-event-variable-matches-some-value">
<h2><a class="toc-backref" href="index.html#toc-entry-253">11.9&nbsp;&nbsp;&nbsp;Run a Job Only When an Event Variable Matches Some Value</a></h2>
<p>By default, <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> will run your job if the <a class="reference internal" href="index.html#start-on">start on</a> condition
matches the events listed:</p>
<pre class="literal-block">start on event-A
</pre>
<p>But if <tt class="docutils literal"><span class="pre">event-A</span></tt> provides a number of environment variables, you can
restrict your job to starting <em>only</em> when one or more of these variables
matches some value. For example:</p>
<pre class="literal-block">start on event-A FOO=hello BAR=wibble
</pre>
<p>Now, <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> will only run your job <em>if all of the following are true</em>:</p>
<ul class="simple">
<li>the <tt class="docutils literal"><span class="pre">event-A</span></tt> is emitted</li>
<li>the value of the <tt class="docutils literal">$FOO</tt> variable in <tt class="docutils literal"><span class="pre">event-A</span></tt>'s environment
is "<tt class="docutils literal">hello</tt>".</li>
<li>the value of the <tt class="docutils literal">$BAR</tt> variable in <tt class="docutils literal"><span class="pre">event-A</span></tt>'s environment
is "<tt class="docutils literal">wibble</tt>".</li>
</ul>
</div>
<div class="section" id="run-a-job-when-an-event-variable-does-not-match-some-value">
<h2><a class="toc-backref" href="index.html#toc-entry-254">11.10&nbsp;&nbsp;&nbsp;Run a Job when an Event Variable Does Not Match Some Value</a></h2>
<p><a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> supports negation of environment variable values such that you
can say:</p>
<pre class="literal-block">start on event-A FOO=hello BAR!=wibble
</pre>
<p>Now, <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> will only run your job <em>if all of the following are true</em>:</p>
<ul class="simple">
<li>the <tt class="docutils literal"><span class="pre">event-A</span></tt> is emitted</li>
<li>the value of the <tt class="docutils literal">$FOO</tt> variable in <tt class="docutils literal"><span class="pre">event-A</span></tt>'s environment
is "<tt class="docutils literal">hello</tt>".</li>
<li>the value of the <tt class="docutils literal">$BAR</tt> variable in <tt class="docutils literal"><span class="pre">event-A</span></tt>'s environment
is <strong>not</strong> "<tt class="docutils literal">wibble</tt>".</li>
</ul>
</div>
<div class="section" id="run-a-job-as-soon-as-possible-after-boot">
<h2><a class="toc-backref" href="index.html#toc-entry-255">11.11&nbsp;&nbsp;&nbsp;Run a Job as Soon as Possible After Boot</a></h2>
<p>(Note: we ignore the initramfs in this section).</p>
<p>To start a job as early as possible, simply "<tt class="docutils literal">start on</tt>" the <tt class="docutils literal">startup</tt>
event. This is the first event Upstart emits and all other events and jobs
follow from this:</p>
<pre class="literal-block">start on startup
</pre>
</div>
<div class="section" id="run-a-job-when-a-user-logs-in-graphically-ubuntu-specific">
<h2><a class="toc-backref" href="index.html#toc-entry-256">11.12&nbsp;&nbsp;&nbsp;Run a Job When a User Logs in Graphically (<img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719">)</a></h2>
<p>Assuming a graphical login, this can be achieved using a <tt class="docutils literal">start on</tt> condition of:</p>
<pre class="literal-block">start on desktop-session-start
</pre>
<p>This requires the display manager emit the event in question. See the
<a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/upstart-events.7.html">upstart-events(7)</a> man page on an Ubuntu system for the 2 events a Display
Manager is expected to emit. If your Display Manager does not emit these
event, check its documentation to see if it allows scripts to be called
at appropriate points and then you can easily conform to the reference
implementations behaviour:</p>
<pre class="literal-block"># A user has logged in
/sbin/initctl -q emit desktop-session-start \
  DISPLAY_MANAGER=some_name USER=$USER

# Display Manager has initialized and displayed a login screen
# (if appropriate)
/sbin/initctl -q emit login-session-start \
  DISPLAY_MANAGER=some_name
</pre>
</div>
<div class="section" id="run-a-job-when-a-user-logs-in">
<h2><a class="toc-backref" href="index.html#toc-entry-257">11.13&nbsp;&nbsp;&nbsp;Run a Job When a User Logs in</a></h2>
<p>This makes use of <a class="reference internal" href="index.html#d-bus-service-activation">D-Bus Service Activation</a>.</p>
<ol class="arabic">
<li><p class="first">Add "<tt class="docutils literal">UpstartJob=true</tt>" to file "<tt class="docutils literal"><span class="pre">/usr/share/dbus-1/system-services/org.freedesktop.ConsoleKit.service</span></tt>".</p>
</li>
<li><p class="first">Create a job configuration file corresponding to the <a class="reference external" href="http://dbus.freedesktop.org/">D-Bus</a> service,
say <tt class="docutils literal"><span class="pre">/etc/init/user-login.conf</span></tt> <a class="footnote-reference" href="index.html#use-of-exec-in-dbus-job" id="footnote-reference-20">[16]</a>:</p>
<pre class="literal-block">start on dbus-activation org.freedesktop.ConsoleKit
exec /usr/sbin/console-kit-daemon --no-daemon
</pre>
</li>
<li><p class="first">Ensure that the <a class="reference external" href="http://dbus.freedesktop.org/">D-Bus</a> daemon ("<tt class="docutils literal"><span class="pre">dbus-daemon</span></tt>") is started with the
<tt class="docutils literal"><span class="pre">--activation=upstart</span></tt> option (see <tt class="docutils literal">/etc/init/dbus.conf</tt>).</p>
</li>
</ol>
<p>Now, when a user logs in, <a class="reference external" href="http://dbus.freedesktop.org/">D-Bus</a> will emit the <tt class="docutils literal"><span class="pre">dbus-activation</span></tt>
event, specifying the <a class="reference external" href="http://dbus.freedesktop.org/">D-Bus</a> service started. You can now create other
jobs that <tt class="docutils literal">start on <span class="pre">user-login</span></tt>.</p>
<div class="section" id="environment">
<h3><a class="toc-backref" href="index.html#toc-entry-258">11.13.1&nbsp;&nbsp;&nbsp;Environment</a></h3>
<p>Below is an example of the environment such an Upstart <a class="reference external" href="http://dbus.freedesktop.org/">D-Bus</a> job runs
in:</p>
<pre class="literal-block">UPSTART_INSTANCE=
DBUS_STARTER_BUS_TYPE=system
UPSTART_JOB=user-login
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
SERVICE=org.freedesktop.ConsoleKit
DBUS_SYSTEM_BUS_ADDRESS=unix:path=/var/run/dbus/system_bus_socket,guid=e86f5a01fbb7f5f1c22131090000000a
UPSTART_EVENTS=dbus-activation
PWD=/
DBUS_STARTER_ADDRESS=unix:path=/var/run/dbus/system_bus_socket,guid=e86f5a01fbb7f5f1c22131090000000a
</pre>
</div>
</div>
<div class="section" id="run-a-job-for-all-of-a-number-of-conditions">
<h2><a class="toc-backref" href="index.html#toc-entry-259">11.14&nbsp;&nbsp;&nbsp;Run a Job For All of a Number of Conditions</a></h2>
<p>If you have a job configuration file like this:</p>
<pre class="literal-block">start on (event-A or (event-B or event-C))

script
  echo "`date`: ran in environment: `env`" &gt;&gt; /tmp/myjob.log
end script
</pre>
<p><a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> will run this job <em>when any of the following events is
emitted</em>:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">event-A</span></tt></li>
<li><tt class="docutils literal"><span class="pre">event-B</span></tt></li>
<li><tt class="docutils literal"><span class="pre">event-C</span></tt></li>
</ul>
<p>You cannot know the order in which the events will arrive in, but the
specified <a class="reference internal" href="index.html#start-on">start on</a> condition has told <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> that any of them will
suffice for your purposes. So, if <tt class="docutils literal"><span class="pre">event-B</span></tt> is emitted first, Upstart
will run the job and only consider re-running the job if and when the
job has finished running. If <tt class="docutils literal"><span class="pre">event-B</span></tt> is emitted and the job is
running and <em>then</em> (before the job finishes running) <tt class="docutils literal"><span class="pre">event-A</span></tt> is
emitted, <em>the job will not be re-run</em>.</p>
<p>However, what if you wanted to run the script for all the events? If you
know that all of these events will be emitted at some point, you could
change the <a class="reference internal" href="index.html#start-on">start on</a> to be:</p>
<pre class="literal-block">start on (event-A and (event-B and event-C))
</pre>
<p>Here, the job will only run at the time when the last of the three
events is received.</p>
<p>Is it possible to run this job for each event <em>as soon as each event
arrives</em>? Yes it is:</p>
<pre class="literal-block">start on (event-A or (event-B or event-C))

instance $UPSTART_EVENTS

script
  echo "`date`: ran in environment: `env`" &gt;&gt; /tmp/myjob.log
end script
</pre>
<p>By adding the <a class="reference internal" href="index.html#instance">instance</a> keyword, you ensure that whenever <em>any</em> of the
events listed in your <a class="reference internal" href="index.html#start-on">start on</a> condition is emitted, <em>an instance of</em>
the job will be run. Therefore, if all three events are emitted very
close together in time, three jobs <em>instances</em> will now be run.</p>
<p>See the <a class="reference internal" href="index.html#instance">Instance</a> section for further details.</p>
</div>
<div class="section" id="run-a-job-before-another-job">
<h2><a class="toc-backref" href="index.html#toc-entry-260">11.15&nbsp;&nbsp;&nbsp;Run a Job Before Another Job</a></h2>
<p>If you wish to run a particular job before some other job, simply make
your jobs <tt class="docutils literal">start on</tt> condition specify the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/starting.7.html">starting(7)</a> event. Since
the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/starting.7.html">starting(7)</a> event is emitted <em>just before</em> the job in question
starts, this provides the behaviour you want since your job will be run
first.</p>
<p>For example, assuming your job is called <tt class="docutils literal"><span class="pre">job-B</span></tt> and you want it to
start before <tt class="docutils literal"><span class="pre">job-A</span></tt>, in <tt class="docutils literal"><span class="pre">/etc/init/job-B.conf</span></tt> you would specify:</p>
<pre class="literal-block">start on starting job-A
</pre>
</div>
<div class="section" id="run-a-job-after-another-job">
<h2><a class="toc-backref" href="index.html#toc-entry-261">11.16&nbsp;&nbsp;&nbsp;Run a Job After Another Job</a></h2>
<p>If you have a job you wish to run after job "<tt class="docutils literal"><span class="pre">job-A</span></tt>", your <tt class="docutils literal">start
on</tt> condition would need to make use of the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/stopped.7.html">stopped(7)</a> event like
this:</p>
<pre class="literal-block">start on stopped job-A
</pre>
</div>
<div class="section" id="run-a-job-once-after-some-other-job-ends">
<h2><a class="toc-backref" href="index.html#toc-entry-262">11.17&nbsp;&nbsp;&nbsp;Run a Job Once After Some Other Job Ends</a></h2>
<p>Imagine a job configuration file <tt class="docutils literal">myjob.conf</tt> such as the following
which might result in a job which is restarted a number of times:</p>
<pre class="literal-block">start on event-A

script
  # do something
end script
</pre>
<p>Is it possible to run a job <em>only once</em> <strong>after</strong> job <tt class="docutils literal">myjob</tt> ends?
Yes if you create a job configuration file <tt class="docutils literal"><span class="pre">myjob-sync.conf</span></tt> such as:</p>
<pre class="literal-block">start on stopped myjob and event-B

script
  # do something
end script
</pre>
<p>Now, when <tt class="docutils literal"><span class="pre">event-A</span></tt> is emitted, job <tt class="docutils literal">myjob</tt> will start and if and
when job <tt class="docutils literal">myjob</tt> finishes <em>and</em> event <tt class="docutils literal"><span class="pre">event-B</span></tt> is emitted, job
<tt class="docutils literal"><span class="pre">myjob-sync</span></tt> will be run.</p>
<p>However, crucially, even if job <tt class="docutils literal">myjob</tt> is restarted, the
<tt class="docutils literal"><span class="pre">myjob-sync</span></tt> job will <em>not</em> be restarted.</p>
</div>
<div class="section" id="run-a-job-before-another-job-and-stop-it-after-that-job-stops">
<h2><a class="toc-backref" href="index.html#toc-entry-263">11.18&nbsp;&nbsp;&nbsp;Run a Job Before Another Job and Stop it After that Job Stops</a></h2>
<p>If you have a job you wish to be running before job "<tt class="docutils literal"><span class="pre">job-A</span></tt>" starts,
but which you want to stop as soon as <tt class="docutils literal"><span class="pre">job-A</span></tt> stops:</p>
<pre class="literal-block">start on starting job-A
stop on stopped job-A
</pre>
</div>
<div class="section" id="run-a-job-only-if-another-job-succeeds">
<h2><a class="toc-backref" href="index.html#toc-entry-264">11.19&nbsp;&nbsp;&nbsp;Run a Job Only If Another Job Succeeds</a></h2>
<p>To have a job start only when <tt class="docutils literal"><span class="pre">job-A</span></tt> succeeds, use the <tt class="docutils literal">$RESULT</tt>
variable from the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/stopped.7.html">stopped(7)</a> event like this:</p>
<pre class="literal-block">start on stopped job-A RESULT=ok
</pre>
</div>
<div class="section" id="run-a-job-only-if-another-job-fails">
<h2><a class="toc-backref" href="index.html#toc-entry-265">11.20&nbsp;&nbsp;&nbsp;Run a Job Only If Another Job Fails</a></h2>
<p>To have a job start only when <tt class="docutils literal"><span class="pre">job-A</span></tt> fails, use the <tt class="docutils literal">$RESULT</tt>
variable from the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/stopped.7.html">stopped(7)</a> event like this:</p>
<pre class="literal-block">start on stopped job-A RESULT=failed
</pre>
<p>Note that you could also specify this condition as:</p>
<pre class="literal-block">start on stopped job-A RESULT!=ok
</pre>
</div>
<div class="section" id="run-a-job-only-if-one-job-succeeds-and-another-fails">
<h2><a class="toc-backref" href="index.html#toc-entry-266">11.21&nbsp;&nbsp;&nbsp;Run a Job Only If One Job Succeeds and Another Fails</a></h2>
<p>This would be a strange scenario to want, but it is quite easy to
specify. Assuming we want a job to start only if <tt class="docutils literal"><span class="pre">job-A</span></tt> succeeds and
if <tt class="docutils literal"><span class="pre">job-B</span></tt> fails:</p>
<pre class="literal-block">start on stopped job-A RESULT=ok and stopped job-B RESULT=failed
</pre>
</div>
<div class="section" id="run-a-job-if-another-job-exits-with-a-particular-exit-code">
<h2><a class="toc-backref" href="index.html#toc-entry-267">11.22&nbsp;&nbsp;&nbsp;Run a Job If Another Job Exits with a particular Exit Code</a></h2>
<p>Imagine you have a database server process that exits with a particular
exit code (say <tt class="docutils literal">7</tt>) to denote that it needs some sort of cleanup
process to be run before it can be re-started. To handle this you could
create <tt class="docutils literal"><span class="pre">/etc/init/mydb-cleanup.conf</span></tt> with a <tt class="docutils literal">start on</tt> condition
like this:</p>
<pre class="literal-block">start on stopped mydb EXIT_STATUS=7

script
  # handle cleanup...

  # assuming the cleanup was successful, restart the server
  start mydb
end script
</pre>
</div>
<div class="section" id="detect-if-any-job-fails">
<h2><a class="toc-backref" href="index.html#toc-entry-268">11.23&nbsp;&nbsp;&nbsp;Detect if Any Job Fails</a></h2>
<p>To "monitor" all jobs for failures, you could either create a job that
checks specifically for a <em>single</em> job failure (see <a class="reference internal" href="index.html#run-a-job-if-another-job-exits-with-a-particular-exit-code">Run a Job If Another Job
Exits with a particular Exit Code</a>), but you could just as easily
detect if <em>any</em> job has failed as follows:</p>
<pre class="literal-block">start on stopped RESULT=failed
</pre>
<p>Since this <a class="reference internal" href="index.html#start-on">start on</a> condition does not specify the <a class="reference internal" href="index.html#job">Job</a> to match
against, it will match all jobs. You can then perform condition
processing:</p>
<pre class="literal-block">script
    if [ -n "$EXIT_STATUS" ];
    then
        str="with exit status $EXIT_STATUS"
    else
        str="due to signal $EXIT_SIGNAL"
    fi

    logger "Upstart Job $JOB (instance '$INSTANCE', process $PROCESS) failed $str"

    case "$JOB" in
        myjob1)
        ;;

        myjob2)
        ;;

        etc)
        ;;
    esac

end script
</pre>
<p>Note that <tt class="docutils literal">$PROCESS</tt> above is <em>not</em> the PID, it is the name of the job
process type (such as <tt class="docutils literal">main</tt> or <tt class="docutils literal"><span class="pre">pre-start</span></tt>). See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/stopped.7.html">stopped(7)</a> for
further details.</p>
</div>
<div class="section" id="use-details-of-a-failed-job-from-another-job">
<h2><a class="toc-backref" href="index.html#toc-entry-269">11.24&nbsp;&nbsp;&nbsp;Use Details of a Failed Job from Another Job</a></h2>
<p>Although you cannot see the exact environment another job ran in, you
can access some details. For example, if your job specified
<tt class="docutils literal"><span class="pre">/etc/init/job-B.conf</span></tt> as:</p>
<pre class="literal-block">start on stopped job-A RESULT=fail

script
  exec 1&gt;&gt;/tmp/log.file
  echo "Environment of job $JOB was:"
  env
  echo
end script
</pre>
<p>The file <tt class="docutils literal">/tmp/log.file</tt> might contain something like this:</p>
<pre class="literal-block">UPSTART_INSTANCE=
EXIT_STATUS=7
INSTANCE=
UPSTART_JOB=B
TERM=linux
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin
PROCESS=main
UPSTART_EVENTS=stopped
PWD=/
RESULT=failed
JOB=A
</pre>
<p>Here, <tt class="docutils literal"><span class="pre">job-B</span></tt> can see that:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">job-A</span></tt> exited in its "main" process. This is a special name for the
<tt class="docutils literal">script</tt> section. All other script sections are named as expected.
For example, if the <tt class="docutils literal"><span class="pre">pre-start</span></tt> section had failed, the <tt class="docutils literal">PROCESS</tt> variable
would be set to <tt class="docutils literal"><span class="pre">pre-start</span></tt>, and if in <tt class="docutils literal"><span class="pre">post-stop</span></tt>, the variable would
have been set to <tt class="docutils literal"><span class="pre">post-stop</span></tt>.</li>
<li><tt class="docutils literal"><span class="pre">job-A</span></tt> exited with exit code <tt class="docutils literal">7</tt>.</li>
<li><tt class="docutils literal"><span class="pre">job-A</span></tt> only had 1 instance (since the <tt class="docutils literal">INSTANCE</tt> variable is set
to the null value.</li>
<li><tt class="docutils literal"><span class="pre">job-A</span></tt> ran in the root ("<tt class="docutils literal">/</tt>") directory.</li>
<li><tt class="docutils literal">UPSTART_JOB</tt> is the name of the job running the script (ie <tt class="docutils literal"><span class="pre">job-B</span></tt>).</li>
<li><tt class="docutils literal">JOB</tt> is the name of the job that we are starting on (here <tt class="docutils literal"><span class="pre">job-A</span></tt>).</li>
<li><tt class="docutils literal">UPSTART_EVENTS</tt> is a list of the events that caused <tt class="docutils literal">UPSTART_JOB</tt>
(ie <tt class="docutils literal"><span class="pre">job-B</span></tt>) to start. Here, the event is <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/starting.7.html">starting(7)</a> showing that
<tt class="docutils literal"><span class="pre">job-B</span></tt> started as a result of <tt class="docutils literal"><span class="pre">job-A</span></tt> being sent the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/stopped.7.html">stopped(7)</a>
event.</li>
</ul>
</div>
<div class="section" id="stop-a-job-when-another-job-starts">
<h2><a class="toc-backref" href="index.html#toc-entry-270">11.25&nbsp;&nbsp;&nbsp;Stop a Job when Another Job Starts</a></h2>
<p>If we wish <tt class="docutils literal"><span class="pre">job-A</span></tt> to stop when <tt class="docutils literal"><span class="pre">job-B</span></tt> starts, specify the
following in <tt class="docutils literal"><span class="pre">/etc/init/job-A.conf</span></tt>:</p>
<pre class="literal-block">stop on starting job-B
</pre>
<div class="section" id="simple-mutual-exclusion">
<h3><a class="toc-backref" href="index.html#toc-entry-271">11.25.1&nbsp;&nbsp;&nbsp;Simple Mutual Exclusion</a></h3>
<p>It is possible to create two jobs which will be "toggled" such that when
<tt class="docutils literal"><span class="pre">job-A</span></tt> is running, <tt class="docutils literal"><span class="pre">job-B</span></tt> will be stopped and <em>vice versa</em>. This
provides a simple mutually exclusive environment. Here is the job
configuration file for <tt class="docutils literal"><span class="pre">job-A</span></tt>:</p>
<pre class="literal-block"># /etc/init/job-A.conf
start on stopped job-B

script
  # do something when job-B is stopped
end script
</pre>
<p>And <tt class="docutils literal"><span class="pre">job-B</span></tt>:</p>
<pre class="literal-block"># /etc/init/job-B.conf
start on stopped job-A

script
  # do something when job-A is stopped
end script
</pre>
<p>Finally, start one of the jobs:</p>
<pre class="literal-block"># start job-A
</pre>
<p>Now:</p>
<ul class="simple">
<li>when <tt class="docutils literal"><span class="pre">job-A</span></tt> is running, <tt class="docutils literal"><span class="pre">job-B</span></tt> will be stopped.</li>
<li>when <tt class="docutils literal"><span class="pre">job-B</span></tt> is running, <tt class="docutils literal"><span class="pre">job-A</span></tt> will be stopped.</li>
</ul>
<p>Note though that attempting to have more than two jobs using such a scheme
<em>will not work</em>. However, you can use the technique described in the
<a class="reference internal" href="index.html#synchronisation">Synchronisation</a> section to achieve the same goal.</p>
</div>
</div>
<div class="section" id="run-a-job-periodically">
<h2><a class="toc-backref" href="index.html#toc-entry-272">11.26&nbsp;&nbsp;&nbsp;Run a Job Periodically</a></h2>
<p>This cannot currently be handled by Upstart directly. However, the "Temporal
Events" feature is being worked on now will address this.</p>
<p>Until Temporal Events are available you should either use <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/cron.8.html">cron(8)</a>,
or something like:</p>
<pre class="literal-block"># /etc/init/timer.conf

instance $JOB_TO_RUN

script
  for var in SLEEP JOB_TO_RUN
  do
    eval val=\${$var}
    if [ -z "$val" ]
    then
      logger -t $0 "ERROR: variable $var not specified"
      exit 1
    fi
  done

  eval _sleep=\${SLEEP}
  eval _job=\${JOB_TO_RUN}

  while [ 1 ]
  do
    stop  $_job || true
    sleep $_sleep
    start $_job || true
  done
end script
</pre>
<p>Note well the contents of the <tt class="docutils literal">while</tt> loop. We ensure that the commands that
might fail are converted into expressions guaranteed to pass. If we did not do
this, <tt class="docutils literal">timer.conf</tt> would fail, which would be undesirable. Note too the use
of <tt class="docutils literal">instance</tt> to allow more than one instance of the <tt class="docutils literal">timer</tt> job to be
running at any one time.</p>
</div>
<div class="section" id="restart-a-job-on-a-particular-event">
<h2><a class="toc-backref" href="index.html#toc-entry-273">11.27&nbsp;&nbsp;&nbsp;Restart a job on a Particular Event</a></h2>
<p>To restart a job when a particular event is emitted requires two jobs.
First the main job:</p>
<pre class="literal-block">start on something

exec /sbin/some-command
</pre>
<p>Then a helper job to perform the restart:</p>
<pre class="literal-block">start on my-special-event

exec restart main-job
</pre>
<p>Now, when the <tt class="docutils literal"><span class="pre">my-special-event</span></tt> event is emitted, the main job will
be restarted.</p>
</div>
<div class="section" id="migration-from-system-v-initialization-scripts">
<h2><a class="toc-backref" href="index.html#toc-entry-274">11.28&nbsp;&nbsp;&nbsp;Migration from System V initialization scripts</a></h2>
<p>With SysV init scripts, the Administrator decides the order that jobs are
started in by assigning numeric values to each service. Such a system is
simple, but non-optimal since:</p>
<ul>
<li><p class="first">The SysV init system runs each job sequentially.</p>
<p>This disallows running jobs in parallel, to make full use of system
resources. Due to the limited nature of the SysV system, many SysV services put
services that take a long time to start into the background to give the
illusion that the boot is progressing quickly. However, this makes it difficult
for Administrators to know if a required service is running by the time their
later service starts.</p>
</li>
<li><p class="first">The Administrator cannot know the best order to run jobs in.</p>
<p>Since the only meta information encoded for services is a numeric value used
purely for ordering jobs, the system cannot optimize the services since it
knows nothing about the requirements for each job.</p>
</li>
</ul>
<p>In summary, the SysV init system is designed to be easy for the Administrator
to use, not easy for the system to optimize.</p>
<p>In order to migrate a service from SysV to Upstart, it is necessary to change
your mindset somewhat. Rather than trying to decide which two services to
"slot" your service between, you need to consider the conditions that your
service needs before it can legitimately be started.</p>
<p>So, if you wished to add a new service that traditionally started before
<a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/cron.8.html">cron(8)</a> or <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/atd.8.html">atd(8)</a> you do not need to change the configuration
files <tt class="docutils literal">cron.conf</tt> or <tt class="docutils literal">atd.conf</tt>. You can "insert" your new service
by specifying a  simple:</p>
<pre class="literal-block"># /etc/init/my-service.conf
start on (starting cron or starting atd)
</pre>
<p>In English, this says,</p>
<blockquote>
"start the "<tt class="docutils literal"><span class="pre">my-service</span></tt>" service <em>just before</em> <strong>either</strong> the <tt class="docutils literal">cron</tt> or
the <tt class="docutils literal">atd</tt> services start".</blockquote>
<p>Whether <tt class="docutils literal">crond</tt> or <tt class="docutils literal">atd</tt> actually start first is not a concern for
my-service: Upstart ensures that the <tt class="docutils literal"><span class="pre">my-service</span></tt> service will be started
before either of them. Even if <tt class="docutils literal">cron</tt> normally starts before <tt class="docutils literal">atd</tt> but for
some reason one day atd starts first, Upstart will ensure that <tt class="docutils literal"><span class="pre">my-service</span></tt>
will be started before <tt class="docutils literal">atd</tt>.</p>
<p>Note therefore that introducing a new service should not generally require
existing job configuration files to be updated.</p>
</div>
<div class="section" id="how-to-establish-a-jobs-start-on-and-stop-on-conditions">
<h2><a class="toc-backref" href="index.html#toc-entry-275">11.29&nbsp;&nbsp;&nbsp;How to Establish a Jobs <tt class="docutils literal">start on</tt> and <tt class="docutils literal">stop on</tt> Conditions</a></h2>
<p>How do you establish what values you should specify for a jobs <tt class="docutils literal">start
on</tt> and <tt class="docutils literal">stop on</tt> conditions?</p>
<div class="section" id="determining-the-start-on-condition-debian-and-ubuntu-specific">
<h3><a class="toc-backref" href="index.html#toc-entry-276">11.29.1&nbsp;&nbsp;&nbsp;Determining the <tt class="docutils literal">start on</tt> Condition (<img alt="D" class="debian-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/4926319605052bdf09442836fd8d799b236e5db8"> , <img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719">)</a></h3>
<p>So you have created a Job Configuration File for your <a class="reference internal" href="index.html#service-job">Service Job</a>.
You have checked the <a class="reference internal" href="index.html#expect">expect</a> stanza is correct and you've even enabled
<a class="reference internal" href="index.html#respawn">respawn</a>.</p>
<p>But how do you determine the <em>correct</em> "<cite>start on</cite>" condition? Actually,
this is almost a trick question since there are potentially many
"correct" answers; it depends on the application and how sensitive it is
to the environment it runs in. There are <em>many</em> potential <tt class="docutils literal">start on</tt>
conditions - it is your job to determine the most efficient and
effective one. This section attempts to give some advice and guidelines
on choosing a suitable condition, and explaining how to test your choice
for correctness. However, note that each job requires a specific and
possibly unique set of conditions to run.</p>
<div class="section" id="standard-idioms">
<h4><a class="toc-backref" href="index.html#toc-entry-277">11.29.1.1&nbsp;&nbsp;&nbsp;Standard Idioms</a></h4>
<p>If your application isn't particularly needy, you may be able to use one
of the standard idioms below:</p>
<ul>
<li><p class="first">To start your job <em>as soon as possible</em>:</p>
<p>See <a class="reference internal" href="index.html#run-a-job-as-soon-as-possible-after-boot">Run a Job as Soon as Possible After Boot</a>.</p>
</li>
<li><p class="first">To start your job "<em>as late as possible</em>":</p>
<p>See <a class="reference internal" href="index.html#run-a-job-when-a-user-logs-in-graphically-ubuntu-specific">Run a Job When a User Logs in Graphically (ubuntu-specific)</a>.</p>
</li>
<li><p class="first">If you want the job to start "around the time" (actually just after) the
equivalent System-V job would run, specify:</p>
<pre class="literal-block">start on stopped rc
</pre>
</li>
<li><p class="first">If you want your job to start after all filesystems are mounted,
specify:</p>
<pre class="literal-block">start on filesystem
</pre>
</li>
<li><p class="first">If you want your job to start when all network devices are active,
specify:</p>
<pre class="literal-block">start on stopped networking
</pre>
<p>Note that as of Ubuntu Oneiric, you could also say:</p>
<pre class="literal-block">start on static-network-up
</pre>
</li>
<li><p class="first">If you want your job to start when a <a class="reference internal" href="index.html#runlevel">runlevel</a> begins, specify:</p>
<pre class="literal-block">start on runlevel [2345]
</pre>
<p>This is used by a lot of standard jobs and is a good starting place.</p>
</li>
</ul>
</div>
<div class="section" id="more-exotic-start-on-conditions">
<h4><a class="toc-backref" href="index.html#toc-entry-278">11.29.1.2&nbsp;&nbsp;&nbsp;More Exotic start on Conditions</a></h4>
<p>If your job more precise control over when your job starts, read
carefully the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/upstart-events.7.html">upstart-events(7)</a> manual page which summarizes all the
"well-known" events you can rely upon on an <a class="reference external" href="http://www.ubuntu.com/">Ubuntu</a> system. These
events provide a set of "hook points" which your job can make use of to
simplify the job of specifying the <a class="reference internal" href="index.html#start-on">start on</a> condition.</p>
<p>The main question to ask yourself is, "<em>what are the exact requirements
for the job?</em>". To help answer that question consider the following
questions:</p>
<blockquote>
<ul>
<li><p class="first">Does your application live in a standard local directory?</p>
</li>
<li><p class="first">Does the application write any files to disk? (data files, log
files, lock files, named sockets?) If so, which partition(s) does it
need to write to?</p>
</li>
<li><p class="first">Does the application read any files from disk? If so, which
partitions do they live in? <tt class="docutils literal">/etc</tt>? <tt class="docutils literal">/var</tt>?</p>
</li>
<li><p class="first">Do you want the application to start as early as possible, or as
late as possible?</p>
</li>
<li><p class="first">Does the application need to start before or after a service which
might <em>not</em> be installed?</p>
</li>
<li><p class="first">If the application needs access to a disk (it probably will), which
partitions or mounts does it need? <tt class="docutils literal">/etc</tt>? <tt class="docutils literal">/var</tt>?
<tt class="docutils literal"><span class="pre">/mnt/remote-system</span></tt>? Can it wait until all <em>local</em> partitions are
mounted? Or does it need to wait for a particular <em>remote</em>
filesystem to be mounted?</p>
</li>
<li><p class="first">Should a particular set of services already be running when your job starts?</p>
</li>
<li><p class="first">Should a particular set of services <em>not</em> be running when your job starts?</p>
</li>
<li><p class="first">What <a class="reference internal" href="index.html#runlevel">runlevel</a> (or runlevels) should your job run in?</p>
</li>
<li><p class="first">Does your application require a network?</p>
<ul class="simple">
<li>Does it need a local network (127.0.0.1?)</li>
<li>Does it need IPv6?</li>
<li>Does it require a bridge network interface?</li>
</ul>
</li>
<li><p class="first">Should your service only start when a client network connection is initiated?
If so, use the <tt class="docutils literal">socket</tt> event (emitted by the <a class="reference internal" href="index.html#upstart-socket-bridge">upstart-socket-bridge</a>).
See the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/socket-event.7.html">socket-event(7)</a> man page for details.</p>
</li>
<li><p class="first">Does your job require the services of some other system server?</p>
</li>
<li><p class="first">Does your job access files over the network?</p>
</li>
<li><p class="first">Does your application provide a <a class="reference external" href="http://dbus.freedesktop.org/">D-Bus</a> service which you want to start
when some sequence of Upstart events are emitted?</p>
<p>If so, use the <a class="reference external" href="http://dbus.freedesktop.org/">D-Bus</a> service activation facility.</p>
</li>
</ul>
</blockquote>
<p>This list can be summarized as:</p>
<blockquote>
What are the precise conditions your job needs before it can be
started successfully?</blockquote>
<p>And yes, you really do need to be able to answer all the questions above
before you can know that you have chosen the correct <a class="reference internal" href="index.html#start-on">start on</a>
condition. This might sound daunting, but consider:</p>
<blockquote>
<ul class="simple">
<li>Upstart needs to know this information to allow your application to
run at the correct point.</li>
<li>By devoting some time to understanding your applications
requirements, you will allow the system to run as efficiently as
possible.</li>
</ul>
</blockquote>
<div class="section" id="udev-conditions">
<h5><a class="toc-backref" href="index.html#toc-entry-279">11.29.1.2.1&nbsp;&nbsp;&nbsp;udev conditions</a></h5>
<p>To identify a <a class="reference internal" href="index.html#start-on">start on</a> condition making use of udev events, first you
need to know which udev subsystem is appropriate. See
<a class="reference internal" href="index.html#upstart-udev-bridge">upstart-udev-bridge</a> for details.</p>
<p>Having identified the subsystem, follow the steps below:</p>
<ol class="arabic">
<li><p class="first">Create a job that displays all udev variables set for a particular
udev subsystem.</p>
<p>In the example below, we're consider at the <tt class="docutils literal">tty</tt> subsystem, so
modify to taste:</p>
<pre class="literal-block">start on tty-device-added
exec env
</pre>
</li>
<li><p class="first">Boot your system and look at the relevant log file for the job.</p>
<p>For example look at <tt class="docutils literal">/var/log/upstart/myjob.log</tt> to see which udev
variables are set for your chosen udev subsystem.</p>
<p>If your version of Upstart does not have job logging, you'll need to
redirect the output of <tt class="docutils literal">env</tt> somewhere - refer to section <a class="reference internal" href="index.html#see-the-environment-a-job-runs-in">See the
Environment a Job Runs In</a>.</p>
</li>
<li><p class="first">Refine your <a class="reference internal" href="index.html#start-on">start on</a> condition accordingly.</p>
<p>For example, you might change it to be something like:</p>
<pre class="literal-block">start on tty-device-added DEVNAME=*ttyS1
</pre>
<p>to start the job when the <tt class="docutils literal">/dev/ttS1</tt> serial device becomes available.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="section" id="determining-the-stop-on-condition-ubuntu-specific">
<h3><a class="toc-backref" href="index.html#toc-entry-280">11.29.2&nbsp;&nbsp;&nbsp;Determining the <tt class="docutils literal">stop on</tt> Condition (<img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719">)</a></h3>
<p>Recall from the <a class="reference internal" href="index.html#shutdown">Shutdown</a> section that if no <tt class="docutils literal">stop on</tt> condition is
stopped, your job will be killed <em>at some (random) point</em> at system
shutdown. If you need your job to stop at a particular point in the
shutdown sequence, you <em>must</em> specify a suitable <tt class="docutils literal">stop on</tt> condition.</p>
<p>Shut down is not as event rich as startup. A common idiom is to specify
your <tt class="docutils literal">stop on</tt> as:</p>
<pre class="literal-block">stop on runlevel [016]
</pre>
<p>This ensures the job will be stopped on shutdown, when switching to
single-user mode and on reboot.</p>
<p>The next most common is to stop your job either before or after some
other job stops:</p>
<ul>
<li><p class="first">To stop a job just before a particular job has <em>started</em> to stop:</p>
<pre class="literal-block"># stop your job "just before" job 'some-job' ends
stop on stopping some-job
</pre>
<p>See also <a class="reference internal" href="index.html#run-a-job-before-another-job">Run a Job Before Another Job</a>.</p>
</li>
<li><p class="first">To stop a job immediately after a particular job has stopped:</p>
<pre class="literal-block"># stop your job "just after" job 'some-job' has ended
stop on stopped some-job
</pre>
<p>See also <a class="reference internal" href="index.html#run-a-job-after-another-job">Run a Job After Another Job</a>.</p>
</li>
</ul>
<p>Other questions relating to other stanzas:</p>
<ul class="simple">
<li>What should happen if your job fails to start?</li>
<li>What should happen if your job fails after some period of time?</li>
<li>Do you want Upstart to restart the job if it exits?
If so, use the <tt class="docutils literal">respawn</tt> stanza.</li>
<li>Does your job use non-standard exit codes to denote success and failure?
If so, use the <a class="reference internal" href="index.html#normal-exit">normal exit</a> stanza.</li>
<li>Is your job a daemon? If so, how many times does it call <a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/fork.2.html">fork(2)</a>?</li>
</ul>
</div>
<div class="section" id="final-words-of-advice">
<h3><a class="toc-backref" href="index.html#toc-entry-281">11.29.3&nbsp;&nbsp;&nbsp;Final Words of Advice</a></h3>
<p>If your <a class="reference internal" href="index.html#start-on">start on</a> or <a class="reference internal" href="index.html#stop-on">stop on</a> conditions are becoming complex
(referencing more than 2 or maybe 3 events), you should consider your
strategy carefully since there is probably an easier way to achieve your
goal by specifying some more appropriate event. See the
<a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/upstart-events.7.html">upstart-events(7)</a> manual page for ideas.</p>
<p>Also, review the conditions from standard job configuration files on
your system. However, it is inadvisable to make use of conditions you do
not <em>fully</em> understand.</p>
</div>
</div>
<div class="section" id="guarantee-that-a-job-will-only-run-once">
<h2><a class="toc-backref" href="index.html#toc-entry-282">11.30&nbsp;&nbsp;&nbsp;Guarantee that a job will only run once</a></h2>
<p>If you have a job which must only be run once, but which depends on
multiple conditions, the naive approach won't necessarily work:</p>
<pre class="literal-block">task
start on (A or B)
</pre>
<p>If event 'A' is emitted, the task will run. But assuming the task has
completed and event 'B' is <em>then</em> emitted, the task will run <em>again</em>.</p>
<div class="section" id="method-1">
<h3><a class="toc-backref" href="index.html#toc-entry-283">11.30.1&nbsp;&nbsp;&nbsp;Method 1</a></h3>
<p>A better approach is as follows:</p>
<ol class="arabic">
<li><p class="first">Create separate job configuration files for each condition you want
your job to <a class="reference internal" href="index.html#start-on">start on</a>:</p>
<pre class="literal-block"># /etc/init/got-A.conf
# job that will "run forever" when event A is emitted
start on A

# /etc/init/got-B.conf
# job that will "run forever" when event B is emitted
start on B
</pre>
</li>
<li><p class="first">Create a job which starts on either of the <tt class="docutils literal"><span class="pre">got-A</span></tt> or <tt class="docutils literal"><span class="pre">got-B</span></tt>
jobs starting:</p>
<pre class="literal-block"># /etc/init/only-run-once.conf
start on (starting got-A or starting got-B)
</pre>
</li>
</ol>
<p>Now, job "<tt class="docutils literal"><span class="pre">only-run-once</span></tt>" will start only once since jobs "<tt class="docutils literal"><span class="pre">got-A</span></tt>"
and "<tt class="docutils literal"><span class="pre">got-B</span></tt>" can only be started once themselves since:</p>
<ul class="simple">
<li>they do not specify the <a class="reference internal" href="index.html#instance">instance</a> stanza to allow multiple instances
of the jobs.</li>
<li>if either job starts, that job will run forever.</li>
<li>none of the jobs have a <a class="reference internal" href="index.html#stop-on">stop on</a> stanza.</li>
</ul>
</div>
<div class="section" id="method-2">
<h3><a class="toc-backref" href="index.html#toc-entry-284">11.30.2&nbsp;&nbsp;&nbsp;Method 2</a></h3>
<p>Change your <tt class="docutils literal">start on</tt> condition to include the <tt class="docutils literal">startup</tt> event:</p>
<pre class="literal-block">task
start on startup and (A or B)
</pre>
</div>
</div>
<div class="section" id="stop-a-job-that-is-about-to-start">
<h2><a class="toc-backref" href="index.html#toc-entry-285">11.31&nbsp;&nbsp;&nbsp;Stop a Job That is About to Start</a></h2>
<p>Upstart will start a job when its "<tt class="docutils literal">start on</tt>" condition becomes true.</p>
<p>Although somewhat unusual, it is quite possible to stop a job from starting
when Upstart tries to start it:</p>
<pre class="literal-block">start on starting job-A

script
  stop $JOB
end script
</pre>
</div>
<div class="section" id="stop-a-job-that-is-about-to-start-from-within-that-job">
<h2><a class="toc-backref" href="index.html#toc-entry-286">11.32&nbsp;&nbsp;&nbsp;Stop a Job That is About to Start From Within That Job</a></h2>
<p>You can in fact stop a job that Upstart has decided it needs to start
<em>from within that job</em>:</p>
<pre class="literal-block">pre-start script
  stop
end script
</pre>
<p>This is actually just an alias for:</p>
<pre class="literal-block">pre-start script
  stop $UPSTART_JOB
end script
</pre>
<p>Of course, you could set the <a class="reference internal" href="index.html#pre-start">pre-start</a> using the <a class="reference internal" href="index.html#override-files">Override Files</a>
facility.</p>
</div>
<div class="section" id="stop-a-job-from-running-if-its-configuration-file-has-not-been-created-modified">
<h2><a class="toc-backref" href="index.html#toc-entry-287">11.33&nbsp;&nbsp;&nbsp;Stop a Job from Running if its Configuration file has not been Created/Modified</a></h2>
<p>Use a <a class="reference internal" href="index.html#pre-start">pre-start</a> stanza to check for required application conditions.
If these are not met, call:</p>
<pre class="literal-block">stop
exit 0
</pre>
<p>This will cause the job to stop successfully before the main <a class="reference internal" href="index.html#script">script</a>
or <a class="reference internal" href="index.html#exec">exec</a> stanza (which would run your application/daemon) is started.</p>
<p>In particular, see the Ubuntu-specific example</p>
</div>
<div class="section" id="stop-a-job-when-some-other-job-is-about-to-start">
<h2><a class="toc-backref" href="index.html#toc-entry-288">11.34&nbsp;&nbsp;&nbsp;Stop a Job When Some Other Job is about to Start</a></h2>
<p>Here, we create <tt class="docutils literal"><span class="pre">/etc/init/job-C.conf</span></tt> which will stop <tt class="docutils literal"><span class="pre">job-B</span></tt> when
<tt class="docutils literal"><span class="pre">job-A</span></tt> is <em>about to start</em>:</p>
<pre class="literal-block">start on starting job-A

script
  stop job-B
end script
</pre>
</div>
<div class="section" id="start-a-job-when-a-particular-filesystem-is-about-to-be-mounted">
<h2><a class="toc-backref" href="index.html#toc-entry-289">11.35&nbsp;&nbsp;&nbsp;Start a Job when a Particular Filesystem is About to be Mounted</a></h2>
<p>Here, we start a job when the <tt class="docutils literal">/apps</tt> mountpoint is mounted read-only as an
NFS-v4 filesystem:</p>
<pre class="literal-block">start on mounting TYPE=nfs4 MOUNTPOINT=/apps OPTION=ro
</pre>
<p>Here's another example:</p>
<pre class="literal-block">start on mounted MOUNTPOINT=/var/run TYPE=tmpfs
</pre>
<p>Another example where a job would be started when any non-virtual filesystem is mounted:</p>
<pre class="literal-block">start on mounted DEVICE=[/UL]*
</pre>
<p>The use of the <tt class="docutils literal">$DEVICE</tt> variable is interesting. It is used here to specify
succinctly any device that:</p>
<ul class="simple">
<li>is a real device (starts with "<tt class="docutils literal">/</tt>" (to denote a normal "<tt class="docutils literal"><span class="pre">/dev/...</span></tt>" mount)).</li>
<li>is a device specified by its filesystem:<ul>
<li>label (starts with "<tt class="docutils literal">L</tt>" (to denote a "<tt class="docutils literal">LABEL=</tt>" mount)).</li>
<li>UUID (starts with "<tt class="docutils literal">U</tt>" (to denote a "<tt class="docutils literal">UUID=</tt>" mount)).</li>
</ul>
</li>
</ul>
<p>Another example where a job is started when a non-root filesystem is mounted:</p>
<pre class="literal-block">start on mounting MOUNTPOINT!=/ TYPE!=swap
</pre>
</div>
<div class="section" id="start-a-job-when-a-device-is-hot-plugged">
<h2><a class="toc-backref" href="index.html#toc-entry-290">11.36&nbsp;&nbsp;&nbsp;Start a Job when a Device is Hot-Plugged</a></h2>
<p>Hot-plug kernel events create <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/udev.7.html">udev(7)</a> events under Linux and Upstart events
are created from udev events by the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/upstart-udev-bridge.html">upstart-udev-bridge(8)</a>.</p>
<p>Added to this the <tt class="docutils literal">ifup</tt> and <tt class="docutils literal">ifdown</tt> commands are run at boot when network
devices are available for use.</p>
<div class="section" id="to-start-a-job-when-eth0-is-added-to-the-system">
<h3><a class="toc-backref" href="index.html#toc-entry-291">11.36.1&nbsp;&nbsp;&nbsp;To start a job when eth0 is <em>added to the system</em></a></h3>
<p>Note that the device is <em>not</em> yet be available for use):</p>
<pre class="literal-block">start on net-device-added INTERFACE=eth0
</pre>
<p>See <a class="reference internal" href="index.html#upstart-udev-bridge">upstart-udev-bridge</a> for more examples.</p>
<p>On an Ubuntu system, you can see which devices have been added by udev
(which the <tt class="docutils literal"><span class="pre">upstart-udev-bridge</span></tt> is using) with this snippet:</p>
<pre class="literal-block">$ awk 'BEGIN {RS=""; ORS="\n\n"}; /ACTION=add/ &amp;&amp; /SUBSYSTEM=net/ { print; }' \
    /var/log/udev | grep ^INTERFACE= | cut -d= -f2 | sort -u
eth0
lo
wlan0
$
</pre>
</div>
<div class="section" id="to-start-a-job-when-eth0-is-available">
<h3><a class="toc-backref" href="index.html#toc-entry-292">11.36.2&nbsp;&nbsp;&nbsp;To start a job when eth0 is <em>available</em></a></h3>
<p>Here, the device is available for use:</p>
<pre class="literal-block">start on net-device-up IFACE=eth0
</pre>
<p>Notes:</p>
<ul>
<li><p class="first">It does not matter whether the <tt class="docutils literal">eth0</tt> interface has been
configured statically, or if it is handled via DHCP, this event will
always be emitted.</p>
<p>See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/upstart-events.7.html">upstart-events(7)</a> and file <tt class="docutils literal">/var/log/udev</tt> for further details.</p>
</li>
<li><p class="first">The "<tt class="docutils literal"><span class="pre">net-device-up</span></tt>" event sets the "<tt class="docutils literal">IFACE</tt>" variable whereas
the net-device-added event sets the "<tt class="docutils literal">INTERFACE</tt>" variable!</p>
</li>
</ul>
</div>
</div>
<div class="section" id="stopping-a-job-if-it-runs-for-too-long">
<h2><a class="toc-backref" href="index.html#toc-entry-293">11.37&nbsp;&nbsp;&nbsp;Stopping a Job if it Runs for Too Long</a></h2>
<p>To stop a running job after a certain period of time, create a generic job
configuration file like this:</p>
<pre class="literal-block"># /etc/init/timeout.conf
stop on stopping JOB=$JOB_TO_WAIT_FOR
kill timeout 1
manual

export JOB_TO_WAIT_FOR
export TIMEOUT

script
  sleep $TIMEOUT
  initctl stop $JOB_TO_WAIT_FOR
end script
</pre>
<p>Now, you can control a job using a timeout:</p>
<pre class="literal-block">start myjob
start timeout JOB_TO_WAIT_FOR=myjob TIMEOUT=5
</pre>
<p>This will start job <tt class="docutils literal">myjob</tt> running and then wait for 5 seconds. If job
"<tt class="docutils literal">myjob</tt>" is still running after this period of time, the job will be
stopped using the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/initctl.8.html">initctl(8)</a> command. Note the <tt class="docutils literal">stop on</tt> stanza which will
cause the <tt class="docutils literal">timeout</tt> job not to run if the job being waited for has already
started to stop.</p>
</div>
<div class="section" id="run-a-job-when-a-file-or-directory-is-created-deleted">
<h2><a class="toc-backref" href="index.html#toc-entry-294">11.38&nbsp;&nbsp;&nbsp;Run a Job When a File or Directory is Created/Deleted</a></h2>
<p>As of Upstart 1.8, you can use the <a class="reference internal" href="index.html#upstart-file-bridge">upstart-file-bridge</a>.</p>
<p>If you are using an older version of Upstart, read on...</p>
<p>If you need to start a Job only when a certain file is created, you
could create a generic job configuration file such as the following:</p>
<pre class="literal-block"># /etc/init/wait_for_file.conf
instance $FILE_PATH
export   FILE_PATH

script
  while [ ! -e "$FILE_PATH" ]
  do
    sleep 1
  done

  initctl emit file FILE_PATH="$FILE_PATH"
end script
</pre>
<p>Having done this, you can now make use of it. To have another job start
if say file <tt class="docutils literal">/var/run/foo.dat</tt> gets created, you first need to
create a job configuration file stating this:</p>
<pre class="literal-block"># /etc/init/myapp.conf
start on file FILE_PATH=/var/run/foo.dat

script
  # ...
end script
</pre>
<p>Lastly, kick of the process by starting an instance of
<tt class="docutils literal">wait_for_file</tt>:</p>
<pre class="literal-block">start wait_for_file FILE_PATH=/var/run/foo.dat
</pre>
<p>Now, when file <tt class="docutils literal">/var/run/foo.dat</tt> is created, the following will
happen:</p>
<ol class="arabic simple">
<li>The <tt class="docutils literal">myapp</tt> job will emit the <tt class="docutils literal">file</tt> event, passing the path of
the file which you just specified in that events environment.</li>
<li><a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> will see that the <a class="reference internal" href="index.html#start-on">start on</a> condition for the <tt class="docutils literal">myapp</tt> job
configuration file is satisfied.</li>
<li><a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> will create a <tt class="docutils literal">myapp</tt> job, and start it.</li>
</ol>
<p>You can modify this strategy slightly to run a job when a file is:</p>
<ul class="simple">
<li>modified</li>
<li>deleted</li>
<li>contains certain content</li>
<li><em>et cetera</em></li>
</ul>
<p>See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/test.1.html">test(1)</a>, or your shells documentation for available file tests.</p>
<p>Note that this is very simplistic. A better approach would be to use
<a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/inotify.7.html">inotify(7)</a>.</p>
</div>
<div class="section" id="run-a-job-each-time-a-condition-is-true">
<h2><a class="toc-backref" href="index.html#toc-entry-295">11.39&nbsp;&nbsp;&nbsp;Run a Job Each Time a Condition is True</a></h2>
<p>This is the default way Upstart works when you have defined a task:</p>
<pre class="literal-block"># /etc/init/myjob.conf
task
exec /some/program
start on (A or B)
</pre>
<p>Job "myjob" will run every time either event 'A' or event 'B' are
emitted. However, there is a corner condition: if event 'A' has been
emitted and the task is <em>currently running</em> when event 'B' is emitted,
job "myjob" will <em>not</em> be run. To avoid this situation, use instances:</p>
<pre class="literal-block"># /etc/init/myjob2.conf
task
instance $SOME_VARIABLE
exec /some/program
start on (A or B)
</pre>
<p>Now, as long variable <tt class="docutils literal">$SOME_VARIABLE</tt> is defined with a unique value
each time either event 'A' or 'B' is emitted, Upstart will run job
"<tt class="docutils literal">myjob2</tt>" multiple times.</p>
</div>
<div class="section" id="run-a-job-when-a-particular-runlevel-is-entered-and-left">
<h2><a class="toc-backref" href="index.html#toc-entry-296">11.40&nbsp;&nbsp;&nbsp;Run a Job When a Particular Runlevel is Entered and Left</a></h2>
<p>To run a job when a particular runlevel is entered and also run it when
that same runlevel is left, you could specify:</p>
<pre class="literal-block">start on runlevel RUNLEVEL=5 or runlevel PREVLEVEL=5
</pre>
<p>See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/runlevel.7.html">runlevel(7)</a> and the <a class="reference internal" href="index.html#runlevels">Runlevels</a> section for more details.</p>
</div>
<div class="section" id="pass-state-between-job-processes">
<h2><a class="toc-backref" href="index.html#toc-entry-297">11.41&nbsp;&nbsp;&nbsp;Pass State Between Job Processes</a></h2>
<p>Assume you have a job configuration file like this:</p>
<pre class="literal-block">pre-start script
   # ...
end script

exec /bin/some-program $ARG
</pre>
<p>How can you get the <a class="reference internal" href="index.html#pre-start">pre-start</a> script section to set <tt class="docutils literal">$ARG</tt> and have
the "main" section use that value in the "<tt class="docutils literal">exec</tt>" stanza? This
isn't as easy as you might imagine for the simple reason that Upstart
runs each <tt class="docutils literal">script</tt> and <tt class="docutils literal">exec</tt> section in a new process. As such, by
the time Upstart gets to the <tt class="docutils literal">exec</tt> stanza the process spawned to
handle the <tt class="docutils literal"><span class="pre">pre-start</span> script</tt> section has now ended. This implies they cannot
communicate directly. However, there are ways to send information from
one section to another...</p>
<p>One method to achieve the required goal is as follows:</p>
<pre class="literal-block"># set a variable which is the name of a file this job will use
# to pass information between script sections.
env ARG_FILE="/var/myapp/myapp.dat"

# make the variable accessible to all script sections (ie sub-shells)
export ARG_FILE

pre-start script
   # decide upon arguments and write them to
   # $ARG_FILE, which is available in this sub-shell.
end script

script
  # read back the contents of the arguments file
  # and pass the values to the program to run.
  ARGS="$(cat $ARG_FILE)"

  # clean up
  rm -f $ARG_FILE || true

  exec /bin/some-program $ARGS
end script
</pre>
<p>However, as of Upstart 1.7, this is now possible (for <a class="reference internal" href="index.html#session-jobs">Session Jobs</a>
only!) by using the <a class="reference internal" href="index.html#initctl-set-env">initctl set-env</a> command. For example:</p>
<pre class="literal-block">pre-start script
  # modify the running jobs job environment table
  # such that when the 'exec' stanza is executed, Upstart will apply
  # all variables in this table to that job process.
  initctl set-env ARG=foo
end script

exec /bin/some-program $ARG
</pre>
</div>
<div class="section" id="pass-state-from-job-configuration-file-to-a-script-section">
<h2><a class="toc-backref" href="index.html#toc-entry-298">11.42&nbsp;&nbsp;&nbsp;Pass State From Job Configuration File to a Script Section</a></h2>
<p>To pass a value from a job configuration file to one of its script
sections, simply use the <tt class="docutils literal">env</tt> stanza:</p>
<pre class="literal-block">env CONF_FILE=/etc/myapp/myapp.cfg

script
  exec /bin/myapp -c $CONF_FILE
end script
</pre>
<p>This example is a little pointless, but the following slightly modified
example is much more useful:</p>
<pre class="literal-block">start on an-event
export CONF_FILE

script
  exec /bin/myapp -c $CONF_FILE
end script
</pre>
<p>By dropping the use of the <tt class="docutils literal">env</tt> stanza we can now pass the value in
via an event:</p>
<pre class="literal-block"># initctl emit an-event CONF_FILE=/etc/myapp/myapp.cfg
</pre>
<p>This is potentially much more useful since the value passed into
<tt class="docutils literal">myapp.conf</tt> can be varied without having to modify the job
configuration file.</p>
</div>
<div class="section" id="run-a-job-as-a-different-user">
<h2><a class="toc-backref" href="index.html#toc-entry-299">11.43&nbsp;&nbsp;&nbsp;Run a Job as a Different User</a></h2>
<div class="section" id="running-a-user-job">
<h3><a class="toc-backref" href="index.html#toc-entry-300">11.43.1&nbsp;&nbsp;&nbsp;Running a User Job</a></h3>
<p>See <a class="reference internal" href="index.html#user-job">User Job</a>.</p>
</div>
<div class="section" id="changing-user">
<h3><a class="toc-backref" href="index.html#toc-entry-301">11.43.2&nbsp;&nbsp;&nbsp;Changing User</a></h3>
<p>Some daemons start running as the super-user and then internally arrange
to drop their privilege level to some other (less privileged) user.
However, some daemons do not need to do this: they never need root
privileges so can be invoked as a non-root user.</p>
<p>How do you run a "system job" but have it run as a non-root user then?
As of Upstart 1.4, Upstart has the ability to run a <a class="reference internal" href="index.html#system-job">System Job</a> as a
specified user using the <a class="reference internal" href="index.html#setuid">setuid</a> and <a class="reference internal" href="index.html#setgid">setgid</a> stanzas.</p>
<p>However, if you are not using Upstart 1.4, it is easy to accomplish the
required goal. There are a couple of methods you can use. The recommended
method for Debian and Ubuntu systems is to use the helper utility
<a class="reference internal" href="index.html#start-stop-daemon-8">start-stop-daemon(8)</a> like this:</p>
<pre class="literal-block">exec start-stop-daemon --start -c myuser --exec command
</pre>
<p>The advantage of using <a class="reference internal" href="index.html#start-stop-daemon-8">start-stop-daemon(8)</a> is that it simply
changes the user and group the command is run as. This also has an
advantage over <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/su.1.html">su(1)</a> in that <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/su.1.html">su(1)</a> must fork to be able to hold
its PAM session open, and so is harder for upstart to track, whereas
<a class="reference internal" href="index.html#start-stop-daemon-8">start-stop-daemon(8)</a> will simply exec the given command after changing
the uid/gid.</p>
<p>Another potential issue to be aware of is that <tt class="docutils literal"><span class="pre">start-stop-daemon</span></tt> does
<em>not</em> impose <a class="reference external" href="http://www.kernel.org/pub/linux/libs/pam/">PAM</a> ("Pluggable Authentication Module") limits to the
process it starts. Such limits can be set using the appropriate Upstart
stanzas, you just cannot specify the limits via PAMs <a class="reference external" href="http://manpages.ubuntu.com/manpages/man5/limits.conf.5.html">limits.conf(5)</a>.</p>
<p>Of course, you may <em>want</em> PAM restrictions in place, in which case you
should either use <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/su.1.html">su(1)</a> or <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/sudo.8.html">sudo(8)</a>, both of which are linked to
the PAM libraries.</p>
<p>The general advice is <em>NOT</em> to use <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/su.1.html">su(1)</a> or <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/sudo.8.html">sudo(8)</a> though since PAM
restrictions really not appropriate for system services. For example,
PAM will make a <a class="reference external" href="http://manpages.ubuntu.com/manpages/man5/wtmp.5.html">wtmp(5)</a> entry every time <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/su.1.html">su(1)</a> or <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/sudo.8.html">sudo(8)</a> are
called and those records are not appropriate for system services.</p>
<p>If you want to use <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/su.1.html">su(1)</a> or <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/sudo.8.html">sudo(8)</a>, the examples below show you
how.</p>
<p>Using <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/su.1.html">su(1)</a>:</p>
<pre class="literal-block">exec su -s /bin/sh -c command $user
</pre>
<p>Note that although you <em>could</em> simplify the above to the following, it
is not recommended since if user "<tt class="docutils literal">$user</tt>" is a system account with a
shell specified as <tt class="docutils literal">/bin/false</tt>, the job will <em>not</em> run the specified
command: it will fail due to <tt class="docutils literal">/bin/false</tt> returning "<tt class="docutils literal">1</tt>":</p>
<pre class="literal-block">exec su -c command $user
</pre>
<p>The job will silently fail if user "<tt class="docutils literal">$user</tt>" is a system account with
a shell specified as <tt class="docutils literal">/bin/false</tt>.</p>
<p>To avoid the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/fork.2.html">fork(2)</a> caused by the shell being spawned, you could
instead specify:</p>
<pre class="literal-block">exec su -s /bin/sh -c 'exec "$0" "$@"' $user -- /path/to/command --arg1=foo -b wibble
</pre>
<p>This technique is particularly useful if your job is a <a class="reference internal" href="index.html#service-job">Service Job</a> that
makes use of <a class="reference internal" href="index.html#expect">expect</a>.</p>
<p>A basic example using <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/sudo.8.html">sudo(8)</a>:</p>
<pre class="literal-block">exec sudo -u $user command
</pre>
</div>
</div>
<div class="section" id="disabling-a-job-from-automatically-starting">
<h2><a class="toc-backref" href="index.html#toc-entry-302">11.44&nbsp;&nbsp;&nbsp;Disabling a Job from Automatically Starting</a></h2>
<p>With Upstart 0.6.7, to stop Upstart automatically starting a job, you can
either:</p>
<ul class="simple">
<li>Rename the job configuration file such that it does not end with
"<tt class="docutils literal">.conf</tt>".</li>
<li>Edit the job configuration file and comment out the "<tt class="docutils literal">start on</tt>"
stanza using a leading '#'.</li>
</ul>
<p>To re-enable the job, just undo the change.</p>
<div class="section" id="override-files">
<h3><a class="toc-backref" href="index.html#toc-entry-303">11.44.1&nbsp;&nbsp;&nbsp;Override Files</a></h3>
<p>With Upstart 1.3, you can make use of an "<span class="target" id="override-file">override file</span>" and the
<tt class="docutils literal">manual</tt> stanza to achieve the same result in a simpler manner
<a class="footnote-reference" href="index.html#override-files-blog" id="footnote-reference-21">[31]</a>:</p>
<pre class="literal-block"># echo "manual" &gt;&gt; /etc/init/myjob.override
</pre>
<p>Note that you <em>could</em> achieve the same effect by doing this:</p>
<pre class="literal-block"># echo "manual" &gt;&gt; /etc/init/myjob.conf
</pre>
<p>However, using the override facility means you can leave the original
job configuration file untouched.</p>
<p>To revert to the original behaviour, either delete or rename the
override file (or remove the <tt class="docutils literal">manual</tt> stanza from your "<tt class="docutils literal">.conf</tt>"
file).</p>
<p>For <a class="reference internal" href="index.html#session-jobs">Session Jobs</a>, note that if an override already exists "higher"
up the search path, only that override file will apply: you cannot
override an override file.</p>
<div class="section" id="change-a-jobs-start-stop-conditions">
<h4><a class="toc-backref" href="index.html#toc-entry-304">11.44.1.1&nbsp;&nbsp;&nbsp;Change a Jobs Start/Stop Conditions</a></h4>
<p>Override files allow you to modify the way in which a job starts and stop by
modifying the <a class="reference internal" href="index.html#start-on">start on</a> and <a class="reference internal" href="index.html#stop-on">stop on</a> conditions.</p>
<p>Maybe you are writing an application packaged for Upstart and you need to work
around some known bugs, or maybe the system you are installing the package on
is somehow non-standard and needs a special configuration. Again, override
files can help. If your package has a job configuration file with a <a class="reference internal" href="index.html#start-on">start on</a>
condition such as:</p>
<pre class="literal-block">start on event-A
</pre>
<p>You can change that trivially with an override:</p>
<pre class="literal-block">echo "start on (event-A and event-B)" &gt;&gt; /etc/init/myjob.override
</pre>
<p>Now the job will only start when both the <tt class="docutils literal"><span class="pre">event-A</span></tt> and <tt class="docutils literal"><span class="pre">event-B</span></tt> events
are emitted.  Again, to revert the behaviour back to starting when only
<tt class="docutils literal"><span class="pre">event-A</span></tt> is emitted, just delete the override file.</p>
</div>
<div class="section" id="adding-stanzas-that-are-not-present-in-the-conf-file">
<h4><a class="toc-backref" href="index.html#toc-entry-305">11.44.1.2&nbsp;&nbsp;&nbsp;Adding Stanzas that are Not Present in the .conf File</a></h4>
<p>You can specify stanzas in the override file that are not in the original <a class="reference internal" href="index.html#job-configuration-file">job
configuration file</a> and have Upstart use these values too. For example, imagine
you have a daemon process that opens and writes to stderr with debug
information if it sees a special "magic file":</p>
<pre class="literal-block">$ cat &gt;&gt; /etc/init/my-daemon.override &lt;&lt; EOT
console output
pre-start exec touch /var/run/my-daemon.magic
EOT
</pre>
<p>Note: We assume here that the corresponding <tt class="docutils literal"><span class="pre">/etc/init/my-daemon.conf</span></tt> file
does not already specify a <a class="reference internal" href="index.html#pre-start">pre-start</a> since if it did, our override file
would replace it.</p>
</div>
<div class="section" id="separating-variables-from-the-job">
<h4><a class="toc-backref" href="index.html#toc-entry-306">11.44.1.3&nbsp;&nbsp;&nbsp;Separating Variables from the Job</a></h4>
<p>Imagine you have a service which requires a number of variables to be
defined. However, those variables vary depending on the system you
intend to deploy the job to.</p>
<p>A way to resolve this problem is to use a static job coupled with an
override file which you can generate for each host.</p>
<p>For example, your static job (say <tt class="docutils literal">foo.conf</tt>) could look like this:</p>
<pre class="literal-block">start on ...

exec myapp --log-directory $LOGDIR --port $PORT --foo $FOO_VALUE
</pre>
<p>Then, you can create a <tt class="docutils literal">foo.override</tt> for one particular system
containing for example:</p>
<pre class="literal-block">env LOGDIR=/var/log/myapp
env PORT=12345
env FOO_VALUE="bar"
</pre>
</div>
<div class="section" id="ensuring-customized-packages-upgrade-smoothly">
<h4><a class="toc-backref" href="index.html#toc-entry-307">11.44.1.4&nbsp;&nbsp;&nbsp;Ensuring Customized Packages Upgrade Smoothly</a></h4>
<p>If you make changes to a packages configuration files, the chances are that you
have a Package Manager which will notice this fact when it needs to upgrade the
package. It may then prompt you to establish whether you want to keep your
customized configuration file, overwrite it with the new package versions
configuration file, or some other possibilities.</p>
<p>If you use override files to encode any modifications you make to a packages
job configuration, you can avoid this issue (at least for job configuration) and
ensure your configuration is always used (since the job configuration files
itself never needs to be changed).</p>
</div>
<div class="section" id="caveat-emptor">
<h4><a class="toc-backref" href="index.html#toc-entry-308">11.44.1.5&nbsp;&nbsp;&nbsp;Caveat Emptor</a></h4>
<p>If override files are used, you should employ other facilities to detect when
an underlying job configuration file has actually changed.</p>
<p>This would be necessary for example should a new job configuration file be
installed that fixed an important bug: if your override file overrides the
particular configuration option that the new version resolved a issue with,
your system may still exhibit the bug since you have overridden the (fixed)
configuration option and thus may have unwittingly "undone" the fix. This
problem is certainly not unique to Upstart override files, but it is worth
considering.</p>
</div>
</div>
</div>
<div class="section" id="jobs-that-run-forever">
<h2><a class="toc-backref" href="index.html#toc-entry-309">11.45&nbsp;&nbsp;&nbsp;Jobs that "Run Forever"</a></h2>
<p>To create a job that runs continuously from the time it is manually
<a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/started.7.html">started(7)</a> until the time it is manually <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/stopped.7.html">stopped(7)</a>, create a job
configuration file without any process definition (<tt class="docutils literal">exec</tt> and
<tt class="docutils literal">script</tt>) or event definition (<tt class="docutils literal">start on</tt> for example) stanzas:</p>
<pre class="literal-block"># /etc/init/runforever.conf
description "job that runs until stopped manually"
</pre>
<p>This job can only be started by the administrator running:</p>
<pre class="literal-block"># start runforever
</pre>
<p>The status of this job will now be "<tt class="docutils literal">start/running</tt>" until the
administrator subsequently runs:</p>
<pre class="literal-block"># stop runforever
</pre>
<p>These "<a class="reference internal" href="index.html#abstract-job">Abstract Job</a>" types have other uses as covered in other parts
of this document. See for example <a class="reference internal" href="index.html#synchronisation">Synchronisation</a>.</p>
</div>
<div class="section" id="run-a-java-application">
<h2><a class="toc-backref" href="index.html#toc-entry-310">11.46&nbsp;&nbsp;&nbsp;Run a Java Application</a></h2>
<p>Running a Java application is no different to any other, but Java
suffers from the inability to switch users without extra helper classes.</p>
<p>If your Java daemon needs to run as a different user and you are running
Upstart 1.4, you can use the <a class="reference internal" href="index.html#setuid">setuid</a> and <a class="reference internal" href="index.html#setgid">setgid</a> stanzas.</p>
<p>However, if you are using an older version, you will have to use a
facility such as <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/su.1.html">su(1)</a>. Also, you may wish to define some variables
to simplify the invocation:</p>
<pre class="literal-block">env ROOT_DIR=/apps/myapp
env HTTP_PORT=8080
env USER=java_user
env JAVA_HOME=/usr/lib/jvm/java-6-openjdk
env JVM_OPTIONS="-Xms64m -Xmx256m"
env APP_OPTIONS="--httpPort=$HTTP_PORT"
env LOGFILE=/var/log/myapp.log

script
  exec su -c "$JAVA_HOME/bin/java $JVM_OPTIONS \
    -jar $ROOT_DIR/myjar.jar $APP_OPTIONS &gt; $LOGFILE 2&gt;&amp;1" $USER
end script
</pre>
<p>You should read the <a class="reference internal" href="index.html#changing-user">Changing User</a> section section before using this
technique though.</p>
<div class="section" id="alternative-method">
<h3><a class="toc-backref" href="index.html#toc-entry-311">11.46.1&nbsp;&nbsp;&nbsp;Alternative Method</a></h3>
<p>Here is how you might run a Java application which calls <a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/fork.2.html">fork(2)</a> some
number of times:</p>
<pre class="literal-block">exec start-stop-daemon --start --exec $JAVA_HOME/bin/java \
  -- $JAVA_OPTS -jar $SOMEWHERE/file.war
</pre>
<p>Again, you should read the <a class="reference internal" href="index.html#changing-user">Changing User</a> section section before using
this technique.</p>
</div>
</div>
<div class="section" id="ensure-a-directory-exists-before-starting-a-job">
<h2><a class="toc-backref" href="index.html#toc-entry-312">11.47&nbsp;&nbsp;&nbsp;Ensure a Directory Exists Before Starting a Job</a></h2>
<p>This is a good use of the <tt class="docutils literal"><span class="pre">pre-start</span></tt> stanza:</p>
<pre class="literal-block">env DIR=/var/run/myapp
env USER=myuser
env GROUP=mygroup
env PERMS=0755

pre-start script
  mkdir $DIR              || true
  chmod $PERMS $DIR       || true
  chown $USER:$GROUP $DIR || true
end script
</pre>
</div>
<div class="section" id="run-a-gui-application">
<h2><a class="toc-backref" href="index.html#toc-entry-313">11.48&nbsp;&nbsp;&nbsp;Run a GUI Application</a></h2>
<p>To have Upstart start a GUI application, you first need to ensure that
the user who will be running it has access to the X display. This is
achieved using the <tt class="docutils literal">xhost</tt> command.</p>
<p>Once the user has access, the method is the same as usual:</p>
<pre class="literal-block">env DISPLAY=:0.0
exec xclock -update 1
</pre>
</div>
<div class="section" id="run-an-application-through-gnu-screen">
<h2><a class="toc-backref" href="index.html#toc-entry-314">11.49&nbsp;&nbsp;&nbsp;Run an Application through GNU Screen</a></h2>
<p>If you want Upstart to create a GNU Screen (or Byobu) session to run
your application in, this is equally simple:</p>
<pre class="literal-block">exec su myuser -c "screen -D -m -S MYAPP java -jar MyApp.jar"
</pre>
</div>
<div class="section" id="run-upstart-in-a-chroot-environment">
<h2><a class="toc-backref" href="index.html#toc-entry-315">11.50&nbsp;&nbsp;&nbsp;Run Upstart in a chroot Environment</a></h2>
<div class="section" id="chroot-workaround-for-older-versions-of-upstart-debian-and-ubuntu-specific">
<h3><a class="toc-backref" href="index.html#toc-entry-316">11.50.1&nbsp;&nbsp;&nbsp;chroot Workaround for Older Versions of Upstart (<img alt="D" class="debian-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/4926319605052bdf09442836fd8d799b236e5db8"> , <img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719">)</a></h3>
<p>Older versions of Upstart jobs cannot be started in a <a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/chroot.2.html">chroot(2)</a> environment
<a class="footnote-reference" href="index.html#chroot-bug" id="footnote-reference-22">[21]</a> because Upstart acts as a service supervisor, and processes
within the chroot are unable to communicate with the Upstart running outside
of the chroot. This will cause some packages that have been converted to use
Upstart jobs instead of init scripts to fail to upgrade within a chroot.</p>
<p>Users are advised to configure their chroots with <tt class="docutils literal">/sbin/initctl</tt> pointing
to <tt class="docutils literal">/bin/true</tt>, with the following commands <em>run within the chroot</em>:</p>
<pre class="literal-block">dpkg-divert --local --rename --add /sbin/initctl
ln -s /bin/true /sbin/initctl
</pre>
</div>
<div class="section" id="chroots-in-ubuntu-natty-ubuntu-specific">
<h3><a class="toc-backref" href="index.html#toc-entry-317">11.50.2&nbsp;&nbsp;&nbsp;chroots in Ubuntu Natty (<img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719">)</a></h3>
<p>The version of Upstart in Ubuntu Natty now has full <a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/chroot.2.html">chroot(2)</a>
support. This means that if <a class="reference internal" href="index.html#initctl">initctl</a> is run as user <tt class="docutils literal">root</tt> from within a
chroot the Upstart init daemon (outside the chroot) will honour requests from
within the chroot to manipulate jobs within the chroot.</p>
<p>What all this means is that you no longer need to use <tt class="docutils literal"><span class="pre">dpkg-divert</span></tt>
and can control chroot jobs from within the chroot environment exactly
as you would control jobs outside a chroot environment. There are a
number of caveats and notes to consider though:</p>
<ul>
<li><p class="first">Within the chroot, only jobs within the chroot are visible</p>
</li>
<li><p class="first">Within the chroot, only jobs within the chroot can be manipulated.</p>
</li>
<li><p class="first">It is only possible to view and control such chroot jobs from within the
chroot.</p>
<p>That is to say, the "outer" system cannot manipulate jobs within the chroot.</p>
</li>
<li><p class="first">Due to the design of this feature, Upstart will not be able to detect changes
to job configuration files within the chroot until a process within the chroot
has either manipulated a job, or listed one or more jobs.</p>
</li>
<li><p class="first">Chroot support can be disabled at boot by passing the "<tt class="docutils literal"><span class="pre">--no-sessions</span></tt>"
option on the Grub kernel command-line.</p>
<p>See <a class="reference internal" href="index.html#add-verbose-or-debug-to-the-kernel-command-line">Add --verbose or --debug to the kernel command-line</a> for details of how
to add values to the grub kernel command-line.</p>
<p>If chroots are disabled, running Upstart commands within a chroot will affect
jobs outside the chroot only.</p>
<p>Note that "<tt class="docutils literal"><span class="pre">--no-sessions</span></tt>" was removed in Upstart 1.13 since the
default in newer versions of Upstart is to run with chroot sessions
diabled. To enable chroot support, it is now necessary to specify
"<tt class="docutils literal"><span class="pre">--chroot-sessions</span></tt>".</p>
</li>
<li><p class="first">If a job is run in a chroot environment (such as provided by <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/schroot.1.html">schroot(1)</a>),
exiting the chroot will kill the job.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="record-all-jobs-and-events-which-emit-an-event">
<h2><a class="toc-backref" href="index.html#toc-entry-318">11.51&nbsp;&nbsp;&nbsp;Record all Jobs and Events which Emit an Event</a></h2>
<p>For example, if you want to record all jobs which emit a started event:</p>
<pre class="literal-block"># /etc/init/debug.conf
start on started
script
  exec 1&gt;&gt;/tmp/log.file
  echo "$0:$$:`date`:got called. Environment of job $JOB was:"
  env
  echo
end script
</pre>
<p>You could also log details of all jobs (except the debug job itself)
which are affected by the main events:</p>
<pre class="literal-block"># /etc/init/debug.conf
start on ( starting JOB!=debug \
  or started JOB!=debug \
  or stopping JOB!=debug \
  or stopped JOB!=debug )
script
  exec 1&gt;&gt;/tmp/log.file
  echo -n "$UPSTART_JOB/$UPSTART_INSTANCE ($0):$$:`date`:"
  echo    "Job $JOB/$INSTANCE $UPSTART_EVENTS. Environment was:"
  env
  echo
end script
</pre>
<p>Note that the <tt class="docutils literal">$UPSTART_JOB</tt> and <tt class="docutils literal">$UPSTART_INSTANCE</tt> environment
variables refer to <em>the debug job itself</em>, whereas <tt class="docutils literal">$JOB</tt> and
<tt class="docutils literal">$INSTANCE</tt> refer to <em>the job which the debug job is triggered by</em>.</p>
</div>
<div class="section" id="integrating-your-new-application-with-upstart">
<h2><a class="toc-backref" href="index.html#toc-entry-319">11.52&nbsp;&nbsp;&nbsp;Integrating your New Application with Upstart</a></h2>
<p>Integrating your application into Upstart is actually very simple.
However, you need to remember that Upstart is <em>NOT</em> "System V" (aka
"SysV"), so you need to think in a different way.</p>
<p>With SysV you slot your service script between other service scripts by
specifying a startup number. The SysV init system then runs each script
in numerical order. This is very simple to understand and use, but
highly inefficient in practical terms since it means the boot cannot be
parallelised and thus cannot be optimized.</p>
</div>
<div class="section" id="block-another-job-until-yours-has-started">
<h2><a class="toc-backref" href="index.html#toc-entry-320">11.53&nbsp;&nbsp;&nbsp;Block Another Job Until Yours has Started</a></h2>
<p>It is common that a particular piece of software, when installed, will
need to be started before another. The logical conclusion is to use the
'starting' event of the other job:</p>
<pre class="literal-block">start on starting foo
</pre>
<p>This will indeed, block foo from starting until our job has started.</p>
<p>But what if we have multiple events that we need to delay:</p>
<pre class="literal-block">start on starting foo or starting network-services
</pre>
<p>This would seem to make sense. However, if we have a time-line like this:</p>
<pre class="literal-block">starting foo
starting our job
starting network-services
started network-services
</pre>
<p>Network-services will actually NOT be blocked. This is because upstart
only blocks an event if that event causes change in the <em>goal</em> of the
service. So, we need to make sure upstart waits every time. This can be
done by using a "wait job":</p>
<pre class="literal-block"># myjob-wait
start on starting foo or starting network-services
stop on started myjob or stopped myjob
instance $JOB
normal exit 2
task
script
  status myjob | grep -q 'start/running' &amp;&amp; exit 0
  start myjob || :
  sleep 3600
end script
</pre>
<p>This is a bit of a hack to get around the lack of state awareness in
Upstart. Eventually this should be built in to upstart. The job above
will create an instance for each JOB that causes it to start. It will
try and check to see if it's already running, and if so, let the blocked
job go with exit 0. If it's not running, it will set the ball in motion
for it to start. By doing this, we make it very likely that the stopped
or started event for myjob will be emitted (the only thing that will
prevent this, is a script line in 'myjob' that runs 'stop'). Because we
know we will get one of those start or stopped events, we can just sleep
for an hour waiting for upstart to kill us when the event happens.</p>
</div>
<div class="section" id="controlling-upstart-using-d-bus">
<h2><a class="toc-backref" href="index.html#toc-entry-321">11.54&nbsp;&nbsp;&nbsp;Controlling Upstart using D-Bus</a></h2>
<p><a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> contains its own <a class="reference external" href="http://dbus.freedesktop.org/">D-Bus</a> server which means that <a class="reference internal" href="index.html#initctl">initctl</a> and
any other D-Bus application can control <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a>. The examples below use
<tt class="docutils literal"><span class="pre">dbus-send</span></tt>, but any of the D-Bus bindings could be used.</p>
<div class="section" id="query-version-of-upstart">
<h3><a class="toc-backref" href="index.html#toc-entry-322">11.54.1&nbsp;&nbsp;&nbsp;Query Version of Upstart</a></h3>
<p>To emulate <a class="reference internal" href="index.html#initctl-version">initctl version</a>, run:</p>
<pre class="literal-block">$ dbus-send --system --print-reply --dest=com.ubuntu.Upstart /com/ubuntu/Upstart org.freedesktop.DBus.Properties.Get string:com.ubuntu.Upstart0_6 string:version
</pre>
<p>Note: this is querying the version of <tt class="docutils literal">/sbin/init</tt>, <em>not</em> the version
of <tt class="docutils literal">initctl</tt>. For the latter, see <a class="reference internal" href="index.html#initctl-version">initctl version</a>.</p>
</div>
<div class="section" id="query-log-priority">
<h3><a class="toc-backref" href="index.html#toc-entry-323">11.54.2&nbsp;&nbsp;&nbsp;Query Log Priority</a></h3>
<p>To emulate <a class="reference internal" href="index.html#initctl-log-priority">initctl log-priority</a> and show the current log priority, run:</p>
<pre class="literal-block">$ dbus-send --system --print-reply --dest=com.ubuntu.Upstart /com/ubuntu/Upstart org.freedesktop.DBus.Properties.Get string:com.ubuntu.Upstart0_6 string:log_priority
</pre>
</div>
<div class="section" id="set-log-priority">
<h3><a class="toc-backref" href="index.html#toc-entry-324">11.54.3&nbsp;&nbsp;&nbsp;Set Log Priority</a></h3>
<p>To emulate <a class="reference internal" href="index.html#initctl-log-priority">initctl log-priority</a> and <em>set</em> a new log priority, run:</p>
<pre class="literal-block">$ priority=debug
$ sudo dbus-send --system --print-reply --dest=com.ubuntu.Upstart /com/ubuntu/Upstart org.freedesktop.DBus.Properties.Set string:com.ubuntu.Upstart0_6 string:log_priority variant:string:$priority
</pre>
</div>
<div class="section" id="list-all-jobs-via-d-bus">
<h3><a class="toc-backref" href="index.html#toc-entry-325">11.54.4&nbsp;&nbsp;&nbsp;List all Jobs via D-Bus</a></h3>
<p>To emulate <a class="reference internal" href="index.html#initctl-list">initctl list</a>, run:</p>
<pre class="literal-block">$ dbus-send --system --print-reply --dest=com.ubuntu.Upstart /com/ubuntu/Upstart com.ubuntu.Upstart0_6.GetAllJobs
</pre>
</div>
<div class="section" id="get-status-of-job-via-d-bus">
<h3><a class="toc-backref" href="index.html#toc-entry-326">11.54.5&nbsp;&nbsp;&nbsp;Get Status of Job via D-Bus</a></h3>
<p>To emulate <a class="reference internal" href="index.html#initctl-status">initctl status</a>, run:</p>
<pre class="literal-block">$ job=myjob
$ dbus-send --system --print-reply --dest=com.ubuntu.Upstart /com/ubuntu/Upstart/jobs/${job}/_ org.freedesktop.DBus.Properties.GetAll string:''
</pre>
<p>Note that this will return information on all running job instances of
<tt class="docutils literal">myjob</tt>.</p>
</div>
<div class="section" id="emit-an-event">
<h3><a class="toc-backref" href="index.html#toc-entry-327">11.54.6&nbsp;&nbsp;&nbsp;Emit an Event</a></h3>
<p>To emulate <a class="reference internal" href="index.html#initctl-emit">initctl emit</a>, run:</p>
<pre class="literal-block">$ event=foo
$ sudo dbus-send --system --print-reply --dest=com.ubuntu.Upstart /com/ubuntu/Upstart com.ubuntu.Upstart0_6.EmitEvent string:$event array:string: boolean:true
</pre>
<p>To emulate <tt class="docutils literal">initctl emit <span class="pre">--no-wait</span> &lt;event&gt; A=B <span class="pre">c='hello</span> world' D=123.456</tt>, run:</p>
<pre class="literal-block">$ event=foo
$ sudo dbus-send --system --print-reply --dest=com.ubuntu.Upstart /com/ubuntu/Upstart com.ubuntu.Upstart0_6.EmitEvent string:$event array:string:'A=B',"C='hello world'",D=123.456 boolean:false
</pre>
</div>
<div class="section" id="get-jobs-start-on-and-stop-on-conditions-via-d-bus">
<h3><a class="toc-backref" href="index.html#toc-entry-328">11.54.7&nbsp;&nbsp;&nbsp;Get Jobs start on and stop on Conditions via D-Bus</a></h3>
<p>To show a jobs <a class="reference internal" href="index.html#start-on">start on</a> and <a class="reference internal" href="index.html#stop-on">stop on</a> conditions:</p>
<pre class="literal-block">$ job=cron
$ for condition in start_on stop_on
&gt; do
&gt;     dbus-send --system --print-reply --dest=com.ubuntu.Upstart /com/ubuntu/Upstart/jobs/$job org.freedesktop.DBus.Properties.Get string:com.ubuntu.Upstart0_6.Job string:$condition
&gt; done
</pre>
<p>If you have a job with a <a class="reference internal" href="index.html#start-on">start on</a> condition like this:</p>
<pre class="literal-block">start on (starting foo A=B or (stopping bar C=D and (stopped baz E=F G=H I=J or foo)))
</pre>
<p>... a <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/dbus-send.1.html">dbus-send(1)</a> query like the one above for <a class="reference internal" href="index.html#start-on">start on</a> will
return an "array of arrays of strings":</p>
<pre class="literal-block">method return sender=:1.629 -&gt; dest=:1.630 reply_serial=2
   variant       array [
         array [
            string "starting"
            string "foo"
            string "A=B"
         ]
         array [
            string "stopping"
            string "bar"
            string "C=D"
         ]
         array [
            string "stopped"
            string "baz"
            string "E=F"
            string "G=H"
            string "I=J"
         ]
         array [
            string "foo"
         ]
         array [
            string "/OR"
         ]
         array [
            string "/AND"
         ]
         array [
            string "/OR"
         ]
      ]
</pre>
<p>This will require a little massaging. Every inner array entry represents
one of the following:</p>
<blockquote>
<ul class="simple">
<li>an <a class="reference internal" href="index.html#event">Event</a></li>
<li>an operator ("<tt class="docutils literal">and</tt>" or "<tt class="docutils literal">or</tt>")</li>
</ul>
</blockquote>
<p>For event arrays, the first element is the event name and subsequent
elements represent the events environment variables.</p>
<p>Note too that the entire <a class="reference internal" href="index.html#start-on">start on</a> expression has been encoded using
Reverse Polish Notation (RPN) since this is a convenient format to
represent the condition (particularly when you consider that they are
represented internally as trees).</p>
<p>Normally, you don't need to get involved with RPN since <a class="reference internal" href="index.html#initctl-show-config">initctl
show-config</a> converts the RPN back into the original form as specified in
the <a class="reference internal" href="index.html#job-configuration-file">Job Configuration file</a>.</p>
</div>
<div class="section" id="to-start-a-job-via-d-bus">
<h3><a class="toc-backref" href="index.html#toc-entry-329">11.54.8&nbsp;&nbsp;&nbsp;To Start a Job via D-Bus</a></h3>
<p>To emulate <a class="reference internal" href="index.html#initctl-start">initctl start</a>, run:</p>
<pre class="literal-block"># job=myjob
# dbus-send --system --print-reply --dest=com.ubuntu.Upstart /com/ubuntu/Upstart/jobs/${job} com.ubuntu.Upstart0_6.Job.Start array:string: boolean:true
</pre>
<p>Note that you must be <tt class="docutils literal">root</tt> to manipulate system jobs.</p>
</div>
<div class="section" id="to-stop-a-job-via-d-bus">
<h3><a class="toc-backref" href="index.html#toc-entry-330">11.54.9&nbsp;&nbsp;&nbsp;To Stop a Job via D-Bus</a></h3>
<p>To emulate <a class="reference internal" href="index.html#initctl-stop">initctl stop</a>, run:</p>
<pre class="literal-block"># job=myjob
# dbus-send --system --print-reply --dest=com.ubuntu.Upstart /com/ubuntu/Upstart/jobs/${job} com.ubuntu.Upstart0_6.Job.Stop array:string: boolean:true
</pre>
<p>Note that you must be <tt class="docutils literal">root</tt> to manipulate system jobs.</p>
</div>
<div class="section" id="to-restart-a-job-via-d-bus">
<h3><a class="toc-backref" href="index.html#toc-entry-331">11.54.10&nbsp;&nbsp;&nbsp;To Restart a Job via D-Bus</a></h3>
<p>To emulate <a class="reference internal" href="index.html#initctl-restart">initctl restart</a>, run:</p>
<pre class="literal-block"># job=myjob
# dbus-send --system --print-reply --dest=com.ubuntu.Upstart /com/ubuntu/Upstart/jobs/${job} com.ubuntu.Upstart0_6.Job.Restart array:string: boolean:true
</pre>
<p>Note that you must be <tt class="docutils literal">root</tt> to manipulate system jobs.</p>
</div>
</div>
<div class="section" id="establish-blocking-job">
<h2><a class="toc-backref" href="index.html#toc-entry-332">11.55&nbsp;&nbsp;&nbsp;Establish Blocking Job</a></h2>
<p>Image you have just run the following command and it has "blocked"
(appeared to hang):</p>
<pre class="literal-block"># initctl emit event-A
</pre>
<p>The reason for the block is that the <tt class="docutils literal"><span class="pre">event-A</span></tt> event changes the goal
of "some job", and until the goal has changed, the <tt class="docutils literal">initctl</tt> command
will block.</p>
<p>But <em>which</em> job is being slow to change goal? It is now possible to hone
in on the problem using <tt class="docutils literal">initctl <span class="pre">show-config</span></tt> in a script such as
this:</p>
<pre class="literal-block">#!/bin/sh
# find_blocked_job.sh

[ $# -ne 1 ] &amp;&amp; { echo "ERROR: usage: $0 &lt;event&gt;"; exit 1; }
event="$1"

# obtain a list of jobs (removing instances)
initctl list | awk '{print $1}' | sort -u | while read job
do
  initctl show-config -e "$job" |\
    egrep "(start|stop) on \&lt;event\&gt;" &gt;/dev/null 2&gt;&amp;1
  [ $? -eq 0 ] &amp;&amp; echo $job
done
</pre>
<p>This will return a list of jobs, one per line. One of these will be the
culprit. Having identified the problematic job, you can debug using
techniques from the <a class="reference internal" href="index.html#debugging">Debugging</a> section.</p>
</div>
<div class="section" id="determine-if-a-job-is-disabled">
<h2><a class="toc-backref" href="index.html#toc-entry-333">11.56&nbsp;&nbsp;&nbsp;Determine if a Job is Disabled</a></h2>
<p>To determine if a job has been disabled from starting automatically:</p>
<pre class="literal-block">$ job=foo
$ initctl show-config $job | grep -q "^  start on" &amp;&amp; echo enabled || echo disabled
</pre>
</div>
<div class="section" id="visualising-jobs-and-events">
<h2><a class="toc-backref" href="index.html#toc-entry-334">11.57&nbsp;&nbsp;&nbsp;Visualising Jobs and Events</a></h2>
<p>Use the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/initctl2dot.8.html">initctl2dot(8)</a> facility. See <a class="footnote-reference" href="index.html#job-visualisation-blog" id="footnote-reference-23">[29]</a> for
further details and examples.</p>
</div>
<div class="section" id="sourcing-files">
<h2><a class="toc-backref" href="index.html#toc-entry-335">11.58&nbsp;&nbsp;&nbsp;Sourcing Files</a></h2>
<p>You need to take care when "sourcing" a script or
configuration file into a script section for a number of reasons.
Suppose we have the following:</p>
<pre class="literal-block">script
. /etc/default/myapp.cfg
. /etc/myapp/myapp.cfg
echo hello &gt; /tmp/myapp.log
end script
</pre>
<p>Assume that file <tt class="docutils literal">/etc/myapp/myapp.cfg</tt> does <em>NOT</em> exist.</p>
<div class="section" id="develop-scripts-using-bin-sh">
<h3><a class="toc-backref" href="index.html#toc-entry-336">11.58.1&nbsp;&nbsp;&nbsp;Develop Scripts Using <tt class="docutils literal">/bin/sh</tt></a></h3>
<p>Firstly, if you developed this script using the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/bash.1.html">bash(1)</a> shell, before
you put it into a job configuration file), all would be well. However,
as noted, <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> runs all jobs with <tt class="docutils literal">/bin/sh <span class="pre">-e</span></tt>. What you will find
is that if you run the script above under <tt class="docutils literal">/bin/sh</tt>, in all likelihood
the file will <em>never</em> be created since regardless of whether you specify
"<tt class="docutils literal"><span class="pre">-e</span></tt>" or not, the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/dash.1.html">dash(1)</a> shell (which <tt class="docutils literal">/bin/sh</tt> is linked to on
<a class="reference external" href="http://www.ubuntu.com/">Ubuntu</a> systems) has different semantics when it comes to sourcing
compared with <tt class="docutils literal">/bin/bash</tt>.</p>
<p>Therefore, to avoid surprises later on:</p>
<ul>
<li><p class="first">Always develop your scripts using "<tt class="docutils literal">/bin/sh <span class="pre">-e</span></tt>".</p>
</li>
<li><p class="first">Always code defensively.</p>
<p>For example, it would be better to write the script above as:</p>
<pre class="literal-block">script
  [ -f /etc/default/myapp.cfg ] &amp;&amp; . /etc/default/myapp.cfg
  [ -f /etc/myapp/myapp.cfg ]   &amp;&amp; . /etc/myapp/myapp.cfg
  echo hello &gt; /tmp/myapp.log
end script
</pre>
</li>
</ul>
<p>Or maybe even like this to minimise mistakes:</p>
<pre class="literal-block">script
  files="\
  /etc/default/myapp.cfg
  /etc/myapp/myapp.cfg
  "

  for file in $files
  do
    [ -f "$file" ] &amp;&amp; . "$file"
  done
  echo hello &gt; /tmp/myapp.log
end script
</pre>
</div>
<div class="section" id="ureadahead">
<h3><a class="toc-backref" href="index.html#toc-entry-337">11.58.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">ureadahead</tt></a></h3>
<p>Most modern Linux systems attempt to optimise the boot experience by
pre-loading files early on in the boot sequence. This allows hard
disks can minimise expensive (slow) seek operations.</p>
<p>On <a class="reference external" href="http://www.ubuntu.com/">Ubuntu</a>, this job is accomplished using <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/ureadahead.8.html">ureadahead(8)</a>, which was
designed with <em>both</em> spinning hard disk and SSD drives in mind.
However, if your job configuration files start reading files from all
over the disk, you will be potentially slowing down the boot as the disk
is then forced to seek across the filesystem, looking for your files.</p>
<p>The general advice is therefore to put your configuration variables
<em>inside</em> the job configuration file itself where possible.</p>
</div>
</div>
<div class="section" id="determining-how-to-stop-a-job-with-multiple-running-instances">
<h2><a class="toc-backref" href="index.html#toc-entry-338">11.59&nbsp;&nbsp;&nbsp;Determining How to Stop a Job with Multiple Running Instances</a></h2>
<p>As explained in the <a class="reference internal" href="index.html#initctl-status">initctl status</a> section, a job that has multiple
running instances will show the specific (unique) instance value within
brackets:</p>
<pre class="literal-block">$ initctl list | grep ^network-interface-security
network-interface-security (network-manager) start/running
network-interface-security (network-interface/eth0) start/running
network-interface-security (network-interface/lo) start/running
network-interface-security (networking) start/running
</pre>
<p>In the example output above there are four instances of the
<tt class="docutils literal"><span class="pre">network-interface-security</span></tt> job running with the unique instances
values of:</p>
<blockquote>
<ul class="simple">
<li>"<tt class="docutils literal"><span class="pre">network-manager</span></tt>"</li>
<li>"<tt class="docutils literal"><span class="pre">network-interface/eth0</span></tt>"</li>
<li>"<tt class="docutils literal"><span class="pre">network-interface/lo</span></tt>"</li>
<li>"<tt class="docutils literal">networking</tt>"</li>
</ul>
</blockquote>
<p>So how do we stop one of these jobs? Lets try to work this out without
looking at <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/initctl.8.html">initctl(8)</a> manual page:</p>
<pre class="literal-block"># stop network-interface-security network-interface/eth0
stop: Env must be KEY=VALUE pairs
</pre>
<p>That clearly doesn't work. The problem is that we have provided the
<em>value</em> to the instance variable, but we haven't named the instance
variable that the given value corresponds to. But how do we establish
the instance variable <em>name</em>?</p>
<p>There are 2 options:</p>
<blockquote>
<ul>
<li><p class="first">look at the corresponding Job Configuration File.</p>
<p><tt class="docutils literal"><span class="pre">/etc/init/network-interface-security.conf</span></tt> in this example.</p>
</li>
<li><p class="first">Use a trick to get Upstart to tell you the name:</p>
<pre class="literal-block">$ status network-interface-security
status: Unknown parameter: JOB
</pre>
<p>This shows us the name of the instance variable is "<tt class="docutils literal">JOB</tt>".</p>
</li>
</ul>
</blockquote>
<p>We are now in a position to stop a particular instance of this job:</p>
<pre class="literal-block"># stop network-interface-security JOB=network-interface/eth0
network-interface-security stop/waiting
</pre>
<p>The job instance has now been stopped. To prove it:</p>
<pre class="literal-block"># status network-interface-security JOB=network-interface/eth0
status: Unknown instance: network-interface/eth0
# initctl list | grep ^network-interface-security | grep network-interface/eth0
#
</pre>
</div>
<div class="section" id="logging-boot-and-shutdown-times">
<h2><a class="toc-backref" href="index.html#toc-entry-339">11.60&nbsp;&nbsp;&nbsp;Logging Boot and Shutdown Times</a></h2>
<p>If you want to create a log of when your system starts and stops, you
could do something like this:</p>
<pre class="literal-block">start on filesystem or runlevel [06]

env log=/var/log/boot-times.log

script
  action=$(echo "$UPSTART_EVENTS" | grep -q filesystem &amp;&amp; echo boot || echo shutdown)
  echo "`date`: $action" &gt;&gt; $log
end script
</pre>
<p>Note that you do <em>not</em> need to specify a <a class="reference internal" href="index.html#stop-on">stop on</a> condition: you want
this job to <em>start</em> both "around" the time of system startup (when the
disks are writeable, hence the use of the <tt class="docutils literal">filesystem</tt> event) and
shutdown.</p>
<p>If you want a more accurate method, you would need to have a job start
on <a class="reference internal" href="index.html#startup">startup</a>. The slight issue here is that when Upstart emits that
first event, there is no guarantee of writeable disks. However, this can
be overcome using a bit of thought...</p>
<p>First, create a "<tt class="docutils literal"><span class="pre">record-boot-time.conf</span></tt>" job configuration file to
record the time of the "boot" (initial Upstart event):</p>
<pre class="literal-block">start on startup

exec initctl emit boot-time TIME=$(date '+%s')
</pre>
<p>This job emits an event containing a variable specifying the time in
seconds since the Epoch.</p>
<p>Now, create a second "<tt class="docutils literal"><span class="pre">log-boot-time.conf</span></tt>" job configuration file to
actually log the boot time:</p>
<pre class="literal-block">start on boot-time and filesystem

log=/var/log/boot-times.log

script
  echo "system booted at $TIME" &gt;&gt;$log
end script
</pre>
<p>Since the "<tt class="docutils literal"><span class="pre">log-boot-time</span></tt>" job specifies the "<tt class="docutils literal">booted</tt>" event
emitted by the "<tt class="docutils literal"><span class="pre">record-boot-time</span></tt>" job, Upstart will retain knowledge
of this event until it is able to run the second job. The
"<tt class="docutils literal"><span class="pre">record-boot-time</span></tt>" job can then simply make use of the "<tt class="docutils literal">TIME</tt>"
variable set by the first job.</p>
</div>
<div class="section" id="running-an-alternative-job-on-a-tty">
<h2><a class="toc-backref" href="index.html#toc-entry-340">11.61&nbsp;&nbsp;&nbsp;Running an Alternative Job on a tty</a></h2>
<p>Here's a silly example of how to run a custom job on a particular tty. It asks
the user to guess a random number. If after 3 attempts they fail to guess the
correct number, the job ends. However, if they guess successfully, the are
allowed to login. This won't win any scripting competitions, but you get the
idea.</p>
<p>WARNING - <em>DO NOT USE THIS ON A REAL SYSTEM</em> unless you want to get hacked, or
fired or both!:</p>
<pre class="literal-block"># Get the user to guess the number. If they get it right, let them
# login.

start on runlevel [23]
stop on runlevel [!23]

env tty=tty9

# XXX: Ensure job is connected to the terminal device
console output

script
  # XXX: Ensure all standard streams are connected to the console
  exec 0&lt;/dev/$tty &gt;/dev/$tty 2&gt;&amp;1
  clear
  trap '' INT TERM HUP
  RANDOM=$(dd if=/dev/urandom count=1 2&gt;/dev/null|cksum|cut -f1 -d' ')
  answer=$(((RANDOM % 100) + 1))
  attempt=0
  max=3
  got=0

  while [ $attempt -lt $max ]
  do
    attempt=$((attempt+1))
    echo -n "Guess the number (1-100, attempt $attempt of $max): "
    read guess
    if [ "$guess" -eq "$answer" ]
    then
      got=1
      break
    else
      echo "Wrong"
    fi
  done

  [ "$got" = 0 ] &amp;&amp; stop

  exec /sbin/getty -8 38400 $tty
end script
</pre>
<p>The important lines are:</p>
<pre class="literal-block">console output
</pre>
<p>... and:</p>
<pre class="literal-block">exec 0&lt;/dev/$tty &gt;/dev/$tty 2&gt;&amp;1
</pre>
</div>
<div class="section" id="delay-respawn-of-a-job">
<h2><a class="toc-backref" href="index.html#toc-entry-341">11.62&nbsp;&nbsp;&nbsp;Delay Respawn of a Job</a></h2>
<p>If a job specifies <a class="reference internal" href="index.html#respawn">respawn</a>, but you want to delay the respawn for
some reason, simply use a <a class="reference internal" href="index.html#post-stop">post-stop</a> stanza:</p>
<pre class="literal-block">respawn
exec mydaemon
post-stop exec sleep 10
</pre>
<p>Now, every time <tt class="docutils literal">mydaemon</tt> exits with a non-zero return code, the job
will sleep for 10 seconds before Upstart restarts it.</p>
<p>For a real service, you would probably use a <a class="reference internal" href="index.html#post-stop">post-stop</a> script stanza
to perform a check rather than simply sleeping.</p>
</div>
<div class="section" id="allow-a-job-to-detect-if-it-was-stopped-manually">
<h2><a class="toc-backref" href="index.html#toc-entry-342">11.63&nbsp;&nbsp;&nbsp;Allow a job to detect if it was stopped manually</a></h2>
<p>A job can detect if it itself was stopped manually by an administrator
job using the <a class="reference internal" href="index.html#stop">stop</a> command, by virtue of the fact that the
<tt class="docutils literal">$UPSTART_EVENTS</tt> environment variable will not be set in the jobs
environment (since no <em>event</em> caused the job to stop - an administrator
intervened).</p>
<p>See <a class="reference internal" href="index.html#standard-environment-variables">Standard Environment Variables</a> for details of environment
variables Upstart sets.</p>
</div>
<div class="section" id="detect-if-a-job-stopped-before-reaching-its-respawn-limit">
<h2><a class="toc-backref" href="index.html#toc-entry-343">11.64&nbsp;&nbsp;&nbsp;Detect if a job stopped before reaching its respawn limit</a></h2>
<p>In this scenario, assuming the job actually specifies the <a class="reference internal" href="index.html#respawn">respawn</a>
stanza, the <tt class="docutils literal">$PROCESS</tt> variable of the <cite>stopping`</cite> event (see
<a class="reference internal" href="index.html#event">Event</a>) will be set to a value other than <tt class="docutils literal">respawn</tt> - it will be set
to the name of the particular job process type (<tt class="docutils literal"><span class="pre">pre-start</span></tt>, <tt class="docutils literal">main</tt>,
<tt class="docutils literal"><span class="pre">post-stop</span></tt>, <em>et cetera</em>) that failed.</p>
<p>Upstart will then automatically restart the job.</p>
<p>To create a job that reacts to a job stopping before it reaches its
respawn limit:</p>
<pre class="literal-block">start on stopped PROCESS!=respawn

script

  # Exit if $JOB has not specified the respawn stanza.
  # Unfortunately, Upstart does not provide a good way to do this
  # aside from using grep on the job file to look for the stanza.
  #
  egrep "^ *\&lt;respawn\&gt; *$" /etc/init/${JOB}.conf &amp;&amp; exit 0 || true

  echo "respawn job '$JOB' (instance '$INSTANCE') will be restarted"

end script
</pre>
<p>See:</p>
<ul class="simple">
<li><a class="reference internal" href="index.html#standard-environment-variables">Standard Environment Variables</a> for details of environment variables
Upstart sets.</li>
<li><a class="reference internal" href="index.html#stopping-a-job">Stopping a Job</a>.</li>
</ul>
</div>
<div class="section" id="detecting-a-job-respawning">
<h2><a class="toc-backref" href="index.html#toc-entry-344">11.65&nbsp;&nbsp;&nbsp;Detecting a job respawning</a></h2>
<p>See <a class="reference internal" href="index.html#detect-if-a-job-stopped-before-reaching-its-respawn-limit">Detect if a job stopped before reaching its respawn limit</a>.</p>
</div>
<div class="section" id="detecting-a-job-hitting-its-respawn-limit">
<h2><a class="toc-backref" href="index.html#toc-entry-345">11.66&nbsp;&nbsp;&nbsp;Detecting a job hitting its respawn limit</a></h2>
<p>To create a watchdog job that can react to jobs which hit their respawn
limit:</p>
<pre class="literal-block">start on stopped RESULT="failed" PROCESS="respawn"

exec echo "ERROR: `date`: job '$JOB' (instance '$INSTANCE') hit respawn limit"
</pre>
<p>Note that unlike the job in <a class="reference internal" href="index.html#detect-if-a-job-stopped-before-reaching-its-respawn-limit">Detect if a job stopped before reaching its
respawn limit</a>, we don't need to check for the <a class="reference internal" href="index.html#respawn">respawn</a> stanza since
Upstart only sets <tt class="docutils literal"><span class="pre">PROCESS="respawn"</span></tt> value for a job that has
specified the <tt class="docutils literal">respawn</tt>.</p>
<p>Rather than just logging an error, the job could take any number of
actions. For example, it could log a error, then manually restart the
job, setting an extra variable so that the job itself could detect that
it had failed and possibly fall back to some other configuration:</p>
<pre class="literal-block">script

  exec echo "ERROR: `date`: job '$JOB' (instance '$INSTANCE') hit respawn limit - restarting"

  start "$JOB" RESTARTED_BY_WATCHDOG=1 || true

end script
</pre>
</div>
<div class="section" id="identifying-jobs-that-may-need-a-respawn-stanza">
<h2><a class="toc-backref" href="index.html#toc-entry-346">11.67&nbsp;&nbsp;&nbsp;Identifying jobs that may need a respawn stanza</a></h2>
<p>By default, Upstart will <em>not</em> respawn a job - you need to specify the
<a class="reference internal" href="index.html#respawn">respawn</a> stanza.</p>
<p>But, is there a way to determine whether you <em>should</em> add the
<a class="reference internal" href="index.html#respawn">respawn</a> stanza to a job?</p>
<p>There are 2 main reasons for using the <a class="reference internal" href="index.html#respawn">respawn</a> stanza:</p>
<ul>
<li><p class="first">To handle jobs that legitimately exit and need to be restared.</p>
<p>A good example of this category of jobs is getty. See
<tt class="docutils literal">/etc/init/tty1.conf</tt> on an Ubuntu system for an example.</p>
</li>
<li><p class="first">To handle buggy applications / daemons</p>
<p>Using respawn for this class of jobs may be a practical solution but
must be seen as a temporary plaster / bandaid over a gaping wound -
the cause of the crashes should be identified and the code fixed.</p>
</li>
</ul>
<p>That said, to highlight jobs that could benefit from the addition of
the <a class="reference internal" href="index.html#respawn">respawn</a> stanza, you could create a watcher job that specifies:</p>
<pre class="literal-block">start on stopped RESULT=failed PROCESS!=respawn

script
  # ignore jobs that already specify respawn
  egrep "^ *\&lt;respawn\&gt; *$" /etc/init/${JOB}.conf &amp;&amp; exit 0 || true

  echo "job '$JOB' may benefit from adding 'respawn'"

end script
</pre>
<p>Then, review the results and determine if it is appropriate to either
fix the code or add <a class="reference internal" href="index.html#respawn">respawn</a> (possibly temorarily).</p>
</div>
<div class="section" id="creating-a-systemv-service-that-communicates-with-upstart-ubuntu-specific">
<h2><a class="toc-backref" href="index.html#toc-entry-347">11.68&nbsp;&nbsp;&nbsp;Creating a SystemV Service that Communicates with Upstart <img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719"></a></h2>
<p>There are occasions when you want to have a SystemV service start an
Upstart job. However, you must take care as shown in the example
below...</p>
<p>Image we create a SysV service as <tt class="docutils literal">/etc/init.d/myservice</tt>. This service
needs another service to be running but that other service is actually
an Upstart job (<tt class="docutils literal">/etc/init/myjob.conf</tt>).</p>
<p>The Upstart job specifies a <a class="reference internal" href="index.html#start-on">start on</a> condition of:</p>
<pre class="literal-block">start on filesystem and static-network-up and myservice-server-running
</pre>
<p>So, job <tt class="docutils literal">myjob</tt> will only start once all three of the events specified
are emitted and the <tt class="docutils literal"><span class="pre">myservice-server-running</span></tt> event is being emitted by
<tt class="docutils literal">/etc/init.d/myservice</tt> like this:</p>
<pre class="literal-block">initctl emit myservice-server-running
</pre>
<p>This all looks perfectly reasonable and in fact it is... generally.</p>
<p>However, consider what would happen if the package containing
<tt class="docutils literal">/etc/init.d/myservice</tt> happened to attempt to restart that service
having installed it (to make sure it is running immediately after installation)...</p>
<blockquote>
<ol class="arabic simple">
<li><tt class="docutils literal">/etc/init.d/myservice</tt> is run.</li>
<li><tt class="docutils literal">/etc/init.d/myservice</tt> calls "<tt class="docutils literal">initctl emit <span class="pre">myservice-server-running</span></tt>".</li>
<li>Upstart emits the <tt class="docutils literal"><span class="pre">myservice-server-running</span></tt> event.</li>
</ol>
</blockquote>
<p>Nothing magical here yet. Or is there? Since job <tt class="docutils literal">myjob</tt> will only be
started when all three of the events specified in its <a class="reference internal" href="index.html#start-on">start on</a>
condition are true, this job cannot yet be started. Why? Because the
<tt class="docutils literal">filesystem</tt> and <tt class="docutils literal"><span class="pre">static-network-up</span></tt> events have <em>already</em> been
emitted early in the boot (see
<a class="reference internal" href="index.html#ubuntu-well-known-events-ubuntu-specific">Ubuntu Well-Known Events (ubuntu-specific)</a>).</p>
<p>What this means is that the job <tt class="docutils literal">myjob</tt> will <em>never</em> start <em>post boot</em>
if those two events it cares about <em>have already been emitted</em>. Any yet,
the SysV job and the Upstart event combinations are perfectly valid <em>on
boot</em>. Note too that because those two events will not be re-emitted,
the <a class="reference internal" href="index.html#initctl-emit">initctl emit</a> will block (appear to hang) since Upstart is waiting
for those two events to be emitted.</p>
<p>The solution to this is very simple: make the SysV job only emit the
event in question <em>on boot</em>:</p>
<pre class="literal-block"># Only emit the event 'on boot' to ensure the SysV service
# does not "hang" (block) due to events the ``myjob`` job requires
# never being re-emitted post-boot. We do this by checking for one of
# Upstarts  standard environment variables which will only be run when
# the Upstart SysV compatibility system is running the SysV service in
# question.
[ -n "$UPSTART_JOB" ] &amp;&amp; initctl emit myservice-server-running
</pre>
<p>A slightly different method is to emit a signal by running
<a class="reference internal" href="index.html#initctl">initctl</a> with the <tt class="docutils literal"><span class="pre">--no-wait</span></tt> option like this:</p>
<pre class="literal-block">[ -n "$UPSTART_JOB" ] &amp;&amp; initctl emit --no-wait myservice-server-running
</pre>
<p>See <a class="reference internal" href="index.html#signals">Signals</a> and <a class="reference internal" href="index.html#standard-environment-variables">Standard Environment Variables</a>.</p>
</div>
<div class="section" id="running-a-job-in-a-cgroup-ubuntu-specific">
<h2><a class="toc-backref" href="index.html#toc-entry-348">11.69&nbsp;&nbsp;&nbsp;Running a job in a cgroup <img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719"></a></h2>
<p>As of Upstart 1.13, cgroups are supported. See <a class="reference internal" href="index.html#cgroup">cgroup</a>.</p>
<p>For older versions of Upstart in versions of <a class="reference external" href="http://www.ubuntu.com/">Ubuntu</a> from Trusty onwards, you can make use of
the provided Cgroup management daemon called <tt class="docutils literal">cgmanager</tt> (available
in a package of the same name). Upstart job processes can be
cgroup-contained by making use of the <tt class="docutils literal">cgm(1)</tt> utility available in the
<tt class="docutils literal"><span class="pre">cgmanager-utils</span></tt> package.  Note that <em>each job process that needs to
be cgroup-contained need to call ``cgm`` appropriately</em>.</p>
<p>Examples:</p>
<ul>
<li><p class="first">To run <em>just</em> the <tt class="docutils literal">main</tt> (<a class="reference internal" href="index.html#exec">exec</a> or <a class="reference internal" href="index.html#script">script</a>) job process in an existing cgroup:</p>
<pre class="literal-block">start on ...

script
  cgm movepid cpu an-existing-group $$
  exec myprog --arg1 "foo"
end script
</pre>
</li>
<li><p class="first">To run the <a class="reference internal" href="index.html#pre-start">pre-start</a>, <tt class="docutils literal">main</tt> and <a class="reference internal" href="index.html#pre-stop">pre-stop</a> job processes in a new
memory cgroup with a modified memory limit:</p>
<pre class="literal-block">start on ...

env cgroup_name="foo"
env cgroup_controller="memory"

pre-start script
  cgm create "$cgroup_controller" "$cgroup_name"
  cgm setvalue "$cgroup_controller" "$cgroup_name" limit_in_bytes 52428800
  cgm movepid "$cgroup_controller" "$cgroup_name" $$

  # ...
end script

script
  cgm movepid "$cgroup_controller" "$cgroup_name" $$

  exec myprog --arg1 "foo"
end script

pre-stop script
  cgm movepid "$cgroup_controller" "$cgroup_name" $$

  # ...
end script
</pre>
</li>
</ul>
<p>See the <a class="reference external" href="http://manpages.ubuntu.com/manpages/trusty/en/man1/cgm.1.html">cgm(1)</a> manual page for further details.</p>
</div>
<div class="section" id="making-a-job-respawn-indefinitely">
<h2><a class="toc-backref" href="index.html#toc-entry-349">11.70&nbsp;&nbsp;&nbsp;Making a job respawn indefinitely</a></h2>
<p>See <a class="reference internal" href="index.html#respawn-limit">respawn limit</a>.</p>
</div>
</div>
<div class="section" id="test-your-knowledge">
<h1><a class="toc-backref" href="index.html#toc-entry-350">12&nbsp;&nbsp;&nbsp;Test Your Knowledge</a></h1>
<div class="section" id="questions-about-start-on">
<h2><a class="toc-backref" href="index.html#toc-entry-351">12.1&nbsp;&nbsp;&nbsp;Questions about <cite>start on</cite></a></h2>
<p>Consider the following <a class="reference internal" href="index.html#start-on">start on</a> condition:</p>
<pre class="literal-block">start on startup or starting stopped or stopping started
</pre>
<p>Questions (answers provided in footnote links):</p>
<table class="docutils field-list" frame="void" rules="none">
<colgroup><col class="field-name">
<col class="field-body">
</colgroup><tbody valign="top">
<tr class="field"><th class="field-name">Question:</th><td class="field-body">Is this a legal condition?</td>
</tr>
<tr class="field"><th class="field-name">Answer:</th><td class="field-body"><a class="footnote-reference" href="index.html#test-question-1" id="footnote-reference-24">[1]</a></td>
</tr>
<tr class="field"><th class="field-name">Question:</th><td class="field-body">What standard Upstart tool could you use to help explain the expression?</td>
</tr>
<tr class="field"><th class="field-name">Answer:</th><td class="field-body"><a class="footnote-reference" href="index.html#test-question-2" id="footnote-reference-25">[2]</a></td>
</tr>
<tr class="field"><th class="field-name">Question:</th><td class="field-body">Explain the condition.</td>
</tr>
<tr class="field"><th class="field-name">Answer:</th><td class="field-body"><a class="footnote-reference" href="index.html#test-question-3" id="footnote-reference-26">[3]</a></td>
</tr>
<tr class="field"><th class="field-name">Question:</th><td class="field-body">How many times could this job be run assuming all other jobs
on the system run exactly once?</td>
</tr>
<tr class="field"><th class="field-name">Answer:</th><td class="field-body"><a class="footnote-reference" href="index.html#test-question-4" id="footnote-reference-27">[4]</a></td>
</tr>
</tbody>
</table>
<p>Consider this <a class="reference internal" href="index.html#start-on">start on</a> condition:</p>
<pre class="literal-block">start on not foo
</pre>
<table class="docutils field-list" frame="void" rules="none">
<colgroup><col class="field-name">
<col class="field-body">
</colgroup><tbody valign="top">
<tr class="field"><th class="field-name">Question:</th><td class="field-body">Is this a legal condition?</td>
</tr>
<tr class="field"><th class="field-name">Answer:</th><td class="field-body"><a class="footnote-reference" href="index.html#test-question-5" id="footnote-reference-28">[5]</a></td>
</tr>
<tr class="field"><th class="field-name">Question:</th><td class="field-body">What event will cause the job to start?</td>
</tr>
<tr class="field"><th class="field-name">Answer:</th><td class="field-body"><a class="footnote-reference" href="index.html#test-question-6" id="footnote-reference-29">[6]</a></td>
</tr>
<tr class="field"><th class="field-name">Question:</th><td class="field-body">What is <tt class="docutils literal">foo</tt> in this context?</td>
</tr>
<tr class="field"><th class="field-name">Answer:</th><td class="field-body"><a class="footnote-reference" href="index.html#test-question-7" id="footnote-reference-30">[7]</a></td>
</tr>
<tr class="field"><th class="field-name">Question:</th><td class="field-body">How could you trigger this job to run using <a class="reference internal" href="index.html#initctl-emit">initctl emit</a>?</td>
</tr>
<tr class="field"><th class="field-name">Answer:</th><td class="field-body"><a class="footnote-reference" href="index.html#test-question-8" id="footnote-reference-31">[8]</a></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="general-questions">
<h2><a class="toc-backref" href="index.html#toc-entry-352">12.2&nbsp;&nbsp;&nbsp;General Questions</a></h2>
<p>What is wrong with the following job configuration file?:</p>
<pre class="literal-block">start on startup

script
  echo hello &gt; /tmp/foo.log
end script
</pre>
<p>Answer: <a class="footnote-reference" href="index.html#test-question-9" id="footnote-reference-32">[9]</a></p>
<p>What is wrong with the following job configuration file?:</p>
<pre class="literal-block">start on runlevel [2345]

env CONFIG=/etc/default/myapp

expect fork
respawn

script
  enabled=$(grep ENABLED=1 $CONFIG)
  [ -z "$enabled" ] &amp;&amp; exit 0
  /usr/bin/myapp
end script
</pre>
<p>Answer: <a class="footnote-reference" href="index.html#test-question-10" id="footnote-reference-33">[10]</a></p>
</div>
</div>
<div class="section" id="common-problems">
<h1><a class="toc-backref" href="index.html#toc-entry-353">13&nbsp;&nbsp;&nbsp;Common Problems</a></h1>
<div class="section" id="cannot-start-a-job">
<h2><a class="toc-backref" href="index.html#toc-entry-354">13.1&nbsp;&nbsp;&nbsp;Cannot Start a Job</a></h2>
<p>If you have just created or modified a job configuration file such as
<tt class="docutils literal">/etc/init/myjob.conf</tt>, but <tt class="docutils literal">start</tt> gives the following error when
you attempt to start it:</p>
<pre class="literal-block">start: Unknown job: myjob
</pre>
<p>The likelihood is that the file contains a syntax error. The easiest way
to establish if this is true is by running the <a class="reference internal" href="index.html#init-checkconf">init-checkconf</a> command.</p>
<p>If you are wondering why the original error couldn't be more helpful, it
is important to remember that the job control commands (<tt class="docutils literal">start</tt>,
<tt class="docutils literal">stop</tt> and <tt class="docutils literal">restart</tt>) and <tt class="docutils literal">initctl</tt> communicate with Upstart over
<a class="reference external" href="http://dbus.freedesktop.org/">D-Bus</a>. The problem here is that Upstart rejected the invalid
<tt class="docutils literal">myjob.conf</tt>, so attempting to control that job over <a class="reference external" href="http://dbus.freedesktop.org/">D-Bus</a> is
nonsensical - the job does not exist.</p>
</div>
<div class="section" id="cannot-stop-a-job">
<h2><a class="toc-backref" href="index.html#toc-entry-355">13.2&nbsp;&nbsp;&nbsp;Cannot stop a job</a></h2>
<p>If <a class="reference internal" href="index.html#start">start</a> is hanging or seems to be behaving oddly, the chances are you have
misspecified the <a class="reference internal" href="index.html#expect">expect</a> stanza. See <a class="reference internal" href="index.html#expect">expect</a> and <a class="reference internal" href="index.html#how-to-establish-fork-count">How to Establish Fork
Count</a>.</p>
</div>
<div class="section" id="strange-error-when-running-start-stop-restart-or-initctl-emit">
<h2><a class="toc-backref" href="index.html#toc-entry-356">13.3&nbsp;&nbsp;&nbsp;Strange Error When Running <tt class="docutils literal">start</tt>/<tt class="docutils literal">stop</tt>/<tt class="docutils literal">restart</tt> or <tt class="docutils literal">initctl emit</tt></a></h2>
<p>If you attempt to run a job command, or emit an event and you get a
<a class="reference external" href="http://dbus.freedesktop.org/">D-Bus</a> error like this:</p>
<pre class="literal-block">$ start myjob
start: Rejected send message, 1 matched rules; type="method_call", sender=":1.58" (uid=1000 pid=5696 comm="start) interface="com.ubuntu.Upstart0_6.Job" member="Start" error name="(unset)" requested_reply=0 destination="com.ubuntu.Upstart" (uid=0 pid=1 comm="/sbin/init"))
</pre>
<p>The problem is caused by not running the command as <tt class="docutils literal">root</tt>. To
resolve it, either "<tt class="docutils literal">su -</tt>" to <tt class="docutils literal">root</tt> or use a facility such as
<a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/sudo.8.html">sudo(8)</a>:</p>
<pre class="literal-block"># start myjob
myjob start/running, process 1234
</pre>
<p>The reason for the very cryptic error is that the job control commands
(<tt class="docutils literal">start</tt>, <tt class="docutils literal">stop</tt> and <tt class="docutils literal">restart</tt>) and <tt class="docutils literal">initctl</tt> communicate with
Upstart over <a class="reference external" href="http://dbus.freedesktop.org/">D-Bus</a>.</p>
</div>
<div class="section" id="the-initctl-command-shows-the-wrong-pid">
<h2><a class="toc-backref" href="index.html#toc-entry-357">13.4&nbsp;&nbsp;&nbsp;The <tt class="docutils literal">initctl</tt> command shows "the wrong PID"</a></h2>
<p>The likelihood is that you have mis-specified the type of application
you are running in the job configuration file. Since Upstart traces or
follows <a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/fork.2.html">fork(2)</a> calls, it needs to know how many forks to expect. If
your application forks <em>once</em>, specify the following in the job
configuration file:</p>
<pre class="literal-block">expect fork
</pre>
<p>However, if your application forks <em>twice</em> (which all daemon processes
<em>should</em> do), specify:</p>
<pre class="literal-block">expect daemon
</pre>
<p>See also <a class="reference internal" href="index.html#alternative-method">Alternative Method</a>.</p>
</div>
<div class="section" id="symbolic-links-don-t-work-in-etc-init">
<h2><a class="toc-backref" href="index.html#toc-entry-358">13.5&nbsp;&nbsp;&nbsp;Symbolic Links don't work in <tt class="docutils literal">/etc/init</tt></a></h2>
<p><a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> does not monitor files which are symbolic links since it needs
to be able to guarantee behaviour and if a link is broken or cannot be
followed (it might refer to a filesystem that hasn't yet been mounted
for example), behaviour would be unexpected, and thus undesirable. As
such, all system job configuration files must live in or below
<tt class="docutils literal">/etc/init</tt> (although user jobs can live in other locations).</p>
</div>
<div class="section" id="sometimes-status-shows-pid-but-other-times-does-not">
<h2><a class="toc-backref" href="index.html#toc-entry-359">13.6&nbsp;&nbsp;&nbsp;Sometimes <tt class="docutils literal">status</tt> shows PID, but other times does not</a></h2>
<p>You may have noticed that when you start certain jobs manually using
<a class="reference internal" href="index.html#start">start</a>, sometimes the output will show the PID of the process
associated with that job. However, other times, no PID is shown. Why?</p>
<p>This behaviour is observed when the job runs to completion very quickly.
If your system has minimal load the job will start <em>and finish</em> before
the <a class="reference internal" href="index.html#initctl-status">initctl status</a> command has a chance to query its PID from
Upstart. Whereas if your system is busy you may well see a PID displayed
since Upstart was able to return the PID details to <tt class="docutils literal">status</tt> before the
job finished.</p>
<p>The behaviour is similar to the following shell code:</p>
<pre class="literal-block">(sleep 0.01 &amp;) ; ps -fU $USER | grep sleep | grep -v grep
</pre>
<p>It is unlikely that you will get any output from this command (since the
<tt class="docutils literal">sleep 0.01</tt> command will run to completion before the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/grep.1.html">grep(1)</a> calls
get a chance filter the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/ps.1.html">ps(1)</a> output. However, change the time for
that subshell to run, and you will see the PID:</p>
<pre class="literal-block">(sleep 5 &amp;) ; ps -fU $USER | grep sleep | grep -v grep
</pre>
<p>See <a class="reference internal" href="index.html#initctl-status">initctl status</a>.</p>
</div>
</div>
<div class="section" id="upstart-in-debian-and-ubuntu-debian-and-ubuntu-specific">
<h1><a class="toc-backref" href="index.html#toc-entry-360">14&nbsp;&nbsp;&nbsp;Upstart in Debian and Ubuntu (<img alt="D" class="debian-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/4926319605052bdf09442836fd8d799b236e5db8"> , <img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719">)</a></h1>
<div class="section" id="packaging">
<h2><a class="toc-backref" href="index.html#toc-entry-361">14.1&nbsp;&nbsp;&nbsp;Packaging</a></h2>
<p>Simply create you <a class="reference internal" href="index.html#job-configuration-file">Job Configuration File</a> in the package but rather
than having the file end with <tt class="docutils literal">.conf</tt>, ensure the suffix is
<tt class="docutils literal">.upstart</tt> such as:</p>
<pre class="literal-block">debian/$package.upstart
</pre>
<p><a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/debhelper.html">debhelper(7)</a> will then automatically install this job as
<tt class="docutils literal"><span class="pre">/etc/init/${package}.conf</span></tt>.</p>
<p>As long as you do not override <tt class="docutils literal">dh_install</tt>
(<tt class="docutils literal">override_dh_install</tt> or <tt class="docutils literal">override_dh_auto_install</tt> in
<tt class="docutils literal">debian/rules</tt>), this will "just work" as <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/debhelper.html">debhelper(7)</a> will
automatically invoke <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/dh_installinit.html">dh_installinit(1)</a> for you.</p>
<p>If you <em>do</em> override <tt class="docutils literal">dh_install</tt>, ensure you invoke
<tt class="docutils literal">dh_installinit</tt> in <tt class="docutils literal">debian/rules</tt>.</p>
<ul class="simple">
<li><a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/service.html">service(8)</a> just "does the right thing".</li>
<li><a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/update-rc.d.html">update-rc.d(8)</a> just "does the right thing".</li>
<li><a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/invoke-rc.d.html">invoke-rc.d(8)</a> just "does the right thing".</li>
<li>Do <em>not</em> have your package call <tt class="docutils literal"><span class="pre">/etc/init.d/${package}</span></tt> directly
since:<ul>
<li>it is not necessary.</li>
<li>it assumes a particular init system.</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="system-v-compatibility-link-debian-and-ubuntu-specific">
<h2><a class="toc-backref" href="index.html#toc-entry-362">14.2&nbsp;&nbsp;&nbsp;System V Compatibility Link (<img alt="D" class="debian-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/4926319605052bdf09442836fd8d799b236e5db8"> , <img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719">)</a></h2>
<p>Upstart in <a class="reference external" href="http://www.debian.org/">Debian</a> and <a class="reference external" href="http://www.ubuntu.com/">Ubuntu</a> ships with a
<tt class="docutils literal"><span class="pre">/lib/init/upstart-job</span></tt> helper script which allows an existing Upstart
job to be controlled by the legacy SystemV commands (such as
<a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/service.html">service(8)</a>).</p>
<p>In <a class="reference external" href="http://www.debian.org/">Debian</a> Jessie and <a class="reference external" href="http://www.ubuntu.com/">Ubuntu</a> Saucy (13.10), symlinks to <tt class="docutils literal"><span class="pre">upstart-job</span></tt>
are no longer required. Instead update-rc.d and friends were updated to
cope with upstart jobs (See <a class="reference external" href="https://wiki.ubuntu.com/UpstartCompatibleInitScripts">Upstart Compatible Init Scripts</a>).</p>
</div>
<div class="section" id="fun-with-job-files-debian-and-ubuntu-specific">
<h2><a class="toc-backref" href="index.html#toc-entry-363">14.3&nbsp;&nbsp;&nbsp;Fun with Job Files (<img alt="D" class="debian-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/4926319605052bdf09442836fd8d799b236e5db8"> , <img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719">)</a></h2>
<div class="section" id="identify-missing-system-jobs-debian-and-ubuntu-specific">
<h3><a class="toc-backref" href="index.html#toc-entry-364">14.3.1&nbsp;&nbsp;&nbsp;Identify Missing System Jobs (<img alt="D" class="debian-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/4926319605052bdf09442836fd8d799b236e5db8"> , <img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719">)</a></h3>
<p>If somebody inadvertently deleted a job file, here's one way to establish
which ones:</p>
<pre class="literal-block">dpkg -l | grep ^ii | awk '{print $2}' | xargs dpkg -s | grep '^ /' |\
    awk '{print $1}' | grep "^/etc/init/" | while read file
    do
        [ ! -f "$file" ] &amp;&amp; echo "job '$file' missing"
    done
</pre>
<p>It prints a list of missing job files, one per line.</p>
</div>
<div class="section" id="identify-modified-system-jobs-debian-and-ubuntu-specific">
<h3><a class="toc-backref" href="index.html#toc-entry-365">14.3.2&nbsp;&nbsp;&nbsp;Identify Modified System Jobs (<img alt="D" class="debian-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/4926319605052bdf09442836fd8d799b236e5db8"> , <img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719">)</a></h3>
<p>To find out if any job files have been modified from their "pristine"
installed state, run this:</p>
<pre class="literal-block">dpkg-query -W -f='${Conffiles}\n' '*' | grep "^ /etc/init/" |\
    awk 'OFS=" "{print $2,$1}' | md5sum -c 2&gt;/dev/null |\
    awk -F': ' '$2 !~ /OK/ {print $1}'
</pre>
<p>The script above prints the full path to all modified job files, one per
line. In fact, it will print missing files as well as modified files.</p>
</div>
<div class="section" id="identify-non-packaged-system-jobs-debian-and-ubuntu-specific">
<h3><a class="toc-backref" href="index.html#toc-entry-366">14.3.3&nbsp;&nbsp;&nbsp;Identify Non-Packaged System Jobs (<img alt="D" class="debian-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/4926319605052bdf09442836fd8d799b236e5db8"> , <img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719">)</a></h3>
<p>To get a list of jobs that were created manually (in other words are not
part of official packages), run:</p>
<pre class="literal-block"># First, get a list of all Upstart jobs in all packages installed on
# your system, and write it to a data file.
dpkg-query -W -f='${Conffiles}\n' '*' | grep "^ /etc/init/" |\
    awk '{print $1}' | sed 's!/etc/init/!!g' &gt; /tmp/upstart.dat

# Now list all jobs *NOT* in the data file from above
ls /etc/init/*.conf | sed 's!^/etc/init/!!g' |\
while read file
do
    grep -q "^${file}$" /tmp/upstart.dat || echo "/etc/init/$file"
done
</pre>
</div>
<div class="section" id="re-install-all-packages-with-missing-or-modified-system-job-files-debian-and-ubuntu-specific">
<h3><a class="toc-backref" href="index.html#toc-entry-367">14.3.4&nbsp;&nbsp;&nbsp;Re-install all Packages with Missing or Modified System Job Files (<img alt="D" class="debian-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/4926319605052bdf09442836fd8d799b236e5db8"> , <img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719">)</a></h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Before trying this, make sure you understand the implications and
that <em>you have a full system backup</em>!!</p>
</div>
<p>To forcibly re-install all packages which have either had their job
files deleted or modified in some way, run the following to get back to
a "pristine" state:</p>
<pre class="literal-block"># Install required helper application
$ sudo apt-get install -y apt-file

# Get a list of modified or missing files
$ dpkg-query -W -f='${Conffiles}\n' '*' | grep /etc/init/ |\
    awk 'OFS=" "{print $2,$1}' | md5sum -c 2&gt;/dev/null |\
    awk -F': ' '$2 !~ /OK/{print $1}' &gt; /tmp/upstart.dat

$ cat /tmp/upstart.dat | while read file
    do
        pkg=$(apt-file search -x "^${file}$" | cut -d: -f1)
        [ -n "$pkg" ] &amp;&amp; echo "$pkg" &gt;&gt; /tmp/packages.dat
    done

# Remove any duplicates
$ sort -u /tmp/packages.dat &gt; /tmp/packages.sorted

# Re-install
$ sudo apt-get -o Dpkg::Options::="--force-confmiss" install \
    --reinstall $(cat /tmp/packages.sorted)
</pre>
</div>
</div>
</div>
<div class="section" id="testing">
<h1><a class="toc-backref" href="index.html#toc-entry-368">15&nbsp;&nbsp;&nbsp;Testing</a></h1>
<p>Before embarking on rewriting your systems job configuration files,
think <em>very</em>, <strong>very</strong> carefully.</p>
<p>We would advise strongly that before you make your production server
unbootable that you consider the following advice:</p>
<ol class="arabic">
<li><p class="first">Version control any job configuration files you intend to change.</p>
<p>You could employ the <a class="reference internal" href="index.html#version">version</a> stanza to help in this regard.</p>
</li>
<li><p class="first">Test your changes in a Virtual Machine.</p>
</li>
<li><p class="first">Test your changes on a number of non-critical systems.</p>
</li>
<li><p class="first">Backup all your job configuration files to <em>both</em>:</p>
<ul>
<li><p class="first">An alternate location on the local system</p>
<p>(Allowing them to be recovered quickly if required).</p>
</li>
<li><p class="first">At least one other suitable alternate backup location.</p>
</li>
</ul>
</li>
</ol>
</div>
<div class="section" id="daemon-behaviour">
<h1><a class="toc-backref" href="index.html#toc-entry-369">16&nbsp;&nbsp;&nbsp;Daemon Behaviour</a></h1>
<p>Upstart manages the running of jobs. Most of these jobs are so-called
"daemons", or programs that:</p>
<ul class="simple">
<li>run detached from a terminal device.</li>
<li>require no user input.</li>
<li>generate no output to the standard output streams "<tt class="docutils literal">stdout"</tt> and
"<tt class="docutils literal">stderr</tt>".</li>
</ul>
<p>To manage such daemons, Upstart expects a daemon to adhere to the
following rules:</p>
<ul>
<li><p class="first">The daemon should advertise if it forks once, or if it double-forks.</p>
<p>This allows the Administrator to establish the correct value for the
important <a class="reference internal" href="index.html#expect">expect</a> stanza.</p>
</li>
<li><p class="first">The daemon should not install a <tt class="docutils literal">SIGCHLD</tt> handler of its own.</p>
<p>This is a problem when the job incorrectly specifies <a class="reference internal" href="index.html#expect-fork">expect fork</a>
for a daemon (that should have been specified as <a class="reference internal" href="index.html#expect-daemon">expect daemon</a>)
since Upstart waits for a single fork but the daemon double forks
however Upstart never gets notification of the first process exiting
since a <tt class="docutils literal">SIGCHLD</tt> signal is never generated for that process.</p>
<p>This leads to a "stuck job (see <a class="reference internal" href="index.html#implications-of-misspecifying-expect">Implications of Misspecifying
expect</a>).</p>
<p>this could stop Upstart from determining when the process has
finished if the <a class="reference internal" href="index.html#expect">expect</a> stanza is mis-specified as <a class="reference internal" href="index.html#expect-fork">expect fork</a>.</p>
</li>
<li><p class="first">The daemon should ensure that when it completes the second fork that
it is fully initialized, since Upstart uses the fork count to determine
service readiness (see <a class="reference internal" href="index.html#expect">expect</a>).</p>
</li>
<li><p class="first">When sent a <tt class="docutils literal">SIGHUP</tt> signal, Upstart will expect the daemon to:</p>
<ul>
<li><p class="first">do whatever is necessary to re-initialize itself, for example by
re-reading its configuration file.</p>
<p>This behaviour ensures that "<tt class="docutils literal">initctl reload &lt;job&gt;</tt>" will work as expected.</p>
</li>
<li><p class="first">retain its current PID: if the daemon calls <a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/fork.2.html">fork(2)</a> on receiving this
signal. See <a class="reference internal" href="index.html#expect">expect</a>.</p>
<p>This behaviour ensures that Upstart can continue to manage the PID.</p>
</li>
</ul>
</li>
<li><p class="first">When sent a <tt class="docutils literal">SIGTERM</tt> signal, Upstart expects the daemon to shut down cleanly.</p>
<p>If a daemon does not shut down on receipt of this signal in a timely fashion,
Upstart will send it the unblockable <tt class="docutils literal">SIGKILL</tt> signal.</p>
</li>
<li><p class="first">Signalling "readiness": Since Upstart tracks forks, it can only assume that
once the <em>final</em> <a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/fork.2.html">fork(2)</a> call has been made (as indicated by the <a class="reference internal" href="index.html#expect">expect</a>
stanza specification), that the job is "ready" to accept work from other parts
of the system.</p>
<p>This generally works very well, but can be an issue for daemons which start
relatively quickly, but which are not considered "ready" to service requests
until some arbitrary future time.</p>
<p>A good example of this scenario would be a database server which starts but
which can only be considered "ready" or "online" once it has finished
replaying some transaction logs (which take some time to process).
In this scenario, there are two approaches:</p>
<ol class="arabic simple">
<li>Create a <a class="reference internal" href="index.html#post-start">post-start</a> section that performs some check and only
returns once the service is "ready".</li>
<li>If the service accepts incoming network connections, modify it to make
use of the <a class="reference internal" href="index.html#upstart-socket-bridge">upstart-socket-bridge</a>.</li>
</ol>
</li>
<li><p class="first">The daemon should not make use of the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/ptrace.2.html">ptrace(2)</a> system call
(at least not until it has initialized itself fully).</p>
<p>This ensures that Upstart is able to track the daemons pid. See
<a class="reference internal" href="index.html#expect">expect</a>.</p>
</li>
</ul>
<p>The following are recommendations if you are writing a new daemon:</p>
<ul class="simple">
<li>If the daemon does not <em>need</em> to run as root, it should drop
its privilege level (using <a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/setuid.2.html">setuid(2)</a> and <a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/setgid.2.html">setgid(2)</a>).</li>
<li>If a daemon is able to drop its privilege level to any non-root user,
it should provide a documented way (such as command-line options) for
the invoker to specify the user and group to have the daemon
eventually run as.</li>
</ul>
</div>
<div class="section" id="precepts-for-creating-a-job-configuration-file">
<h1><a class="toc-backref" href="index.html#toc-entry-370">17&nbsp;&nbsp;&nbsp;Precepts for Creating a Job Configuration File</a></h1>
<div class="section" id="determining-the-value-of-expect">
<h2><a class="toc-backref" href="index.html#toc-entry-371">17.1&nbsp;&nbsp;&nbsp;Determining the value of <tt class="docutils literal">expect</tt></a></h2>
<p>The <a class="reference internal" href="index.html#expect">Expect</a> section explains how to determine the value of the
<tt class="docutils literal">expect</tt> stanza. Note that you <em>should not</em> introduce the <a class="reference internal" href="index.html#respawn">respawn</a>
stanza until you are fully satisfied you have specified the <a class="reference internal" href="index.html#expect">expect</a>
stanza correctly.</p>
</div>
<div class="section" id="start-on-and-stop-on-condition">
<h2><a class="toc-backref" href="index.html#toc-entry-372">17.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">start on</tt> and <tt class="docutils literal">stop on</tt> condition</a></h2>
<p>See <a class="reference internal" href="index.html#how-to-establish-a-jobs-start-on-and-stop-on-conditions">How to Establish a Jobs start on and stop on Conditions</a>.</p>
</div>
<div class="section" id="services">
<h2><a class="toc-backref" href="index.html#toc-entry-373">17.3&nbsp;&nbsp;&nbsp;Services</a></h2>
<ul>
<li><p class="first">If your job is a service, identify the correct value for the <a class="reference internal" href="index.html#expect">expect</a>
stanza.</p>
<p>Once you have decided on the correct value:</p>
<ol class="arabic">
<li><p class="first">start the job:</p>
<pre class="literal-block">$ sudo start myjob
</pre>
</li>
<li><p class="first">Check the PID of the job matches the expected PID:</p>
<pre class="literal-block">$ actual_pid=$(pidof myapp)
$ upstart_pid=$(status myjob | awk '{print $NF}')
$ [ "$actual_pid" = "$upstart_pid" ] || echo "ERROR: pid "
</pre>
</li>
<li><p class="first">Stop the job:</p>
<pre class="literal-block">$ sudo stop myjob
</pre>
</li>
<li><p class="first">Ensure the PID no longer exists:</p>
<pre class="literal-block">$ [ -z "$(pidof myapp)" ] || echo "ERROR: myapp still running"
</pre>
</li>
</ol>
</li>
<li><p class="first"><em>Only</em> once you have specified the correct <a class="reference internal" href="index.html#expect">expect</a> stanza should you
introduce the <a class="reference internal" href="index.html#respawn">respawn</a> stanza since if you introduce it at the
outset, this will just confuse your understanding, particularly if the
<a class="reference internal" href="index.html#expect">expect</a> stanza has been misspecified.</p>
</li>
</ul>
</div>
<div class="section" id="ubuntu-rules-ubuntu-specific">
<h2><a class="toc-backref" href="index.html#toc-entry-374">17.4&nbsp;&nbsp;&nbsp;Ubuntu Rules (<img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719">)</a></h2>
<p>On <a class="reference external" href="http://www.ubuntu.com/">Ubuntu</a>, the following rules should be adhered to:</p>
<div class="section" id="console-attributes">
<h3><a class="toc-backref" href="index.html#toc-entry-375">17.4.1&nbsp;&nbsp;&nbsp;Console attributes</a></h3>
<p>Jobs that specify <a class="reference internal" href="index.html#console-output">console output</a> or <a class="reference internal" href="index.html#console-owner">console owner</a>
should <strong>NOT</strong> modify the attributes of the console (<tt class="docutils literal">/dev/console</tt>), for
example by using <a class="reference external" href="http://manpages.ubuntu.com/manpages/man3/tcsetattr.3.html">tcsetattr(3)</a>.</p>
<p>The reason for this being that <a class="reference external" href="http://www.freedesktop.org/wiki/Software/Plymouth">Plymouth</a>, the graphical boot splash
application, needs full control over the console on boot and shutdown.</p>
</div>
</div>
</div>
<div class="section" id="debugging">
<h1><a class="toc-backref" href="index.html#toc-entry-376">18&nbsp;&nbsp;&nbsp;Debugging</a></h1>
<div class="section" id="obtaining-a-list-of-events">
<h2><a class="toc-backref" href="index.html#toc-entry-377">18.1&nbsp;&nbsp;&nbsp;Obtaining a List of Events</a></h2>
<p>To obtain a list of events that have been generated by your system, do
one of the following:</p>
<div class="section" id="add-verbose-or-debug-to-the-kernel-command-line">
<h3><a class="toc-backref" href="index.html#toc-entry-378">18.1.1&nbsp;&nbsp;&nbsp;Add <tt class="docutils literal"><span class="pre">--verbose</span></tt> or <tt class="docutils literal"><span class="pre">--debug</span></tt> to the kernel command-line</a></h3>
<p>By adding <tt class="docutils literal"><span class="pre">--verbose</span></tt> or <tt class="docutils literal"><span class="pre">--debug</span></tt> to the kernel command-line, you
inform Upstart to enter either verbose or debug mode. In these modes,
Upstart generates extra messages which can be viewed in the system log.
See <a class="reference internal" href="index.html#initctl-log-priority">initctl log-priority</a>.</p>
<p>Assuming an standard Ubuntu Natty system, you could view the output
like this:</p>
<pre class="literal-block">grep init: /var/log/syslog
</pre>
<p>Note that until Upstart 1.3 it was difficult to get a complete log of
events for the simple reason that when Upstart starts, there is no
system logger running to record messages from Upstart (since Upstart
hasn't started it yet!) However, Upstart 1.3 writes these "early
messages" to the kernel ring buffer (see <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/dmesg.1.html">dmesg(1)</a>) such that by
considering the kernel log <em>and</em> the system log, you can obtain a
complete list of events from the initial "<tt class="docutils literal">startup</tt>". So, for a
standard Ubuntu Oneiric system, you would do:</p>
<pre class="literal-block">grep init: /var/log/kern.log /var/log/syslog
</pre>
<p>The mechanism for adding say the <tt class="docutils literal"><span class="pre">--debug</span></tt> option to the kernel
command-line is as follows:</p>
<ol class="arabic simple">
<li>Hold down SHIFT key before the splash screen appears
(this will then display the grub menu).</li>
<li>Type, "<tt class="docutils literal">e</tt>" to edit the default kernel command-line.</li>
<li>Use the arrow keys to go to the end of the line which starts
"<tt class="docutils literal">linux /boot/vmlinuz ...</tt>".</li>
<li>Press the <tt class="docutils literal">END</tt> key (or use arrows) to go to end of the line.</li>
<li>Add a space followed by "<tt class="docutils literal"><span class="pre">--debug</span></tt>" (note the two dashes).</li>
<li>Press <tt class="docutils literal">CONTROL+x</tt> to boot with this modified kernel command line.</li>
</ol>
</div>
<div class="section" id="change-the-log-priority">
<h3><a class="toc-backref" href="index.html#toc-entry-379">18.1.2&nbsp;&nbsp;&nbsp;Change the log-priority</a></h3>
<p>If you want to see event messages or debug messages "post boot", change
the log priority to <tt class="docutils literal">debug</tt> or <tt class="docutils literal">verbose</tt>. See <a class="reference internal" href="index.html#initctl-log-priority">initctl
log-priority</a>.</p>
</div>
</div>
<div class="section" id="see-the-environment-a-job-runs-in">
<h2><a class="toc-backref" href="index.html#toc-entry-380">18.2&nbsp;&nbsp;&nbsp;See the Environment a Job Runs In</a></h2>
<p>To get a log of the environment variables set when Upstart ran a job you
can add simple debug to the appropriate <tt class="docutils literal">script</tt> section. For
example:</p>
<pre class="literal-block">script
  echo "DEBUG: `set`" &gt;&gt; /tmp/myjob.log

  # rest of script follows...
end script
</pre>
<p>Alternatively you could always have the script log to the system log:</p>
<pre class="literal-block">script
  logger -t "$0" "DEBUG: `set`"

  # rest of script follows...
end script
</pre>
<p>Or, have it pop up a GUI window for you:</p>
<pre class="literal-block">env DISPLAY=:0.0

script
  env | zenity --title="got event $UPSTART_EVENTS" --text-info &amp;
end script
</pre>
<p>For the full details, install the <a class="reference external" href="https://launchpad.net/procenv">procenv(1)</a> utility and run this as
a job. On a Debian Sid or Ubuntu Raring (or newer) system:</p>
<pre class="literal-block">$ sudo apt-get -y install procenv
$ cat &lt;&lt;EOT | sudo tee /etc/init/procenv.conf
exec /usr/bin/procenv
EOT
$ sudo start procenv
$ sudo cat /var/log/upstart/procenv.log
</pre>
</div>
<div class="section" id="checking-how-a-service-might-react-when-run-as-a-job">
<h2><a class="toc-backref" href="index.html#toc-entry-381">18.3&nbsp;&nbsp;&nbsp;Checking How a Service Might React When Run as a Job</a></h2>
<p>Before you even put your service into a <a class="reference internal" href="index.html#job-configuration-file">Job Configuration File</a>, try
the following test which simulates an Upstart-like environment.</p>
<p>Assuming your service is <tt class="docutils literal">/usr/bin/mydaemon</tt> and you want to run it as
user <tt class="docutils literal">root</tt>:</p>
<pre class="literal-block">$ user=root
$ cmd=/usr/bin/mydaemon
$ su -c 'nohup env -i $cmd &lt;/dev/null &gt;/dev/null 2&gt;&amp;1 &amp;' $user
</pre>
<p>That command will run <tt class="docutils literal">/usr/bin/mydaemon</tt>:</p>
<ul class="simple">
<li>as user <tt class="docutils literal">$user</tt> (<tt class="docutils literal">root</tt> here, but maybe not for you if you've used <a class="reference internal" href="index.html#setuid">setuid</a>)</li>
<li>with no associated terminal</li>
<li>parented to init</li>
<li>with no environment</li>
</ul>
<p>Or, if you want to set a user <em>and</em> a group, use <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/sudo.8.html">sudo(8)</a> (or maybe
<a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/su.1.html">su(1)</a> and <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/newgrp.1.html">newgrp(1)</a>):</p>
<pre class="literal-block">$ user=user1
$ group=group2
$ cmd=/usr/bin/mydaemon
$ ( sudo -u $user -g $group nohup env -i $cmd &lt; /dev/null &gt; /dev/null 2&gt;&amp;1 ) &amp;
</pre>
<p>For the <tt class="docutils literal">sudo</tt> example, you should first check that <tt class="docutils literal">$user</tt> is able
to run <tt class="docutils literal">$cmd</tt>.</p>
<p>If your service is unable to run in one of these environments, it is
also likely to fail when run as a <a class="reference internal" href="index.html#job">Job</a>.</p>
<div class="section" id="determining-why-your-service-fails-to-start">
<h3><a class="toc-backref" href="index.html#toc-entry-382">18.3.1&nbsp;&nbsp;&nbsp;Determining why your Service Fails to Start</a></h3>
<p>You may find that your service runs fine when executed from the
command-line, but does not work initially when you start testing it with
Upstart. This is because the environment the service is run in when
started by Upstart is potentially radically different to your
interactive user (or even <tt class="docutils literal">root</tt> user) environment.</p>
<p>To discover exactly what sort of environment Upstart provides, see the
<tt class="docutils literal">procenv</tt> example in <a class="reference internal" href="index.html#see-the-environment-a-job-runs-in">See the Environment a Job Runs In</a>.</p>
<p>You can also use procenv and <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/diff.1.html">diff(1)</a> to determine relatively quickly
how the two environments differ:</p>
<ol class="arabic">
<li><p class="first">Run your application or daemon (let's call it "<tt class="docutils literal">mycmd</tt>") from the
command-line (where it is expected to work) using procenv to log the
environment:</p>
<pre class="literal-block">$ procenv --file=/tmp/procenv-cmdline.log --exec -- mycmd --arg1 --foo=bar
</pre>
</li>
<li><p class="first">Run your application from within an Upstart Job, again using procenv
to log the environment:</p>
<pre class="literal-block">exec procenv --file=/tmp/procenv-job.log --exec -- mycmd --arg1 --foo=bar
</pre>
<p>Or from a script section:</p>
<pre class="literal-block">script

exec procenv --file=/tmp/procenv-job.log --exec -- mycmd --arg1 --foo=bar

end script
</pre>
</li>
<li><p class="first">Compare the two environments:</p>
<pre class="literal-block">$ diff /tmp/procenv-cmdline.log /tmp/procenv-job.log
</pre>
</li>
</ol>
</div>
</div>
<div class="section" id="obtaining-a-log-of-a-script-section">
<h2><a class="toc-backref" href="index.html#toc-entry-383">18.4&nbsp;&nbsp;&nbsp;Obtaining a log of a Script Section</a></h2>
<div class="section" id="upstart-1-4-and-above">
<h3><a class="toc-backref" href="index.html#toc-entry-384">18.4.1&nbsp;&nbsp;&nbsp;Upstart 1.4 (and above)</a></h3>
<p>Upstart 1.4 provides automatic logging of all job output.</p>
<p>See <a class="reference internal" href="index.html#console-log">console log</a> for further details.</p>
</div>
<div class="section" id="versions-of-upstart-older-than-1-4">
<h3><a class="toc-backref" href="index.html#toc-entry-385">18.4.2&nbsp;&nbsp;&nbsp;Versions of Upstart older than 1.4</a></h3>
<p>This technique relies on a trick relating to the early boot process on
an Ubuntu system. On the first line below <tt class="docutils literal">script</tt> stanza, add:</p>
<pre class="literal-block">exec &gt;&gt;/dev/.initramfs/myjob.log 2&gt;&amp;1
set -x
</pre>
<p>This will ensure that <tt class="docutils literal">/bin/sh</tt> will log its progress to the file
named <tt class="docutils literal"><span class="pre">/dev/.initramfs/myjob.log</span></tt>.</p>
<p>The location of this file is special in that <tt class="docutils literal"><span class="pre">/dev/.initramfs/</span></tt> will
be available early on in the boot sequence (before the root filesystem
has been mounted read-write).</p>
<p>Note that newer releases of Ubuntu mount <tt class="docutils literal">/run/</tt> read-writeable very
early on in the boot process too.</p>
</div>
</div>
<div class="section" id="log-script-section-output-to-syslog">
<h2><a class="toc-backref" href="index.html#toc-entry-386">18.5&nbsp;&nbsp;&nbsp;Log Script Section Output to Syslog</a></h2>
<p>There are two techniques you can use to do this:</p>
<p>Use the same technique as shown in <a class="reference internal" href="index.html#obtaining-a-log-of-a-script-section">Obtaining a log of a Script
Section</a>, but change the file to <cite>/dev/kmsg</cite>. This will send the data
to the kernels ring buffer. Once the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man3/syslog.3.html">syslog(3)</a> daemon starts, this
data will be redirected to the system log file:</p>
<pre class="literal-block">script
  exec &gt;/dev/kmsg 2&gt;&amp;1
  echo "this data will be sent to the system log"
end script
</pre>
</div>
<div class="section" id="checking-a-job-configuration-file-for-syntax-errors">
<h2><a class="toc-backref" href="index.html#toc-entry-387">18.6&nbsp;&nbsp;&nbsp;Checking a Job Configuration File for Syntax Errors</a></h2>
<p>See <a class="reference internal" href="index.html#init-checkconf">init-checkconf</a>.</p>
</div>
<div class="section" id="check-a-script-section-for-errors">
<h2><a class="toc-backref" href="index.html#toc-entry-388">18.7&nbsp;&nbsp;&nbsp;Check a Script Section for Errors</a></h2>
<p>Upstart runs your job using <tt class="docutils literal">/bin/sh <span class="pre">-e</span></tt> for safety reasons: scripts
running as the <tt class="docutils literal">root</tt> user need to be well-written! But how can you
check to ensure that your script sections contain valid (syntactically
correct at least) shell fragments? Simply run the <a class="reference internal" href="index.html#init-checkconf">init-checkconf</a> script,
which performs these checks automatically.</p>
<div class="section" id="older-versions-of-upstart">
<h3><a class="toc-backref" href="index.html#toc-entry-389">18.7.1&nbsp;&nbsp;&nbsp;Older versions of Upstart</a></h3>
<p>To check that you haven't made a (shell) syntax error in your <tt class="docutils literal">script</tt>
section, you can use <tt class="docutils literal">sed</tt> like this:</p>
<pre class="literal-block">$ /bin/sh -n &lt;(sed -n '/^script/,/^end script/p' myjob.conf)
</pre>
<p>Or for a <tt class="docutils literal"><span class="pre">pre-start</span></tt> <tt class="docutils literal">script</tt> section:</p>
<pre class="literal-block">$ /bin/sh -n &lt;(sed -n '/^pre-start script/,/^end script/p' myjob.conf)
</pre>
<p>No output indicates no syntax errors.</p>
<p>Alternatively, you could wrap this into a script like this:</p>
<pre class="literal-block">#!/bin/sh
# check-upstart-script-sections.sh

[ $# -ne 1 ] &amp;&amp; { echo "ERROR: usage: $0 &lt;conf_file&gt;"; exit 1; }
file="$1"

[ ! -f "$file" ] &amp;&amp; { echo "ERROR: file $file does not exist" &gt;&amp;2; exit 1; }

for v in pre-start post-start script pre-stop post-stop
do
  if egrep -q "\&lt;${v}\&gt;" $file
  then
    sed -n "/^ *${v}/,/^ *end script/p" $file | \
      sh -n || echo "ERROR in $v section"
  fi
done
</pre>
<p>And run it like this to check all possible script sections for errors:</p>
<pre class="literal-block">$ check-upstart-script-sections.sh myjob.conf
</pre>
</div>
</div>
<div class="section" id="debugging-a-script-which-appears-to-be-behaving-oddly">
<h2><a class="toc-backref" href="index.html#toc-entry-390">18.8&nbsp;&nbsp;&nbsp;Debugging a Script Which Appears to be Behaving Oddly</a></h2>
<p>If a <tt class="docutils literal">script</tt> section appears to be behaving in an odd fashion, the
chances are that one of the commands is failing. Remember that Upstart
runs every <tt class="docutils literal">script</tt> section using <tt class="docutils literal">/bin/sh <span class="pre">-e</span></tt>. This means that if
<em>any</em> simple command fails, the shell will exit. For example, if file
<cite>/etc/does-not-exist.cfg</cite> does not exist in the example below <strong>the
script will exit before the shell runs the</strong> <tt class="docutils literal">if</tt> <strong>test</strong>:</p>
<pre class="literal-block">script
  grep foo /etc/does-not-exist.cfg &gt;/dev/null 2&gt;&amp;1
  if [ $? -eq 0 ]
  then
    echo ok
  else
    echo bad
  fi
end script
</pre>
<p>In other words, you will get <em>no</em> output from this script if the file
grep is attempting to operate on does not exist.</p>
<p>The common idiom to handle possible errors of this type is to convert
the simple expression into an expression guaranteed to return true:</p>
<pre class="literal-block">script
  # ensure this statement always evaluates to true
  command-that-might-fail || true

  # ditto
  another-command || :
end script
</pre>
<p>See <tt class="docutils literal">man sh</tt> for further details.</p>
</div>
</div>
<div class="section" id="recovery">
<h1><a class="toc-backref" href="index.html#toc-entry-391">19&nbsp;&nbsp;&nbsp;Recovery</a></h1>
<p>If you do something really bad or if for some reason Upstart fails, you
might need to boot to recovery mode and revert your job configuration
file changes. In Ubuntu, you can therefore either:</p>
<div class="section" id="boot-into-recovery-mode">
<h2><a class="toc-backref" href="index.html#toc-entry-392">19.1&nbsp;&nbsp;&nbsp;Boot into Recovery Mode</a></h2>
<p>Select the "recovery" option in the Grub boot menu</p>
<p>This assumes that Upstart (<a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/init.8.html">init(8)</a> itself) is usable.</p>
<p>Note that you need to hold down the <tt class="docutils literal">SHIFT</tt> key to see the Grub boot menu.</p>
</div>
<div class="section" id="boot-to-a-shell-directly">
<h2><a class="toc-backref" href="index.html#toc-entry-393">19.2&nbsp;&nbsp;&nbsp;Boot to a shell directly</a></h2>
<p>If Upstart (<a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/init.8.html">init(8)</a>) itself has broken, you'll need to follow the steps
below. By specifying an alternate "initial process" (here a shell) it is
possible to repair the system.</p>
<ol class="arabic">
<li><p class="first">Hold down SHIFT key before the splash screen appears
(this will then display the grub menu).</p>
</li>
<li><p class="first">Type, "<tt class="docutils literal">e</tt>" to edit the default kernel command-line.</p>
</li>
<li><p class="first">Use the arrow keys to go to the end of the line which starts
"<tt class="docutils literal">linux /boot/vmlinuz ...</tt>".</p>
</li>
<li><p class="first">Press the <tt class="docutils literal">END</tt> key (or use arrows) to go to end of the line.</p>
</li>
<li><p class="first">Add a space followed by "<tt class="docutils literal"><span class="pre">init=/bin/sh</span></tt>".</p>
</li>
<li><p class="first">If the line you are editing contains "<cite>quiet</cite>" and/or "<cite>splash</cite>",
remove them.</p>
</li>
<li><p class="first">Press <tt class="docutils literal">CONTROL+x</tt> to boot with this modified kernel command line.</p>
</li>
<li><p class="first">When the shell appears you will need to remount the root filesystem
read-write like this:</p>
<pre class="literal-block"># mount -oremount,rw /
</pre>
</li>
</ol>
<p>You can now make changes to your system as necessary.</p>
</div>
</div>
<div class="section" id="advanced-topics">
<h1><a class="toc-backref" href="index.html#toc-entry-394">20&nbsp;&nbsp;&nbsp;Advanced Topics</a></h1>
<div class="section" id="changing-the-default-shell">
<h2><a class="toc-backref" href="index.html#toc-entry-395">20.1&nbsp;&nbsp;&nbsp;Changing the Default Shell</a></h2>
<p>By default, Upstart uses "<tt class="docutils literal">/bin/sh</tt>" to execute script sections. If
you wish to change this behaviour, you have the following options:</p>
<ul>
<li><p class="first">Link <tt class="docutils literal">/bin/sh</tt> to your chosen shell <a class="footnote-reference" href="index.html#link-to-bin-sh" id="footnote-reference-34">[13]</a>.</p>
</li>
<li><p class="first">Copy your chosen shell to <tt class="docutils literal">/bin/sh</tt>.</p>
</li>
<li><p class="first">Recompile Upstart specifying an alternative shell as follows:</p>
<pre class="literal-block"># XXX: Note the careful quoting to retain double-quotes around the shell!
export CFLAGS=-DSHELL='\"/bin/bash\"'
./configure &amp;&amp; make &amp;&amp; sudo make install
</pre>
<p>Note that you should consider such a change carefully since Upstart
has to rely upon the shell. Remember too that <strong>Upstart runs all script
sections as the root user</strong>.</p>
</li>
<li><p class="first">Use a "here document" (assuming your chosen shell supports them)
within the Job Configuration Files you wish to run with a different
shell:</p>
<pre class="literal-block">script
/bin/bash &lt;&lt;EOT

echo "Hi - I am running under the bash shell"

date

echo "and so am I :)"

EOT
end script
</pre>
<p>Note that currently, this technique is the only way (without modifying
the Upstart source code) to run a shell <em>without</em> specifying the "<tt class="docutils literal"><span class="pre">-e</span></tt>"
option (see <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/dash.1.html">dash(1)</a> or <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/bash.1.html">bash(1)</a> for details).</p>
</li>
</ul>
</div>
<div class="section" id="running-a-script-section-with-python">
<h2><a class="toc-backref" href="index.html#toc-entry-396">20.2&nbsp;&nbsp;&nbsp;Running a script Section with Python</a></h2>
<p>To run a script section with Python:</p>
<pre class="literal-block">script

python - &lt;&lt;END

from datetime import datetime

today = datetime.now().strftime("%A")

fh = open("/tmp/file.txt", "w")
print &gt;&gt;fh, "Today is %s" % today
fh.close()

END

end script
</pre>
</div>
<div class="section" id="running-a-script-section-with-perl">
<h2><a class="toc-backref" href="index.html#toc-entry-397">20.3&nbsp;&nbsp;&nbsp;Running a script Section with Perl</a></h2>
<p>To run a script section with Perl:</p>
<pre class="literal-block">script

perl - &lt;&lt;END

use strict;
use warnings;
use POSIX;

my $fh;
my $today = POSIX::strftime("%A", localtime);

open($fh, "&gt;/tmp/file.txt");
printf $fh "Today is %s\n", $today;
close($fh);

END

end script
</pre>
</div>
</div>
<div class="section" id="development-and-testing">
<h1><a class="toc-backref" href="index.html#toc-entry-398">21&nbsp;&nbsp;&nbsp;Development and Testing</a></h1>
<div class="section" id="warnings">
<h2><a class="toc-backref" href="index.html#toc-entry-399">21.1&nbsp;&nbsp;&nbsp;Warnings</a></h2>
<ul>
<li><p class="first">Upstart runs as <tt class="docutils literal">root</tt> so has full system privileges.</p>
</li>
<li><p class="first">If Upstart crashes...:</p>
<pre class="literal-block">Kernel panic - not syncing: Attempted to kill init! exitcode=0x00000100
[ 2.745566]
[ 2.751931] Pid: 1, comm: false Not tainted 3.5.0-15-generic #22-Ubuntu
[ 2.755489] Call Trace:
[ 2.757068]  [&lt;c15be842&gt;] panic+0x81/0x17b
[ 2.759206]  [&lt;c104a6a5&gt;] do_exit+0x745/0x7a0
[ 2.761602]  [&lt;c104a9a4&gt;] do_group_exit+0x34/0xa0
[ 2.764162]  [&lt;c104aa28&gt;] sys_exit_group+0x18/0x20
[ 2.765231]  [&lt;c15c8a94&gt;] syscall_call+0x7/0xb
</pre>
<p>... your kernel panics!</p>
</li>
<li><p class="first">Unlike the kernel, if a new version of Upstart fails to work at all,
there is no easy fix.</p>
</li>
</ul>
</div>
<div class="section" id="precautions-and-practises">
<h2><a class="toc-backref" href="index.html#toc-entry-400">21.2&nbsp;&nbsp;&nbsp;Precautions and Practises</a></h2>
<p>Precautions and Practises:</p>
<ul class="simple">
<li>Every function asserts its arguments. This allows simple programming
bugs to be found very quickly ("fail fast").</li>
<li>Every function that returns a value must be checked and exceptions
handled. GCC helps in this respect with the
<tt class="docutils literal">__attribute__ ((warn_unused_result))</tt> function attribute.</li>
<li>Every function that returns newly-allocated memory has its prototype
decorated using <tt class="docutils literal">__attribute__ ((malloc))</tt>.</li>
<li>No compiler warnings are allowed (<tt class="docutils literal"><span class="pre">-Wall</span> <span class="pre">-Werror</span></tt>).</li>
<li>Every function or logical unit of functionality <em>must</em> have an
associated set of tests.</li>
<li>Every build of Upstart <em>must</em> pass all NIH and Upstart tests before
being made available to users.</li>
<li>The code is very well tested(using physical and virtual hardware, all
architectures and containers).</li>
<li><em>All</em> code is peer-reviewed.</li>
<li>All changes to the main <tt class="docutils literal">lp:upstart</tt> code branch in Launchpad now
automatically generate a mail to the Upstart mailing list.</li>
<li>All bzr merge proposals raised on Upstart also result in a mail to
the Upstart mailing list.</li>
<li>Where possible, all new features add a <tt class="docutils literal"><span class="pre">--no--&lt;feature&gt;</span></tt>
command-line option (allowing the feature to be disabled to provide a
fall-back mechanism).</li>
</ul>
</div>
<div class="section" id="code-style">
<h2><a class="toc-backref" href="index.html#toc-entry-401">21.3&nbsp;&nbsp;&nbsp;Code Style</a></h2>
<ul class="simple">
<li>Use tabs.</li>
<li>Every function, macro, structure, typedef and variable must be
documented.</li>
<li>Every function must specify what is returned on success and failure.</li>
<li>Every function must check all possible parameters using .</li>
</ul>
<p>See file: <tt class="docutils literal">upstart:HACKING</tt></p>
</div>
<div class="section" id="development-advice">
<h2><a class="toc-backref" href="index.html#toc-entry-402">21.4&nbsp;&nbsp;&nbsp;Development Advice</a></h2>
<ul>
<li><p class="first">KISS and KIRS ("keep it readable silly")</p>
<p>"Clever" code often outwits the author.</p>
<p>Prefer to keep it simple, elegant and most of all readable.
Bit-twiddlers and IOCCC champions need not apply.</p>
</li>
<li><p class="first">Do not use system calls or library calls if NIH already provides an
alternative. That means:</p>
<ul class="simple">
<li>No <tt class="docutils literal">malloc()</tt>, <tt class="docutils literal">calloc()</tt>, <tt class="docutils literal">strtok()</tt>, <tt class="docutils literal">sprintf()</tt>, <em>et cetera</em>.</li>
<li>You really need to familiarise yourself with NIH by reading the
NIH source and the Upstart source.</li>
</ul>
</li>
<li><p class="first">Don't just read the NIH and Upstart source, read the test code - it
has comments too! ;-)</p>
</li>
<li><p class="first">Write code to be <em>testable</em>.</p>
</li>
<li><p class="first">Always consider security and performance.</p>
<ul class="simple">
<li>DoS possibility?</li>
<li>Get the code security-reviewed.</li>
</ul>
</li>
<li><p class="first">If you plan to work on some huge feature that will take you 6 months
of effort, <em>PLEASE</em> alert the developers via the mailing list
<em>BEFORE</em> you start since:</p>
<ul class="simple">
<li>We may already be working on such a feature.</li>
<li>If your design doesn't fit in with the project, you're potentially
facing a lot of avoidable rework.</li>
</ul>
</li>
<li><p class="first">Always test on a range of hardware:</p>
<ul class="simple">
<li>Physical and virtual.</li>
<li>32-bit and 64-bit.</li>
<li>Intel/ARM/etc.</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="setting-up-an-upstart-development-environment">
<h2><a class="toc-backref" href="index.html#toc-entry-403">21.5&nbsp;&nbsp;&nbsp;Setting up an Upstart Development Environment</a></h2>
<pre class="literal-block">$ sudo apt-get install build-dep upstart # cheat :)
$ bzr branch lp:upstart
$ cd upstart
$ ./configure --disable-silent-rules --enable-compiler-warnings \
    --disable-compiler-optimisations --disable-linker-optimisations \
    --enable-compiler-coverage
$ export CFLAGS="-fstack-protector --param=ssp-buffer-size=4 -Wformat -Werror=format-security"
$ make
$ cscope -Rbq &amp;&amp; ctags
</pre>
<ul class="simple">
<li>You <em>need</em> to build the code before indexing since D-Bus bindings are
auto-generated (using <tt class="docutils literal"><span class="pre">nih-dbus-tool</span></tt>).</li>
<li>You <em>need</em> to use all those flags to enable all the compiler checks.</li>
</ul>
</div>
<div class="section" id="setting-up-an-upstart-nih-development-environment">
<h2><a class="toc-backref" href="index.html#toc-entry-404">21.6&nbsp;&nbsp;&nbsp;Setting up an Upstart+NIH Development Environment</a></h2>
<p>Since Upstart makes such heavy use of NIH, it is often useful to build
both Upstart and link it to a debug symbols build of NIH:</p>
<pre class="literal-block">$ sudo apt-get install build-dep upstart libnih1 # cheat :)
$ prefix=/testing
$ mkdir $prefix
$ export PKG_CONFIG_PATH=${prefix}/lib/pkgconfig:$PKG_CONFIG_PATH
$ export ACDIR=${prefix}/share/aclocal:$ACDIR
$ export CFLAGS="-fstack-protector --param=ssp-buffer-size=4 -Wformat \
                 -Werror=format-security -ggdb3 -fno-inline"
$ bzr branch lp:libnih
$ cd libnih
$ ./configure --disable-silent-rules --enable-compiler-warnings \
    --disable-compiler-optimisations --disable-linker-optimisations \
    --enable-compiler-coverage &amp;&amp; make &amp;&amp; make install
$ cd -
$ bzr branch lp:upstart
$ cd upstart
$ ./configure --disable-silent-rules --enable-compiler-warnings \
    --disable-compiler-optimisations --disable-linker-optimisations \
    --enable-compiler-coverage &amp;&amp; make &amp;&amp; make install
</pre>
</div>
<div class="section" id="upstart-objects">
<h2><a class="toc-backref" href="index.html#toc-entry-405">21.7&nbsp;&nbsp;&nbsp;Upstart Objects</a></h2>
<ul class="simple">
<li><tt class="docutils literal">Event</tt> represents an event.</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal">ConfSource</tt> represents a type of configuration source (file or directory) and</dt>
<dd>includes <tt class="docutils literal">inotify</tt> watches.</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal">ConfFile</tt> represents the jobs "<tt class="docutils literal">.conf</tt>" file <em>name</em>, but also</dt>
<dd>has a pointer to its contents (see below).</dd>
</dl>
</li>
<li><tt class="docutils literal">JobClass</tt> represents the jobs "<tt class="docutils literal">.conf</tt>" file <em>contents</em>.</li>
<li><tt class="docutils literal">Job</tt> represents a running instance of job.</li>
<li><tt class="docutils literal">Session</tt> represents a user session for user jobs, or a chroot.</li>
<li><tt class="docutils literal">Log</tt> represents job log data (data that a single job process has
produced on its standard output and standard error).</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal">Blocked</tt> is used to handle <tt class="docutils literal">hook</tt> and <tt class="docutils literal">method</tt> events types.</dt>
<dd>(See <a class="reference internal" href="index.html#hooks">hooks</a> and <a class="reference internal" href="index.html#methods">methods</a>).</dd>
</dl>
</li>
</ul>
<p>See <a class="reference internal" href="index.html#upstart-objects-diagram">upstart-objects-diagram</a>.</p>
</div>
<div class="section" id="unit-tests">
<h2><a class="toc-backref" href="index.html#toc-entry-406">21.8&nbsp;&nbsp;&nbsp;Unit Tests</a></h2>
<p>Every major feature in Upstart needs to be accompanied with
comprehensive unit tests. To run the tests:</p>
<pre class="literal-block">$ autoreconf -fi
$ ./configure --enable-compiler-coverage ...
$ make check 2&gt;&amp;1|tee make-check.log
</pre>
<p>Note that as of Upstart 1.3, some of these tests cannot be run from
within a <a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/chroot.2.html">chroot(2)</a> environment unless D-Bus is installed and
configured <em>within</em> the chroot. This scenario is detected, a warning
about <a class="reference external" href="https://bugs.launchpad.net/upstart/+bug/728988">bug 728988</a> is logged and those tests are automatically skipped.
Hence, to run <em>all</em> the tests, please ensure you run "<tt class="docutils literal">make check</tt>"
<em>outside</em> of a <a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/chroot.2.html">chroot(2)</a> environment.</p>
<div class="section" id="building-within-a-chroot">
<h3><a class="toc-backref" href="index.html#toc-entry-407">21.8.1&nbsp;&nbsp;&nbsp;Building Within a Chroot</a></h3>
<p>Some of the unit tests assume a full environment, including a
controlling terminal. If you wish to build an Upstart package on a
<a class="reference external" href="http://www.debian.org/">Debian</a> or <a class="reference external" href="http://www.ubuntu.com/">Ubuntu</a> system, note that although the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/pbuilder.html">pbuilder(8)</a> tool
will work as expected, currently <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/sbuild.html">sbuild(1)</a> does not provide a
controlling terminal which causes tests to fail. See <a class="footnote-reference" href="index.html#sbuild-bug" id="footnote-reference-35">[23]</a> and
<a class="footnote-reference" href="index.html#debian-sbuild-bug" id="footnote-reference-36">[24]</a>.</p>
</div>
<div class="section" id="statistics">
<h3><a class="toc-backref" href="index.html#toc-entry-408">21.8.2&nbsp;&nbsp;&nbsp;Statistics</a></h3>
<p>At the time of writing, the number of Upstart tests, and tests for the
NIH Utility Library used by Upstart are:</p>
<table border="1" class="docutils">
<caption>Unit Test Statistics.</caption>
<colgroup>
<col width="64%">
<col width="36%">
</colgroup>
<thead valign="bottom">
<tr><th class="head">Application</th>
<th class="head">Test Count</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Upstart unit tests</td>
<td>1368</td>
</tr>
<tr><td>NIH Utility Library</td>
<td>2863</td>
</tr>
<tr><td><strong>Total</strong></td>
<td><strong>4231</strong></td>
</tr>
</tbody>
</table>
<p>importance of the test-suite cannot be overstated: it's one of the main
"safety-nets" to ensure the behaviour of NIH and Upstart is assured.</p>
<p>To run the test suite for NIH or Upstart, simply run the following <em>as a
non-privileged user</em>:</p>
<pre class="literal-block">make check
</pre>
</div>
<div class="section" id="test-coverage">
<h3><a class="toc-backref" href="index.html#toc-entry-409">21.8.3&nbsp;&nbsp;&nbsp;Test Coverage</a></h3>
<p>To check the test coverage after running the tests, look at each file
using <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/gcov.1.html">gcov(1)</a>:</p>
<pre class="literal-block">$ cd init
$ gcov -bf event.c
</pre>
</div>
</div>
<div class="section" id="enable-full-compiler-warnings">
<h2><a class="toc-backref" href="index.html#toc-entry-410">21.9&nbsp;&nbsp;&nbsp;Enable Full Compiler Warnings</a></h2>
<p>If you want to start submitting changes to Upstart, you need to ensure
you build it as follows to catch any warnings and errors the compiler
can flag:</p>
<pre class="literal-block">./configure --disable-silent-rules --enable-compiler-warnings --disable-compiler-optimisations --disable-linker-optimisations --enable-compiler-coverage
</pre>
</div>
<div class="section" id="running-upstart-as-a-non-privileged-user">
<h2><a class="toc-backref" href="index.html#toc-entry-411">21.10&nbsp;&nbsp;&nbsp;Running Upstart as a Non-Privileged User</a></h2>
<p>Upstart 1.3 introduced a number of options to help with testing. The
"<tt class="docutils literal"><span class="pre">--session</span></tt>" command-line option allows you to run Upstart as a
non-privileged user since it makes Upstart connect to the D-Bus <em>session</em>
bus for which each user has their own:</p>
<pre class="literal-block">$ /sbin/init --session --debug --confdir $HOME/conf/ --no-sessions
</pre>
<p>This is useful since you can now try out new features, debug with
<a class="reference external" href="http://www.gnu.org/software/gdb/">GDB</a>, <em>et cetera</em> without having to install Upstart and run it as
<tt class="docutils literal">root</tt>. Once you've got your second instance of Upstart running, you
can then use the same option on <a class="reference internal" href="index.html#initctl">initctl</a> to manipulate jobs:</p>
<pre class="literal-block">$ initctl --session emit foo
</pre>
<p>The caveat here is that running Upstart as a non-privileged user with a PID
other than <tt class="docutils literal">1</tt> changes its behaviour slightly. So, only use this
technique for unit/functional testing and remember that any changes you
post for inclusion should have been tested in a real scenario where
Upstart is run as <tt class="docutils literal">root</tt> and used to boot a system.</p>
</div>
<div class="section" id="useful-tools-for-debugging-with-d-bus">
<h2><a class="toc-backref" href="index.html#toc-entry-412">21.11&nbsp;&nbsp;&nbsp;Useful tools for Debugging with D-Bus</a></h2>
<p>If you are debugging <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/initctl.8.html">initctl(8)</a>, you'll need to understand D-Bus.
These tools are invaluable:</p>
<ul class="simple">
<li><a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/dbus-send.1.html">dbus-send(1)</a></li>
<li><a class="reference external" href="https://live.gnome.org/DFeet/">D-Feet</a></li>
</ul>
</div>
<div class="section" id="debugging-a-job">
<h2><a class="toc-backref" href="index.html#toc-entry-413">21.12&nbsp;&nbsp;&nbsp;Debugging a Job</a></h2>
<p>There is a magic stanza called <tt class="docutils literal">debug</tt> which will start the job via
<a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/fork.2.html">fork(2)</a> and then pause it. This can be useful. Assuming you
have a job "<tt class="docutils literal">debug.conf</tt>" such as:</p>
<pre class="literal-block"># XXX: magic stanza!
debug

script
  /bin/true
end script
</pre>
<p>You could now trace the job process like this:</p>
<pre class="literal-block"># start debug
debug start/running, process 12345
# strace -p 12345 -o /tmp/debug.log -Ff -s 1024 -v
status debug debug stop/waiting
</pre>
<p>After the call to <a class="reference internal" href="index.html#start">start</a>, the job process will be "running", but
paused. The <cite>strace(1)</cite> will resume the job and you will then have a
log of what happened in file "<tt class="docutils literal">/tmp/debug.log</tt>".</p>
</div>
<div class="section" id="debugging-another-instance-of-upstart-running-as-root-with-pid-1">
<h2><a class="toc-backref" href="index.html#toc-entry-414">21.13&nbsp;&nbsp;&nbsp;Debugging Another Instance of Upstart Running as root with PID 1</a></h2>
<div class="section" id="method-1-crazy">
<h3><a class="toc-backref" href="index.html#toc-entry-415">21.13.1&nbsp;&nbsp;&nbsp;Method 1 (crazy)</a></h3>
<p>Caveat Emptor: this is somewhat crazy, but if you really want to do
this:</p>
<pre class="literal-block">$ sudo \
  gdb --args \
  clone -e DBUS_SYSTEM_BUS_ADDRESS=$DBUS_SESSION_BUS_ADDRESS \
  -f CLONE_NEWPID,SIGCHLD,CLONE_PTRACE -- \
  init/init --debug --confdir /my/conf/dir --no-startup-event
    --no-sessions
</pre>
<p>This uses the <a class="reference external" href="https://code.launchpad.net/~jamesodhunt/+junk/clone">Clone</a> tool, which is very similar to <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/unshare.1.html">unshare(1)</a> but
allows you to put a process into a new PID namespace.</p>
</div>
<div class="section" id="method-2-saner">
<h3><a class="toc-backref" href="index.html#toc-entry-416">21.13.2&nbsp;&nbsp;&nbsp;Method 2 (saner)</a></h3>
<p>Use a container technology such as <a class="reference external" href="http://lxc.sourceforge.net/">LXC</a>, that simplifies the access to
namespaces. For example <a class="footnote-reference" href="index.html#lxc-note" id="footnote-reference-37">[12]</a>:</p>
<pre class="literal-block">$ sudo lxc-start -n natty
$ upstart_pid=$(pgrep -f /sbin/init|grep -v '^1$')
$ sudo gdb /sbin/init $upstart_pid
</pre>
<p>Like the example above, here we use <a class="reference external" href="http://www.gnu.org/software/gdb/">gdb</a> to debug Upstart running as
root with PID 1, but with thanks to <a class="reference external" href="http://lxc.sourceforge.net/">LXC</a>, the container is fully
isolated from the host system using namespaces. See <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/lxc.7.html">lxc(7)</a> for
details of <a class="reference external" href="http://lxc.sourceforge.net/">LXC</a> on <a class="reference external" href="http://www.ubuntu.com/">Ubuntu</a>.</p>
</div>
</div>
<div class="section" id="nih">
<h2><a class="toc-backref" href="index.html#toc-entry-417">21.14&nbsp;&nbsp;&nbsp;NIH</a></h2>
<p>Grab the code from the <a class="reference external" href="http://launchpad.net/libnih">NIH Utility Library</a> page.</p>
<p>The NIH documentation is <em>with</em> the code:</p>
<ul class="simple">
<li>Header files provide introductory details.</li>
<li>Every function, macro and variable is documented immediately above
it.</li>
</ul>
<p>References in the sections below give locations of file in the NIH
source.</p>
<div class="section" id="memory-handling">
<h3><a class="toc-backref" href="index.html#toc-entry-418">21.14.1&nbsp;&nbsp;&nbsp;Memory Handling</a></h3>
<p>Do not use <tt class="docutils literal">malloc()</tt>, <tt class="docutils literal">calloc()</tt>, <tt class="docutils literal">realloc()</tt> or <tt class="docutils literal">free()</tt> when
working with Upstart. Rely instead on the NIH memory routines:</p>
<ul>
<li><p class="first">Low-level memory allocation is handled using <tt class="docutils literal">nih_alloc()</tt> and
<tt class="docutils literal">nih_realloc()</tt>.</p>
</li>
<li><p class="first">It is more normal to use <tt class="docutils literal">nih_new(parent, type)</tt> though.</p>
</li>
<li><p class="first">To free memory, use <tt class="docutils literal">nih_free()</tt>:</p>
<pre class="literal-block">typedef struct foo {
    int i;
} Foo;

Foo *foo = nih_new (NULL, Foo);
foo-&gt;i = 123;
    /* time passes... */
nih_free (foo);
</pre>
</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><em>NEVER</em> free memory using <tt class="docutils literal">nih_free()</tt> that NIH did not allocate!</p>
</div>
<p>See: <tt class="docutils literal"><span class="pre">nih/alloc.[ch]</span></tt></p>
<p>Like C++, NIH can perform automatic cleanup when objects go out of
scope. The most magical part of NIH is <tt class="docutils literal">nih_local</tt>.</p>
<p>Question: is the following code leaking memory?</p>
<pre class="literal-block">void foo (void)
{
    nih_local char *string = nih_strdup (NULL, "hello, world");

    nih_message ("%s", string);
}
</pre>
<p>Answer: No!</p>
<ul class="simple">
<li><tt class="docutils literal">nih_local</tt> is syntactic sugar to tell the compiler that the memory
that the variable it applies to ("<tt class="docutils literal">string</tt>") should be freed when
the last reference to it is dropped. This happens when the variable goes
out of scope at the end of <tt class="docutils literal">foo()</tt>.</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><em>ALWAYS</em> assign <tt class="docutils literal">nih_local</tt> variables to <tt class="docutils literal">NULL</tt> to avoid memory
corruption issues if the variable is not assigned for some code path!</p>
</div>
</div>
<div class="section" id="the-nih-parent-pointer">
<h3><a class="toc-backref" href="index.html#toc-entry-419">21.14.2&nbsp;&nbsp;&nbsp;The NIH Parent Pointer</a></h3>
<p>Most NIH routines take a <tt class="docutils literal">void *parent</tt> as their first parameter.</p>
<p>This parent pointer can be <tt class="docutils literal">NULL</tt> as shown below:</p>
<pre class="literal-block">nih_strdup (NULL, "hello, world");
</pre>
<p>If the parent is <em>not</em> <tt class="docutils literal">NULL</tt>, NIH will automatically add an
appropriate reference such that when the parent is freed, so are its
child objects.</p>
<p>Consider this example:</p>
<pre class="literal-block">void bar (void)
{
    typedef struct thing {
        char *str;
    } Thing;

    nih_local Thing *thing = nih_new (NULL, Thing);

    /* XXX: note that we specify the parent as 'thing' */
    thing-&gt;str = nih_strdup (thing, "first string");
}
</pre>
<p>Two memory allocations have been performed:</p>
<ul class="simple">
<li><tt class="docutils literal">thing</tt></li>
<li><tt class="docutils literal"><span class="pre">thing-&gt;str</span></tt></li>
</ul>
<p>And yet when <tt class="docutils literal">bar()</tt> exits, there is <em>no</em> leak because NIH knows that
<tt class="docutils literal"><span class="pre">thing-&gt;str</span></tt> is a "child" of <tt class="docutils literal">thing</tt> and will <em>do-the-right-thing
(TM)</em> and free both chunks of memory!</p>
<p>Here is another subtle example:</p>
<pre class="literal-block">void bar (void)
{
    typedef struct thing {
        char *str;
    } Thing;

    nih_local Thing *thing = nih_new (NULL, Thing);

    /* XXX: note that we specify the parent as 'thing' */
    thing-&gt;str = nih_strdup (thing, "a string value");

    /* now, let's reassign the pointer */
    thing-&gt;str = nih_strdup (thing, "another string value");
}
</pre>
<p>Surely, there must be a leak <em>now</em> since we've re-assigned
<tt class="docutils literal"><span class="pre">thing-&gt;str</span></tt>?</p>
<p>In fact, <em>there is no leak</em> because both the strings that we've assigned
to <tt class="docutils literal"><span class="pre">thing-&gt;str</span></tt> have specified the <em>same</em> parent: <tt class="docutils literal">thing</tt>. So, the
reference to <tt class="docutils literal">a string value</tt> has not been lost and both string values
will be freed correctly when <tt class="docutils literal">thing</tt> goes out of scope!</p>
</div>
<div class="section" id="nih-free">
<h3><a class="toc-backref" href="index.html#toc-entry-420">21.14.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">nih_free()</tt></a></h3>
<p>However, sometimes using <tt class="docutils literal">nih_local</tt> is not appropriate. In the
example below, we manually free the memory using <tt class="docutils literal">nih_free()</tt>:</p>
<pre class="literal-block">void bar (void)
{
    typedef struct thing {
        char *str;
    } Thing;

    Thing *thing = nih_new (NULL, Thing);

    /* XXX: note that we specify the parent as 'foo' */
    thing-&gt;str = nih_strdup (thing, "first string");

    /* "manually" free thing _and_ thing-&gt;str */
    nih_free (thing);
}
</pre>
<p>Here we use <tt class="docutils literal">nih_free()</tt> to force NIH to free up memory.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><em>NEVER</em> call <tt class="docutils literal">nih_free()</tt> on an <tt class="docutils literal">nih_local</tt> variable!</p>
</div>
</div>
<div class="section" id="nih-must">
<h3><a class="toc-backref" href="index.html#toc-entry-421">21.14.4&nbsp;&nbsp;&nbsp;<tt class="docutils literal">NIH_MUST()</tt></a></h3>
<p>The example so far have not checked for error conditions. Here's how we
<em>could</em> handle an out-of-memory scenario:</p>
<pre class="literal-block">nih_local char *string = NULL;

string = nih_strdup (thing, "first string");

if (! string) {
  /* handle the error */
}
</pre>
<p>However, this tends to lead to code littered with error checking. There
is a common NIH idiom that avoids such problems:</p>
<pre class="literal-block">nih_local char *string = NULL;

string = NIH_MUST (nih_strdup (thing, "first string"));

  /* string is now guaranteed to have the expected error */
}
</pre>
<p>See file: <tt class="docutils literal">nih/macros.h</tt></p>
<p><tt class="docutils literal">NIH_MUST()</tt> will evaluate its argument until it returns a value.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><tt class="docutils literal">NIH_MUST()</tt> will try <em>forever</em> to grab the memory required.</p>
<blockquote class="last">
That <em>could</em> lead to Upstart going into a tight loop and effectively
killing your machine.</blockquote>
</div>
<p>However, realistically, Upstart only ever allocates small chunks of
memory and if <tt class="docutils literal">/sbin/init</tt>, running as <tt class="docutils literal">root</tt> is unable to allocate
a few bytes of memory, you machine has big problems.</p>
</div>
<div class="section" id="error-handling">
<h3><a class="toc-backref" href="index.html#toc-entry-422">21.14.5&nbsp;&nbsp;&nbsp;Error Handling</a></h3>
<p>If a function detects a failure, it must return a suitable error value.
However, it may be appropriate to raise an exception. You'll know if a
function raises an exception since it will be documented like this:</p>
<pre class="literal-block">Returns: zero on success, negative value on raised error.
</pre>
<p>A "raised error" refers to an <tt class="docutils literal">NihError</tt> object being raised when the
function detects an error.</p>
<p>Therefore, it is the callers responsibility to:</p>
<ul class="simple">
<li>Check the return code of every function that returns a value.</li>
<li>Handle raised errors appropriately (and immediately!)</li>
</ul>
<p>See: <tt class="docutils literal"><span class="pre">nih/error.[ch]</span></tt></p>
<p>Let's look at an example:</p>
<pre class="literal-block">char *
num_to_str (int i)
{
    if (i % 2)
        return NIH_MUST (nih_sprintf (NULL, "%d", i));

    nih_error_raise_no_memory ();
    return NULL;
}

int
main (int argc, char *argv[])
{
    nih_local char *s = NULL;

    s = num_to_str (1);
    nih_message ("got: '%s'", s);

    /* force error scenario */
    s = num_to_str (2);
    if (! s) {
        /* retrieve the error */
        err = nih_error_get ();

        /* display it */
        nih_message ("%s:%d:%s:%d:%s",
                err-&gt;filename,
                err-&gt;line,
                err-&gt;function,
                err-&gt;number,
                err-&gt;message);
        /* clear the error */
        nih_free (err);
    }

    exit (EXIT_SUCCESS);
}
</pre>
<div class="section" id="impact-of-ignoring-a-raised-error">
<h4><a class="toc-backref" href="index.html#toc-entry-423">21.14.5.1&nbsp;&nbsp;&nbsp;Impact of Ignoring a Raised Error</a></h4>
<p>An example of code that ignores a raised error:</p>
<pre class="literal-block">char *
num_to_str (int i)
{
    if (i % 2)
        return NIH_MUST (nih_sprintf (NULL, "%d", i));

    nih_error_raise_no_memory ();
    return NULL;
}

int
main (int argc, char *argv[])
{
    nih_local char *s = NULL;

    /* ok */
    s = num_to_str (1);
    nih_message ("got: '%s'", s);

    /* force error scenario */
    s = num_to_str (2);

    /* Oops - forgot to check return! */
    nih_message ("got: '%s'", s);

    exit (EXIT_SUCCESS);
}
</pre>
<p>Output:</p>
<pre class="literal-block">got: '1'
got: '(null)'
(null):test_nih_error.c:38: Unhandled error from num_to_str: Cannot
allocate memory
[1]    20476 abort (core dumped)  bin/test_nih_error
</pre>
<p>The reason this crashes is that NIH installs an <a class="reference external" href="http://manpages.ubuntu.com/manpages/man3/atexit.3.html">atexit(3)</a> handler
which checks for any <tt class="docutils literal">NihError</tt> errors that have not been handled on exit.</p>
<p>Of course, in the case of Upstart, <em>it</em> never exits so failing to handle
an error will result in an assertion failure the <em>next</em> time an error
object is raised.</p>
<ul class="simple">
<li>To raise an exception when <tt class="docutils literal">ERRNO</tt> gets set, use:<ul>
<li><tt class="docutils literal">nih_error_raise_system()</tt></li>
<li><tt class="docutils literal">nih_return_system_error()</tt></li>
</ul>
</li>
<li>To raise an arbitrary exception, use:<ul>
<li><tt class="docutils literal">nih_error_raise(number, message)</tt></li>
<li><tt class="docutils literal">nih_error_raise_printf(number, format, <span class="pre">...)</span></tt></li>
<li><tt class="docutils literal">nih_return_error(retval)</tt></li>
</ul>
</li>
</ul>
<p>See file: <tt class="docutils literal">nih/error.h</tt></p>
</div>
</div>
<div class="section" id="output">
<h3><a class="toc-backref" href="index.html#toc-entry-424">21.14.6&nbsp;&nbsp;&nbsp;Output</a></h3>
<p>NIH has a rich set of output routines:</p>
<ul class="simple">
<li><tt class="docutils literal">nih_debug()</tt></li>
<li><tt class="docutils literal">nih_info()</tt></li>
<li><tt class="docutils literal">nih_message()</tt></li>
<li><tt class="docutils literal">nih_warn()</tt></li>
<li><tt class="docutils literal">nih_fatal()</tt></li>
<li><tt class="docutils literal">nih_fatal()</tt></li>
</ul>
<p>All routines take a format string and arguments like <a class="reference external" href="http://manpages.ubuntu.com/manpages/man3/printf.3.html">printf(3)</a>:</p>
<pre class="literal-block">int   i = 123;
char *s = "hello, world";
nih_debug ("s='%s', i=%d", s, i);
</pre>
<p>Like <a class="reference external" href="http://manpages.ubuntu.com/manpages/man3/syslog.3.html">syslog(3)</a>, NIH will only display message made with the above
calls if the log priority is appropriate.</p>
<p>To change the priority, use <tt class="docutils literal"><span class="pre">--verbose</span></tt>, <tt class="docutils literal"><span class="pre">--debug</span></tt>, or
programatically call <tt class="docutils literal">nih_set_priority()</tt>.</p>
<p>By default, output goes to <em>standard output</em>, but early in its
initialisation, it redirects output to the kernel ring buffer using:</p>
<pre class="literal-block">nih_log_set_logger (logger_kmsg);
</pre>
<p>See file: <tt class="docutils literal"><span class="pre">nih/logging.[ch]</span></tt></p>
</div>
</div>
<div class="section" id="creating-a-new-object">
<h2><a class="toc-backref" href="index.html#toc-entry-425">21.15&nbsp;&nbsp;&nbsp;Creating a New Object</a></h2>
<div class="section" id="template-for-a-new-foo">
<h3><a class="toc-backref" href="index.html#toc-entry-426">21.15.1&nbsp;&nbsp;&nbsp;Template for a new "foo"</a></h3>
<pre class="literal-block">/**
 * foo:
 * @entry: list header,
 * @name: name of foo,
 * @value: value of foo.
 *
 * Structure to hold a foo.
 * &lt;&lt; XXX: more details here &gt;&gt;.
 **/
 typedef struct foo {
     NihList   entry;
     char     *name;
     int       value;
 } Foo;

 /**
  * foos:
  * List of all foos. &lt;&lt; XXX: more details here &gt;&gt;
  **/
 NihList *foos;

 /**
  * Initilise the foos list.
  */
 void foo_init (void)
 {
     if (! foos)
         foos = NIH_MUST (nih_list_new (NULL));
 }

 Foo * foo_new (void *parent, const char *name, int value)
         __attribute__ ((warn_unused_result, malloc));

 /**
  * foo_new:
  * @parent: parent of new foo,
  * @name: name of foo,
  * @value: value of foo.
  *
  * Returns: Newly allocated foo, or NULL on insufficient memory.
  **/
  Foo *
  foo_new (void *parent, const char *name, int value)
  {
      Foo *foo;

      assert (name); /* check all args possible */
      foo_init (); /* initialise the subsystem */

      /* create the object */
      foo = NIH_MUST (nih_new (parent, Foo));

      /* initialise the embedded list */
      nih_list_init (&amp;foo-&gt;entry);

      /* save values */
      foo-&gt;name = NIH_MUST (nih_strdup (foo, name));
      foo-&gt;value = value;

      /* Add object to list of known foos */
      nih_list_add (foos, &amp;source-&gt;entry);

      /* explain how objects should be disposed of */
      nih_alloc_set_destructor (foo, nih_list_destroy);

      return foo;

  error:
      nih_free (foo);
      return NULL;
  }
</pre>
</div>
<div class="section" id="basic-test-example-for-a-new-foo">
<h3><a class="toc-backref" href="index.html#toc-entry-427">21.15.2&nbsp;&nbsp;&nbsp;Basic Test Example for a New "foo"</a></h3>
<pre class="literal-block">Foo  *foo;
char *str;

TEST_FEATURE ("with parent");

foo_init ();

TEST_LIST_EMPTY (foos);

str = nih_strdup (NULL, "hello");
TEST_NE_P (str, NULL);

foo = foo_new (str, "foo", 123);
TEST_NE_P (foo, NULL);

TEST_ALLOC_PARENT (foo, str);
TEST_ALLOC_SIZE (foo, sizeof (Foo));

TEST_FREE_TAG (foo-&gt;name);
TEST_LIST_NOT_EMPTY (foos);

TEST_EQ (foo-&gt;value, 123);
TEST_EQ_STR (foo-&gt;name, "foo");
TEST_ALLOC_PARENT (foo-&gt;name, foo);

nih_free (foo);
TEST_LIST_EMPTY (foos);
TEST_FREE (foo-&gt;name);

nih_free (str);
</pre>
</div>
</div>
<div class="section" id="adding-a-new-initctl-command">
<h2><a class="toc-backref" href="index.html#toc-entry-428">21.16&nbsp;&nbsp;&nbsp;Adding a new <tt class="docutils literal">initctl</tt> command</a></h2>
<div class="section" id="adding-a-new-non-job-command">
<h3><a class="toc-backref" href="index.html#toc-entry-429">21.16.1&nbsp;&nbsp;&nbsp;Adding a New non-Job Command</a></h3>
<ol class="arabic">
<li><p class="first">Add a new function called "<tt class="docutils literal">&lt;name&gt;_action()</tt>" to <tt class="docutils literal">util/initctl.c</tt>
where "<tt class="docutils literal">&lt;name&gt;</tt>" is the name of the new command the user will type on
the command-line ("<tt class="docutils literal">initctl &lt;name&gt;</tt>") with all hyphens ("<tt class="docutils literal">-</tt>")
converted to underscores ("<tt class="docutils literal">_</tt>").</p>
<p>Example: "<tt class="docutils literal">reload_configuration_action()</tt>" for the
"<tt class="docutils literal"><span class="pre">reload-configuration</span></tt>" command-line command.</p>
</li>
<li><p class="first">Make "<tt class="docutils literal">&lt;name&gt;_action()</tt>" call "<tt class="docutils literal">upstart_&lt;name&gt;_sync()</tt>", which
will be an auto-generated function (see below).</p>
<p>Example: "<tt class="docutils literal">reload_configuration_action()</tt>" calls
"<tt class="docutils literal">upstart_reload_configuration_sync()</tt>".</p>
</li>
<li><p class="first">Add a new D-Bus method corresponding to "<tt class="docutils literal">&lt;name&gt;</tt>" <em>in "camel-case"</em> to:</p>
<pre class="literal-block">dbus/com.ubuntu.Upstart.xml
</pre>
<p>Example: Add the following for the "<tt class="docutils literal"><span class="pre">reload-configuration</span></tt>" command:</p>
<pre class="literal-block">&lt;method name="ReloadConfiguration"&gt;
&lt;/method&gt;
</pre>
</li>
<li><p class="first">Add implementation to "<tt class="docutils literal">init/control.c</tt>" as "<tt class="docutils literal"><span class="pre">control_&lt;name&gt;()</span></tt>".</p>
<p>Example: add "<tt class="docutils literal">control_reload_configuration()</tt>".</p>
</li>
</ol>
</div>
<div class="section" id="adding-a-new-job-class-command">
<h3><a class="toc-backref" href="index.html#toc-entry-430">21.16.2&nbsp;&nbsp;&nbsp;Adding a New Job Class Command</a></h3>
<p>Process is as per <a class="reference internal" href="index.html#adding-a-new-non-job-command">Adding a new non-Job Command</a>, but rather than
modifying file "<tt class="docutils literal">dbus/com.ubuntu.Upstart.xml</tt>", you must modify file:</p>
<pre class="literal-block">dbus/com.ubuntu.Upstart.Job.xml
</pre>
<p>... and then add a function to "<tt class="docutils literal">init/job_class.c</tt>".</p>
</div>
<div class="section" id="adding-a-new-job-command">
<h3><a class="toc-backref" href="index.html#toc-entry-431">21.16.3&nbsp;&nbsp;&nbsp;Adding a New Job Command</a></h3>
<p>Process is as per <a class="reference internal" href="index.html#adding-a-new-non-job-command">Adding a new non-Job Command</a>, but rather than
modifying file "<tt class="docutils literal">dbus/com.ubuntu.Upstart.xml</tt>", you must modify file:</p>
<pre class="literal-block">dbus/com.ubuntu.Upstart.Instance.xml
</pre>
<p>... and then add a function to "<tt class="docutils literal">init/job.c</tt>".</p>
</div>
<div class="section" id="generating-the-d-bus-bindings">
<h3><a class="toc-backref" href="index.html#toc-entry-432">21.16.4&nbsp;&nbsp;&nbsp;Generating the D-Bus Bindings</a></h3>
<p>After following the steps above to add a new <tt class="docutils literal">initctl</tt> command, run
"<tt class="docutils literal">make</tt>" and observe the the <tt class="docutils literal"><span class="pre">nih-dbus-tool</span></tt> utility gets calls to
convert your XML definitions into auto-generated code:</p>
<pre class="literal-block">/usr/bin/nih-dbus-tool \
                --package=upstart \
                --mode=object --prefix=control \
                --default-interface=com.ubuntu.Upstart0_6 \
                --output=com.ubuntu.Upstart.c
../dbus/com.ubuntu.Upstart.xml
/usr/bin/nih-dbus-tool \
                --package=upstart \
                --mode=object --prefix=job_class \
                --default-interface=com.ubuntu.Upstart0_6.Job \
                --output=com.ubuntu.Upstart.Job.c
../dbus/com.ubuntu.Upstart.Job.xml
/usr/bin/nih-dbus-tool \
                --package=upstart \
                --mode=object --prefix=job \
                --default-interface=com.ubuntu.Upstart0_6.Instance \
                --output=com.ubuntu.Upstart.Instance.c
../dbus/com.ubuntu.Upstart.Instance.xml
</pre>
</div>
</div>
<div class="section" id="test-alloc-fail">
<h2><a class="toc-backref" href="index.html#toc-entry-433">21.17&nbsp;&nbsp;&nbsp;<tt class="docutils literal">TEST_ALLOC_FAIL</tt></a></h2>
<p>NIH provides a rather clever macro called <tt class="docutils literal">TEST_ALLOC_FAILED</tt>; it
accepts a code block and will execute that block 1 + <em>N</em> times where <em>N</em>
is the number of NIH memory allocation calls made within the block.</p>
<ul class="simple">
<li>The first time through, the macro counts the number of NIH allocation
calls.</li>
<li>Each subsequent time through, it causes the <em>N</em>th call to an NIH
memory allocation routine to fail.</li>
</ul>
<p>This exercises fully for example a function which returns a
newly-allocated object (and which may make any number of calls to the
NIH memory allocation routines).</p>
<p>Essentially, it ensures your handling of memory allocation failures are
correct.</p>
<div class="section" id="improved-test-example-for-a-new-foo-with-a-bug">
<h3><a class="toc-backref" href="index.html#toc-entry-434">21.17.1&nbsp;&nbsp;&nbsp;Improved Test Example for a New "foo" (with a bug)</a></h3>
<p>We can now modify our previous example to also use <tt class="docutils literal">TEST_ALLOC_FAIL</tt>.
Note that this version contains a bug! Can you spot it?:</p>
<pre class="literal-block">Foo  *foo;
char *str;

TEST_FEATURE ("put text here");

foo_init ();

TEST_ALLOC_FAIL {
    TEST_LIST_EMPTY (foos);

    str = nih_strdup (NULL, "hello");
    TEST_NE_P (str, NULL);

    foo = foo_new (str, "foo", 123);
    if (test_alloc_failed) {
        TEST_EQ_P (foo, NULL);
        continue;
    }

    TEST_LIST_NOT_EMPTY (foos);

    TEST_ALLOC_SIZE (foo, sizeof (Foo));
    TEST_EQ (foo-&gt;value, 123);
    TEST_EQ_STR (foo-&gt;name, "foo");

    nih_free (str);
}
</pre>
</div>
</div>
<div class="section" id="test-alloc-safe">
<h2><a class="toc-backref" href="index.html#toc-entry-435">21.18&nbsp;&nbsp;&nbsp;<tt class="docutils literal">TEST_ALLOC_SAFE</tt></a></h2>
<p>If you need to guarantee that particular memory allocations within the
<em>do not</em> fail, wrap those in a call to <tt class="docutils literal">TEST_ALLOC_SAFE</tt>:</p>
<pre class="literal-block">TEST_ALLOC_FAIL {
    TEST_ALLOC_SAFE {
        /* Memory allocations will work here */
    }

    /* Memory allocations will be sequentially FAILED here */
}
</pre>
<div class="section" id="final-test-example-for-a-new-foo">
<h3><a class="toc-backref" href="index.html#toc-entry-436">21.18.1&nbsp;&nbsp;&nbsp;Final Test Example for a New "foo"</a></h3>
<p>Using <tt class="docutils literal">TEST_ALLOC_FAIL</tt>, we can now fix the example to be:</p>
<pre class="literal-block">Foo  *foo;
char *str;

TEST_FEATURE ("put text here");

foo_init ();

TEST_ALLOC_FAIL {
    TEST_ALLOC_SAFE {
        TEST_LIST_EMPTY (foos);

        str = nih_strdup (NULL, "hello");
        TEST_NE_P (str, NULL);
    }

    foo = foo_new (str, "foo", 123);
    if (test_alloc_failed) {
        TEST_EQ_P (foo, NULL);
        continue;
    }

    TEST_LIST_NOT_EMPTY (foos);

    TEST_ALLOC_SIZE (foo, sizeof (Foo));
    TEST_EQ (foo-&gt;value, 123);
    TEST_EQ_STR (foo-&gt;name, "foo");

    nih_free (str);
}
</pre>
</div>
</div>
<div class="section" id="basic-debugging">
<h2><a class="toc-backref" href="index.html#toc-entry-437">21.19&nbsp;&nbsp;&nbsp;Basic Debugging</a></h2>
<p>Don't underestimate the usefulness of two very simple techniques:</p>
<ul class="simple">
<li><tt class="docutils literal">sudo strace <span class="pre">-p</span> 1 <span class="pre">-fFv</span> <span class="pre">-s</span> 1024</tt></li>
<li><tt class="docutils literal"><span class="pre">nih_fatal("\%s:\%d",</span> __func__, __LINE__);</tt></li>
</ul>
</div>
<div class="section" id="debugging-upstart-as-a-non-privileged-user">
<h2><a class="toc-backref" href="index.html#toc-entry-438">21.20&nbsp;&nbsp;&nbsp;Debugging Upstart as a Non-Privileged User</a></h2>
<p>With the right <a class="reference internal" href="index.html#command-line-options">command-line options</a>, it's possible to run Upstart as
a normal non-privileged user:</p>
<pre class="literal-block">$ make
$ mkdir /tmp/conf /tmp/log
$ cp *.conf /tmp/conf
$ gdb init/init --confdir /tmp/conf --logdir /tmp/log --no-sessions --session --debug
</pre>
<p>This is a useful technique but be aware that the behaviour of Upstart
running as a non-privileged user is slightly different to running it as
<tt class="docutils literal">root</tt> with PID 1.</p>
</div>
<div class="section" id="debugging-upstart-as-root">
<h2><a class="toc-backref" href="index.html#toc-entry-439">21.21&nbsp;&nbsp;&nbsp;Debugging Upstart as <tt class="docutils literal">root</tt></a></h2>
<p>It <em>is</em> in fact possible to debug <tt class="docutils literal">/sbin/init</tt> using <tt class="docutils literal">gdb</tt> as user
<tt class="docutils literal">root</tt> on a running system!</p>
<ul class="simple">
<li>Build upstart with <tt class="docutils literal"><span class="pre">-ggdb3</span></tt> and install to <tt class="docutils literal">/sbin/init.foo</tt> for
example.</li>
<li><tt class="docutils literal">sudo gdb /sbin/init.foo 1</tt></li>
</ul>
</div>
<div class="section" id="debug-tip-using-destructors">
<h2><a class="toc-backref" href="index.html#toc-entry-440">21.22&nbsp;&nbsp;&nbsp;Debug Tip Using Destructors</a></h2>
<p>If can be useful to register a custom destructor for your object as a
debug aid:</p>
<pre class="literal-block">int foo_destructor(void *ignored)
{
    /* Do something */
    return 1;
}

Foo *
foo_new (void *parent)
{
    Foo *foo = NIH_MUST (nih_new (parent, Foo));

    /* ... */

    /* Call foo_destructor when object is destroyed */
    nih_alloc_set_destructor (foo, foo_destructor);

    return foo;
}
</pre>
<p>Now, whenever a <tt class="docutils literal">Foo</tt> is freed, <tt class="docutils literal">foo_destructor()</tt> will be called.</p>
<p>Note that child objects of the <tt class="docutils literal">Foo</tt> object that <tt class="docutils literal">foo_destructor()</tt>
is being called for and the parent references and the object itself
<em>will</em> be freed - the destructor is for very specialist operations, such
as debugging.</p>
<div class="section" id="lists">
<h3><a class="toc-backref" href="index.html#toc-entry-441">21.22.1&nbsp;&nbsp;&nbsp;Lists</a></h3>
<p>Here's an example of using NIH lists:</p>
<pre class="literal-block">typedef struct bar {
    NihList  entry;
    char    *str;
} Bar;

int
main (int argc, char *argv[])
{
    int i;
    nih_local NihList *args = NULL;

    args = NIH_MUST (nih_list_new (NULL));

    /* store all arguments in a list */
    for (i = 1; i &lt; argc; ++i) {
        Bar *bar = NIH_MUST (nih_new (args, Bar));
        nih_list_init (&amp;bar-&gt;entry);
        bar-&gt;str = NIH_MUST (nih_strdup (bar, argv[i]));
        nih_list_add (args, &amp;bar-&gt;entry);
    }
    i = 1;

    /* display all arguments by iterating over list */
    NIH_LIST_FOREACH (args, iter) {
        Bar *bar = (Bar *)iter;
        nih_message ("argument %d='%s'", i, bar-&gt;str);
        ++i;
    }

    return (0);
}
</pre>
<ul class="simple">
<li>NIH lists are designed to be <em>embedded</em> within some other
structure.</li>
<li>Create a list dynamically using <tt class="docutils literal">nih_list_new()</tt>.</li>
<li>Initialize a static list using <tt class="docutils literal">nih_list_init()</tt>.</li>
<li>Add one list to another using <tt class="docutils literal">nih_list_add()</tt>.</li>
<li>Iterate a list using <tt class="docutils literal">NIH_LIST_FOREACH()</tt>.</li>
</ul>
<p>See file: <tt class="docutils literal"><span class="pre">nih/list.[ch]</span></tt></p>
<div class="section" id="removing-elements-from-a-list">
<h4><a class="toc-backref" href="index.html#toc-entry-442">21.22.1.1&nbsp;&nbsp;&nbsp;Removing Elements from a List</a></h4>
<p>An example showing how to remove an element from a list:</p>
<pre class="literal-block">NihList      *entry_list;
NihListEntry *entry;

entry_list = NIH_MUST (nih_list_new (NULL));

entry = NIH_MUST (nih_list_entry_new (entry_list));
entry-&gt;str = NIH_MUST (nih_strdup (entry, "hello"));
nih_list_add (entry_list, &amp;entry-&gt;entry);

entry = NIH_MUST (nih_list_entry_new (entry_list));
entry-&gt;str = NIH_MUST (nih_strdup (entry, "world"));
nih_list_add (entry_list, &amp;entry-&gt;entry);

entry = (NihListEntry *)nih_list_remove (entry_list);
nih_free (entry_list);
</pre>
<p>Freeing <tt class="docutils literal">entry_list</tt> frees the "<tt class="docutils literal">hello`" *and* the "`world`" entries
since although the <span class="pre">"``world</span></tt>" entry was removed from its containing list, we did
<em>NOT</em> break the reference between that entry and its parent (<tt class="docutils literal">entry_list</tt>).</p>
<p>If we had wanted to break the reference, we could have used
<tt class="docutils literal">nih_ref()</tt> and <tt class="docutils literal">nih_unref()</tt> to:</p>
<ul class="simple">
<li>Add a reference for this entry to a new parent.</li>
<li>Remove the existing reference between <tt class="docutils literal">entry_list</tt> and the entry.</li>
</ul>
<p>Another method for removing an entry from a list is whilst iterating it:</p>
<pre class="literal-block">NIH_LIST_FOREACH_SAFE (entry_list, iter) {
    NihListEntry *entry = (NihListEntry *)iter;
    nih_free (entry);
}
</pre>
<ul class="simple">
<li>Note that we are now using . Do <em>NOT</em> attempt to remove a list entry
whilst iterating a list using .</li>
<li>It is <em>NOT</em> allowed to iterate a list <em>whilst it is already being
iterated</em>. Therefore, you need to be <em>very</em> careful that your
function is not being called from within a foreach-loop.</li>
</ul>
</div>
<div class="section" id="moving-an-element-between-lists">
<h4><a class="toc-backref" href="index.html#toc-entry-443">21.22.1.2&nbsp;&nbsp;&nbsp;Moving an Element Between Lists</a></h4>
<p>An example showing moving an element from one list to another:</p>
<pre class="literal-block">NihList      *list1;
NihList      *list2;
NihListEntry *entry;

list1 = NIH_MUST (nih_list_new (NULL));
list2 = NIH_MUST (nih_list_new (NULL));

/* Create entry and add to list1 */
entry = NIH_MUST (nih_list_entry_new (list1));
nih_list_add (list1, &amp;entry-&gt;entry);

/* Fully move entry to list2 */
nih_list_add (list2, &amp;entry-&gt;entry);
nih_ref (entry, list2);
nih_unref (entry, list1);

/* Frees list1, but not entry */
nih_free (list1);

/* Frees list2 AND entry */
nih_free (list2);
</pre>
</div>
</div>
<div class="section" id="hashes">
<h3><a class="toc-backref" href="index.html#toc-entry-444">21.22.2&nbsp;&nbsp;&nbsp;Hashes</a></h3>
<p>NIH Hashes are actually "hashed lists" (essentially arrays of lists):</p>
<pre class="literal-block">NihHash *
nih_hash_new (const void      *parent,
              size_t           entries,
              NihKeyFunction   key_function,
              NihHashFunction  hash_function,
              NihCmpFunction   cmp_function);
</pre>
<p>However, the more common way to create a hash is via:</p>
<pre class="literal-block">typedef struct foo {
    NihList  entry;
    char    *name;
} Foo;

/**
 * foos:
 * List of all foos. &lt;&lt; XXX: more details here &gt;&gt;
 **/
NihHash *foos;

/**
 * Initilise the foos hash.
 */
void foo_init (void)
{
    if (! foos)
        foos = NIH_MUST (nih_hash_string_new (NULL, 0));
}

Foo *
foo_new (void *parent, const char *name)
{
    Foo *foo;

    assert (name);
    foo_init (); /* initialise the subsystem */

    /* create the object */
    foo = NIH_MUST (nih_new (parent, Foo));

    /* initialise the embedded _list_ */
    nih_list_init (&amp;foo-&gt;entry);

    nih_hash_add (foos, &amp;foo-&gt;entry);

    return foo;
}
</pre>
<div class="section" id="using-hashes">
<h4><a class="toc-backref" href="index.html#toc-entry-445">21.22.2.1&nbsp;&nbsp;&nbsp;Using Hashes</a></h4>
<p>To iterate a hash, use <tt class="docutils literal">NIH_HASH_FOREACH()</tt>:</p>
<pre class="literal-block">NIH_HASH_FOREACH (foos, iter) {
    Foo *foo = (Foo *)iter;

    /* do something with foo */
}
</pre>
<p>To find an entry in a hash, use <tt class="docutils literal">nih_hash_lookup()</tt>:</p>
<pre class="literal-block">Foo *foo;

foo = (Foo *)nih_hash_lookup (foos, "hello");
if (foo) {
    /* ... */
}
</pre>
<p>Alternatively, if there are <em>multiple</em> entries for a particular "hash
bucket", use <tt class="docutils literal">nih_hash_search()</tt>.</p>
<p>See: <tt class="docutils literal"><span class="pre">nih/hash.[ch]</span></tt></p>
</div>
<div class="section" id="nih-hash-string-new">
<h4><a class="toc-backref" href="index.html#toc-entry-446">21.22.2.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">nih_hash_string_new()</tt></a></h4>
<p><tt class="docutils literal"><span class="pre">nih_hash_string_new()``is</span> "magic" *BUT* to use it *the first structure
element **after** the element **must** be a <span class="pre">"``char</span> *</tt>" that will uniquely
represent that hash entry*.</p>
<p>If a simple string is not sufficient for your purposes, you will need to
use <tt class="docutils literal">nih_hash_new()</tt> and will also have to specify the
<tt class="docutils literal">NihKeyFunction</tt>, <tt class="docutils literal">NihHashFunction</tt> and <tt class="docutils literal">NihCmpFunction</tt>.</p>
<p>Analogous to <tt class="docutils literal">NIH_LIST_FOREACH_SAFE</tt>, there is also a
<tt class="docutils literal">NIH_HASH_FOREACH_SAFE</tt> facility for removing hash entries whilst
iterating the hash.</p>
</div>
</div>
<div class="section" id="trees">
<h3><a class="toc-backref" href="index.html#toc-entry-447">21.22.3&nbsp;&nbsp;&nbsp;Trees</a></h3>
<p>A basic example of NIH trees:</p>
<pre class="literal-block">typedef struct foo {
    NihTree node;
    int     value;
} Foo;

NihTree *tree;
Foo     *foo;

tree = NIH_MUST (nih_tree_new (NULL));
foo = NIH_MUST (nih_new (tree, Foo));
nih_tree_init (&amp;foo-&gt;node);
foo-&gt;value = 123;

nih_tree_add (tree, &amp;foo-&gt;entry, NIH_TREE_LEFT);
</pre>
<p>To iterate a tree:</p>
<ul class="simple">
<li><tt class="docutils literal">NIH_TREE_FOREACH()</tt> (in-order traversal)</li>
<li><tt class="docutils literal">NIH_TREE_FOREACH_PRE()</tt> (pre-order traversal)</li>
<li><tt class="docutils literal">NIH_TREE_FOREACH_POST()</tt> (post-order traversal)</li>
</ul>
<p>See: <tt class="docutils literal"><span class="pre">nih/tree.[ch]</span></tt></p>
<p>Example of iterating a tree using in-order traversal:</p>
<pre class="literal-block">NIH_TREE_FOREACH (tree, iter) {
    Foo *foo = (Foo *)iter;
    /* ... */
}
</pre>
</div>
<div class="section" id="avoiding-problems">
<h3><a class="toc-backref" href="index.html#toc-entry-448">21.22.4&nbsp;&nbsp;&nbsp;Avoiding Problems</a></h3>
<p>What's wrong with this code?:</p>
<pre class="literal-block">/* XXX: this code is incorrect! */
void foo (const char *string)
{
    nih_local char *str;
    nih_assert (string);

    if (! strcmp ("foo", string)) {
        str = NIH_MUST (nih_strdup (NULL, "bar"));
        bar (str);
    }
}
</pre>
<p>The problem here is that <tt class="docutils literal">str</tt> is not always assigned a value, so if
<tt class="docutils literal">string</tt> is not <tt class="docutils literal">foo</tt>, the results of this function are undefined -
it could result in a crash!!</p>
<p>The example below contains two memory leaks:</p>
<pre class="literal-block">NihList      *entry_list;
NihListEntry *entry;

entry_list = NIH_MUST (nih_list_new (NULL));

entry = NIH_MUST (nih_list_entry_new (NULL));
entry-&gt;str = NIH_MUST (nih_strdup (NULL, "hello"));
nih_list_add (entry_list, &amp;entry-&gt;entry);

nih_free (entry_list);
</pre>
<ul class="simple">
<li><tt class="docutils literal">entry</tt> is <em>not</em> freed. To resolve, either:<ul>
<li>Make its parent pointer non-<tt class="docutils literal">NULL</tt> (recommended).</li>
<li>Call <tt class="docutils literal">nih_free()</tt>.</li>
</ul>
</li>
<li><tt class="docutils literal"><span class="pre">entry-&gt;str</span></tt> is <em>not</em> freed. To resolve, either:<ul>
<li>Set its parent pointer to <tt class="docutils literal">entry</tt> (recommended).</li>
<li>Call <tt class="docutils literal">nih_free <span class="pre">(entry-&gt;str)</span></tt>.</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="debugger-magic">
<h2><a class="toc-backref" href="index.html#toc-entry-449">21.23&nbsp;&nbsp;&nbsp;Debugger Magic</a></h2>
<p>Debugging in <a class="reference external" href="http://www.gnu.org/software/gdb/">gdb</a> initially seems rather difficult, but you just need
to know the right tricks. The complication comes from the fact that
Upstart uses the <a class="reference external" href="http://launchpad.net/libnih">NIH Utility Library</a>, which uses macros (such as
<tt class="docutils literal">NIH_LIST_FOREACH</tt> and <tt class="docutils literal">NIH_HASH_FOREACH</tt>) for performance.</p>
<p>However, how do you access a data structure such as an <a class="reference internal" href="index.html#nihlist">NihList</a> whose
only method of iteration is a macro? Like this:</p>
<div class="section" id="nihlist">
<h3><a class="toc-backref" href="index.html#toc-entry-450">21.23.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">NihList</tt></a></h3>
<pre class="literal-block"># first entry
(gdb) print *(JobClass *)job_classes-&gt;next

# 2nd entry
(gdb) print *(JobClass *)job_classes-&gt;next-&gt;next

# 3rd entry
(gdb) print *(JobClass *)job_classes-&gt;next-&gt;next-&gt;next

# ConfSource NihWatch for 1st entry in conf_sources list
(gdb) print *((ConfSource *)conf_sources-&gt;next)-&gt;watch
</pre>
</div>
<div class="section" id="nihhash">
<h3><a class="toc-backref" href="index.html#toc-entry-451">21.23.2&nbsp;&nbsp;&nbsp;<tt class="docutils literal">NihHash</tt></a></h3>
<pre class="literal-block"># size of JobClass-&gt;instances hash list
# XXX: this is the capacity, *NOT* the number of entries!
print class-&gt;instances-&gt;size

# first entry in job_classes global hash
print *(JobClass *)job_classes-&gt;bins-&gt;next
</pre>
</div>
<div class="section" id="nih-iterators">
<h3><a class="toc-backref" href="index.html#toc-entry-452">21.23.3&nbsp;&nbsp;&nbsp;<tt class="docutils literal">nih_iterators</tt></a></h3>
<p>Alternatively, you can make use of the "unofficial" <a class="reference external" href="http://people.canonical.com/~jhunt/nih/nih_iterators.c">NIH Iterators</a>
which provide functional versions of the standard NIH macros and a few
extras. Note that these are <em>ONLY</em> for testing and debugging!</p>
<ul>
<li><p class="first"><tt class="docutils literal">nih_list_foreach()</tt>:</p>
<pre class="literal-block">/**
 * nih_list_foreach:
 *
 * @list: list,
 * @len: optional output parameter that will contain length of list,
 * @handler: optional function called for each list entry,
 * @data: optional data to pass to handler along with list entry.
 *
 * Iterate over specified list.
 *
 * One of @len or @handler may be NULL.
 * If @handler is NULL, list length will still be returned in @len.
 * If @handler returns 1, @len will be set to the number of list entries
 * processed successfully up to that point.
 *
 * Returns: 0 on success, or -1 if handler returns an error.
 **/
int
nih_list_foreach (const NihList *list, size_t *len, NihListHandler handler, void *data);
</pre>
</li>
<li><p class="first"><tt class="docutils literal">nih_hash_foreach()</tt>:</p>
<pre class="literal-block">/**
 * nih_hash_foreach:
 *
 * @hash: hash,
 * @len: optional output parameter that will contain count of hash entries,
 * @handler: optional function called for each hash entry,
 * @data: optional data to pass to handler along with hash entry.
 *
 * Iterate over specified hash.
 *
 * One of @len or @handler may be NULL.
 * If @handler is NULL, count of hash entries will still be returned in @len.
 * If @handler returns 1, @len will be set to the number of hash entries
 * processed successfully up to that point.
 *
 * Returns: 0 on success, or -1 if handler returns an error.
 **/
int
nih_hash_foreach (const NihHash *hash, size_t *len,
            NihListHandler handler, void *data);
</pre>
</li>
<li><p class="first"><tt class="docutils literal">nih_tree_foreach()</tt>:</p>
<pre class="literal-block">/**
 * nih_tree_foreach:
 *
 * @tree: tree,
 * @len: optional output parameter that will contain count of tree nodes,
 * @handler: optional function called for each tree node,
 * @data: optional data to pass to handler along with tree node.
 *
 * Iterate over specified tree.
 *
 * One of @len or @handler may be NULL.
 * If @handler is NULL and @len is non-NULL, count of tree nodes will
 * still be returned in @len.
 * If @handler returns 1, @len will be set to the number of tree nodes
 * processed successfully up to that point.
 *
 * Returns: 0 on success, or -1 if handler returns an error.
 **/
int
nih_tree_foreach (NihTree *tree, size_t *len,
            NihTreeFilter handler, void *data);
</pre>
</li>
</ul>
<p>These routines allow us to also provide trivial implementations of the
following convenience functions:</p>
<ul class="simple">
<li><tt class="docutils literal">nih_list_count()</tt></li>
<li><tt class="docutils literal">nih_hash_count()</tt></li>
<li><tt class="docutils literal">nih_tree_count()</tt></li>
</ul>
</div>
</div>
<div class="section" id="development-utilities">
<h2><a class="toc-backref" href="index.html#toc-entry-453">21.24&nbsp;&nbsp;&nbsp;Development Utilities</a></h2>
<div class="section" id="upstart-menu-sh">
<h3><a class="toc-backref" href="index.html#toc-entry-454">21.24.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">upstart_menu.sh</tt></a></h3>
<p>The <a class="reference internal" href="index.html#upstart-menu">upstart-menu</a> utility allows <tt class="docutils literal">/sbin/init</tt> versions you wish
to boot with to be selected using a friendly menu. You can also select a
shell. <tt class="docutils literal">upstart_menu.sh</tt> scans <tt class="docutils literal">/sbin/</tt> for <tt class="docutils literal">init</tt> version and
presents a list, most recently modified version first:</p>
<div class="figure align-center">
<img alt="upstart menu main screen" src="https://storage.googleapis.com/chromium-website-lob-storage/074446409a0abdab70e6b410a2fdfe73aaf6d89d" style="width: 360.0px; height: 200.0px;">
<p class="caption">Main screen of <tt class="docutils literal">upstart_menu.sh</tt>.</p>
</div>
<p>The utility also allows you to specify options (it automatically shows
you a list of available options for the version of the program you have
selected):</p>
<div class="figure align-center">
<img alt="upstart menu options screen" src="https://storage.googleapis.com/chromium-website-lob-storage/9b9ed176718cb097312bc3072b4700368a712ddd" style="width: 360.0px; height: 200.0px;">
<p class="caption"><tt class="docutils literal">upstart_menu.sh</tt> showing the options screen.</p>
</div>
<div class="section" id="enabling-upstart-menu-sh-debian-and-ubuntu-specific">
<h4><a class="toc-backref" href="index.html#toc-entry-455">21.24.1.1&nbsp;&nbsp;&nbsp;Enabling <tt class="docutils literal">upstart_menu.sh</tt> <img alt="D" class="debian-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/4926319605052bdf09442836fd8d799b236e5db8"> , <img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719"></a></h4>
<p>To enable <tt class="docutils literal">upstart_menu.sh</tt>:</p>
<ol class="arabic simple">
<li>Copy file to <tt class="docutils literal">/sbin/upstart_menu.sh</tt>.</li>
<li>Make the file executable.</li>
<li>Update <tt class="docutils literal">/etc/default/grub</tt> such that <tt class="docutils literal">GRUB_CMDLINE_LINUX</tt> is modified to:<ul>
<li>Remove "<tt class="docutils literal">quiet</tt>" and "<tt class="docutils literal">splash</tt>".</li>
<li>Add "<tt class="docutils literal"><span class="pre">init=/sbin/upstart_menu.sh</span></tt>".</li>
</ul>
</li>
<li>Update grub: "<tt class="docutils literal">sudo <span class="pre">update-grub</span></tt>".</li>
<li>Reboot!</li>
</ol>
</div>
</div>
</div>
<div class="section" id="gotchas">
<h2><a class="toc-backref" href="index.html#toc-entry-456">21.25&nbsp;&nbsp;&nbsp;Gotchas</a></h2>
<ul class="simple">
<li>Passing <tt class="docutils literal">NULL</tt> to <tt class="docutils literal">nih_free()</tt>: unlike <tt class="docutils literal">free(3)</tt>, <tt class="docutils literal">nih_free()</tt>
<strong>does not</strong> allow a <tt class="docutils literal">NULL</tt> parameter.</li>
<li>Running <tt class="docutils literal">make check</tt> as <tt class="docutils literal">root</tt> (tests <em>will</em> fail).</li>
<li>Debugging a failing memory-checking test by littering test code with
calls to <tt class="docutils literal">nih_debug()</tt>... which calls <tt class="docutils literal">nih_alloc()</tt>.</li>
<li>Forgetting to install either <tt class="docutils literal">/sbin/init</tt> or <tt class="docutils literal">/sbin/initctl</tt>
when you modify the D-Bus interface to Upstart (if you're lucky,
you'll get a crash, else very odd behaviour! :-)</li>
<li>Not checking for existing <tt class="docutils literal">init</tt> and <tt class="docutils literal">test_*</tt> processes
still running from a previous failed test run when you run
<tt class="docutils literal">make check</tt>.</li>
</ul>
</div>
</div>
<div class="section" id="known-issues">
<h1><a class="toc-backref" href="index.html#toc-entry-457">22&nbsp;&nbsp;&nbsp;Known Issues</a></h1>
<div class="section" id="restarting-jobs-with-complex-conditions">
<h2><a class="toc-backref" href="index.html#toc-entry-458">22.1&nbsp;&nbsp;&nbsp;Restarting Jobs with Complex Conditions</a></h2>
<p>The <tt class="docutils literal">and</tt> and <tt class="docutils literal">or</tt> operators allowed with <tt class="docutils literal">start on</tt> and <tt class="docutils literal">stop on</tt>
do not work intuitively: operands to the right of either operator are only
evaluated when the specified event is emitted. This can lead to jobs with
complex <tt class="docutils literal">start on</tt> or <tt class="docutils literal">stop on</tt> conditions not behaving as expected
when restarted. For example, if a job specifies the following condition:</p>
<pre class="literal-block">start on A and (B or C)
</pre>
<p>When the events "<tt class="docutils literal">A</tt>" and "<tt class="docutils literal">B</tt>" are emitted, the condition is
satisfied so the job will be run. If the job fails to start, or is
stopped later, there is no guarantee that "<tt class="docutils literal">A</tt>" will be emitted again,
and the fact that it happened before <strong>is no longer known to Upstart</strong>.
Meanwhile, events "<tt class="docutils literal">C</tt>" or "<tt class="docutils literal">B</tt>" may occur, but the job will <em>not</em>
be transitioned back to a start goal, until event "<tt class="docutils literal">A</tt>" is emitted
again.</p>
<div class="section" id="advice">
<h3><a class="toc-backref" href="index.html#toc-entry-459">22.1.1&nbsp;&nbsp;&nbsp;Advice</a></h3>
<p>To minimise the risk of being affected by this issue, avoid using complex
conditions with jobs which need to be restarted.</p>
</div>
</div>
<div class="section" id="using-expect-with-script-sections">
<h2><a class="toc-backref" href="index.html#toc-entry-460">22.2&nbsp;&nbsp;&nbsp;Using <tt class="docutils literal">expect</tt> with <tt class="docutils literal">script</tt> sections</a></h2>
<p>Using the <a class="reference internal" href="index.html#expect">expect</a> stanza with a job that uses a <tt class="docutils literal">script</tt> section
will lead to trouble if your script spawns any processes (likely!).
Consider:</p>
<pre class="literal-block">expect fork
respawn
script
  ARGS=$(cat /etc/default/grub)
  exec echo "ARGS=$ARGS" &gt; /tmp/myjob.log
end script
</pre>
<p>This job configuration file is somewhat nonsensical, but it does
demonstrate the problem. The main issue here is that by specifying
<a class="reference internal" href="index.html#expect-fork">expect fork</a>, Upstart will attempt to follow <em>only</em> the <strong>first</strong>
<a class="reference external" href="http://manpages.ubuntu.com/manpages/man2/fork.2.html">fork(2)</a> call. The first process that this job will spawn is...
<a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/cat.1.html">cat(1)</a>, <em>NOT</em> <tt class="docutils literal">echo</tt>. As such, starting the job will show something
like this:</p>
<pre class="literal-block"># start myjob
myjob start/running, process 12345
# status myjob
myjob start/running, process 12345
# ps --no-headers -p 12345
# kill 12345
-su: kill: (12345) - No such process
</pre>
<p>As the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man1/ps.1.html">ps(1)</a> call shows, the (<tt class="docutils literal">cat</tt>) process is no longer running,
but Upstart thinks it is.</p>
<p>Unfortunately, since Upstart will wait forever until it is able to stop
the pid (which no longer exits). A manual attempt to either "<tt class="docutils literal">stop
myjob</tt>" or "<tt class="docutils literal">start myjob</tt>" will also hang.</p>
<p>The only solution to clear this "stuck job" is to reboot. See
<a class="footnote-reference" href="index.html#stuck-job-bug" id="footnote-reference-38">[22]</a> and <a class="reference internal" href="index.html#recovery-on-misspecification-of-expect">Recovery on Misspecification of expect</a>. Note
that this "zombie job" isn't actually causing any problems for Upstart,
but it is annoying and potentially confusing seeing it listed in
<a class="reference internal" href="index.html#initctl">initctl</a> output. It will of course also be consuming a very small
amount of memory.</p>
<p>Note however, that if you are working on a development system (hopefully
you <em>are</em> whilst developing your <a class="reference internal" href="index.html#job-configuration-file">job configuration file</a>!), what you
<em>can</em> do to keep working is to copy the problematic <a class="reference internal" href="index.html#job-configuration-file">job configuration
file</a> to a new name, ignore the old job entirely and keep working using
the new job!</p>
</div>
<div class="section" id="bugs">
<h2><a class="toc-backref" href="index.html#toc-entry-461">22.3&nbsp;&nbsp;&nbsp;Bugs</a></h2>
<dl class="docutils">
<dt><a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> bugs</dt>
<dd><a class="reference external" href="https://bugs.launchpad.net/upstart">https://bugs.launchpad.net/upstart</a></dd>
<dt>Ubuntu-specific <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> bugs</dt>
<dd><a class="reference external" href="https://launchpad.net/ubuntu/+source/upstart/+bugs">https://launchpad.net/ubuntu/+source/upstart/+bugs</a></dd>
</dl>
</div>
</div>
<div class="section" id="support">
<h1><a class="toc-backref" href="index.html#toc-entry-462">23&nbsp;&nbsp;&nbsp;Support</a></h1>
<p>The primary sources of support are:</p>
<ul>
<li><p class="first">The IRC Channel
<tt class="docutils literal">#upstart</tt> on IRC server <tt class="docutils literal">freenode.net</tt>.</p>
<p>If you don't get a response, consider posting to the <a class="reference internal" href="index.html#mailing-list">Mailing List</a>.</p>
</li>
<li><p class="first">The <a class="reference internal" href="index.html#mailing-list">Mailing List</a></p>
<p>If you don't get a response, consider raising a bug. See <a class="reference internal" href="index.html#coverage">Coverage</a>
to determine how to report bugs and ask questions.</p>
</li>
</ul>
</div>
<div class="section" id="references">
<h1><a class="toc-backref" href="index.html#toc-entry-463">24&nbsp;&nbsp;&nbsp;References</a></h1>
<div class="section" id="manual-pages">
<h2><a class="toc-backref" href="index.html#toc-entry-464">24.1&nbsp;&nbsp;&nbsp;Manual Pages</a></h2>
<dl class="docutils">
<dt><a class="reference external" href="http://manpages.ubuntu.com/manpages/man5/init.5.html">man 5 init</a></dt>
<dd>Configuration syntax reference.</dd>
<dt><a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/init.8.html">man 8 init</a></dt>
<dd>Options for running the Upstart init daemon.</dd>
<dt><a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/initctl.8.html">man 8 initctl</a></dt>
<dd>Explanation of the Upstart control command.</dd>
<dt><a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/upstart-events.7.html">man 7 upstart-events</a> <img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719"></dt>
<dd>Comprehensive summary of all "well-known" Upstart system events on Ubuntu.</dd>
</dl>
</div>
<div class="section" id="web-sites">
<h2><a class="toc-backref" href="index.html#toc-entry-465">24.2&nbsp;&nbsp;&nbsp;Web Sites</a></h2>
<dl class="docutils">
<dt><a class="reference external" href="http://upstart.ubuntu.com/">http://upstart.ubuntu.com/</a></dt>
<dd>Main <a class="reference external" href="http://www.ubuntu.com/">Ubuntu</a> page for <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a>.</dd>
<dt><a class="reference external" href="http://launchpad.net/upstart">http://launchpad.net/upstart</a></dt>
<dd>The main <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> <a class="reference external" href="http://bzr.launchpad.net/">Bazaar</a> project page.</dd>
<dt><a class="reference external" href="http://netsplit.com/category/tech/upstart/">http://netsplit.com/category/tech/upstart/</a></dt>
<dd>Scotts Original Upstart blog with useful overviews of features and Concepts.</dd>
<dt><a class="reference external" href="https://wiki.ubuntu.com/ReplacementInit">https://wiki.ubuntu.com/ReplacementInit</a></dt>
<dd>Original Specification.</dd>
</dl>
</div>
<div class="section" id="mailing-list">
<h2><a class="toc-backref" href="index.html#toc-entry-466">24.3&nbsp;&nbsp;&nbsp;Mailing List</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://lists.ubuntu.com/mailman/listinfo/upstart-devel">https://lists.ubuntu.com/mailman/listinfo/upstart-devel</a></li>
</ul>
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<!-- FOOTER -->
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<span class="target" id="start-stop-daemon-8"></span><!-- _ man 8 start-stop-daemon: http://manpages.ubuntu.com/manpages/man8/start-stop-daemon.8.html -->
</div>
</div>
<div class="section" id="answers-to-test">
<h1><a class="toc-backref" href="index.html#toc-entry-467">25&nbsp;&nbsp;&nbsp;Answers to Test</a></h1>
<table class="docutils footnote" frame="void" id="test-question-1" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-24">[1]</a></td><td>Yes.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="test-question-2" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-25">[2]</a></td><td><tt class="docutils literal">initctl <span class="pre">show-config</span> <span class="pre">-e</span></tt>. See <a class="reference internal" href="index.html#initctl-show-config">initctl show-config</a>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="test-question-3" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-26">[3]</a></td><td>Job would start "as early as possible": when the
<tt class="docutils literal">startup</tt> event is emitted (see <a class="reference internal" href="index.html#startup-process">Startup Process</a>). It would
<em>also</em> be run if the confusingly-named job called "<tt class="docutils literal">stopped</tt>" begun
to start (see <a class="reference internal" href="index.html#starting-a-job">Starting a Job</a>). It would also be run <em>again</em> if the also
confusingly-named job "<tt class="docutils literal">started</tt>" begun to stop (see <a class="reference internal" href="index.html#stopping-a-job">Stopping a
Job</a>). The example chose names that were designed to be confusing.
Clearly, in reality you should only create jobs with sensible names
that refer to the application they run.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="test-question-4" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-27">[4]</a></td><td>Three times.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="test-question-5" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-28">[5]</a></td><td>Yes. However, it appears that the person who
specified this condition failed to read <a class="reference external" href="http://manpages.ubuntu.com/manpages/man5/init.5.html">init(5)</a> since it probably
won't do what they expect!</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="test-question-6" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-29">[6]</a></td><td>The <tt class="docutils literal">not</tt> event.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="test-question-7" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-30">[7]</a></td><td>Here, <tt class="docutils literal">foo</tt> is the <em>value</em> of the first positional
environment variable specified by the <tt class="docutils literal">not</tt> event. Upstart treats
it as a value since no equals sign is present. This is a convenience
since it allows for a more compact (and at times) natural way to
specify the <a class="reference internal" href="index.html#start-on">start on</a> condition. For example, rather than having
to specify "<tt class="docutils literal">start on started JOB=foo</tt>" you can specify the more
natural <tt class="docutils literal">start on started foo</tt>. For full details see <a class="reference external" href="http://manpages.ubuntu.com/manpages/man5/init.5.html">init(5)</a>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="test-question-8" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-31">[8]</a></td><td>You could trigger the job to start by calling
"<tt class="docutils literal">initctl emit not BLAH_BOING_WOBBLE=foo</tt>", but you could equally
start the job by calling "<tt class="docutils literal">initctl emit not FIRST_PARAM=foo</tt>".</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="test-question-9" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-32">[9]</a></td><td><tt class="docutils literal">/tmp</tt> is not mounted.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="test-question-10" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-33">[10]</a></td><td><p class="first">Short answer: "<tt class="docutils literal">/usr/bin/myapp</tt>" will <em>never</em> run.  Long
answer: This job attempts to only start <tt class="docutils literal">myapp</tt> if it is not disabled
by checking its configuration file. However, there are two fatal flaws
here:</p>
<ul class="simple">
<li>The <a class="reference internal" href="index.html#script">script</a> section does not handle the scenario where
<tt class="docutils literal">/etc/default/myapp</tt> does not exist. If it doesn't exist, the script
will <em>immediately exit</em> causing the job to fail to start.  See
<a class="reference internal" href="index.html#debugging-a-script-which-appears-to-be-behaving-oddly">Debugging a Script Which Appears to be Behaving Oddly</a> to understand
why.</li>
<li>Even if the <tt class="docutils literal">/etc/default/myapp</tt> configuration file exists, the job
will fail due to the use of <a class="reference internal" href="index.html#expect-fork">expect fork</a> and <a class="reference internal" href="index.html#respawn">respawn</a> with a
<a class="reference internal" href="index.html#script">script</a> section.</li>
</ul>
<p>A corrected version of the <a class="reference internal" href="index.html#job-configuration-file">Job Configuration File</a> is:</p>
<pre class="literal-block">start on runlevel [2345]

env CONFIG=/etc/default/myapp

expect fork
respawn

pre-start
  [ -f "$CONFIG" ] || stop &amp;&amp; exit 0
  enabled=$(grep ENABLED=1 $CONFIG || :)
  [ -z "$enabled" ] &amp;&amp; exit 0
end script

exec /usr/bin/myapp
</pre>
<p>Or, if you need to pass options from the config file to the daemon, you
could say:</p>
<pre class="literal-block">start on runlevel [2345]

env CONFIG=/etc/default/myapp

expect fork
respawn

pre-start
  [ -f "$CONFIG" ] || stop &amp;&amp; exit 0
  enabled=$(grep ENABLED=1 $CONFIG || :)
  [ -z "$enabled" ] &amp;&amp; exit 0
end script

script
  . $CONFIG
  exec myapp $MYAPP_OPTIONS
end script
</pre>
<p class="last">Note how the config file is sourced in the <a class="reference internal" href="index.html#script">script</a> section and how we
specify the shell keyword <tt class="docutils literal">exec</tt> to ensure no sub-shell is created
(thus allowing Upstart to track the correct PID).</p>
</td></tr>
</tbody>
</table>
</div>
<div class="section" id="footnotes">
<h1><a class="toc-backref" href="index.html#toc-entry-468">26&nbsp;&nbsp;&nbsp;Footnotes</a></h1>
<table class="docutils footnote" frame="void" id="tell-upstart-disk-writeable" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-18">[11]</a></td><td>Recall that Upstart has no knowledge
of disks whatsoever. In Ubuntu, it relies upon <a class="reference internal" href="index.html#mountall-debian-and-ubuntu-specific">mountall
(debian-and-ubuntu-specific)</a> to handle mounting of disks.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="lxc-note" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-37">[12]</a></td><td>Note the method for obtaining the PID of the instance of
Upstart running in the <a class="reference external" href="http://lxc.sourceforge.net/">LXC</a> container assumes only one other
container is running.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="link-to-bin-sh" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-34">[13]</a></td><td>Note that some shells (including <a class="reference external" href="http://www.gnu.org/software/bash/">Bash</a>) change
their behaviour if invoked as <tt class="docutils literal">/bin/sh</tt>. Consult your shells
documentation for specifics.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="using-sudo" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-3">[14]</a></td><td><p class="first">Commands to be run as root directly for clarity.
However, you should consider using <a class="reference external" href="http://manpages.ubuntu.com/manpages/man8/sudo.8.html">sudo(8)</a> rather than running a
root shell. Due to the way sudo works, you have to modify your behaviour
slightly. For example, rather than running the following in a root
shell:</p>
<pre class="literal-block"># echo hello &gt; /tmp/root.txt
</pre>
<p>You would instead run the command below in a <strong>non-root</strong> shell:</p>
<pre class="literal-block">$ echo hello | sudo tee /tmp/root.txt
</pre>
<p class="last">Note that you should not use <cite>sudo</cite> <em>within</em> a job. See <a class="reference internal" href="index.html#changing-user">Changing User</a>.</p>
</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="a" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-5">[15]</a></td><td>If there is a <tt class="docutils literal">script</tt> or <tt class="docutils literal">exec</tt> section and this process is
running, state will be <tt class="docutils literal"><span class="pre">pre-stop</span></tt>, else it will be <tt class="docutils literal">stopping</tt>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="use-of-exec-in-dbus-job" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-20">[16]</a></td><td>Note that the <tt class="docutils literal">exec</tt> line is taken directly
from the <tt class="docutils literal">org.freedesktop.ConsoleKit.service</tt> file.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="upstart-written-for-ubuntu" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-1">[17]</a></td><td><a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> was written specifically for
<a class="reference external" href="http://www.ubuntu.com/">Ubuntu</a>, although this does not mean that it cannot run on any other
Linux-based system. <a class="reference external" href="http://upstart.ubuntu.com/">Upstart</a> was first introduced into <a class="reference external" href="http://www.ubuntu.com/">Ubuntu</a> in
release 6.10 ("Edgy Eft"). See <a class="reference external" href="http://www.ubuntu.com/news/610released">http://www.ubuntu.com/news/610released</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ubuntu-specific-config" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-12">[18]</a></td><td>This section of the document contains
Ubuntu-specific examples of events.  Other operating systems which use Upstart
may not implement the same behaviour.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="networkservices" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label">[19]</td><td><em>(<a class="fn-backref" href="index.html#footnote-reference-14">1</a>, <a class="fn-backref" href="index.html#footnote-reference-15">2</a>)</em> This job is not actually available in Ubuntu yet, but is expected to be added early in the 11.10 development cycle.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="pre-stop-bug" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label">[20]</td><td><em>(<a class="fn-backref" href="index.html#footnote-reference-13">1</a>, <a class="fn-backref" href="index.html#footnote-reference-16">2</a>)</em> Note that <a class="reference internal" href="index.html#pre-stop">pre-stop</a> does not behave in the same
manner as other script sections. See bug 703800 (<a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/upstart/+bug/703800">https://bugs.launchpad.net/ubuntu/+source/upstart/+bug/703800</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="chroot-bug" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-22">[21]</a></td><td>For status on chroot support, see bugs 430224 and 728531:
- <a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/upstart/+bug/430224">https://bugs.launchpad.net/ubuntu/+source/upstart/+bug/430224</a>
- <a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/upstart/+bug/728531">https://bugs.launchpad.net/ubuntu/+source/upstart/+bug/728531</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="stuck-job-bug" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-38">[22]</a></td><td><a class="reference external" href="https://bugs.launchpad.net/upstart/+bug/406397">https://bugs.launchpad.net/upstart/+bug/406397</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="sbuild-bug" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-35">[23]</a></td><td><a class="reference external" href="https://bugs.launchpad.net/upstart/+bug/888910">https://bugs.launchpad.net/upstart/+bug/888910</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="debian-sbuild-bug" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-36">[24]</a></td><td><a class="reference external" href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=607844">http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=607844</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="events-are-like" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-7">[25]</a></td><td>A series of blog posts by Scott James Remnant gives further details on
events and how they are used. See <a class="footnote-reference" href="index.html#keybuk-events-are-like-signals" id="footnote-reference-39">[26]</a>,
<a class="footnote-reference" href="index.html#keybuk-events-are-like-hooks" id="footnote-reference-40">[27]</a>, and <a class="footnote-reference" href="index.html#keybuk-events-are-like-methods" id="footnote-reference-41">[28]</a>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="keybuk-events-are-like-signals" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label">[26]</td><td><em>(<a class="fn-backref" href="index.html#footnote-reference-8">1</a>, <a class="fn-backref" href="index.html#footnote-reference-39">2</a>)</em> <a class="reference external" href="http://upstart.at/2010/12/08/events-are-like-signals/">http://upstart.at/2010/12/08/events-are-like-signals/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="keybuk-events-are-like-hooks" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label">[27]</td><td><em>(<a class="fn-backref" href="index.html#footnote-reference-9">1</a>, <a class="fn-backref" href="index.html#footnote-reference-40">2</a>)</em> <a class="reference external" href="http://upstart.at/2011/01/06/events-are-like-hooks/">http://upstart.at/2011/01/06/events-are-like-hooks/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="keybuk-events-are-like-methods" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-41">[28]</a></td><td><a class="reference external" href="http://upstart.at/2010/12/16/events-are-like-methods/">http://upstart.at/2010/12/16/events-are-like-methods/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="job-visualisation-blog" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label">[29]</td><td><em>(<a class="fn-backref" href="index.html#footnote-reference-19">1</a>, <a class="fn-backref" href="index.html#footnote-reference-23">2</a>)</em> <a class="reference external" href="http://upstart.at/2011/03/25/visualisation-of-jobs-and-events-in-ubuntu-natty/">http://upstart.at/2011/03/25/visualisation-of-jobs-and-events-in-ubuntu-natty/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="checking-jobs-and-events-blog" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-17">[30]</a></td><td><a class="reference external" href="http://upstart.at/2011/03/16/checking-jobs-and-events-in-ubuntu-natty/">http://upstart.at/2011/03/16/checking-jobs-and-events-in-ubuntu-natty/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="override-files-blog" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-21">[31]</a></td><td><a class="reference external" href="http://upstart.at/2011/03/11/override-files-in-ubuntu-natty/">http://upstart.at/2011/03/11/override-files-in-ubuntu-natty/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ubuntu-kill-jobs" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-6">[32]</a></td><td><a class="reference external" href="http://www.ubuntu.com/">Ubuntu</a> will kill any jobs still running at
system shutdown using <tt class="docutils literal">/etc/init.d/sendsigs</tt>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="no-startup-file" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-11">[33]</a></td><td>Note that there is no "<tt class="docutils literal">startup</tt>" job (and hence
no <tt class="docutils literal">/etc/init/startup.conf</tt> file).</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="any-number-of-runlevels" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-10">[34]</a></td><td>It is worth noting that Unix and Linux
systems are confined by standards to the runlevels specified in the
<a class="reference internal" href="index.html#runlevels">Runlevels</a> section. However, in principle Upstart allows any number of
runlevels.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="upstart-spec" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-4">[35]</a></td><td><a class="reference external" href="https://wiki.ubuntu.com/ReplacementInit">https://wiki.ubuntu.com/ReplacementInit</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="upstart-objects-diagram" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label">[36]</td><td><a class="reference external" href="http://people.canonical.com/~jhunt/upstart/devel/upstart_objects.png">http://people.canonical.com/~jhunt/upstart/devel/upstart_objects.png</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="upstart-menu" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label">[37]</td><td><a class="reference external" href="http://people.canonical.com/~jhunt/upstart/utils/upstart_menu.sh">http://people.canonical.com/~jhunt/upstart/utils/upstart_menu.sh</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="rhel-upstart" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="index.html#footnote-reference-2">[38]</a></td><td><a class="reference external" href="http://docs.redhat.com/docs/en-US/Red_Hat_Enterprise_Linux/6/html/Technical_Notes/deployment.html">http://docs.redhat.com/docs/en-US/Red_Hat_Enterprise_Linux/6/html/Technical_Notes/deployment.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="upstart-user-sessions-spec" rules="none">
<colgroup><col class="label"><col></colgroup>
<tbody valign="top">
<tr><td class="label">[39]</td><td><a class="reference external" href="https://wiki.ubuntu.com/FoundationsTeam/Specs/RaringUpstartUserSessions">https://wiki.ubuntu.com/FoundationsTeam/Specs/RaringUpstartUserSessions</a></td></tr>
</tbody>
</table>
</div>
<div class="section" id="colophon">
<h1><a class="toc-backref" href="index.html#toc-entry-469">27&nbsp;&nbsp;&nbsp;Colophon</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<colgroup><col class="field-name">
<col class="field-body">
</colgroup><tbody valign="top">
<tr class="field"><th class="field-name">Copyright:</th><td class="field-body">Copyright  2011-2023, Canonical Ltd. All Rights Reserved.
This work is licensed under the Creative Commons Attribution-Share
Alike 3.0 Unported License. To view a copy of this license, visit
<a class="reference external" href="http://creativecommons.org/licenses/by-sa/3.0/">http://creativecommons.org/licenses/by-sa/3.0/</a> or send a letter
to Creative Commons, 171 Second Street, Suite 300, San Francisco,
California, 94105, USA.V</td>
</tr>
<tr class="field"><th class="field-name">Organization:</th><td class="field-body">Canonical Ltd.</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Drafting</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="appendices">
<h1><a class="toc-backref" href="index.html#toc-entry-470">28&nbsp;&nbsp;&nbsp;Appendices</a></h1>
<div class="section" id="ubuntu-well-known-events-ubuntu-specific">
<h2><a class="toc-backref" href="index.html#toc-entry-471">28.1&nbsp;&nbsp;&nbsp;Ubuntu Well-Known Events (<img alt="U" class="ubuntu-logo" src="https://storage.googleapis.com/chromium-website-lob-storage/be7e4cc6ef7ce95e285337634be009b70561d719">)</a></h2>
<p>The information in this section is taken from the <a class="reference external" href="http://manpages.ubuntu.com/manpages/man7/upstart-events.7.html">upstart-events(7)</a>
manual page.</p>
<pre class="literal-block">Name

   upstart-events  Well-known Upstart events summary

Event Summary

   This manual page summarizes well-known events generated by the Upstart init(8) daemon. It is
   not an exhaustive list of all possible events, but rather details a standard set of events
   expected to be generated on any Ubuntu system running Upstart.

   The primary table, Table 1, encodes the well-known events, along with the type of each event
   (listed in Table 2), the emitter of the event (see Table 3) and the approximate time at which
   the event could be generated. Additionally, the Note column indexes into Table 4 for further
   details on a particular event.

   The Ref (Reference) column is used to refer to individual events succinctly in the Time
   column.

   Note that the ''&lt;'' and ''&gt;'' characters in the Time column denote that the event in the Event
   column occurs respectively before or after the event specified in the Time column (for
   example, the mounting(7) event occurs "at some time" after the startup(7) event, and the
   virtual-filesystems(7) event occurs after the last mounted(7) event relating to a virtual
   filesystem has been emitted).

   For further details on events, consult the manual pages and the job configuration files,
   usually located in /etc/init.

   Table&nbsp;1.&nbsp;Table 1: Well-Known Event Summary.

   
    Ref             Event              Type  Emit             Time             Note 
   
         all-swaps                      S     M    &gt; (5)                        &nbsp;   
   
         control-alt-delete(7)          S     A    &gt; (5)                        A   
   
         container                      S     C    &gt; /run mounted               Q   
   
         dbus-activation                S     B    &gt; D-Bus client request       &nbsp;   
   
         deconfiguring-networking       H     V    &lt; non-local IFs down         P   
   
         desktop-session-start          H     D    &gt; X(7) session created       B   
   
         desktop-shutdown               H     D    &gt; X(7) session ended         O   
   
         device-not-ready               H     M    &gt; (2)                        N   
   
         drm-device-added               S     U    &gt; (5)                        C   
   
         failsafe-boot                  S     X    &gt; (7) and local IF           S   
   
     7   filesystem                     S     M    After last (1)               D   
   
         graphics-device-added          S     U    &gt; (5)                        C   
   
         keyboard-request(7)            S     A    &gt; (5)                        E   
   
         local-filesystems(7)           S     M    &gt; (6)                        &nbsp;   
   
         login-session-start            H     D    &lt; DM running                 F   
   
     1   mounted(7)                     H     M    &gt; associated (2)             G   
   
     2   mounting(7)                    H     M    &gt; (5)                        H   
   
     3   net-device-added               S     U    &gt; (5)                        C   
   
         net-device-changed             S     U    &gt; (5)                        C   
   
         net-device-down                S     F    &lt; (4)                        C   
   
     4   net-device-removed             S     U    &gt; (5)                        C   
   
         net-device-up                  S    F,N   &gt; (3)                        C   
   
         not-container                  S     C    &gt; /run mounted               Q   
   
         power-status-changed(7)        S     I    &gt; (5)                        I   
   
         recovery                       S     G    Boot (&lt;5)                    R   
   
         remote-filesystems(7)          S     M    &gt; (6)                        &nbsp;   
   
         runlevel(7)                    M     T    &gt; (7) + (8)                  &nbsp;   
   
         socket(7)                      S     S    &gt; socket connection          &nbsp;   
   
     5   startup(7)                     S     I    Boot                         J   
   
         started(7)                     S     I    &gt; job started                K   
   
         starting(7)                    H     I    &lt; job starts                 K   
   
     8   static-network-up              S     N    &gt; last static IF up          &nbsp;   
   
         stopped(7)                     S     I    &gt; job stopped                K   
   
         stopping(7)                    H     I    &lt; job stops                  K   
   
         unmounted-remote-filesystems   H     V    &gt; last remote FS unmounted   L   
   
     6   virtual-filesystems(7)         S     M    &gt; last virtual FS (1)        M   
   

   Key: ''DM'' is an abbreviation for Display Manager. ''FS'' is an abbreviation for filesystem.
   ''IF'' is an abbreviation for Network Interface.

   Table&nbsp;2.&nbsp;Table 2: Event Types.

   
    Ref  Event Type  Notes                                                           
   
     H   Hook        Blocking. Waits for events that start on or stop on this event. 
   
     M   Method      Blocking task.                                                  
   
     S   Signal      Non-blocking.                                                   
   

   Table&nbsp;3.&nbsp;Table 3: Event Emitters.

   
    Ref  Emitter                           Notes                           
   
     A   System Administrator (initiator)  Technically emitted by init(8). 
   
     B   dbus-daemon(1)                    Run with "--activation=upstart" 
   
     C   container-detect job              &nbsp;                               
   
     D   Display Manager                   e.g. lightdm/gdm/kdm/xdm.       
   
     F   ifup(8) or ifdown(8)              See /etc/network/.              
   
     G   bootloader or initramfs           &nbsp;                               
   
     I   init(8)                           &nbsp;                               
   
     M   mountall(8)                       &nbsp;                               
   
     N   network-interface job             &nbsp;                               
   
     S   upstart-socket-bridge(8)          &nbsp;                               
   
     T   telinit(8), shutdown(8)           &nbsp;                               
   
     U   upstart-udev-bridge(8)            &nbsp;                               
   
     V   System V init system              &nbsp;                               
   
     X   failsafe job                      &nbsp;                               
   

   Table&nbsp;4.&nbsp;Table 4: Event Summary Notes.

   
    Note  Detail                                                                              
   
     A    Requires administrator to press Control-Alt-Delete key combination on the console.  
   
     B    Event generated when user performs graphical login.                                 
   
          These are specific examples. upstart-udev-bridge(8) will emit events which match    
     C    the pattern, "S-device-A" where ''S'' is the udev subsystem and ''A'' is the udev   
          action. See udev(7) and for further details. If you have sysfs mounted, you can     
          look in /sys/class/ for possible values for subsystem.                              
   
     D    Note this is in the singular - there is no ''filesystems'' event.                   
   
     E    Emitted when administrator presses Alt-UpArrow key combination on the console.      
   
     F    Denotes Display Manager running (about to be displayed), but no users logged in     
          yet.                                                                                
   
     G    Generated for each mount that completes successfully.                               
   
     H    Emitted when mount attempt for single entry from fstab(5) for any filesystem type   
          is about to begin.                                                                  
   
     I    Emitted when Upstart receives the SIGPWR signal.                                    
   
     J    Initial event.                                                                      
   
     K    Although the events are emmitted by init(8), the instigator may be initctl(8) if a  
          System Administrator has manually started or stopped a job.                         
   
     L    /etc/init/umountnfs.sh.                                                             
   
     M    Emitted when all virtual filesystems (such as /proc) mounted.                       
   
     N    Emitted when the --dev-wait-time timeout is exceeded for mountall(8). This defaults 
          to 30 seconds.                                                                      
   
     O    Emitted when the X(7) display manager exits at shutdown or reboot, to hand off to   
          the shutdown splash manager.                                                        
   
     P    Emitted by /etc/init.d/networking just prior to stopping all non-local network      
          interfaces.                                                                         
   
     Q    Either ''container'' or ''not-container'' is emitted (depending on the              
          environment), but not both.                                                         
   
          Emitted by either the initramfs or bootloader (for example grub) as the initial     
     R    event (rather than startup(7)) to denote the system has booted into recovery mode.  
          If recovery was successful, the standard startup(7) event is then emitted, allowing 
          the system to boot as normal.                                                       
   
          Emitted to indicate the system has failed to boot within the expected time. This    
     S    event will trigger other jobs to forcibly attempt to bring the system into a usable 
          state.                                                                              
   
</pre>
</div>
</div>
<div class="section" id="footer">
<h1><a class="toc-backref" href="index.html#toc-entry-472">29&nbsp;&nbsp;&nbsp;Footer</a></h1>
</div>
</div>
<div class="footer">
<hr class="footer">
Document generated from <a class="reference external" href="http://docutils.sourceforge.net/rst.html">reStructuredText</a> plaintext markup source
on 2023-10-23 at 10:17:20 from <a class="reference external" href="http://bzr.launchpad.net/">Bazaar</a> branch <a class="reference external" href="lp:upstart-cookbook">branch</a>. See
<a class="reference external" href="https://launchpad.net/~upstart-documenters">Upstart Documenters</a> and <a class="reference external" href="https://launchpad.net/upstart-cookbook">Upstart Cookbook</a>.
(revision $Revision-Id$).
</div>


</body></html>
